{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"\ud83c\udfe0 Home","text":"Documentaci\u00f3n de Equipo de Desarrollo El Alto \ud83d\ude80 Aqu\u00ed podr\u00e1s encontrar la documentaci\u00f3n de todas las apps disponibles: frontend, backend y gu\u00edas de c\u00f3mo se fueron levantando los distintos servicios. \ud83d\udcca Arquitectura del Sistema <pre><code>flowchart LR\nClient[Cliente Web]\nAPI[FastAPI Backend]\nDB[(MySQL DB)]\nSAP[SAP ERP]\nAzure[Azure Cloud]\nClient --&gt;|HTTP/HTTPS| API\nAPI --&gt;|Queries| DB\nAPI &lt;--&gt;|RFC| SAP\nAPI --&gt;|Deployed on| Azure</code></pre> \ud83d\udd04 Flujo de Trabajo Git <pre><code>gitGraph\ncommit id: \"inicial\"\nbranch qa\ncheckout qa\ncommit id: \"qa-inicial\"\nbranch develop\ncheckout develop\ncommit id: \"dev-inicial\"\nbranch feature/nueva\ncheckout feature/nueva\ncommit id: \"desarrollo-feature\"\ncommit id: \"feature-completa\"\ncheckout develop\nmerge feature/nueva\ncommit id: \"dev-estable\"\ncheckout qa\nmerge develop\ncommit id: \"qa-validado\"\ncheckout main\nmerge qa tag: \"v1.0.0\"</code></pre> \ud83d\udee0\ufe0f Tecnolog\u00edas Implementadas Cloud y Backend: Frontend:"},{"location":"CONFIRMAR_GUIAS_README/","title":"Documentaci\u00f3n de Confirmaci\u00f3n de Gu\u00edas","text":""},{"location":"CONFIRMAR_GUIAS_README/#archivos-creados","title":"\ud83d\udcda Archivos Creados","text":""},{"location":"CONFIRMAR_GUIAS_README/#backend","title":"Backend","text":"<ul> <li>Ubicaci\u00f3n: <code>docs/backend/tracmin/gu\u00edas/confirmar-guias.md</code></li> <li>Contenido: Documentaci\u00f3n completa del sistema de confirmaci\u00f3n de gu\u00edas en el backend (AppLogiPath)</li> </ul>"},{"location":"CONFIRMAR_GUIAS_README/#frontend","title":"Frontend","text":"<ul> <li>Ubicaci\u00f3n: <code>docs/frontend/tracmin/confirmar-guias.md</code></li> <li>Contenido: Documentaci\u00f3n completa del sistema de confirmaci\u00f3n de gu\u00edas en el frontend (LogiPath)</li> </ul>"},{"location":"CONFIRMAR_GUIAS_README/#descripcion","title":"\ud83c\udfaf Descripci\u00f3n","text":"<p>La documentaci\u00f3n cubre el proceso completo de confirmaci\u00f3n de gu\u00edas de despacho, incluyendo:</p>"},{"location":"CONFIRMAR_GUIAS_README/#backend-applogipath","title":"Backend (AppLogiPath)","text":"<ul> <li>Endpoints de API para obtener y confirmar gu\u00edas</li> <li>L\u00f3gica de validaci\u00f3n de pesos (Gu\u00eda vs Ticket)</li> <li>Manejo de casos especiales:</li> <li>Devoluciones (Peso Gu\u00eda &gt; Peso Ticket)</li> <li>Nuevas Gu\u00edas (Peso Ticket &gt; Peso Gu\u00eda)</li> <li>Confirmaci\u00f3n Normal</li> <li>Rectificaciones</li> <li>Integraci\u00f3n con SAP Service Layer</li> <li>Sistema de cach\u00e9 de sesiones SAP</li> <li>Estados de gu\u00edas y control de procesamiento</li> </ul>"},{"location":"CONFIRMAR_GUIAS_README/#frontend-logipath","title":"Frontend (LogiPath)","text":"<ul> <li>Interfaz de usuario para confirmaci\u00f3n masiva</li> <li>Componentes React y TypeScript</li> <li>Sistema de selecci\u00f3n inteligente de gu\u00edas</li> <li>Modal de confirmaci\u00f3n manual con validaciones</li> <li>Manejo de tickets objetados</li> <li>C\u00e1lculo autom\u00e1tico de diferencias de peso</li> <li>Visualizaci\u00f3n de estado de confirmaci\u00f3n</li> <li>Flujos de usuario detallados</li> </ul>"},{"location":"CONFIRMAR_GUIAS_README/#referencias-cruzadas","title":"\ud83d\udd17 Referencias Cruzadas","text":"<p>La documentaci\u00f3n incluye enlaces a: - Crear Gu\u00edas - Cancelar Gu\u00edas - Correo de Gu\u00edas - Documentaci\u00f3n de SAP Service Layer - TanStack Table v8 - ShadcnUI Components</p>"},{"location":"CONFIRMAR_GUIAS_README/#contenido-destacado","title":"\ud83d\udccb Contenido Destacado","text":""},{"location":"CONFIRMAR_GUIAS_README/#diagramas","title":"Diagramas","text":"<ul> <li>\u2705 Flujo de trabajo completo (Backend)</li> <li>\u2705 Flujo de confirmaci\u00f3n masiva (Frontend)</li> <li>\u2705 Flujo de confirmaci\u00f3n individual (Frontend)</li> <li>\u2705 Manejo de tickets objetados (Frontend)</li> </ul>"},{"location":"CONFIRMAR_GUIAS_README/#codigo-de-ejemplo","title":"C\u00f3digo de Ejemplo","text":"<ul> <li>\u2705 Endpoints de API con par\u00e1metros completos</li> <li>\u2705 L\u00f3gica de negocio para diferentes casos</li> <li>\u2705 Componentes React completos</li> <li>\u2705 Tipos TypeScript</li> <li>\u2705 Validaciones del cliente</li> </ul>"},{"location":"CONFIRMAR_GUIAS_README/#guias-de-troubleshooting","title":"Gu\u00edas de Troubleshooting","text":"<ul> <li>\u2705 Problemas comunes y soluciones (Backend)</li> <li>\u2705 Problemas de UI y soluciones (Frontend)</li> </ul>"},{"location":"CONFIRMAR_GUIAS_README/#como-usar","title":"\ud83d\ude80 C\u00f3mo Usar","text":"<ol> <li> <p>Ver localmente: <pre><code>cd documentacion-elalto\nmkdocs serve\n</code></pre></p> </li> <li> <p>Acceder a:</p> </li> <li>Backend: http://localhost:8000/backend/tracmin/gu\u00edas/confirmar-guias/</li> <li> <p>Frontend: http://localhost:8000/frontend/tracmin/confirmar-guias/</p> </li> <li> <p>Construir documentaci\u00f3n: <pre><code>mkdocs build\n</code></pre></p> </li> </ol>"},{"location":"CONFIRMAR_GUIAS_README/#actualizaciones-realizadas","title":"\ud83d\udcdd Actualizaciones Realizadas","text":"<ul> <li>[x] Crear documentaci\u00f3n de backend</li> <li>[x] Crear documentaci\u00f3n de frontend</li> <li>[x] Actualizar mkdocs.yml con nuevas p\u00e1ginas</li> <li>[x] A\u00f1adir diagramas de flujo con Mermaid</li> <li>[x] Incluir ejemplos de c\u00f3digo</li> <li>[x] Documentar API routes de Next.js</li> <li>[x] Describir componentes y su arquitectura</li> <li>[x] A\u00f1adir secci\u00f3n de troubleshooting</li> </ul>"},{"location":"CONFIRMAR_GUIAS_README/#informacion-tecnica","title":"\ud83d\udd0d Informaci\u00f3n T\u00e9cnica","text":""},{"location":"CONFIRMAR_GUIAS_README/#backend_1","title":"Backend","text":"<ul> <li>Lenguaje: Python</li> <li>Framework: FastAPI</li> <li>Base de datos: SQL Server</li> <li>SAP: Service Layer API</li> <li>Autenticaci\u00f3n: JWT + Header Authorization</li> </ul>"},{"location":"CONFIRMAR_GUIAS_README/#frontend_1","title":"Frontend","text":"<ul> <li>Framework: Next.js 14</li> <li>Lenguaje: TypeScript</li> <li>UI Library: ShadcnUI + Tailwind CSS</li> <li>Tabla: TanStack Table v8</li> <li>Estado: React Hooks (useState, useCallback, useMemo)</li> <li>Notificaciones: SweetAlert2</li> </ul>"},{"location":"CONFIRMAR_GUIAS_README/#contacto","title":"\ud83d\udce7 Contacto","text":"<p>Para dudas o sugerencias sobre la documentaci\u00f3n, contactar al equipo de desarrollo.</p> <p>\u00daltima actualizaci\u00f3n: 30 de diciembre de 2025</p>"},{"location":"backend/ambientes/","title":"\ud83c\udf0d Ambientes de Desarrollo","text":""},{"location":"backend/ambientes/#vision-general","title":"\ud83c\udfaf Visi\u00f3n General","text":"<pre><code>graph LR\n    DEV[\ud83d\udee0\ufe0f Desarrollo] --&gt; QA[\ud83e\uddea Pruebas] --&gt; PROD[\ud83d\ude80 Producci\u00f3n]\n\n    style DEV fill:#f9f,stroke:#333,stroke-width:2px\n    style QA fill:#bbf,stroke:#333,stroke-width:2px\n    style PROD fill:#bfb,stroke:#333,stroke-width:2px</code></pre>"},{"location":"backend/ambientes/#ambientes-disponibles","title":"\ud83d\udd04 Ambientes Disponibles","text":""},{"location":"backend/ambientes/#1-desarrollo-dev","title":"1\ufe0f\u20e3 Desarrollo (DEV)","text":"\ud83d\udee0\ufe0f Ambiente de Desarrollo Aspecto Detalle \ud83c\udf10 URL dev.azurewebsites.net \ud83d\udd11 KeyVault elalto \ud83d\udcca Base de Datos Sandbox <pre><code>graph LR\n    subgraph \"Desarrollo\"\n        D[\ud83d\udee0\ufe0f DEV] --&gt; DS[\ud83d\udcbe SAP Sandbox]\n        D --&gt; DF[\ud83d\udccb Febos Test]\n        D --&gt; DG[\ud83d\udd04 Graph Test]\n    end</code></pre>"},{"location":"backend/ambientes/#2-pruebas-qa","title":"2\ufe0f\u20e3 Pruebas (QA)","text":"\ud83e\uddea Ambiente de Pruebas Aspecto Detalle \ud83c\udf10 URL qa.azurewebsites.net \ud83d\udd11 KeyVault elalto \ud83d\udcca Base de Datos Sandbox <pre><code>graph LR\n    subgraph \"Pruebas\"\n        Q[\ud83e\uddea QA] --&gt; QS[\ud83d\udcbe SAP Sandbox]\n        Q --&gt; QF[\ud83d\udccb Febos Test]\n        Q --&gt; QG[\ud83d\udd04 Graph Test]\n    end</code></pre>"},{"location":"backend/ambientes/#3-produccion-prod","title":"3\ufe0f\u20e3 Producci\u00f3n (PROD)","text":"\ud83d\ude80 Ambiente de Producci\u00f3n Aspecto Detalle \ud83c\udf10 URL prod.azurewebsites.net \ud83d\udd11 KeyVault elalto \ud83d\udcca Base de Datos HANA <pre><code>graph LR\n    subgraph \"Producci\u00f3n\"\n        P[\ud83d\ude80 PROD] --&gt; PS[\ud83d\udcbe SAP HANA]\n        P --&gt; PF[\ud83d\udccb Febos Prod]\n        P --&gt; PG[\ud83d\udd04 Graph Prod]\n    end</code></pre>"},{"location":"backend/ambientes/#servicios-azure","title":"\ud83d\udd27 Servicios Azure","text":"Servicios por Ambiente <pre><code>graph TB\n    subgraph \"Azure Services\"\n        DEV[\"\ud83d\udee0\ufe0f DEV\"] --&gt; |Test|AZ1[\"\n            \ud83d\udce6 Blob Storage\n            \ud83d\udcdd Form Recognizer\n            \ud83d\udd04 Web PubSub\n            \ud83d\udd11 Key Vault\n        \"]\n\n        QA[\"\ud83e\uddea QA\"] --&gt; |Test|AZ2[\"\n            \ud83d\udce6 Blob Storage\n            \ud83d\udcdd Form Recognizer\n            \ud83d\udd04 Web PubSub\n            \ud83d\udd11 Key Vault\n        \"]\n\n        PROD[\"\ud83d\ude80 PROD\"] --&gt; |Production|AZ3[\"\n            \ud83d\udce6 Blob Storage\n            \ud83d\udcdd Form Recognizer\n            \ud83d\udd04 Web PubSub\n            \ud83d\udd11 Key Vault\n        \"]\n    end</code></pre>"},{"location":"backend/ambientes/#arquitectura-sap","title":"\ud83d\udd17 Arquitectura SAP","text":"Conexi\u00f3n SAP <pre><code>graph LR\n    PROD[\ud83d\ude80 Producci\u00f3n] --&gt; GW[\ud83d\udd04 SAP Gateway]\n    GW --&gt; HANA[\ud83d\udcbe SAP HANA]\n\n    style GW fill:#ff9,stroke:#333,stroke-width:2px</code></pre>"},{"location":"backend/ambientes/#configuraciones","title":"\u2699\ufe0f Configuraciones","text":"Consideraciones por Ambiente Ambiente Uso Consideraciones DEV Desarrollo Testing local, debugging QA Pruebas Validaci\u00f3n, UAT PROD Producci\u00f3n Monitoreo, respaldos"},{"location":"backend/ambientes/#seguridad","title":"\ud83d\udd12 Seguridad","text":"Accesos y Permisos Ambiente Nivel Acceso Autenticaci\u00f3n DEV Desarrollo Azure AD QA Restringido Azure AD PROD Estricto Azure AD + MFA"},{"location":"backend/ambientes/#monitoreo","title":"\ud83d\udcca Monitoreo","text":"Herramientas de Monitoreo Herramienta DEV QA PROD Application Insights \u2705 \u2705 \u2705 Log Analytics \u2705 \u2705 \u2705 Azure Monitor \u274c \u2705 \u2705"},{"location":"backend/ambientes/#recursos","title":"\ud83d\udcda Recursos","text":"Enlaces \u00datiles <ul> <li>Azure Portal</li> <li>SAP Portal</li> <li>Documentaci\u00f3n Azure</li> </ul>"},{"location":"backend/websocket/","title":"\ud83d\udd04 WebSocket con Azure Web PubSub","text":""},{"location":"backend/websocket/#descripcion-general","title":"\ud83d\udce1 Descripci\u00f3n General","text":"<p>Azure Web PubSub Service proporciona comunicaci\u00f3n en tiempo real para la aplicaci\u00f3n Tracmin Extracci\u00f3n y Log\u00edstica.</p> <pre><code>graph LR\n    Client[Cliente Web/M\u00f3vil]\n    AWPS[Azure Web PubSub]\n    Server[Backend]\n\n    Client &lt;--&gt;|WebSocket| AWPS\n    AWPS &lt;--&gt;|Events| Server\n\n    style AWPS fill:#0078D4,stroke:#fff,stroke-width:2px,color:#fff</code></pre>"},{"location":"backend/websocket/#configuracion","title":"\u2699\ufe0f Configuraci\u00f3n","text":""},{"location":"backend/websocket/#1-azure-setup","title":"1\ufe0f\u20e3 Azure Setup","text":"Configuraci\u00f3n Azure <pre><code>const connection_string = \"Endpoint=https://{hub}.webpubsub.azure.com;AccessKey={key};Version=1.0;\"\nconst hub_name = \"tracmin\"\n</code></pre>"},{"location":"backend/websocket/#2-cliente-websocket","title":"2\ufe0f\u20e3 Cliente WebSocket","text":"Configuraci\u00f3n Cliente <pre><code>// websocket.service.ts\nexport class WebSocketService {\n  private client: WebSocket;\n  private url: string;\n\n  constructor() {\n    this.url = await this.getNegotiateUrl();\n  }\n\n  private async getNegotiateUrl(): Promise&lt;string&gt; {\n    const response = await fetch('/api/negotiate', {\n      method: 'GET',\n      headers: {\n        'user-id': getCurrentUserId()\n      }\n    });\n    const data = await response.json();\n    return data.url;\n  }\n\n  connect() {\n    this.client = new WebSocket(this.url);\n    this.setupEventHandlers();\n  }\n}\n</code></pre>"},{"location":"backend/websocket/#eventos","title":"\ud83d\udd0c Eventos","text":""},{"location":"backend/websocket/#tipos-de-eventos","title":"Tipos de Eventos","text":"Eventos Principales <pre><code>enum WSEvents {\n  // Viajes\n  TRIP_STARTED = 'trip:started',\n  TRIP_UPDATED = 'trip:updated',\n  TRIP_COMPLETED = 'trip:completed',\n\n  // Ubicaci\u00f3n\n  LOCATION_UPDATE = 'location:update',\n\n  // Sistema\n  CONNECTION_STATE = 'connection:state',\n  ERROR = 'error'\n}\n</code></pre>"},{"location":"backend/websocket/#manejo-de-eventos","title":"Manejo de Eventos","text":"Event Handlers <pre><code>setupEventHandlers() {\n  this.client.onopen = () =&gt; {\n    console.log('WebSocket Connected');\n    this.connectionState$.next('connected');\n  };\n\n  this.client.onmessage = (event) =&gt; {\n    const data = JSON.parse(event.data);\n    this.handleMessage(data);\n  };\n\n  this.client.onclose = () =&gt; {\n    console.log('WebSocket Disconnected');\n    this.connectionState$.next('disconnected');\n    this.reconnect();\n  };\n}\n</code></pre>"},{"location":"backend/websocket/#reconexion-automatica","title":"\ud83d\udd04 Reconexi\u00f3n Autom\u00e1tica","text":"L\u00f3gica de Reconexi\u00f3n <pre><code>class WebSocketManager {\n  private reconnectAttempts = 0;\n  private maxReconnectAttempts = 5;\n  private baseDelay = 1000; // 1 segundo\n\n  async reconnect() {\n    if (this.reconnectAttempts &gt;= this.maxReconnectAttempts) {\n      this.handleReconnectFailure();\n      return;\n    }\n\n    const delay = this.calculateBackoff();\n    await this.wait(delay);\n\n    this.reconnectAttempts++;\n    this.connect();\n  }\n\n  private calculateBackoff(): number {\n    return this.baseDelay * Math.pow(2, this.reconnectAttempts);\n  }\n}\n</code></pre>"},{"location":"backend/websocket/#envio-de-mensajes","title":"\ud83d\udce8 Env\u00edo de Mensajes","text":"M\u00e9todos de Env\u00edo <pre><code>// Env\u00edo de ubicaci\u00f3n\nsendLocation(coords: Coordinates) {\n  this.send({\n    type: WSEvents.LOCATION_UPDATE,\n    payload: coords\n  });\n}\n\n// Actualizaci\u00f3n de estado de viaje\nupdateTripStatus(tripId: string, status: TripStatus) {\n  this.send({\n    type: WSEvents.TRIP_UPDATED,\n    payload: { tripId, status }\n  });\n}\n</code></pre>"},{"location":"backend/websocket/#seguridad","title":"\ud83d\udd12 Seguridad","text":"Consideraciones de Seguridad <ul> <li>Tokens de conexi\u00f3n temporales</li> <li>Validaci\u00f3n de usuario por conexi\u00f3n</li> <li>Encriptaci\u00f3n de datos sensibles</li> <li>Rate limiting</li> <li>Monitoreo de conexiones</li> </ul>"},{"location":"backend/websocket/#monitoreo","title":"\ud83d\udcca Monitoreo","text":"M\u00e9tricas Importantes M\u00e9trica Descripci\u00f3n Alerta Conexiones Activas N\u00famero de clientes conectados &gt;1000 Latencia Tiempo de respuesta &gt;500ms Errores Tasa de errores &gt;1% Reconexiones Intentos de reconexi\u00f3n &gt;5/min"},{"location":"backend/websocket/#manejo-de-errores","title":"\u26a0\ufe0f Manejo de Errores","text":"Errores Comunes Error Causa Soluci\u00f3n Token Expirado Sesi\u00f3n caducada Renovar token Conexi\u00f3n Perdida Red inestable Reconexi\u00f3n autom\u00e1tica Rate Limit Demasiadas peticiones Implementar backoff"},{"location":"backend/websocket/#ejemplos-de-uso","title":"\ud83d\udcdd Ejemplos de Uso","text":"Implementaci\u00f3n B\u00e1sica <pre><code>// Inicializar WebSocket\nconst ws = new WebSocketService();\n\n// Suscribirse a eventos\nws.on(WSEvents.TRIP_UPDATED, (data) =&gt; {\n  updateTripUI(data);\n});\n\n// Enviar actualizaci\u00f3n\nws.sendLocation({\n  lat: -33.4569,\n  lng: -70.6483\n});\n</code></pre>"},{"location":"backend/websocket/#debugging","title":"\ud83d\udd0d Debugging","text":"Herramientas de Debug <ul> <li>Azure Portal Metrics</li> <li>Browser DevTools (Network tab)</li> <li>Custom logging</li> <li>WebSocket Inspector</li> </ul>"},{"location":"backend/websocket/#recursos","title":"\ud83d\udcda Recursos","text":"Enlaces \u00datiles <ul> <li>Azure Web PubSub Docs</li> <li>WebSocket API</li> </ul>"},{"location":"backend/whatsapp/","title":"\ud83d\udcac WhatsApp Business API - Documentaci\u00f3n","text":""},{"location":"backend/whatsapp/#descripcion-general","title":"\ud83d\udcf1 Descripci\u00f3n General","text":"<p>Integraci\u00f3n con WhatsApp Business API para env\u00edo de notificaciones y mensajes automatizados a clientes, conductores y administradores del sistema Tracmin.</p> <pre><code>graph LR\n    Backend[Backend API]\n    WhatsApp[WhatsApp Business API]\n    Cliente[Cliente WhatsApp]\n\n    Backend --&gt;|Enviar Mensaje| WhatsApp\n    WhatsApp --&gt;|Notificaci\u00f3n| Cliente\n    Cliente --&gt;|Respuesta| WhatsApp\n    WhatsApp --&gt;|Webhook| Backend\n\n    style WhatsApp fill:#25D366,stroke:#fff,stroke-width:2px,color:#fff</code></pre>"},{"location":"backend/whatsapp/#webhook-whatsapp-con-ia","title":"\ud83e\udd16 Webhook WhatsApp con IA","text":"<p>Sistema de chatbot inteligente basado en agentes de IA que permite a los usuarios interactuar con la plataforma Tracmin a trav\u00e9s de WhatsApp.</p>"},{"location":"backend/whatsapp/#documentacion-completa-del-webhook","title":"Documentaci\u00f3n Completa del Webhook","text":"<ul> <li>Arquitectura General - Vista general del sistema, stack tecnol\u00f3gico y componentes</li> <li>Flujo de Mensajes - Procesamiento detallado de mensajes y casos especiales</li> <li>Sistema de Agentes - Agentes especializados y factory pattern</li> <li>Seguridad y Validaci\u00f3n - Content filter, guardrails y autenticaci\u00f3n</li> <li>MCP y Base de Datos - Model Context Protocol y acceso a datos</li> </ul>"},{"location":"backend/whatsapp/#caracteristicas-principales","title":"Caracter\u00edsticas Principales","text":"<p>\u2705 Agentes Especializados - Factory pattern con agentes para documentos, combustible, operaciones, veh\u00edculos y transportistas \u2705 Seguridad Multi-Capa - Content filter, AI guardrails, validaci\u00f3n RUT y restricciones por usuario \u2705 Model Context Protocol - Acceso seguro a SQL Server mediante MCP \u2705 Conversaci\u00f3n Natural - Respuestas en lenguaje natural con formato Toon \u2705 Autenticaci\u00f3n Robusta - Vinculaci\u00f3n de cuentas con validaci\u00f3n de RUT chileno \u2705 Roles y Permisos - Diferenciaci\u00f3n entre usuarios normales y administradores</p>"},{"location":"backend/whatsapp/#configuracion","title":"\u2699\ufe0f Configuraci\u00f3n","text":""},{"location":"backend/whatsapp/#1-requisitos-previos","title":"1\ufe0f\u20e3 Requisitos Previos","text":"Credenciales Necesarias <pre><code># Variables de entorno\nWHATSAPP_API_TOKEN = \"tu_token_de_acceso\"\nWHATSAPP_PHONE_NUMBER_ID = \"tu_phone_number_id\"\nWHATSAPP_BUSINESS_ACCOUNT_ID = \"tu_business_account_id\"\nWHATSAPP_WEBHOOK_VERIFY_TOKEN = \"tu_verify_token\"\n</code></pre> Requisitos Meta <ul> <li>Cuenta de Meta Business</li> <li>Aplicaci\u00f3n de WhatsApp Business</li> <li>N\u00famero de tel\u00e9fono verificado</li> <li>Token de acceso permanente</li> </ul>"},{"location":"backend/whatsapp/#2-configuracion-del-cliente","title":"2\ufe0f\u20e3 Configuraci\u00f3n del Cliente","text":"Cliente WhatsApp <pre><code># whatsapp_service.py\nimport requests\nfrom typing import Optional, Dict, List\n\nclass WhatsAppService:\n    BASE_URL = \"https://graph.facebook.com/v18.0\"\n\n    def __init__(self, token: str, phone_number_id: str):\n        self.token = token\n        self.phone_number_id = phone_number_id\n        self.headers = {\n            \"Authorization\": f\"Bearer {token}\",\n            \"Content-Type\": \"application/json\"\n        }\n\n    def send_message(\n        self, \n        to: str, \n        message: str,\n        message_type: str = \"text\"\n    ) -&gt; Dict:\n        \"\"\"\n        Env\u00eda un mensaje de texto por WhatsApp\n\n        Args:\n            to: N\u00famero de tel\u00e9fono (con c\u00f3digo de pa\u00eds)\n            message: Contenido del mensaje\n            message_type: Tipo de mensaje (text, template, etc.)\n\n        Returns:\n            Dict con respuesta de la API\n        \"\"\"\n        url = f\"{self.BASE_URL}/{self.phone_number_id}/messages\"\n\n        payload = {\n            \"messaging_product\": \"whatsapp\",\n            \"to\": to,\n            \"type\": message_type,\n            \"text\": {\"body\": message}\n        }\n\n        response = requests.post(url, json=payload, headers=self.headers)\n        return response.json()\n</code></pre>"},{"location":"backend/whatsapp/#envio-de-mensajes","title":"\ud83d\udce4 Env\u00edo de Mensajes","text":""},{"location":"backend/whatsapp/#mensaje-de-texto-simple","title":"\ud83d\udcdd Mensaje de Texto Simple","text":"Env\u00edo B\u00e1sico <pre><code>@router.post(\"/api/whatsapp/send_text\")\nasync def send_whatsapp_text(\n    sec: Annotated[str, Depends(security_scheme)],\n    phone: str,\n    message: str\n):\n    \"\"\"\n    Env\u00eda un mensaje de texto simple por WhatsApp\n\n    Args:\n        sec: Token JWT de autenticaci\u00f3n\n        phone: N\u00famero de tel\u00e9fono destino (formato: +56912345678)\n        message: Contenido del mensaje\n\n    Returns:\n        dict: {\n            \"status\": \"success\",\n            \"message_id\": \"wamid.xxx\",\n            \"phone\": \"+56912345678\"\n        }\n\n    Raises:\n        HTTPException:\n            - 401: Token inv\u00e1lido\n            - 400: N\u00famero de tel\u00e9fono inv\u00e1lido\n            - 500: Error al enviar mensaje\n    \"\"\"\n    try:\n        # Validar formato de tel\u00e9fono\n        if not phone.startswith(\"+\"):\n            raise HTTPException(\n                status_code=400,\n                detail=\"N\u00famero debe incluir c\u00f3digo de pa\u00eds (ej: +56912345678)\"\n            )\n\n        # Enviar mensaje\n        whatsapp = WhatsAppService(\n            token=WHATSAPP_API_TOKEN,\n            phone_number_id=WHATSAPP_PHONE_NUMBER_ID\n        )\n\n        result = whatsapp.send_message(to=phone, message=message)\n\n        if \"messages\" in result:\n            return {\n                \"status\": \"success\",\n                \"message_id\": result[\"messages\"][0][\"id\"],\n                \"phone\": phone\n            }\n        else:\n            raise HTTPException(\n                status_code=500,\n                detail=f\"Error de WhatsApp: {result.get('error', {}).get('message')}\"\n            )\n\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))\n</code></pre>"},{"location":"backend/whatsapp/#mensaje-con-plantilla-template","title":"\ud83d\udccb Mensaje con Plantilla (Template)","text":"Env\u00edo con Template <pre><code>@router.post(\"/api/whatsapp/send_template\")\nasync def send_whatsapp_template(\n    sec: Annotated[str, Depends(security_scheme)],\n    phone: str,\n    template_name: str,\n    parameters: Optional[List[str]] = None\n):\n    \"\"\"\n    Env\u00eda un mensaje usando plantilla pre-aprobada\n\n    Args:\n        sec: Token JWT\n        phone: N\u00famero destino\n        template_name: Nombre de la plantilla\n        parameters: Lista de par\u00e1metros para la plantilla\n\n    Returns:\n        dict: Resultado del env\u00edo\n    \"\"\"\n    url = f\"{WhatsAppService.BASE_URL}/{WHATSAPP_PHONE_NUMBER_ID}/messages\"\n\n    # Construir componentes de la plantilla\n    components = []\n    if parameters:\n        components.append({\n            \"type\": \"body\",\n            \"parameters\": [\n                {\"type\": \"text\", \"text\": param} \n                for param in parameters\n            ]\n        })\n\n    payload = {\n        \"messaging_product\": \"whatsapp\",\n        \"to\": phone,\n        \"type\": \"template\",\n        \"template\": {\n            \"name\": template_name,\n            \"language\": {\"code\": \"es\"},\n            \"components\": components\n        }\n    }\n\n    headers = {\n        \"Authorization\": f\"Bearer {WHATSAPP_API_TOKEN}\",\n        \"Content-Type\": \"application/json\"\n    }\n\n    response = requests.post(url, json=payload, headers=headers)\n    return response.json()\n</code></pre>"},{"location":"backend/whatsapp/#casos-de-uso-en-tracmin","title":"\ud83d\udd14 Casos de Uso en Tracmin","text":"<p>\u26a0\ufe0f Nota Importante: Los agentes de WhatsApp NO pueden crear gu\u00edas. Solo env\u00edan notificaciones autom\u00e1ticas cuando una gu\u00eda es creada por el sistema o por usuarios autorizados.</p>"},{"location":"backend/whatsapp/#1-notificacion-de-guia-creada","title":"1\ufe0f\u20e3 Notificaci\u00f3n de Gu\u00eda Creada","text":"Gu\u00eda Generada (Solo Notificaci\u00f3n) <pre><code>async def notificar_guia_creada(\n    phone: str,\n    folio: str,\n    cliente: str,\n    conductor: str\n):\n    \"\"\"\n    Notifica al conductor cuando una gu\u00eda es creada por el sistema.\n\n    IMPORTANTE: Esta funci\u00f3n NO crea gu\u00edas, solo env\u00eda una notificaci\u00f3n\n    despu\u00e9s de que la gu\u00eda ha sido creada por otro proceso.\n    \"\"\"\n    message = f\"\"\"\n            \u2705 *Gu\u00eda Generada Exitosamente*\n\n            \ud83d\udcc4 Folio: {folio}\n            \ud83d\udc64 Cliente: {cliente}\n            \ud83d\ude9a Conductor: {conductor}\n\n            La gu\u00eda ha sido generada y est\u00e1 lista para el despacho.\n            \"\"\"\n\n    whatsapp = WhatsAppService(\n        token=WHATSAPP_API_TOKEN,\n        phone_number_id=WHATSAPP_PHONE_NUMBER_ID\n    )\n\n    return whatsapp.send_message(to=phone, message=message.strip())\n</code></pre>"},{"location":"backend/whatsapp/#2-actualizacion-de-estado-de-viaje","title":"2\ufe0f\u20e3 Actualizaci\u00f3n de Estado de Viaje","text":"Estado de Viaje <pre><code>async def notificar_estado_viaje(\n    phone: str,\n    patente: str,\n    estado: str,\n    ubicacion: Optional[str] = None\n):\n    \"\"\"\n    Notifica cambios en el estado del viaje\n    \"\"\"\n    estados_emoji = {\n        \"Inicio Jornada\": \"\ud83d\ude80\",\n        \"En Carga\": \"\u23f3\",\n        \"Con Folio\": \"\ud83d\udcc4\",\n        \"En Tr\u00e1nsito\": \"\ud83d\ude9b\",\n        \"Llegada Cliente\": \"\ud83d\udccd\",\n        \"Fin Entrega\": \"\u2705\",\n        \"Cancelado\": \"\u274c\"\n    }\n\n    emoji = estados_emoji.get(estado, \"\ud83d\udce2\")\n\n    message = f\"\"\"\n        {emoji} *Actualizaci\u00f3n de Viaje*\n        \ud83d\ude9b Patente: {patente}\n        \ud83d\udcca Estado: {estado}\n        \"\"\"\n\n    if ubicacion:\n        message += f\"\ud83d\udccd Ubicaci\u00f3n: {ubicacion}\\n\"\n\n    message += \"\\nTracmin - Extracci\u00f3n y Log\u00edstica\"\n\n    whatsapp = WhatsAppService(\n        token=WHATSAPP_API_TOKEN,\n        phone_number_id=WHATSAPP_PHONE_NUMBER_ID\n    )\n\n    return whatsapp.send_message(to=phone, message=message.strip())\n</code></pre>"},{"location":"backend/whatsapp/#3-alertas-de-sistema","title":"3\ufe0f\u20e3 Alertas de Sistema","text":"Alertas Cr\u00edticas <pre><code>async def enviar_alerta_sistema(\n    phones: List[str],\n    tipo_alerta: str,\n    descripcion: str,\n    severidad: str = \"medium\"\n):\n    \"\"\"\n    Env\u00eda alertas del sistema a administradores\n\n    Args:\n        phones: Lista de n\u00fameros de tel\u00e9fono\n        tipo_alerta: Tipo de alerta (SAP, Database, WebSocket, etc.)\n        descripcion: Descripci\u00f3n del problema\n        severidad: low, medium, high, critical\n    \"\"\"\n    severidad_emoji = {\n        \"low\": \"\u2139\ufe0f\",\n        \"medium\": \"\u26a0\ufe0f\",\n        \"high\": \"\ud83d\udea8\",\n        \"critical\": \"\ud83d\udd34\"\n    }\n\n    emoji = severidad_emoji.get(severidad, \"\u26a0\ufe0f\")\n\n    # Construir mensaje formateado\n    message = f\"\"\"\n        {emoji} *ALERTA DEL SISTEMA*\n\n        \ud83d\udd27 *Tipo:* {tipo_alerta}\n        \ud83d\udcdd *Descripci\u00f3n:* {descripcion}\n        \u23f0 *Hora:* {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}\n\n        \u26a1 _Revise el sistema inmediatamente._\n        \"\"\"\n\n    # Inicializar servicio de WhatsApp\n    whatsapp = WhatsAppService(\n        token=WHATSAPP_API_TOKEN,\n        phone_number_id=WHATSAPP_PHONE_NUMBER_ID\n    )\n\n    # Enviar alertas a todos los tel\u00e9fonos\n    resultados = []\n    for phone in phones:\n        try:\n            result = whatsapp.send_message(\n                to=phone, \n                message=message.strip()\n            )\n            resultados.append({\n                \"phone\": phone,\n                \"status\": \"sent\",\n                \"message_id\": result.get(\"messages\", [{}])[0].get(\"id\")\n            })\n        except Exception as e:\n            resultados.append({\n                \"phone\": phone,\n                \"status\": \"failed\",\n                \"error\": str(e)\n            })\n\n    return resultados\n</code></pre>"},{"location":"backend/whatsapp/#webhook-recepcion-de-mensajes","title":"\ud83d\udd04 Webhook - Recepci\u00f3n de Mensajes","text":""},{"location":"backend/whatsapp/#configuracion-del-webhook","title":"Configuraci\u00f3n del Webhook","text":"Endpoint Webhook <pre><code>@router.get(\"/api/whatsapp/webhook\")\nasync def verify_webhook(\n    request: Request,\n    mode: str = Query(..., alias=\"hub.mode\"),\n    token: str = Query(..., alias=\"hub.verify_token\"),\n    challenge: str = Query(..., alias=\"hub.challenge\")\n):\n    \"\"\"\n    Verificaci\u00f3n del webhook de WhatsApp\n\n    Meta enviar\u00e1 este request para verificar el endpoint\n    \"\"\"\n    if mode == \"subscribe\" and token == WHATSAPP_WEBHOOK_VERIFY_TOKEN:\n        return Response(content=challenge, media_type=\"text/plain\")\n    else:\n        raise HTTPException(status_code=403, detail=\"Verification failed\")\n\n\n@router.post(\"/api/whatsapp/webhook\")\nasync def receive_webhook(request: Request):\n    \"\"\"\n    Recibe webhooks de WhatsApp (mensajes entrantes, estados, etc.)\n    \"\"\"\n    try:\n        body = await request.json()\n\n        # Procesar mensajes entrantes\n        if \"messages\" in body.get(\"entry\", [{}])[0].get(\"changes\", [{}])[0].get(\"value\", {}):\n            messages = body[\"entry\"][0][\"changes\"][0][\"value\"][\"messages\"]\n\n            for message in messages:\n                from_number = message[\"from\"]\n                message_type = message[\"type\"]\n\n                if message_type == \"text\":\n                    text = message[\"text\"][\"body\"]\n\n                    # Procesar el mensaje\n                    await process_incoming_message(from_number, text)\n\n        # Procesar estados de mensajes\n        if \"statuses\" in body.get(\"entry\", [{}])[0].get(\"changes\", [{}])[0].get(\"value\", {}):\n            statuses = body[\"entry\"][0][\"changes\"][0][\"value\"][\"statuses\"]\n\n            for status in statuses:\n                message_id = status[\"id\"]\n                status_value = status[\"status\"]  # sent, delivered, read, failed\n\n                # Actualizar estado del mensaje en DB\n                await update_message_status(message_id, status_value)\n\n        return {\"status\": \"ok\"}\n\n    except Exception as e:\n        print(f\"Error processing webhook: {str(e)}\")\n        return {\"status\": \"error\", \"message\": str(e)}\n</code></pre>"},{"location":"backend/whatsapp/#procesamiento-de-mensajes-entrantes","title":"Procesamiento de Mensajes Entrantes","text":"Respuestas Autom\u00e1ticas <pre><code>async def process_incoming_message(phone: str, message: str):\n    \"\"\"\n    Procesa mensajes entrantes y genera respuestas autom\u00e1ticas\n    \"\"\"\n    message_lower = message.lower().strip()\n\n    whatsapp = WhatsAppService(\n        token=WHATSAPP_API_TOKEN,\n        phone_number_id=WHATSAPP_PHONE_NUMBER_ID\n    )\n\n    # Comando: ESTADO\n    if message_lower == \"estado\":\n        # Buscar viajes activos del conductor\n        trips = await get_active_trips_by_phone(phone)\n\n        if trips:\n            response = \"\ud83d\ude9b *Tus Viajes Activos:*\\n\\n\"\n            for trip in trips:\n                response += f\"\ud83d\ude97 Patente: {trip['patente']}\\n\"\n                response += f\"\ud83d\udcca Estado: {trip['estado']}\\n\"\n                response += f\"\ud83d\udc64 Cliente: {trip['cliente']}\\n\\n\"\n        else:\n            response = \"\u2705 No tienes viajes activos en este momento.\"\n\n        whatsapp.send_message(to=phone, message=response)\n\n    # Comando: AYUDA\n    elif message_lower == \"ayuda\":\n        response = \"\"\"\n            \ud83d\udcf1 *Comandos Disponibles:*\n\n            \u2022 ESTADO - Ver tus viajes activos\n            \u2022 GUIA - Informaci\u00f3n de tu \u00faltima gu\u00eda\n            \u2022 UBICACION - Compartir tu ubicaci\u00f3n\n            \u2022 AYUDA - Ver este mensaje\n\n            Para soporte, contacta a: soporte@tracmin.cl\n\n            \"\"\"\n    whatsapp.send_message(to=phone, message=response.strip())\n\n    # Comando: GUIA\n    elif message_lower == \"guia\":\n        guia = await get_last_guide_by_phone(phone)\n\n        if guia:\n            response = f\"\"\"\n                \ud83d\udcc4 *Tu \u00daltima Gu\u00eda:*\n                \ud83d\udccb Folio: {guia['folio']}\n                \ud83d\udc64 Cliente: {guia['cliente']}\n                \ud83d\udcca Estado: {guia['estado']}\n                \ud83d\udcc5 Fecha: {guia['fecha']}\n                \ud83d\udd17 Link: {guia['datalink']}\n            \"\"\"\n        else:\n            response = \"No se encontraron gu\u00edas recientes.\"\n\n        whatsapp.send_message(to=phone, message=response.strip())\n\n    # Mensaje no reconocido\n    else:\n        response = \"\"\"\n            Hola \ud83d\udc4b\n            No entend\u00ed tu mensaje. Escribe *AYUDA* para ver los comandos disponibles.\n        \"\"\"\n        whatsapp.send_message(to=phone, message=response.strip())\n</code></pre>"},{"location":"backend/whatsapp/#tracking-y-logs","title":"\ud83d\udcca Tracking y Logs","text":""},{"location":"backend/whatsapp/#registro-de-mensajes","title":"Registro de Mensajes","text":"Base de Datos - Modelo <pre><code># models.py\nclass WhatsAppMessage(Base):\n    __tablename__ = \"whatsapp_messages\"\n\n    id = Column(Integer, primary_key=True)\n    message_id = Column(String, unique=True, nullable=False)\n    phone = Column(String, nullable=False)\n    direction = Column(String, nullable=False)  # outgoing, incoming\n    message_type = Column(String, nullable=False)  # text, template, image\n    content = Column(Text)\n    status = Column(String)  # sent, delivered, read, failed\n    error_message = Column(Text)\n    created_at = Column(DateTime, default=datetime.utcnow)\n    updated_at = Column(DateTime, onupdate=datetime.utcnow)\n\n    # Relaciones opcionales\n    user_id = Column(Integer, ForeignKey(\"users.id\"))\n    trip_id = Column(Integer, ForeignKey(\"actual_trip.id\"))\n</code></pre>"},{"location":"backend/whatsapp/#consulta-de-historial","title":"Consulta de Historial","text":"Endpoint Historial <pre><code>@router.get(\"/api/whatsapp/history/{phone}\")\nasync def get_whatsapp_history(\n    phone: str,\n    sec: Annotated[str, Depends(security_scheme)],\n    limit: int = 50,\n    offset: int = 0\n):\n    \"\"\"\n    Obtiene historial de mensajes de WhatsApp\n\n    Args:\n        phone: N\u00famero de tel\u00e9fono\n        sec: Token JWT (solo admin)\n        limit: Cantidad de mensajes\n        offset: Paginaci\u00f3n\n\n    Returns:\n        Lista de mensajes con su estado\n    \"\"\"\n    # Validar permisos de admin\n    validate_admin_permissions(sec)\n\n    messages = db.query(WhatsAppMessage)\\\n        .filter(WhatsAppMessage.phone == phone)\\\n        .order_by(WhatsAppMessage.created_at.desc())\\\n        .limit(limit)\\\n        .offset(offset)\\\n        .all()\n\n    return {\n        \"phone\": phone,\n        \"total\": db.query(WhatsAppMessage).filter_by(phone=phone).count(),\n        \"messages\": [\n            {\n                \"id\": msg.id,\n                \"message_id\": msg.message_id,\n                \"direction\": msg.direction,\n                \"type\": msg.message_type,\n                \"content\": msg.content,\n                \"status\": msg.status,\n                \"created_at\": msg.created_at.isoformat()\n            }\n            for msg in messages\n        ]\n    }\n</code></pre>"},{"location":"backend/whatsapp/#mejores-practicas","title":"\ud83c\udfaf Mejores Pr\u00e1cticas","text":"Recomendaciones"},{"location":"backend/whatsapp/#limites-de-rate","title":"L\u00edmites de Rate","text":"<ul> <li>M\u00e1ximo 1000 mensajes/d\u00eda por n\u00famero (API est\u00e1ndar)</li> <li>80 mensajes/segundo para cuentas verificadas</li> <li>Implementar retry logic con backoff exponencial</li> </ul>"},{"location":"backend/whatsapp/#formato-de-numeros","title":"Formato de N\u00fameros","text":"<ul> <li>Incluir c\u00f3digo de pa\u00eds: <code>+56912345678</code></li> <li>Sin espacios ni caracteres especiales</li> <li>Validar formato antes de enviar</li> </ul>"},{"location":"backend/whatsapp/#contenido-de-mensajes","title":"Contenido de Mensajes","text":"<ul> <li>M\u00e1ximo 4096 caracteres por mensaje</li> <li>Usar emojis para mejor engagement</li> <li>Incluir informaci\u00f3n clara y concisa</li> <li>Agregar llamados a la acci\u00f3n (CTA)</li> </ul>"},{"location":"backend/whatsapp/#templates","title":"Templates","text":"<ul> <li>Crear templates pre-aprobados para notificaciones frecuentes</li> <li>Los templates requieren aprobaci\u00f3n de Meta (24-48 horas)</li> <li>Usar variables din\u00e1micas: <code>{{1}}</code>, <code>{{2}}</code>, etc.</li> </ul>"},{"location":"backend/whatsapp/#seguridad","title":"Seguridad","text":"<ul> <li>Nunca compartir tokens en c\u00f3digo</li> <li>Usar variables de entorno</li> <li>Validar webhook verify token</li> <li>Registrar todos los eventos en logs</li> </ul>"},{"location":"backend/whatsapp/#monitoreo","title":"\ud83d\udcc8 Monitoreo","text":"M\u00e9tricas Importantes <pre><code>@router.get(\"/api/whatsapp/metrics\")\nasync def get_whatsapp_metrics(\n    sec: Annotated[str, Depends(security_scheme)],\n    start_date: Optional[datetime] = None,\n    end_date: Optional[datetime] = None\n):\n    \"\"\"\n    Obtiene m\u00e9tricas de uso de WhatsApp\n    \"\"\"\n    validate_admin_permissions(sec)\n\n    if not start_date:\n        start_date = datetime.utcnow() - timedelta(days=30)\n    if not end_date:\n        end_date = datetime.utcnow()\n\n    # Mensajes enviados\n    sent_count = db.query(WhatsAppMessage)\\\n        .filter(\n            WhatsAppMessage.direction == \"outgoing\",\n            WhatsAppMessage.created_at.between(start_date, end_date)\n        )\\\n        .count()\n\n    # Mensajes entregados\n    delivered_count = db.query(WhatsAppMessage)\\\n        .filter(\n            WhatsAppMessage.direction == \"outgoing\",\n            WhatsAppMessage.status == \"delivered\",\n            WhatsAppMessage.created_at.between(start_date, end_date)\n        )\\\n        .count()\n\n    # Mensajes le\u00eddos\n    read_count = db.query(WhatsAppMessage)\\\n        .filter(\n            WhatsAppMessage.direction == \"outgoing\",\n            WhatsAppMessage.status == \"read\",\n            WhatsAppMessage.created_at.between(start_date, end_date)\n        )\\\n        .count()\n\n    # Mensajes fallidos\n    failed_count = db.query(WhatsAppMessage)\\\n        .filter(\n            WhatsAppMessage.direction == \"outgoing\",\n            WhatsAppMessage.status == \"failed\",\n            WhatsAppMessage.created_at.between(start_date, end_date)\n        )\\\n        .count()\n\n    # Tasa de entrega\n    delivery_rate = (delivered_count / sent_count * 100) if sent_count &gt; 0 else 0\n\n    # Tasa de lectura\n    read_rate = (read_count / delivered_count * 100) if delivered_count &gt; 0 else 0\n\n    return {\n        \"period\": {\n            \"start\": start_date.isoformat(),\n            \"end\": end_date.isoformat()\n        },\n        \"metrics\": {\n            \"sent\": sent_count,\n            \"delivered\": delivered_count,\n            \"read\": read_count,\n            \"failed\": failed_count,\n            \"delivery_rate\": round(delivery_rate, 2),\n            \"read_rate\": round(read_rate, 2)\n        }\n    }\n</code></pre>"},{"location":"backend/whatsapp/#troubleshooting","title":"\ud83d\udee0\ufe0f Troubleshooting","text":"Errores Comunes"},{"location":"backend/whatsapp/#error-401-unauthorized","title":"Error 401: Unauthorized","text":"<ul> <li>Verificar token de acceso</li> <li>Token puede haber expirado</li> <li>Regenerar token en Meta Business</li> </ul>"},{"location":"backend/whatsapp/#error-400-invalid-phone-number","title":"Error 400: Invalid Phone Number","text":"<ul> <li>Verificar formato: <code>+[c\u00f3digo_pa\u00eds][n\u00famero]</code></li> <li>Ejemplo v\u00e1lido: <code>+56912345678</code></li> <li>Sin espacios ni guiones</li> </ul>"},{"location":"backend/whatsapp/#error-131026-message-undeliverable","title":"Error 131026: Message Undeliverable","text":"<ul> <li>N\u00famero no tiene WhatsApp activo</li> <li>Usuario bloque\u00f3 el n\u00famero empresarial</li> <li>N\u00famero inv\u00e1lido</li> </ul>"},{"location":"backend/whatsapp/#error-131047-re-engagement-message","title":"Error 131047: Re-engagement Message","text":"<ul> <li>Han pasado m\u00e1s de 24h desde \u00faltimo mensaje del usuario</li> <li>Usar templates pre-aprobados para reiniciar conversaci\u00f3n</li> </ul>"},{"location":"backend/whatsapp/#error-133016-service-temporarily-unavailable","title":"Error 133016: Service Temporarily Unavailable","text":"<ul> <li>Servidor de WhatsApp saturado</li> <li>Implementar retry con backoff exponencial</li> <li>Esperar 30-60 segundos antes de reintentar</li> </ul>"},{"location":"backend/whatsapp/#recursos-adicionales","title":"\ud83d\udcda Recursos Adicionales","text":"Enlaces \u00datiles <ul> <li>WhatsApp Business API Docs</li> <li>Cloud API Reference</li> <li>Message Templates</li> <li>Webhook Guide</li> <li>Error Codes</li> </ul>"},{"location":"backend/whatsapp/#ejemplo-completo","title":"\ud83d\udcdd Ejemplo Completo","text":"Implementaci\u00f3n Completa <pre><code># whatsapp_router.py\nfrom fastapi import APIRouter, Depends, HTTPException, Query, Request, Response\nfrom typing import Annotated, Optional, List\nfrom datetime import datetime, timedelta\nimport requests\n\nrouter = APIRouter(prefix=\"/api/whatsapp\", tags=[\"WhatsApp\"])\n\nclass WhatsAppService:\n    BASE_URL = \"https://graph.facebook.com/v18.0\"\n\n    def __init__(self):\n        self.token = WHATSAPP_API_TOKEN\n        self.phone_number_id = WHATSAPP_PHONE_NUMBER_ID\n        self.headers = {\n            \"Authorization\": f\"Bearer {self.token}\",\n            \"Content-Type\": \"application/json\"\n        }\n\n    def send_text(self, to: str, message: str) -&gt; dict:\n        url = f\"{self.BASE_URL}/{self.phone_number_id}/messages\"\n        payload = {\n            \"messaging_product\": \"whatsapp\",\n            \"to\": to,\n            \"type\": \"text\",\n            \"text\": {\"body\": message}\n        }\n        response = requests.post(url, json=payload, headers=self.headers)\n        response.raise_for_status()\n        return response.json()\n\n    def send_template(\n        self, \n        to: str, \n        template_name: str, \n        params: List[str]\n    ) -&gt; dict:\n        url = f\"{self.BASE_URL}/{self.phone_number_id}/messages\"\n        payload = {\n            \"messaging_product\": \"whatsapp\",\n            \"to\": to,\n            \"type\": \"template\",\n            \"template\": {\n                \"name\": template_name,\n                \"language\": {\"code\": \"es\"},\n                \"components\": [{\n                    \"type\": \"body\",\n                    \"parameters\": [\n                        {\"type\": \"text\", \"text\": p} for p in params\n                    ]\n                }]\n            }\n        }\n        response = requests.post(url, json=payload, headers=self.headers)\n        response.raise_for_status()\n        return response.json()\n\n# Usar el servicio\nwhatsapp = WhatsAppService()\n\n@router.post(\"/send\")\nasync def send_message(\n    sec: Annotated[str, Depends(security_scheme)],\n    phone: str,\n    message: str\n):\n    try:\n        result = whatsapp.send_text(to=phone, message=message)\n\n        # Guardar en DB\n        db_message = WhatsAppMessage(\n            message_id=result[\"messages\"][0][\"id\"],\n            phone=phone,\n            direction=\"outgoing\",\n            message_type=\"text\",\n            content=message,\n            status=\"sent\"\n        )\n        db.add(db_message)\n        db.commit()\n\n        return {\"status\": \"success\", \"result\": result}\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))\n</code></pre>"},{"location":"backend/bases_de_datos/copias_seguridad/","title":"\ud83d\udcda Copias de seguridad DB Azure","text":""},{"location":"backend/bases_de_datos/copias_seguridad/#creacion-y-restauracion-de-copias-de-seguridad-en-azure","title":"\ud83d\udcc4 Creaci\u00f3n y Restauraci\u00f3n de Copias de Seguridad en Azure","text":"Introducci\u00f3n <ul> <li>Esta documentaci\u00f3n describe el proceso de creaci\u00f3n y  restauraci\u00f3n de copias de seguridad en Azure para bases de datos SQL, incluyendo PITR (Point-in-Time Restore) y copias de seguridad a largo plazo (LTR).</li> </ul>"},{"location":"backend/bases_de_datos/copias_seguridad/#restaurar-db","title":"\ud83d\ude80 Restaurar DB","text":""},{"location":"backend/bases_de_datos/copias_seguridad/#1-creacion-de-copias-de-seguridad","title":"1\ufe0f\u20e3 Creaci\u00f3n de Copias de Seguridad","text":"Configuraci\u00f3n <p>1.1. Copias de seguridad autom\u00e1ticas:</p> <pre><code>- \u2705 Azure SQL Database realiza copias de seguridad de manera autom\u00e1tica sin intervenci\u00f3n manual.\n</code></pre> <p>1.2. Configurar la retenci\u00f3n de copias de seguridad:</p> <pre><code>- \u2705 Iniciar sesi\u00f3n en el portal de Azure: https://portal.azure.com\n- \u2705 Ir a Azure SQL Database y seleccionar la base de datos.\n- \u2705 En informacion general, ir a Propiedades.\n- \u2705 En Propiedades presionar \"Copias de seguridad\".\n- \u2705 Dentro de copias presionar \"Directivas de retenci\u00f3n\".\n- \u2705 Presionar \"Configurar directivas\" y ajustar la configuraci\u00f3n seg\u00fan lo que se necesite.\n</code></pre>"},{"location":"backend/bases_de_datos/copias_seguridad/#2-restauracion-de-copias-de-seguridad","title":"2\ufe0f\u20e3 Restauraci\u00f3n de Copias de Seguridad","text":"<ul> <li>Restauraci\u00f3n desde un punto en el tiempo (PITR)</li> </ul> M\u00e9todo ManualM\u00e9todo PowerShell <pre><code>- \u2705 Ir a Azure SQL Database y seleccionar la base de datos.\n- \u2705 En el men\u00fa superior, hacer clic en Restaurar.\n- \u2705 Elegir la fecha y la hora exacta del punto de restauraci\u00f3n.\n- \u2705 Definir un nuevo nombre para la base de datos restaurada.\n- \u2705 Confirmar y esperar la restauraci\u00f3n.\n</code></pre> <pre><code>Restore-AzSqlDatabase -FromPointInTimeBackup\n-ResourceGroupName \"MiGrupo\"\n-ServerName \"MiServidor\" \n-TargetDatabaseName \"MiBD_Restaurada\"\n-PointInTime \"2024-03-10T12:00:00Z\"\n</code></pre>"},{"location":"backend/bases_de_datos/copias_seguridad/#consideraciones-importantes","title":"\u2699\ufe0f Consideraciones Importantes","text":"<ul> <li>\u2705 Tiempo de restauraci\u00f3n: La restauraci\u00f3n puede tardar minutos u horas dependiendo del tama\u00f1o de la base de datos.</li> <li>\u2705 Restauraci\u00f3n en un nuevo nombre: La base restaurada siempre tendr\u00e1 un nombre diferente al original (renombrar nueva DB).</li> <li>\u2705 Renombrar la DB nueva y eliminar la antigua.</li> <li>\u2705Copias LTR y PITR: Si necesitas restaurar datos anteriores al rango de PITR, usa LTR.</li> </ul>"},{"location":"backend/bases_de_datos/copias_seguridad/#solucion-de-problemas","title":"\u26a0\ufe0f Soluci\u00f3n de Problemas","text":"Problemas Comunes Problema Soluci\u00f3n La restauraci\u00f3n lleva mucho tiempo o parece detenida. Las restauraciones de bases de datos grandes pueden tardar varias horas. Puedes ver el progreso en Portal de Azure \u2192 Monitorizaci\u00f3n. No puedo restaurar la base de datos por falta de permisos. Aseg\u00farate de tener el rol Owner o SQL DB Contributor en el recurso de Azure. La base restaurada no contiene los datos esperados. Revisa el punto de restauraci\u00f3n y selecciona otro m\u00e1s reciente. La opci\u00f3n de restauraci\u00f3n a un punto en el tiempo no aparece o no permite seleccionar una fecha. Verifica en Portal de Azure \u2192 Copia de seguridad si el punto de restauraci\u00f3n est\u00e1 disponible."},{"location":"backend/bases_de_datos/copias_seguridad/#recursos","title":"\ud83d\udcda Recursos","text":"Enlaces \u00datiles <ul> <li>Portal Azure</li> <li>Documentacion copias de seguridad</li> </ul>"},{"location":"backend/control-acceso/api-endpoints/","title":"\ud83d\udce1 API Endpoints - Documentaci\u00f3n Completa","text":""},{"location":"backend/control-acceso/api-endpoints/#descripcion-general","title":"\ud83d\udccb Descripci\u00f3n General","text":"<p>Documentaci\u00f3n detallada de todos los endpoints REST disponibles en la API de Control de Acceso.</p> <p>Base URL: <code>https://AzureDirection/appaccesocontrol</code></p>"},{"location":"backend/control-acceso/api-endpoints/#indice-de-endpoints","title":"\ud83d\udd0d \u00cdndice de Endpoints","text":"<pre><code>graph LR\n    API[API Control Acceso] --&gt; HEALTH[Health]\n    API --&gt; AUTH[Autenticaci\u00f3n]\n    API --&gt; PORTONES[Portones]\n    API --&gt; MQTT[MQTT/IoT]\n    API --&gt; INVITADOS[Invitados]\n\n    AUTH --&gt; LOGIN[POST /login]\n    AUTH --&gt; GUEST[POST /invitados/login]\n\n    PORTONES --&gt; GET_PORT[POST /portones]\n\n    MQTT --&gt; MQTT_TEST[POST /mqtt_test]\n\n    INVITADOS --&gt; CREATE[POST /invitados/crear]\n    INVITADOS --&gt; LIST[POST /invitados/listar]\n    INVITADOS --&gt; UPDATE[PUT /invitados/actualizar]\n\n    style AUTH fill:#FF6B6B\n    style MQTT fill:#660066\n    style INVITADOS fill:#90EE90</code></pre>"},{"location":"backend/control-acceso/api-endpoints/#health-check","title":"\ud83c\udfe5 Health Check","text":""},{"location":"backend/control-acceso/api-endpoints/#get-health","title":"GET /health","text":"<p>Verifica el estado del servidor.</p> <p>Autenticaci\u00f3n: No requerida</p> <p>Request: <pre><code>GET /appaccesocontrol/health HTTP/1.1\nHost: AzureDirection\n</code></pre></p> <p>Response (200 OK): <pre><code>{\n  \"status\": \"healthy\",\n  \"version\": \"3.5.3\"\n}\n</code></pre></p>"},{"location":"backend/control-acceso/api-endpoints/#autenticacion","title":"\ud83d\udd10 Autenticaci\u00f3n","text":""},{"location":"backend/control-acceso/api-endpoints/#post-login","title":"POST /login","text":"<p>Autenticaci\u00f3n de usuario normal con RUT/Email y contrase\u00f1a.</p> <p>Autenticaci\u00f3n: No requerida</p> <p>Request: <pre><code>POST /appaccesocontrol/login HTTP/1.1\nContent-Type: application/json\n\n{\n  \"rut_or_mail\": \"12345678-9\",\n  \"password\": \"micontrase\u00f1a\"\n}\n</code></pre></p> <p>Request Body:</p> Campo Tipo Requerido Descripci\u00f3n <code>rut_or_mail</code> string \u2705 RUT (12345678-9) o Email <code>password</code> string \u2705 Contrase\u00f1a <p>Response (200 OK): <pre><code>{\n  \"id\": 123,\n  \"nombre\": \"Juan\",\n  \"apellido\": \"P\u00e9rez\",\n  \"mail\": \"juan@example.com\",\n  \"rut\": \"12345678-9\",\n  \"admin\": true,\n  \"invitar\": true,\n  \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\"\n}\n</code></pre></p> <p>Response Body:</p> Campo Tipo Descripci\u00f3n <code>id</code> number ID del usuario <code>nombre</code> string Nombre <code>apellido</code> string Apellido <code>mail</code> string Email <code>rut</code> string RUT <code>admin</code> boolean Es administrador <code>invitar</code> boolean Puede crear invitados <code>access_token</code> string JWT token (v\u00e1lido 24h) <p>Errores:</p> <ul> <li>401 Unauthorized: Credenciales incorrectas <pre><code>{\n  \"detail\": \"Credenciales inv\u00e1lidas\"\n}\n</code></pre></li> </ul> <p>Ejemplo con curl: <pre><code>curl -X POST \\\n  https://AzureDirection/appaccesocontrol/login \\\n  -H 'Content-Type: application/json' \\\n  -d '{\n    \"rut_or_mail\": \"12345678-9\",\n    \"password\": \"micontrase\u00f1a\"\n  }'\n</code></pre></p>"},{"location":"backend/control-acceso/api-endpoints/#post-invitadoslogin","title":"POST /invitados/login","text":"<p>Autenticaci\u00f3n de invitado con c\u00f3digo temporal de 4 d\u00edgitos.</p> <p>Autenticaci\u00f3n: No requerida</p> <p>Request: <pre><code>POST /appaccesocontrol/invitados/login HTTP/1.1\nContent-Type: application/json\n\n{\n  \"CodigoAcceso\": \"1234\"\n}\n</code></pre></p> <p>Request Body:</p> Campo Tipo Requerido Descripci\u00f3n <code>CodigoAcceso</code> string \u2705 C\u00f3digo de 4 d\u00edgitos <p>Response (200 OK): <pre><code>{\n  \"IdInvitante\": 123,\n  \"Nombre\": \"Pedro\",\n  \"Apellido\": \"Gonz\u00e1lez\",\n  \"Mail\": \"pedro@empresa.com\",\n  \"FechaInicial\": \"2025-12-26T00:00:00Z\",\n  \"FechaFinal\": \"2025-12-31T23:59:59Z\",\n  \"Empresa\": \"Constructora ABC\",\n  \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\"\n}\n</code></pre></p> <p>Response Body:</p> Campo Tipo Descripci\u00f3n <code>IdInvitante</code> number ID del usuario que invit\u00f3 <code>Nombre</code> string Nombre del invitado <code>Apellido</code> string Apellido <code>Mail</code> string Email <code>FechaInicial</code> string Fecha inicio de acceso (ISO 8601) <code>FechaFinal</code> string Fecha fin de acceso (ISO 8601) <code>Empresa</code> string Empresa del invitado <code>access_token</code> string JWT token <p>Errores:</p> <ul> <li> <p>404 Not Found: C\u00f3digo no encontrado <pre><code>{\n  \"detail\": \"C\u00f3digo de acceso no encontrado\"\n}\n</code></pre></p> </li> <li> <p>403 Forbidden: C\u00f3digo ya usado <pre><code>{\n  \"detail\": \"Este c\u00f3digo ya ha sido utilizado. Solicita una nueva invitaci\u00f3n.\"\n}\n</code></pre></p> </li> <li> <p>403 Forbidden: C\u00f3digo expirado (m\u00e1s de 24h desde generaci\u00f3n) <pre><code>{\n  \"detail\": \"El c\u00f3digo ha expirado. Los c\u00f3digos son v\u00e1lidos por 24 horas desde su generaci\u00f3n.\"\n}\n</code></pre></p> </li> <li> <p>403 Forbidden: Fuera del rango de fechas <pre><code>{\n  \"detail\": \"El acceso a\u00fan no est\u00e1 disponible. V\u00e1lido desde 2025-12-26T00:00:00Z\"\n}\n</code></pre></p> </li> </ul> <p>Ejemplo con curl: <pre><code>curl -X POST \\\n  https://AzureDirection/appaccesocontrol/invitados/login \\\n  -H 'Content-Type: application/json' \\\n  -d '{\n    \"CodigoAcceso\": \"1234\"\n  }'\n</code></pre></p>"},{"location":"backend/control-acceso/api-endpoints/#portones","title":"\ud83d\udeaa Portones","text":""},{"location":"backend/control-acceso/api-endpoints/#post-portones","title":"POST /portones","text":"<p>Obtiene la lista de portones disponibles para el usuario autenticado.</p> <p>Autenticaci\u00f3n: JWT Bearer Token requerido</p> <p>Request: <pre><code>POST /appaccesocontrol/portones HTTP/1.1\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\nContent-Type: application/json\n</code></pre></p> <p>Headers:</p> Header Tipo Requerido Descripci\u00f3n <code>Authorization</code> string \u2705 Bearer <p>Response (200 OK): <pre><code>{\n  \"portones\": [\n    {\n      \"IdPorton\": 1,\n      \"NombrePorton\": \"Port\u00f3n Principal\",\n      \"IdShelly\": \"shellyplus1-a8032ab12345\",\n      \"MensajeApertura\": \"Abriendo port\u00f3n principal...\",\n      \"LatitudPorton\": -33.4569,\n      \"LongitudPorton\": -70.6483,\n      \"Distancia\": 300\n    },\n    {\n      \"IdPorton\": 2,\n      \"NombrePorton\": \"Port\u00f3n Estacionamiento\",\n      \"IdShelly\": \"shellyplus1-a8032ab67890\",\n      \"MensajeApertura\": \"Abriendo estacionamiento...\",\n      \"LatitudPorton\": -33.4580,\n      \"LongitudPorton\": -70.6490,\n      \"Distancia\": 300\n    }\n  ]\n}\n</code></pre></p> <p>Response Body:</p> Campo Tipo Descripci\u00f3n <code>portones</code> array Array de portones <code>portones[].IdPorton</code> number ID \u00fanico del port\u00f3n <code>portones[].NombrePorton</code> string Nombre descriptivo <code>portones[].IdShelly</code> string ID del dispositivo Shelly <code>portones[].MensajeApertura</code> string Mensaje al abrir <code>portones[].LatitudPorton</code> number Coordenada latitud <code>portones[].LongitudPorton</code> number Coordenada longitud <code>portones[].Distancia</code> number Radio en metros (300m) <p>Errores:</p> <ul> <li>401 Unauthorized: Token inv\u00e1lido <pre><code>{\n  \"detail\": \"Could not validate credentials\"\n}\n</code></pre></li> </ul> <p>Ejemplo con curl: <pre><code>curl -X POST \\\n  https://AzureDirection/appaccesocontrol/portones \\\n  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...' \\\n  -H 'Content-Type: application/json'\n</code></pre></p>"},{"location":"backend/control-acceso/api-endpoints/#mqtt-iot","title":"\ud83d\udd0c MQTT / IoT","text":""},{"location":"backend/control-acceso/api-endpoints/#post-mqtt_test","title":"POST /mqtt_test","text":"<p>Env\u00eda comandos MQTT a dispositivos Shelly para controlar portones.</p> <p>Autenticaci\u00f3n: API Key en header</p> <p>Request: <pre><code>POST /appaccesocontrol/mqtt_test HTTP/1.1\nContent-Type: application/json\nkey: tu-api-key-secreta\n\n{\n  \"Lugar\": \"shellyplus1-a8032ab12345\",\n  \"Comando\": \"open\",\n  \"Topico\": \"romana_porton_rss\"\n}\n</code></pre></p> <p>Headers:</p> Header Tipo Requerido Descripci\u00f3n <code>key</code> string \u2705 API Key (config.USERS_KEY) <p>Request Body:</p> Campo Tipo Requerido Descripci\u00f3n <code>Lugar</code> string \u2705 ID del dispositivo Shelly o nombre del lugar <code>Comando</code> string \u2705 Comando: <code>open</code>, <code>close</code> <code>Topico</code> string \u2705 Topic MQTT base (sin /rpc) <p>Comandos disponibles:</p> <ul> <li><code>open</code> - Activar rel\u00e9 (abrir port\u00f3n)</li> <li><code>close</code> - Desactivar rel\u00e9 (cerrar port\u00f3n)</li> </ul> <p>Lugares v\u00e1lidos:</p> <ul> <li><code>Porton Estacionamiento Romana</code> \u2192 Switch ID 0</li> <li><code>Porton Porter\u00eda (Salida)</code> \u2192 Switch ID 0</li> <li><code>Rodiluvio</code> \u2192 Switch ID 1</li> <li><code>Barrera Romana</code> \u2192 Switch ID 1</li> <li><code>Porton Agricola</code> \u2192 Switch ID 2</li> </ul> <p>Response (200 OK): <pre><code>{\n  \"message\": \"ok\",\n  \"lugar\": \"Porton Estacionamiento Romana\",\n  \"comando\": \"open\",\n  \"topic\": \"romana_porton_rss/rpc\",\n  \"acciones_ejecutadas\": [\n    {\n      \"switch_id\": 0,\n      \"on\": true,\n      \"status\": \"enviado\"\n    }\n  ]\n}\n</code></pre></p> <p>Response Body:</p> Campo Tipo Descripci\u00f3n <code>message</code> string Estado: \"ok\" o \"error\" <code>lugar</code> string Lugar recibido <code>comando</code> string Comando ejecutado <code>topic</code> string Topic MQTT usado <code>acciones_ejecutadas</code> array Acciones enviadas <p>Errores:</p> <ul> <li> <p>401 Unauthorized: Key inv\u00e1lida <pre><code>{\n  \"message\": \"error\",\n  \"error\": \"Key inv\u00e1lida\"\n}\n</code></pre></p> </li> <li> <p>400 Bad Request: Lugar no encontrado <pre><code>{\n  \"message\": \"error\",\n  \"error\": \"El porton Lugar Inexistente no fue encontrado:\"\n}\n</code></pre></p> </li> <li> <p>500 Internal Server Error: Error MQTT <pre><code>{\n  \"message\": \"error\",\n  \"error\": \"Error al enviar comandos MQTT: Connection refused\"\n}\n</code></pre></p> </li> </ul> <p>Payload MQTT generado: <pre><code>{\n  \"id\": 101,\n  \"src\": \"prueba-cli\",\n  \"method\": \"Switch.Set\",\n  \"params\": {\n    \"id\": 0,\n    \"on\": true\n  }\n}\n</code></pre></p> <p>Ejemplo con curl: <pre><code>curl -X POST \\\n  https://AzureDirection/appaccesocontrol/mqtt_test \\\n  -H 'Content-Type: application/json' \\\n  -H 'key: tu-api-key-secreta' \\\n  -d '{\n    \"Lugar\": \"Porton Estacionamiento Romana\",\n    \"Comando\": \"open\",\n    \"Topico\": \"romana_porton_rss\"\n  }'\n</code></pre></p>"},{"location":"backend/control-acceso/api-endpoints/#invitados","title":"\ud83d\udc65 Invitados","text":""},{"location":"backend/control-acceso/api-endpoints/#post-invitadoscrear","title":"POST /invitados/crear","text":"<p>Crea un nuevo invitado y genera un c\u00f3digo de acceso \u00fanico de 4 d\u00edgitos.</p> <p>Autenticaci\u00f3n: JWT Bearer Token (solo administradores)</p> <p>Request: <pre><code>POST /appaccesocontrol/invitados/crear HTTP/1.1\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\nContent-Type: application/json\n\n{\n  \"IdInvitante\": 123,\n  \"Rut\": \"11111111-1\",\n  \"Nombre\": \"Carlos\",\n  \"Apellido\": \"Silva\",\n  \"Telefono\": \"+56912345678\",\n  \"Mail\": \"carlos@empresa.com\",\n  \"FechaInicial\": \"2025-12-26T00:00:00Z\",\n  \"FechaFinal\": \"2025-12-31T23:59:59Z\",\n  \"Empresa\": \"Constructora ABC\",\n  \"Motivo\": \"Visita de obra\",\n  \"IdAcceso\": 1\n}\n</code></pre></p> <p>Request Body:</p> Campo Tipo Requerido Descripci\u00f3n <code>IdInvitante</code> number \u2705 ID del usuario que invita <code>Rut</code> string \u274c RUT del invitado <code>Nombre</code> string \u2705 Nombre <code>Apellido</code> string \u2705 Apellido <code>Telefono</code> string \u274c Tel\u00e9fono (+56912345678) <code>Mail</code> string \u2705 Email (debe ser v\u00e1lido) <code>FechaInicial</code> string \u2705 Fecha inicio (ISO 8601) <code>FechaFinal</code> string \u2705 Fecha fin (ISO 8601) <code>Empresa</code> string \u274c Empresa <code>Motivo</code> string \u274c Motivo de la visita <code>IdAcceso</code> number \u274c Tipo de acceso <p>Response (201 Created): <pre><code>{\n  \"message\": \"Invitado creado y c\u00f3digo enviado correctamente\",\n  \"invitado\": {\n    \"IdInvitante\": 123,\n    \"Rut\": \"11111111-1\",\n    \"Nombre\": \"Carlos\",\n    \"Apellido\": \"Silva\",\n    \"Telefono\": \"+56912345678\",\n    \"Mail\": \"carlos@empresa.com\",\n    \"CodigoAcceso\": \"5678\",\n    \"FechaInicial\": \"2025-12-26T00:00:00Z\",\n    \"FechaFinal\": \"2025-12-31T23:59:59Z\",\n    \"Empresa\": \"Constructora ABC\",\n    \"Motivo\": \"Visita de obra\",\n    \"IdAcceso\": 1\n  }\n}\n</code></pre></p> <p>Response Body:</p> Campo Tipo Descripci\u00f3n <code>message</code> string Mensaje de confirmaci\u00f3n <code>invitado</code> object Datos del invitado creado <code>invitado.CodigoAcceso</code> string C\u00f3digo de 4 d\u00edgitos generado <p>Comportamiento:</p> <ol> <li>Si el email ya existe, actualiza el invitado existente con un nuevo c\u00f3digo</li> <li>Genera c\u00f3digo \u00fanico de 4 d\u00edgitos</li> <li>Env\u00eda correo electr\u00f3nico con el c\u00f3digo al invitado</li> <li>El c\u00f3digo expira en 24 horas desde la generaci\u00f3n</li> </ol> <p>Errores:</p> <ul> <li>401 Unauthorized: Token inv\u00e1lido</li> <li>403 Forbidden: Usuario no es administrador</li> <li> <p>400 Bad Request: Email inv\u00e1lido <pre><code>{\n  \"detail\": \"Email inv\u00e1lido\"\n}\n</code></pre></p> </li> <li> <p>500 Internal Server Error: Error al crear <pre><code>{\n  \"detail\": \"Error al crear invitado: {mensaje}\"\n}\n</code></pre></p> </li> </ul> <p>Ejemplo con curl: <pre><code>curl -X POST \\\n  https://AzureDirection/appaccesocontrol/invitados/crear \\\n  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...' \\\n  -H 'Content-Type: application/json' \\\n  -d '{\n    \"IdInvitante\": 123,\n    \"Nombre\": \"Carlos\",\n    \"Apellido\": \"Silva\",\n    \"Mail\": \"carlos@empresa.com\",\n    \"FechaInicial\": \"2025-12-26T00:00:00Z\",\n    \"FechaFinal\": \"2025-12-31T23:59:59Z\"\n  }'\n</code></pre></p>"},{"location":"backend/control-acceso/api-endpoints/#post-invitadoslistar","title":"POST /invitados/listar","text":"<p>Lista todos los invitados registrados.</p> <p>Autenticaci\u00f3n: JWT Bearer Token (solo administradores)</p> <p>Request: <pre><code>POST /appaccesocontrol/invitados/listar HTTP/1.1\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\nContent-Type: application/json\n</code></pre></p> <p>Response (200 OK): <pre><code>{\n  \"invitados\": [\n    {\n      \"IdInvitante\": 123,\n      \"Rut\": \"11111111-1\",\n      \"Nombre\": \"Carlos\",\n      \"Apellido\": \"Silva\",\n      \"Telefono\": \"+56912345678\",\n      \"Mail\": \"carlos@empresa.com\",\n      \"FechaInicial\": \"2025-12-26T00:00:00Z\",\n      \"FechaFinal\": \"2025-12-31T23:59:59Z\",\n      \"Empresa\": \"Constructora ABC\",\n      \"Motivo\": \"Visita de obra\",\n      \"IdAcceso\": 1,\n      \"CodigoAcceso\": \"5678\",\n      \"DiaAcceso\": null\n    },\n    {\n      \"IdInvitante\": 123,\n      \"Rut\": \"22222222-2\",\n      \"Nombre\": \"Ana\",\n      \"Apellido\": \"Mart\u00ednez\",\n      \"Mail\": \"ana@empresa.com\",\n      \"FechaInicial\": \"2025-12-20T00:00:00Z\",\n      \"FechaFinal\": \"2025-12-25T23:59:59Z\",\n      \"CodigoAcceso\": \"1234\",\n      \"DiaAcceso\": \"2025-12-22T10:30:00Z\"\n    }\n  ]\n}\n</code></pre></p> <p>Errores:</p> <ul> <li>401 Unauthorized: Token inv\u00e1lido</li> <li>403 Forbidden: Usuario no es administrador</li> </ul>"},{"location":"backend/control-acceso/api-endpoints/#codigos-de-estado-http","title":"\ud83d\udcca C\u00f3digos de Estado HTTP","text":"C\u00f3digo Descripci\u00f3n Uso 200 OK Request exitoso 201 Created Recurso creado exitosamente 400 Bad Request Datos inv\u00e1lidos en el request 401 Unauthorized Token JWT inv\u00e1lido o faltante 403 Forbidden Sin permisos suficientes 404 Not Found Recurso no encontrado 500 Internal Server Error Error del servidor"},{"location":"backend/control-acceso/api-endpoints/#flujo-de-uso-tipico","title":"\ud83d\udd04 Flujo de Uso T\u00edpico","text":""},{"location":"backend/control-acceso/api-endpoints/#usuario-normal","title":"Usuario Normal","text":"<pre><code>sequenceDiagram\n    participant App as Mobile App\n    participant API as API Backend\n    participant DB as Database\n    participant MQTT as MQTT Broker\n    participant Shelly as Dispositivo Shelly\n\n    App-&gt;&gt;API: POST /login\n    API-&gt;&gt;DB: Validate credentials\n    DB--&gt;&gt;API: User data\n    API--&gt;&gt;App: JWT token\n\n    App-&gt;&gt;API: POST /portones\n    Note over App,API: Authorization: Bearer {token}\n    API-&gt;&gt;DB: Get user portones\n    DB--&gt;&gt;API: Portones list\n    API--&gt;&gt;App: Portones array\n\n    App-&gt;&gt;API: POST /mqtt_test\n    Note over App,API: key: {api-key}\n    API-&gt;&gt;MQTT: Publish Switch.Set\n    MQTT-&gt;&gt;Shelly: Command\n    Shelly--&gt;&gt;MQTT: ACK\n    API--&gt;&gt;App: Success</code></pre>"},{"location":"backend/control-acceso/api-endpoints/#administrador-crear-invitado","title":"Administrador - Crear Invitado","text":"<pre><code>sequenceDiagram\n    participant Admin as Admin App\n    participant API as API Backend\n    participant DB as Database\n    participant Mail as MS Graph API\n    participant Guest as Invitado\n\n    Admin-&gt;&gt;API: POST /login\n    API--&gt;&gt;Admin: JWT token (admin=true)\n\n    Admin-&gt;&gt;API: POST /invitados/crear\n    API-&gt;&gt;API: Generar c\u00f3digo 4 d\u00edgitos\n    API-&gt;&gt;DB: Insert AMInvitados\n    DB--&gt;&gt;API: ID created\n    API-&gt;&gt;Mail: Send email con c\u00f3digo\n    Mail-&gt;&gt;Guest: Email con c\u00f3digo\n    API--&gt;&gt;Admin: C\u00f3digo generado</code></pre>"},{"location":"backend/control-acceso/api-endpoints/#invitado","title":"Invitado","text":"<pre><code>sequenceDiagram\n    participant Guest as Invitado\n    participant App as Mobile App\n    participant API as API Backend\n    participant DB as Database\n\n    Guest-&gt;&gt;App: Ingresa c\u00f3digo 1234\n    App-&gt;&gt;API: POST /invitados/login\n    API-&gt;&gt;DB: Validate c\u00f3digo\n\n    alt C\u00f3digo v\u00e1lido\n        DB--&gt;&gt;API: Invitado data\n        API-&gt;&gt;API: Check fechas\n        API-&gt;&gt;DB: Marcar CodigoUsado=true\n        API--&gt;&gt;App: JWT token\n        App-&gt;&gt;API: POST /portones\n        API--&gt;&gt;App: Portones permitidos\n    else C\u00f3digo inv\u00e1lido\n        API--&gt;&gt;App: 404 Not Found\n    end</code></pre>"},{"location":"backend/control-acceso/api-endpoints/#proximos-pasos","title":"\ud83d\udcda Pr\u00f3ximos Pasos","text":"<ul> <li>Arquitectura</li> <li>Autenticaci\u00f3n y Seguridad</li> <li>Integraci\u00f3n MQTT</li> <li>Base de Datos</li> <li>Sistema de Invitados</li> </ul>"},{"location":"backend/control-acceso/arquitectura/","title":"\ud83c\udfd7\ufe0f Arquitectura del Backend","text":"Descripci\u00f3n General <p>Backend desarrollado como Azure Function con FastAPI que gestiona el control de acceso a portones mediante dispositivos IoT Shelly. Proporciona APIs REST para autenticaci\u00f3n, gesti\u00f3n de usuarios, control MQTT y sistema de invitados temporales.</p> Consideraciones de Arquitectura <ul> <li>Sistema serverless con Azure Functions</li> <li>Comunicaci\u00f3n IoT mediante MQTT</li> <li>Autenticaci\u00f3n JWT con tokens de 24 horas</li> <li>Base de datos SQL Server centralizada</li> </ul> Diagrama GeneralCapas del Sistema <pre><code>graph TB\n    subgraph \"Azure Cloud\"\n        subgraph \"Azure Functions\"\n            FUNC[Azure Function Handler]\n            FASTAPI[FastAPI Application]\n        end\n\n        subgraph \"Application Layer\"\n            ROUTERS[Routers]\n            SECURITY[Security Layer]\n            FUNCTIONS[Business Logic]\n        end\n\n        subgraph \"Data Layer\"\n            ORM[SQLAlchemy ORM]\n            MODELS[Data Models]\n        end\n\n        subgraph \"External Services\"\n            DB[(SQL Server)]\n            MQTT_BROKER[MQTT Broker]\n            GRAPH[Microsoft Graph API]\n        end\n    end\n\n    subgraph \"Clients\"\n        MOBILE[React Native App]\n        WEB[Web Clients]\n    end\n\n    MOBILE --&gt; FUNC\n    WEB --&gt; FUNC\n    FUNC --&gt; FASTAPI\n    FASTAPI --&gt; ROUTERS\n    ROUTERS --&gt; SECURITY\n    ROUTERS --&gt; FUNCTIONS\n    FUNCTIONS --&gt; ORM\n    ORM --&gt; MODELS\n    MODELS --&gt; DB\n    FUNCTIONS --&gt; MQTT_BROKER\n    FUNCTIONS --&gt; GRAPH\n\n    style FUNC fill:#0078D4\n    style FASTAPI fill:#009485\n    style DB fill:#CC2927\n    style MQTT_BROKER fill:#660066\n    style GRAPH fill:#00A4EF</code></pre>"},{"location":"backend/control-acceso/arquitectura/#arquitectura-en-capas","title":"Arquitectura en Capas","text":""},{"location":"backend/control-acceso/arquitectura/#1-capa-de-presentacion","title":"1. Capa de Presentaci\u00f3n","text":"<ul> <li>React Native App (m\u00f3vil)</li> <li>Web Clients</li> </ul>"},{"location":"backend/control-acceso/arquitectura/#2-capa-de-azure-functions","title":"2. Capa de Azure Functions","text":"<ul> <li>Azure Function Handler</li> <li>FastAPI Application</li> <li>ASGI Middleware</li> </ul>"},{"location":"backend/control-acceso/arquitectura/#3-capa-de-aplicacion","title":"3. Capa de Aplicaci\u00f3n","text":"<ul> <li>Routers (endpoints)</li> <li>Security Layer (JWT, Auth)</li> <li>Business Logic</li> </ul>"},{"location":"backend/control-acceso/arquitectura/#4-capa-de-datos","title":"4. Capa de Datos","text":"<ul> <li>SQLAlchemy ORM</li> <li>Data Models (Pydantic)</li> </ul>"},{"location":"backend/control-acceso/arquitectura/#5-servicios-externos","title":"5. Servicios Externos","text":"<ul> <li>SQL Server Database</li> <li>MQTT Broker (Shelly IoT)</li> <li>Microsoft Graph API (correos)</li> </ul>"},{"location":"backend/control-acceso/arquitectura/#stack-tecnologico","title":"\ud83c\udfaf Stack Tecnol\u00f3gico","text":"Backend FrameworkPersistencia y ORMSeguridad y Autenticaci\u00f3nComunicaci\u00f3n IoTServicios Externos Tecnolog\u00eda Versi\u00f3n Prop\u00f3sito Python 3.9+ Lenguaje de programaci\u00f3n FastAPI 0.104+ Framework web async Azure Functions v4 Serverless hosting Uvicorn Latest ASGI server Pydantic 2.0+ Validaci\u00f3n de datos Tecnolog\u00eda Versi\u00f3n Prop\u00f3sito SQLAlchemy 2.0+ ORM para bases de datos pyodbc 4.0+ Driver ODBC para SQL Server SQL Server 2019+ Base de datos principal Tecnolog\u00eda Versi\u00f3n Prop\u00f3sito python-jose 3.3+ Manejo de JWT passlib 1.7+ Hash de contrase\u00f1as (bcrypt) python-multipart 0.0.6+ Manejo de forms Tecnolog\u00eda Versi\u00f3n Prop\u00f3sito paho-mqtt 1.6+ Cliente MQTT requests 2.31+ HTTP client Servicio Prop\u00f3sito Microsoft Graph API Env\u00edo de correos MQTT Broker Comunicaci\u00f3n con dispositivos Shelly"},{"location":"backend/control-acceso/arquitectura/#estructura-del-proyecto","title":"\ud83d\udcc2 Estructura del Proyecto","text":"\u00c1rbol de Directorios <pre><code>AppControlAcceso/\n\u251c\u2500\u2500 __init__.py                    # FastAPI app + Azure Function handler\n\u251c\u2500\u2500 function.json                  # Configuraci\u00f3n Azure Functions\n\u2502\n\u251c\u2500\u2500 config/                        # Configuraci\u00f3n\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 config.py                 # Variables de entorno\n\u2502   \u251c\u2500\u2500 security.py               # JWT, autenticaci\u00f3n, login\n\u2502   \u251c\u2500\u2500 users.py                  # Gesti\u00f3n de usuarios\n\u2502   \u2514\u2500\u2500 health.py                 # Health check endpoint\n\u2502\n\u251c\u2500\u2500 routes/                        # Routers de FastAPI\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 portones.py               # CRUD de portones\n\u2502   \u251c\u2500\u2500 mqtt.py                   # Control MQTT de dispositivos\n\u2502   \u2514\u2500\u2500 invitados.py              # CRUD de invitados\n\u2502\n\u251c\u2500\u2500 functions/                     # L\u00f3gica de negocio\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 invitados.py              # Generaci\u00f3n de c\u00f3digos\n\u2502   \u2514\u2500\u2500 mails.py                  # Env\u00edo de correos\n\u2502\n\u251c\u2500\u2500 schemas/                       # Pydantic schemas\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 login_schema.py           # Request/Response de login\n\u2502   \u251c\u2500\u2500 invitados_schema.py       # Request/Response de invitados\n\u2502   \u251c\u2500\u2500 mqtt_schema.py            # Request/Response de MQTT\n\u2502   \u2514\u2500\u2500 security_schema.py        # Token models\n\u2502\n\u251c\u2500\u2500 sql/                           # Scripts SQL\n\u2502   \u2514\u2500\u2500 *.sql\n\u2502\n\u2514\u2500\u2500 tests/                         # Tests unitarios\n    \u2514\u2500\u2500 *.py\n</code></pre>"},{"location":"backend/control-acceso/arquitectura/#flujo-de-request","title":"\ud83d\udd04 Flujo de Request","text":"<pre><code>sequenceDiagram\n    participant C as Client\n    participant AF as Azure Function\n    participant FA as FastAPI\n    participant M as Middleware\n    participant R as Router\n    participant S as Security\n    participant BL as Business Logic\n    participant ORM as SQLAlchemy\n    participant DB as SQL Server\n\n    C-&gt;&gt;AF: HTTP Request\n    AF-&gt;&gt;FA: AsgiMiddleware\n    FA-&gt;&gt;M: Process middleware\n    M-&gt;&gt;R: Route to endpoint\n\n    alt Endpoint protegido\n        R-&gt;&gt;S: Validate JWT\n        S-&gt;&gt;S: decode_jwt()\n        alt Token inv\u00e1lido\n            S--&gt;&gt;C: 401 Unauthorized\n        end\n    end\n\n    R-&gt;&gt;BL: Execute business logic\n    BL-&gt;&gt;ORM: Query data\n    ORM-&gt;&gt;DB: SQL Query\n    DB--&gt;&gt;ORM: Result set\n    ORM--&gt;&gt;BL: Python objects\n    BL--&gt;&gt;R: Processed data\n    R--&gt;&gt;FA: JSONResponse\n    FA--&gt;&gt;AF: ASGI response\n    AF--&gt;&gt;C: HTTP Response</code></pre>"},{"location":"backend/control-acceso/arquitectura/#inicializacion-de-la-aplicacion","title":"\ud83d\ude80 Inicializaci\u00f3n de la Aplicaci\u00f3n","text":""},{"location":"backend/control-acceso/arquitectura/#main-handler-initpy","title":"main handler (init.py)","text":"<pre><code>from fastapi import FastAPI\nfrom .config.health import router as health_router\nfrom .config.security import router as security_router\nfrom .config.users import router as users_router\nfrom .routes.portones import router as portones_router\nfrom .routes.mqtt import router as mqtt_router\nfrom .routes.invitados import router as invitados_router\nfrom .config import config\nimport azure.functions as func\nimport logging\n\n# Crear aplicaci\u00f3n FastAPI\napp = FastAPI(\n    title=config.PROJECT_NAME,\n    description=config.PROJECT_DESCRIPTION,\n    version=config.PROJECT_VERSION,\n    docs_url=f\"{config.APP_PATH}/docs\",\n    redoc_url=f\"{config.APP_PATH}/redoc\",\n    openapi_url=f'{config.APP_PATH}/openapi.json',\n)\n\n# Incluir routers\napp.include_router(health_router)      # /health\napp.include_router(security_router)    # /login\napp.include_router(users_router)       # /users/*\napp.include_router(portones_router)    # /portones\napp.include_router(mqtt_router)        # /mqtt_test\napp.include_router(invitados_router)   # /invitados/*\n\n# Azure Function handler\nasync def main(req: func.HttpRequest, context: func.Context) -&gt; func.HttpResponse:\n    \"\"\"\n    Handler principal de Azure Functions.\n    Delega todas las peticiones a FastAPI mediante AsgiMiddleware.\n    \"\"\"\n    logging.info(\"Python HTTP trigger function processed a request.\")\n    return await func.AsgiMiddleware(app).handle_async(req, context)\n</code></pre>"},{"location":"backend/control-acceso/arquitectura/#configuration-functionjson","title":"Configuration (function.json)","text":"<pre><code>{\n  \"scriptFile\": \"__init__.py\",\n  \"bindings\": [\n    {\n      \"authLevel\": \"anonymous\",\n      \"type\": \"httpTrigger\",\n      \"direction\": \"in\",\n      \"name\": \"req\",\n      \"methods\": [\"get\", \"post\"],\n      \"route\": \"/appaccesocontrol/{*route}\"\n    },\n    {\n      \"type\": \"http\",\n      \"direction\": \"out\",\n      \"name\": \"$return\"\n    }\n  ]\n}\n</code></pre>"},{"location":"backend/control-acceso/arquitectura/#variables-de-entorno","title":"\u2699\ufe0f Variables de Entorno","text":""},{"location":"backend/control-acceso/arquitectura/#configconfigpy","title":"config/config.py","text":"<pre><code>import os\n\n# Informaci\u00f3n del proyecto\nPROJECT_NAME = \"AppControlAcceso\"\nPROJECT_DESCRIPTION = \"API para control de acceso\"\nPROJECT_VERSION = \"3.5.3\"\nPROJECT_AUTHOR = \"Tracmin\"\n\n# Configuraci\u00f3n de la aplicaci\u00f3n\nAPP_PATH = \"/appaccesocontrol\"\nUSERS_KEY = os.environ[\"USERS_KEY\"]\n\n# Documentaci\u00f3n API\nDOCS_URL = \"/docs\"\nREDOC_URL = \"/redoc\"\nOPENAPI_URL = \"/openapi.json\"\n\n# Seguridad\nSECRET_KEY = os.environ[\"HASH_KEY\"]\nALGORITHM = \"HS256\"\nACCESS_TOKEN_EXPIRE_MINUTES = 1440  # 24 horas\n\n# MQTT\nMQTT_BROKER = os.environ[\"MQTT_BROKER\"]\nMQTT_PORT = int(os.environ.get(\"MQTT_PORT\", \"8883\"))\nMQTT_USER_ACCESO = os.environ[\"MQTT_USER_ACCESO\"]\nMQTT_PASS_ACCESO = os.environ[\"MQTT_PASS_ACCESO\"]\nMQTT_API_KEY = os.environ[\"MQTT_API_KEY\"]\n\n# Microsoft Graph (para env\u00edo de correos)\nGRAPH_CLIENT_ID = os.environ[\"GRAPH_CLIENT_ID\"]\nGRAPH_CLIENT_SECRET = os.environ[\"GRAPH_CLIENT_SECRET\"]\nGRAPH_TENANT_ID = os.environ[\"GRAPH_TENANT_ID\"]\n</code></pre>"},{"location":"backend/control-acceso/arquitectura/#variables-requeridas-en-azure","title":"Variables requeridas en Azure","text":"<pre><code># Seguridad\nHASH_KEY=\"tu-secret-key-para-jwt\"\nUSERS_KEY=\"api-key-para-endpoints-protegidos\"\n\n# Base de datos\nSQL_SERVER=\"tu-servidor.database.windows.net\"\nSQL_DATABASE=\"ElAltoDB\"\nSQL_USERNAME=\"usuario\"\nSQL_PASSWORD=\"contrase\u00f1a\"\n\n# MQTT\nMQTT_BROKER=\"mqtt.broker.com\"\nMQTT_PORT=\"8883\"\nMQTT_USER_ACCESO=\"usuario-mqtt\"\nMQTT_PASS_ACCESO=\"password-mqtt\"\nMQTT_API_KEY=\"key-para-endpoint-mqtt\"\n\n# Microsoft Graph\nGRAPH_CLIENT_ID=\"client-id\"\nGRAPH_CLIENT_SECRET=\"client-secret\"\nGRAPH_TENANT_ID=\"tenant-id\"\n</code></pre>"},{"location":"backend/control-acceso/arquitectura/#routers-de-fastapi","title":"\ud83d\udd0c Routers de FastAPI","text":""},{"location":"backend/control-acceso/arquitectura/#estructura-de-routers","title":"Estructura de Routers","text":"<pre><code>graph LR\n    APP[FastAPI App] --&gt; HEALTH[Health Router]\n    APP --&gt; SECURITY[Security Router]\n    APP --&gt; USERS[Users Router]\n    APP --&gt; PORTONES[Portones Router]\n    APP --&gt; MQTT[MQTT Router]\n    APP --&gt; INVITADOS[Invitados Router]\n\n    SECURITY --&gt; LOGIN[POST /login]\n    SECURITY --&gt; GUEST_LOGIN[POST /invitados/login]\n\n    PORTONES --&gt; GET_PORTONES[POST /portones]\n\n    MQTT --&gt; MQTT_TEST[POST /mqtt_test]\n\n    INVITADOS --&gt; CREATE[POST /invitados/crear]\n    INVITADOS --&gt; LIST[POST /invitados/listar]\n    INVITADOS --&gt; UPDATE[PUT /invitados/actualizar]\n\n    style APP fill:#009485\n    style SECURITY fill:#FF6B6B\n    style MQTT fill:#660066</code></pre>"},{"location":"backend/control-acceso/arquitectura/#detalle-de-routers","title":"Detalle de Routers","text":""},{"location":"backend/control-acceso/arquitectura/#1-health-router","title":"1. Health Router","text":"<pre><code>@router.get(\"/health\")\nasync def health_check():\n    return {\"status\": \"healthy\", \"version\": \"3.5.3\"}\n</code></pre>"},{"location":"backend/control-acceso/arquitectura/#2-security-router","title":"2. Security Router","text":"<ul> <li><code>POST /login</code> - Autenticaci\u00f3n de usuario normal</li> <li><code>POST /invitados/login</code> - Autenticaci\u00f3n de invitado con c\u00f3digo</li> </ul>"},{"location":"backend/control-acceso/arquitectura/#3-portones-router","title":"3. Portones Router","text":"<ul> <li><code>POST /portones</code> - Obtener lista de portones del usuario</li> </ul>"},{"location":"backend/control-acceso/arquitectura/#4-mqtt-router","title":"4. MQTT Router","text":"<ul> <li><code>POST /mqtt_test</code> - Enviar comando MQTT a dispositivo Shelly</li> </ul>"},{"location":"backend/control-acceso/arquitectura/#5-invitados-router","title":"5. Invitados Router","text":"<ul> <li><code>POST /invitados/crear</code> - Crear nuevo invitado</li> <li><code>POST /invitados/listar</code> - Listar todos los invitados</li> <li><code>PUT /invitados/actualizar</code> - Actualizar invitado existente</li> </ul>"},{"location":"backend/control-acceso/arquitectura/#capa-de-datos","title":"\ud83d\uddc4\ufe0f Capa de Datos","text":""},{"location":"backend/control-acceso/arquitectura/#modelos-sqlalchemy","title":"Modelos SQLAlchemy","text":"<pre><code>erDiagram\n    AMUsuario ||--o{ UsuariosPortones : \"tiene acceso\"\n    AMPortones ||--o{ UsuariosPortones : \"es accedido por\"\n    AMInvitados ||--o{ PortonesInvitados : \"puede acceder\"\n    AMPortones ||--o{ PortonesInvitados : \"permite\"\n\n    AMUsuario {\n        int Id PK\n        string Rut\n        string Nombre\n        string Apellido\n        string Mail\n        string Contrasena\n        bool Admin\n        bool Invitar\n    }\n\n    AMPortones {\n        int IdPorton PK\n        string NombrePorton\n        string IdShelly\n        string MensajeApertura\n        float LatitudPorton\n        float LongitudPorton\n        int Distancia\n    }\n\n    AMInvitados {\n        int Id PK\n        int IdInvitante FK\n        string Rut\n        string Nombre\n        string Apellido\n        string Telefono\n        string Mail\n        datetime FechaInicial\n        datetime FechaFinal\n        string Empresa\n        string Motivo\n        string CodigoAcceso\n        datetime FechaGeneracionCodigo\n        bool CodigoUsado\n        datetime DiaAcceso\n    }\n\n    UsuariosPortones {\n        int Id PK\n        int IdUsuario FK\n        int IdPorton FK\n    }\n\n    PortonesInvitados {\n        int Id PK\n        int IdInvitado FK\n        int IdPorton FK\n    }</code></pre>"},{"location":"backend/control-acceso/arquitectura/#database-engine","title":"Database Engine","text":"<pre><code># utils/db_engine_sql.py\nfrom sqlalchemy import create_engine\nfrom sqlalchemy.orm import sessionmaker\nimport os\n\ndef get_el_alto():\n    \"\"\"Obtiene el engine de la base de datos ElAltoDB\"\"\"\n    connection_string = (\n        f\"mssql+pyodbc://{os.environ['SQL_USERNAME']}:\"\n        f\"{os.environ['SQL_PASSWORD']}@\"\n        f\"{os.environ['SQL_SERVER']}/\"\n        f\"{os.environ['SQL_DATABASE']}?\"\n        f\"driver=ODBC+Driver+18+for+SQL+Server\"\n    )\n    return create_engine(connection_string)\n</code></pre>"},{"location":"backend/control-acceso/arquitectura/#capas-de-seguridad","title":"\ud83d\udd12 Capas de Seguridad","text":"Diagrama de SeguridadNiveles de Seguridad <pre><code>graph TB\n    REQUEST[HTTP Request] --&gt; LAYER1[1. Azure Functions Auth]\n    LAYER1 --&gt; LAYER2[2. API Route]\n    LAYER2 --&gt; LAYER3[3. JWT Validation]\n    LAYER3 --&gt; LAYER4[4. Admin Check]\n    LAYER4 --&gt; LAYER5[5. Business Logic]\n    LAYER5 --&gt; RESPONSE[Response]\n\n    LAYER1 -.anonymous.-&gt; LAYER2\n    LAYER3 -.Bearer Token.-&gt; LAYER4\n    LAYER4 -.admin flag.-&gt; LAYER5\n\n    style LAYER1 fill:#FFE5B4\n    style LAYER3 fill:#FFB6B6\n    style LAYER4 fill:#FF6B6B</code></pre>"},{"location":"backend/control-acceso/arquitectura/#1-azure-functions","title":"1. Azure Functions","text":"<p><code>authLevel: \"anonymous\"</code> - Permite acceso directo sin autenticaci\u00f3n de Azure</p>"},{"location":"backend/control-acceso/arquitectura/#2-fastapi-routes","title":"2. FastAPI Routes","text":"<ul> <li>Rutas p\u00fablicas: <code>/health</code>, <code>/login</code></li> <li>Rutas protegidas: Requieren JWT v\u00e1lido</li> </ul>"},{"location":"backend/control-acceso/arquitectura/#3-jwt-validation","title":"3. JWT Validation","text":"<p><code>Depends(security_scheme)</code> - Valida token Bearer en headers</p> Ejemplo de Validaci\u00f3n <pre><code>from fastapi import Depends, HTTPException\nfrom fastapi.security import HTTPBearer\n\nsecurity_scheme = HTTPBearer()\n\nasync def validate_token(token: str = Depends(security_scheme)):\n    if not decode_jwt(token):\n        raise HTTPException(status_code=401)\n    return token\n</code></pre>"},{"location":"backend/control-acceso/arquitectura/#4-admin-check","title":"4. Admin Check","text":"<p><code>decode_jwt(token, admin=1)</code> - Verifica permisos administrativos</p>"},{"location":"backend/control-acceso/arquitectura/#5-business-logic","title":"5. Business Logic","text":"<p>Validaci\u00f3n de datos y reglas de negocio espec\u00edficas</p>"},{"location":"backend/control-acceso/arquitectura/#flujo-de-datos-completo","title":"\ud83d\udcca Flujo de Datos Completo","text":"<pre><code>graph LR\n    subgraph \"Mobile App\"\n        UI[UI Components]\n        API_CLIENT[API Client]\n    end\n\n    subgraph \"Azure Function\"\n        HANDLER[Function Handler]\n        FASTAPI[FastAPI App]\n        ROUTER[Router]\n    end\n\n    subgraph \"Services\"\n        AUTH[Auth Service]\n        BUSINESS[Business Logic]\n        MQTT_CLIENT[MQTT Client]\n        MAIL[Mail Service]\n    end\n\n    subgraph \"External\"\n        DB[(SQL Server)]\n        BROKER[MQTT Broker]\n        SHELLY[Shelly Device]\n        GRAPH[MS Graph]\n    end\n\n    UI --&gt; API_CLIENT\n    API_CLIENT --&gt;|HTTPS| HANDLER\n    HANDLER --&gt; FASTAPI\n    FASTAPI --&gt; ROUTER\n    ROUTER --&gt; AUTH\n    AUTH --&gt; BUSINESS\n    BUSINESS --&gt; DB\n    BUSINESS --&gt; MQTT_CLIENT\n    BUSINESS --&gt; MAIL\n    MQTT_CLIENT --&gt; BROKER\n    BROKER --&gt; SHELLY\n    MAIL --&gt; GRAPH\n\n    style FASTAPI fill:#009485\n    style DB fill:#CC2927\n    style BROKER fill:#660066\n    style SHELLY fill:#00A8E1</code></pre>"},{"location":"backend/control-acceso/arquitectura/#estados-de-la-aplicacion","title":"\ud83d\udea6 Estados de la Aplicaci\u00f3n","text":""},{"location":"backend/control-acceso/arquitectura/#estado-de-servidor","title":"Estado de Servidor","text":"<pre><code>from enum import Enum\n\nclass ServerStatus(str, Enum):\n    HEALTHY = \"healthy\"\n    DEGRADED = \"degraded\"\n    UNHEALTHY = \"unhealthy\"\n\nclass DatabaseStatus(str, Enum):\n    CONNECTED = \"connected\"\n    DISCONNECTED = \"disconnected\"\n    ERROR = \"error\"\n\nclass MqttStatus(str, Enum):\n    CONNECTED = \"connected\"\n    DISCONNECTED = \"disconnected\"\n    PUBLISHING = \"publishing\"\n    ERROR = \"error\"\n</code></pre>"},{"location":"backend/control-acceso/arquitectura/#escalabilidad","title":"\ud83d\udcc8 Escalabilidad","text":"Diagrama de EscalabilidadCaracter\u00edsticas <pre><code>graph TB\n    subgraph \"Azure Functions\"\n        F1[Instance 1]\n        F2[Instance 2]\n        FN[Instance N]\n    end\n\n    subgraph \"Shared Resources\"\n        DB[(SQL Server)]\n        MQTT[MQTT Broker]\n    end\n\n    LB[Azure Load Balancer] --&gt; F1\n    LB --&gt; F2\n    LB --&gt; FN\n\n    F1 --&gt; DB\n    F2 --&gt; DB\n    FN --&gt; DB\n\n    F1 --&gt; MQTT\n    F2 --&gt; MQTT\n    FN --&gt; MQTT\n\n    style LB fill:#0078D4\n    style DB fill:#CC2927\n    style MQTT fill:#660066</code></pre>"},{"location":"backend/control-acceso/arquitectura/#ventajas-implementadas","title":"Ventajas Implementadas","text":"<p>\u2705 Stateless - Sin estado en memoria - Todo persiste en base de datos - F\u00e1cil escalado horizontal</p> <p>\u2705 Auto-scaling - Azure Functions escala autom\u00e1ticamente - Basado en demanda de requests - Sin configuraci\u00f3n manual</p> <p>\u2705 Connection Pooling - SQLAlchemy maneja pool de conexiones - Reutilizaci\u00f3n eficiente de conexiones - Reducci\u00f3n de overhead</p> <p>\u2705 MQTT Async - Conexiones MQTT son r\u00e1pidas - Desconexi\u00f3n inmediata post-publicaci\u00f3n - No bloquea recursos</p>"},{"location":"backend/control-acceso/arquitectura/#mejoras-sugeridas","title":"Mejoras Sugeridas","text":"<p>\u26a0\ufe0f Rate Limiting - No implementado actualmente - Considerar para producci\u00f3n - Prevenir abuso de API</p> <p>\u26a0\ufe0f Caching - No implementado - Considerar Redis para queries frecuentes - Reducir carga en base de datos</p>"},{"location":"backend/control-acceso/arquitectura/#deployment","title":"\ud83d\udee0\ufe0f Deployment","text":"RequisitosAzure FunctionsVariables de Entorno requirements.txt <pre><code>fastapi==0.104.1\nuvicorn[standard]==0.24.0\nazure-functions==1.17.0\nsqlalchemy==2.0.23\npyodbc==5.0.1\npython-jose[cryptography]==3.3.0\npasslib[bcrypt]==1.7.4\npaho-mqtt==1.6.1\npydantic==2.5.0\npython-multipart==0.0.6\nrequests==2.31.0\n</code></pre>"},{"location":"backend/control-acceso/arquitectura/#publicar-a-azure","title":"Publicar a Azure","text":"<pre><code># Publicar funci\u00f3n\nfunc azure functionapp publish &lt;nombre-function-app&gt;\n\n# Con configuraci\u00f3n espec\u00edfica\nfunc azure functionapp publish &lt;nombre-function-app&gt; \\\n  --python \\\n  --build remote\n</code></pre> Prerequisitos <ul> <li>Azure Functions Core Tools instalado</li> <li>Azure CLI autenticado</li> <li>Function App creada en Azure Portal</li> </ul>"},{"location":"backend/control-acceso/arquitectura/#configuracion-en-azure-portal","title":"Configuraci\u00f3n en Azure Portal","text":"<p>Ruta: Function App &gt; Configuration &gt; Application Settings</p> Variable Descripci\u00f3n <code>HASH_KEY</code> Secret key para JWT <code>USERS_KEY</code> API key para endpoints protegidos <code>SQL_SERVER</code> Servidor SQL Server <code>SQL_DATABASE</code> Nombre base de datos (ElAltoDB) <code>SQL_USERNAME</code> Usuario base de datos <code>SQL_PASSWORD</code> Contrase\u00f1a base de datos <code>MQTT_BROKER</code> URL broker MQTT <code>MQTT_PORT</code> Puerto broker (8883) <code>MQTT_USER_ACCESO</code> Usuario MQTT <code>MQTT_PASS_ACCESO</code> Contrase\u00f1a MQTT <code>MQTT_API_KEY</code> API key endpoint MQTT <code>GRAPH_CLIENT_ID</code> Client ID Microsoft Graph <code>GRAPH_CLIENT_SECRET</code> Client Secret Microsoft Graph <code>GRAPH_TENANT_ID</code> Tenant ID Microsoft Graph Ejemplo de Configuraci\u00f3n Local <pre><code># local.settings.json\n{\n  \"IsEncrypted\": false,\n  \"Values\": {\n    \"AzureWebJobsStorage\": \"\",\n    \"FUNCTIONS_WORKER_RUNTIME\": \"python\",\n    \"HASH_KEY\": \"tu-secret-key\",\n    \"USERS_KEY\": \"api-key\",\n    \"SQL_SERVER\": \"servidor.database.windows.net\",\n    \"SQL_DATABASE\": \"ElAltoDB\",\n    \"SQL_USERNAME\": \"usuario\",\n    \"SQL_PASSWORD\": \"password\",\n    \"MQTT_BROKER\": \"mqtt.broker.com\",\n    \"MQTT_PORT\": \"8883\",\n    \"MQTT_USER_ACCESO\": \"usuario-mqtt\",\n    \"MQTT_PASS_ACCESO\": \"password-mqtt\",\n    \"MQTT_API_KEY\": \"key-mqtt\",\n    \"GRAPH_CLIENT_ID\": \"client-id\",\n    \"GRAPH_CLIENT_SECRET\": \"client-secret\",\n    \"GRAPH_TENANT_ID\": \"tenant-id\"\n  }\n}\n</code></pre>"},{"location":"backend/control-acceso/arquitectura/#referencias","title":"Referencias","text":"Documentaci\u00f3n Relacionada <ul> <li>Autenticaci\u00f3n y Seguridad - Sistema de JWT y permisos</li> <li>API Endpoints - Referencia completa de APIs</li> <li>Integraci\u00f3n MQTT - Control de dispositivos IoT</li> <li>Base de Datos - Modelos y schemas</li> <li>Sistema de Invitados - Gesti\u00f3n de accesos temporales</li> </ul>"},{"location":"backend/control-acceso/autenticacion/","title":"\ud83d\udd10 Autenticaci\u00f3n y Seguridad","text":""},{"location":"backend/control-acceso/autenticacion/#descripcion-general","title":"\ud83d\udccb Descripci\u00f3n General","text":"<p>Sistema de autenticaci\u00f3n basado en JWT (JSON Web Tokens) con soporte para dos tipos de usuarios: - Usuarios normales: Autenticaci\u00f3n con RUT/Email + contrase\u00f1a - Invitados: Autenticaci\u00f3n con c\u00f3digo temporal de 4 d\u00edgitos</p> <pre><code>graph TB\n    subgraph \"Tipos de Autenticaci\u00f3n\"\n        USER_AUTH[Usuario Normal]\n        GUEST_AUTH[Invitado]\n    end\n\n    subgraph \"Validaci\u00f3n\"\n        VALIDATE_CREDS[Validar Credenciales]\n        VALIDATE_CODE[Validar C\u00f3digo]\n    end\n\n    subgraph \"Base de Datos\"\n        USER_DB[(AMUsuario)]\n        GUEST_DB[(AMInvitados)]\n    end\n\n    subgraph \"Generaci\u00f3n Token\"\n        CREATE_JWT[Crear JWT]\n    end\n\n    subgraph \"Response\"\n        TOKEN[Access Token]\n        USER_DATA[User Data]\n    end\n\n    USER_AUTH --&gt; VALIDATE_CREDS\n    GUEST_AUTH --&gt; VALIDATE_CODE\n\n    VALIDATE_CREDS --&gt; USER_DB\n    VALIDATE_CODE --&gt; GUEST_DB\n\n    USER_DB --&gt; CREATE_JWT\n    GUEST_DB --&gt; CREATE_JWT\n\n    CREATE_JWT --&gt; TOKEN\n    CREATE_JWT --&gt; USER_DATA\n\n    style USER_AUTH fill:#4A90E2\n    style GUEST_AUTH fill:#90EE90\n    style CREATE_JWT fill:#FF6B6B\n    style TOKEN fill:#FFD700</code></pre>"},{"location":"backend/control-acceso/autenticacion/#jwt-json-web-tokens","title":"\ud83d\udd11 JWT (JSON Web Tokens)","text":""},{"location":"backend/control-acceso/autenticacion/#configuracion-jwt","title":"Configuraci\u00f3n JWT","text":"<pre><code># config/config.py\nSECRET_KEY = os.environ[\"HASH_KEY\"]\nALGORITHM = \"HS256\"\nACCESS_TOKEN_EXPIRE_MINUTES = 1440  # 24 horas\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#estructura-del-token","title":"Estructura del Token","text":"<pre><code>{\n  \"header\": {\n    \"alg\": \"HS256\",\n    \"typ\": \"JWT\"\n  },\n  \"payload\": {\n    \"nombre\": \"Juan P\u00e9rez\",\n    \"admin\": 1,\n    \"invitar\": 1,\n    \"exp\": 1735430400,\n    \"iat\": 1735344000\n  },\n  \"signature\": \"...\"\n}\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#payload-para-usuario-normal","title":"Payload para Usuario Normal","text":"<pre><code>payload = {\n    \"nombre\": \"Juan P\u00e9rez\",      # Nombre completo\n    \"admin\": 1,                   # 1 = Admin, 0 = User normal\n    \"invitar\": 1,                 # 1 = Puede invitar, 0 = No puede\n    \"exp\": 1735430400,            # Timestamp de expiraci\u00f3n\n    \"iat\": 1735344000             # Timestamp de emisi\u00f3n\n}\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#payload-para-invitado","title":"Payload para Invitado","text":"<pre><code>payload = {\n    \"codigo\": \"1234\",             # C\u00f3digo de acceso\n    \"tipo\": \"invitado\",           # Tipo de usuario\n    \"exp\": 1735430400,            # Timestamp de expiraci\u00f3n\n    \"iat\": 1735344000             # Timestamp de emisi\u00f3n\n}\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#hash-de-contrasenas","title":"\ud83d\udd10 Hash de Contrase\u00f1as","text":""},{"location":"backend/control-acceso/autenticacion/#configuracion-de-bcrypt","title":"Configuraci\u00f3n de Bcrypt","text":"<pre><code>from passlib.context import CryptContext\n\npwd_context = CryptContext(schemes=[\"bcrypt\"], deprecated=\"auto\")\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#funciones-de-hash","title":"Funciones de Hash","text":"<pre><code>def get_password_hash(password: str) -&gt; str:\n    \"\"\"\n    Genera un hash bcrypt de la contrase\u00f1a.\n\n    Args:\n        password: Contrase\u00f1a en texto plano\n\n    Returns:\n        Hash bcrypt de la contrase\u00f1a\n    \"\"\"\n    return pwd_context.hash(password)\n\ndef verify_password(plain_password: str, hashed_password: str) -&gt; bool:\n    \"\"\"\n    Verifica si una contrase\u00f1a coincide con su hash.\n\n    Args:\n        plain_password: Contrase\u00f1a en texto plano\n        hashed_password: Hash almacenado en DB\n\n    Returns:\n        True si coinciden, False si no\n    \"\"\"\n    return pwd_context.verify(plain_password, hashed_password)\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#ejemplo-de-uso","title":"Ejemplo de Uso","text":"<pre><code># Registrar usuario (crear hash)\npassword = \"MiContrase\u00f1a123!\"\nhashed = get_password_hash(password)\n# Resultado: \"$2b$12$abcd1234...\"\n\n# Login (verificar hash)\nis_valid = verify_password(\"MiContrase\u00f1a123!\", hashed)\n# Resultado: True\n\nis_valid = verify_password(\"Contrase\u00f1aIncorrecta\", hashed)\n# Resultado: False\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#security-scheme","title":"\ud83d\udd12 Security Scheme","text":""},{"location":"backend/control-acceso/autenticacion/#oauth2-password-bearer","title":"OAuth2 Password Bearer","text":"<pre><code>from fastapi.security import OAuth2PasswordBearer\n\nsecurity_scheme = OAuth2PasswordBearer(tokenUrl=\"/login\")\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#uso-en-endpoints","title":"Uso en Endpoints","text":"<pre><code>@router.post(\"/portones\")\nasync def get_portones(sec: str = Depends(security_scheme)):\n    # sec contiene el token JWT\n    decode_jwt(sec, 0)  # Validar token\n    # ... l\u00f3gica del endpoint\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#login-de-usuario-normal","title":"\ud83d\udeaa Login de Usuario Normal","text":""},{"location":"backend/control-acceso/autenticacion/#flujo-de-autenticacion","title":"Flujo de Autenticaci\u00f3n","text":"<pre><code>sequenceDiagram\n    participant C as Client\n    participant API as FastAPI\n    participant Auth as authenticate_user()\n    participant DB as SQL Server\n    participant JWT as create_access_token()\n\n    C-&gt;&gt;API: POST /login\n    Note over C,API: {rut_or_mail, password}\n\n    API-&gt;&gt;Auth: authenticate_user()\n    Auth-&gt;&gt;DB: Query AMUsuario\n\n    alt Usuario no encontrado\n        DB--&gt;&gt;Auth: null\n        Auth--&gt;&gt;API: null\n        API--&gt;&gt;C: 401 Unauthorized\n    else Usuario encontrado\n        DB--&gt;&gt;Auth: user object\n        Auth-&gt;&gt;Auth: verify_password()\n\n        alt Contrase\u00f1a incorrecta\n            Auth--&gt;&gt;API: null\n            API--&gt;&gt;C: 401 Unauthorized\n        else Contrase\u00f1a correcta\n            Auth--&gt;&gt;API: user object\n            API-&gt;&gt;JWT: create_access_token()\n            JWT--&gt;&gt;API: access_token\n            API--&gt;&gt;C: 200 OK + token + user data\n        end\n    end</code></pre>"},{"location":"backend/control-acceso/autenticacion/#schema-de-request","title":"Schema de Request","text":"<pre><code># schemas/login_schema.py\nfrom pydantic import BaseModel\n\nclass LoginRequest(BaseModel):\n    rut_or_mail: str  # RUT o Email\n    password: str     # Contrase\u00f1a\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#schema-de-response","title":"Schema de Response","text":"<pre><code>class LoginResponse(BaseModel):\n    id: int\n    nombre: str\n    apellido: str\n    mail: str\n    rut: str\n    admin: bool\n    invitar: bool\n    access_token: str\n    token_type: str = \"bearer\"\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#implementacion-del-endpoint","title":"Implementaci\u00f3n del Endpoint","text":"<pre><code>@router.post(\"/login\", response_model=None)\nasync def login_for_access_token(request: LoginRequest):\n    \"\"\"\n    Autentica un usuario y devuelve un JWT.\n\n    - Busca usuario por RUT o Email\n    - Valida contrase\u00f1a con bcrypt\n    - Genera JWT con datos del usuario\n    \"\"\"\n    SessionLocal = sessionmaker(bind=db_engine.get_el_alto())\n    db = SessionLocal()\n\n    try:\n        user = authenticate_user(request.rut_or_mail, request.password, db)\n\n        if not user:\n            raise HTTPException(\n                status_code=status.HTTP_401_UNAUTHORIZED,\n                detail=\"Credenciales incorrectas\",\n                headers={\"WWW-Authenticate\": \"Bearer\"},\n            )\n\n        # Crear token JWT\n        access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)\n        access_token = create_access_token(\n            data={\n                \"nombre\": f\"{user.Nombre} {user.Apellido}\",\n                \"admin\": 1 if user.Admin else 0,\n                \"invitar\": 1 if user.Invitar else 0\n            },\n            expires_delta=access_token_expires\n        )\n\n        return JSONResponse(\n            status_code=200,\n            content={\n                \"id\": user.Id,\n                \"nombre\": user.Nombre,\n                \"apellido\": user.Apellido,\n                \"mail\": user.Mail,\n                \"rut\": user.Rut,\n                \"admin\": user.Admin,\n                \"invitar\": user.Invitar,\n                \"access_token\": access_token,\n                \"token_type\": \"bearer\"\n            }\n        )\n\n    finally:\n        db.close()\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#funcion-authenticate_user","title":"Funci\u00f3n authenticate_user","text":"<pre><code>def authenticate_user(rut_or_mail: str, password: str, db: Session):\n    \"\"\"\n    Autentica un usuario por RUT o Email.\n\n    Args:\n        rut_or_mail: RUT (12345678-9) o Email\n        password: Contrase\u00f1a en texto plano\n        db: Sesi\u00f3n de base de datos\n\n    Returns:\n        User object si es v\u00e1lido, None si no\n    \"\"\"\n    # Buscar en AMUsuario (ElAltoDB)\n    user_am = db.query(AMUsuario).filter(\n        (AMUsuario.Rut == rut_or_mail) | (AMUsuario.Mail == rut_or_mail)\n    ).first()\n\n    if user_am:\n        if verify_password(password, user_am.Contrasena):\n            return user_am\n        else:\n            return None\n\n    # Si no se encuentra, buscar en LogiPath (TransmineralDB)\n    from models.LogiPath import User as LPUser\n    with Session(db_engine.get()) as session:\n        user_lp = session.query(LPUser).filter(\n            (LPUser.Rut == rut_or_mail) | (LPUser.Email == rut_or_mail)\n        ).first()\n\n        if user_lp:\n            if verify_password(password, user_lp.Contrasena):\n                return user_lp\n            else:\n                return None\n\n    return None\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#funcion-create_access_token","title":"Funci\u00f3n create_access_token","text":"<pre><code>from jose import jwt\nfrom datetime import datetime, timedelta\n\ndef create_access_token(data: dict, expires_delta: timedelta | None = None):\n    \"\"\"\n    Crea un JWT firmado.\n\n    Args:\n        data: Datos a incluir en el payload\n        expires_delta: Tiempo de expiraci\u00f3n\n\n    Returns:\n        Token JWT firmado\n    \"\"\"\n    to_encode = data.copy()\n\n    if expires_delta:\n        expire = datetime.utcnow() + expires_delta\n    else:\n        expire = datetime.utcnow() + timedelta(minutes=15)\n\n    to_encode.update({\n        \"exp\": expire,\n        \"iat\": datetime.utcnow()\n    })\n\n    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)\n    return encoded_jwt\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#login-de-invitado","title":"\ud83d\udc64 Login de Invitado","text":""},{"location":"backend/control-acceso/autenticacion/#flujo-de-autenticacion-de-invitado","title":"Flujo de Autenticaci\u00f3n de Invitado","text":"<pre><code>sequenceDiagram\n    participant C as Client\n    participant API as FastAPI\n    participant DB as SQL Server\n    participant JWT as create_access_token_invitado()\n\n    C-&gt;&gt;API: POST /invitados/login\n    Note over C,API: {CodigoAcceso: \"1234\"}\n\n    API-&gt;&gt;DB: Query AMInvitados\n\n    alt C\u00f3digo no encontrado\n        DB--&gt;&gt;API: null\n        API--&gt;&gt;C: 404 Not Found\n    else C\u00f3digo encontrado\n        DB--&gt;&gt;API: invitado object\n        API-&gt;&gt;API: Validar fechas\n\n        alt C\u00f3digo expirado\n            API--&gt;&gt;C: 403 Forbidden\n        else C\u00f3digo v\u00e1lido\n            API-&gt;&gt;DB: Query PortonesInvitados\n            DB--&gt;&gt;API: portones_ids\n            API-&gt;&gt;JWT: create_access_token_invitado()\n            JWT--&gt;&gt;API: access_token\n            API--&gt;&gt;C: 200 OK + token + data\n        end\n    end</code></pre>"},{"location":"backend/control-acceso/autenticacion/#schema-de-request_1","title":"Schema de Request","text":"<pre><code>class InvitadoLoginRequest(BaseModel):\n    CodigoAcceso: str  # C\u00f3digo de 4 d\u00edgitos\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#schema-de-response_1","title":"Schema de Response","text":"<pre><code>class InvitadoLoginResponse(BaseModel):\n    IdInvitante: int\n    Nombre: str\n    Apellido: str\n    Mail: str\n    FechaInicial: datetime\n    FechaFinal: datetime\n    Empresa: str | None\n    Portones: list[int]  # IDs de portones permitidos\n    access_token: str\n    token_type: str = \"bearer\"\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#implementacion-del-endpoint_1","title":"Implementaci\u00f3n del Endpoint","text":"<pre><code>@router.post(\"/invitados/login\")\nasync def login_invitado(request: InvitadoLoginRequest):\n    \"\"\"\n    Autentica un invitado con c\u00f3digo de 4 d\u00edgitos.\n\n    - Valida existencia del c\u00f3digo\n    - Valida fechas de vigencia\n    - Obtiene portones permitidos\n    - Genera JWT para invitado\n    \"\"\"\n    SessionLocal = sessionmaker(bind=db_engine.get_el_alto())\n    db = SessionLocal()\n\n    try:\n        # Buscar invitado por c\u00f3digo\n        invitado = db.query(AMInvitados).filter(\n            AMInvitados.CodigoAcceso == request.CodigoAcceso\n        ).first()\n\n        if not invitado:\n            raise HTTPException(\n                status_code=404,\n                detail=\"C\u00f3digo de acceso no encontrado\"\n            )\n\n        # Validar fechas\n        ahora = datetime.now(timezone.utc)\n\n        if ahora &lt; invitado.FechaInicial:\n            raise HTTPException(\n                status_code=403,\n                detail=\"El c\u00f3digo a\u00fan no est\u00e1 activo\"\n            )\n\n        if ahora &gt; invitado.FechaFinal:\n            raise HTTPException(\n                status_code=403,\n                detail=\"El c\u00f3digo ha expirado\"\n            )\n\n        # Obtener portones permitidos\n        portones_rel = db.query(PortonesInvitados).filter(\n            PortonesInvitados.IdInvitado == invitado.Id\n        ).all()\n\n        portones_ids = [p.IdPorton for p in portones_rel]\n\n        # Crear token JWT para invitado\n        access_token = create_access_token_invitado(\n            data={\n                \"codigo\": request.CodigoAcceso,\n                \"tipo\": \"invitado\",\n                \"nombre\": f\"{invitado.Nombre} {invitado.Apellido}\"\n            }\n        )\n\n        return JSONResponse(\n            status_code=200,\n            content={\n                \"IdInvitante\": invitado.IdInvitante,\n                \"Nombre\": invitado.Nombre,\n                \"Apellido\": invitado.Apellido,\n                \"Mail\": invitado.Mail,\n                \"Empresa\": invitado.Empresa,\n                \"FechaInicial\": invitado.FechaInicial.isoformat(),\n                \"FechaFinal\": invitado.FechaFinal.isoformat(),\n                \"Portones\": portones_ids,\n                \"access_token\": access_token,\n                \"token_type\": \"bearer\"\n            }\n        )\n\n    finally:\n        db.close()\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#funcion-create_access_token_invitado","title":"Funci\u00f3n create_access_token_invitado","text":"<pre><code>def create_access_token_invitado(data: dict, expires_delta: timedelta | None = None):\n    \"\"\"\n    Crea un JWT para invitados.\n    Similar a create_access_token pero con payload diferente.\n    \"\"\"\n    to_encode = data.copy()\n\n    if expires_delta:\n        expire = datetime.utcnow() + expires_delta\n    else:\n        # Invitados: token v\u00e1lido por 12 horas\n        expire = datetime.utcnow() + timedelta(hours=12)\n\n    to_encode.update({\n        \"exp\": expire,\n        \"iat\": datetime.utcnow()\n    })\n\n    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)\n    return encoded_jwt\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#validacion-de-jwt","title":"\u2705 Validaci\u00f3n de JWT","text":""},{"location":"backend/control-acceso/autenticacion/#funcion-decode_jwt","title":"Funci\u00f3n decode_jwt","text":"<pre><code>from jose import jwt, JWTError\nfrom fastapi import HTTPException, status\n\ndef decode_jwt(token: str, admin: int = 0) -&gt; str:\n    \"\"\"\n    Decodifica y valida un JWT.\n\n    Args:\n        token: Token JWT a validar\n        admin: Nivel de admin requerido (0=cualquiera, 1=admin, 2=super admin)\n\n    Returns:\n        Nombre del usuario del token\n\n    Raises:\n        HTTPException: Si el token es inv\u00e1lido o no tiene permisos\n    \"\"\"\n    CREDENTIALS_EXCEPTION = HTTPException(\n        status_code=status.HTTP_401_UNAUTHORIZED,\n        detail=\"Could not validate credentials\",\n        headers={\"WWW-Authenticate\": \"Bearer\"},\n    )\n\n    try:\n        # Decodificar JWT\n        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])\n\n        # Obtener nombre del payload\n        nombre: str = payload.get(\"nombre\")\n        if nombre is None:\n            raise CREDENTIALS_EXCEPTION\n\n        # Validar nivel de admin si es requerido\n        if admin in [1, 2]:\n            admin_status: int = payload.get(\"admin\")\n            if admin_status not in [1, 2]:\n                raise HTTPException(\n                    status_code=status.HTTP_403_FORBIDDEN,\n                    detail=\"Insufficient permissions\"\n                )\n\n        return nombre\n\n    except JWTError:\n        raise CREDENTIALS_EXCEPTION\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#uso-en-endpoints-protegidos","title":"Uso en Endpoints Protegidos","text":"<pre><code>@router.post(\"/portones\")\nasync def get_portones(sec: str = Depends(security_scheme)):\n    \"\"\"\n    Endpoint protegido: Requiere JWT v\u00e1lido.\n    \"\"\"\n    # Validar JWT (cualquier usuario autenticado)\n    decode_jwt(sec, 0)\n\n    # ... l\u00f3gica del endpoint\n\n@router.post(\"/invitados/crear\")\nasync def crear_invitado(\n    invitado: InvitadoCreate,\n    sec: str = Depends(security_scheme)\n):\n    \"\"\"\n    Endpoint protegido: Requiere JWT de admin.\n    \"\"\"\n    # Validar JWT y verificar que sea admin\n    decode_jwt(sec, 1)\n\n    # ... l\u00f3gica del endpoint\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#capas-de-seguridad","title":"\ud83d\udee1\ufe0f Capas de Seguridad","text":"<pre><code>graph TB\n    REQUEST[HTTP Request] --&gt; LAYER1{Azure Functions&lt;br/&gt;Auth Level}\n\n    LAYER1 --&gt;|anonymous| LAYER2{Endpoint&lt;br/&gt;P\u00fablico?}\n\n    LAYER2 --&gt;|No| LAYER3[JWT Validation]\n    LAYER2 --&gt;|S\u00ed| ENDPOINT[Execute Logic]\n\n    LAYER3 --&gt;|Invalid| ERROR1[401 Unauthorized]\n    LAYER3 --&gt;|Valid| LAYER4{Admin&lt;br/&gt;Required?}\n\n    LAYER4 --&gt;|No| ENDPOINT\n    LAYER4 --&gt;|S\u00ed| LAYER5[Check Admin Flag]\n\n    LAYER5 --&gt;|Not Admin| ERROR2[403 Forbidden]\n    LAYER5 --&gt;|Is Admin| ENDPOINT\n\n    ENDPOINT --&gt; LAYER6[Business Logic&lt;br/&gt;Validation]\n\n    LAYER6 --&gt;|Invalid Data| ERROR3[400 Bad Request]\n    LAYER6 --&gt;|Valid Data| SUCCESS[200 OK]\n\n    style LAYER1 fill:#FFE5B4\n    style LAYER3 fill:#FFB6B6\n    style LAYER5 fill:#FF6B6B\n    style SUCCESS fill:#90EE90</code></pre>"},{"location":"backend/control-acceso/autenticacion/#endpoints-publicos","title":"Endpoints P\u00fablicos","text":"<ul> <li><code>GET /health</code> - No requiere autenticaci\u00f3n</li> </ul>"},{"location":"backend/control-acceso/autenticacion/#endpoints-con-jwt-cualquier-usuario","title":"Endpoints con JWT (cualquier usuario)","text":"<ul> <li><code>POST /portones</code> - Requiere JWT v\u00e1lido</li> <li><code>POST /mqtt_test</code> - Requiere API key en header</li> </ul>"},{"location":"backend/control-acceso/autenticacion/#endpoints-con-jwt-solo-admins","title":"Endpoints con JWT (solo admins)","text":"<ul> <li><code>POST /invitados/crear</code> - Crear invitados</li> <li><code>POST /invitados/listar</code> - Listar invitados</li> <li><code>PUT /invitados/actualizar</code> - Actualizar invitados</li> </ul>"},{"location":"backend/control-acceso/autenticacion/#endpoints-sin-jwt-autenticacion-especifica","title":"Endpoints sin JWT (autenticaci\u00f3n espec\u00edfica)","text":"<ul> <li><code>POST /login</code> - Login de usuario normal</li> <li><code>POST /invitados/login</code> - Login de invitado</li> </ul>"},{"location":"backend/control-acceso/autenticacion/#mejores-practicas-de-seguridad","title":"\ud83d\udd10 Mejores Pr\u00e1cticas de Seguridad","text":""},{"location":"backend/control-acceso/autenticacion/#1-contrasenas","title":"1. Contrase\u00f1as","text":"<p>\u2705 Implementado: - Hash con bcrypt (rounds=12) - Nunca almacenar contrase\u00f1as en texto plano - Verificaci\u00f3n segura con timing attack protection</p> <p>\u26a0\ufe0f Recomendado adicional: - Validaci\u00f3n de complejidad de contrase\u00f1a - Pol\u00edtica de renovaci\u00f3n de contrase\u00f1as - L\u00edmite de intentos de login</p>"},{"location":"backend/control-acceso/autenticacion/#2-jwt","title":"2. JWT","text":"<p>\u2705 Implementado: - Algoritmo HS256 - Expiraci\u00f3n de 24 horas - Firma con SECRET_KEY</p> <p>\u26a0\ufe0f Recomendado adicional: - Rotaci\u00f3n de SECRET_KEY peri\u00f3dica - Blacklist de tokens revocados - Refresh tokens para renovaci\u00f3n</p>"},{"location":"backend/control-acceso/autenticacion/#3-api-keys","title":"3. API Keys","text":"<p>\u2705 Implementado: - API key para endpoint MQTT - Validaci\u00f3n en cada request</p> <p>\u26a0\ufe0f Recomendado adicional: - Rotaci\u00f3n peri\u00f3dica de keys - Rate limiting por API key - Logging de uso de API keys</p>"},{"location":"backend/control-acceso/autenticacion/#4-https","title":"4. HTTPS","text":"<p>\u2705 Implementado: - Azure Functions usa HTTPS por defecto</p>"},{"location":"backend/control-acceso/autenticacion/#5-headers-de-seguridad","title":"5. Headers de Seguridad","text":"<p>\u26a0\ufe0f Recomendado implementar:</p> <pre><code>from fastapi.middleware.cors import CORSMiddleware\n\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\"https://tu-app.com\"],\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n# Headers de seguridad\n@app.middleware(\"http\")\nasync def add_security_headers(request, call_next):\n    response = await call_next(request)\n    response.headers[\"X-Content-Type-Options\"] = \"nosniff\"\n    response.headers[\"X-Frame-Options\"] = \"DENY\"\n    response.headers[\"X-XSS-Protection\"] = \"1; mode=block\"\n    return response\n</code></pre>"},{"location":"backend/control-acceso/autenticacion/#proximos-pasos","title":"\ud83d\udcda Pr\u00f3ximos Pasos","text":"<ul> <li>API Endpoints</li> <li>Integraci\u00f3n MQTT</li> <li>Sistema de Invitados</li> <li>Base de Datos</li> </ul>"},{"location":"backend/extraccion/websocket-excavadora/","title":"\ud83d\udd04 WebSocket Cami\u00f3n-Excavadora (Backend)","text":""},{"location":"backend/extraccion/websocket-excavadora/#descripcion-general","title":"\ud83d\udce1 Descripci\u00f3n General","text":"<p>Sistema de comunicaci\u00f3n en tiempo real entre camiones y excavadoras usando Azure Web PubSub Service. Permite coordinar operaciones de carga sincronizando estados de viajes entre equipos.</p> <pre><code>graph LR\n    Camion[\ud83d\udce6 Cami\u00f3n]\n    Backend[\ud83d\udda5\ufe0f Backend API]\n    AWPS[\u2601\ufe0f Azure Web PubSub]\n    Excavadora[\u26cf\ufe0f Excavadora]\n\n    Camion --&gt;|HTTP: Crear/Actualizar Viaje| Backend\n    Backend --&gt;|Publish Event| AWPS\n    AWPS --&gt;|WebSocket| Excavadora\n    Excavadora --&gt;|Recibe Notificaci\u00f3n| Excavadora\n\n    style AWPS fill:#0078D4,stroke:#fff,stroke-width:2px,color:#fff\n    style Backend fill:#e33123,stroke:#fff,stroke-width:2px,color:#fff</code></pre>"},{"location":"backend/extraccion/websocket-excavadora/#configuracion-azure","title":"\u2699\ufe0f Configuraci\u00f3n Azure","text":""},{"location":"backend/extraccion/websocket-excavadora/#conexion-web-pubsub","title":"Conexi\u00f3n Web PubSub","text":"Setup Backend <pre><code>from azure.messaging.webpubsubservice import WebPubSubServiceClient\n\n# Configuraci\u00f3n\nconnection_string = os.getenv(\"AZURE_WEBPUBSUB_CONNECTION_STRING\")\nhub_name = \"extraccion\"\n\n# Cliente\nservice = WebPubSubServiceClient.from_connection_string(\n    connection_string, \n    hub=hub_name\n)\n</code></pre>"},{"location":"backend/extraccion/websocket-excavadora/#endpoint-de-negociacion","title":"Endpoint de Negociaci\u00f3n","text":"GET /ws/negotiate <pre><code>@app.get(\"/ws/negotiate\")\nasync def negotiate(user_id: str):\n    \"\"\"\n    Genera URL de conexi\u00f3n WebSocket para un equipo.\n\n    Args:\n        user_id (str): Identificador del equipo (ej: \"EXC-001\")\n\n    Returns:\n        dict: {\"url\": \"wss://...\"}\n    \"\"\"\n    token = service.get_client_access_token(\n        user_id=user_id,\n        roles=[\"webpubsub.joinLeaveGroup\", \"webpubsub.sendToGroup\"]\n    )\n\n    return {\"url\": token['url']}\n</code></pre>"},{"location":"backend/extraccion/websocket-excavadora/#eventos-del-sistema","title":"\ud83d\udce8 Eventos del Sistema","text":""},{"location":"backend/extraccion/websocket-excavadora/#tipos-de-eventos","title":"Tipos de Eventos","text":"Eventos Emitidos por Backend Evento Emisor Receptor Descripci\u00f3n <code>ViajeCreado</code> Cami\u00f3n API Excavadora Nuevo viaje iniciado <code>ViajeActualizado</code> Cami\u00f3n API Excavadora Cambios en viaje existente <code>CargaFinalizada</code> Cami\u00f3n API Excavadora Cami\u00f3n termin\u00f3 de ser cargado <code>ViajeEnDescarga</code> Cami\u00f3n API Excavadora Cami\u00f3n lleg\u00f3 a descarga <code>ViajeFinalizado</code> Cami\u00f3n API Excavadora Viaje completado <code>ViajeCancelado</code> Cami\u00f3n API Excavadora Viaje cancelado"},{"location":"backend/extraccion/websocket-excavadora/#estructura-de-mensajes","title":"Estructura de Mensajes","text":"ViajeCreadoViajeActualizadoCargaFinalizadaViajeFinalizado <pre><code>{\n  \"type\": \"message\",\n  \"data\": {\n    \"data\": \"ViajeCreado\",\n    \"trip_data\": {\n      \"IdMovimiento\": 12345,\n      \"IdJornada\": 789,\n      \"Usuario\": \"conductor@empresa.cl\",\n      \"Equipo\": \"CAM-101\",\n      \"Patente\": \"ABCD12\",\n      \"IdProducto\": 5,\n      \"DescripcionProducto\": \"Mineral Cu\",\n      \"Conductor\": \"Juan P\u00e9rez\",\n      \"HoraInicio\": \"2026-01-21T10:30:00\",\n      \"HoraCarga\": null,\n      \"LatitudCarga\": \"-23.456\",\n      \"LongitudCarga\": \"-68.789\"\n    },\n    \"equipo\": \"CAM-101\",\n    \"timestamp\": \"2026-01-21T10:30:00.123Z\"\n  }\n}\n</code></pre> <pre><code>{\n  \"type\": \"message\",\n  \"data\": {\n    \"data\": \"ViajeActualizado\",\n    \"IdMovimiento\": 12345,\n    \"HoraFinCarga\": \"2026-01-21T10:45:00\",\n    \"Patente\": \"ABCD12\",\n    \"equipo\": \"CAM-101\",\n    \"timestamp\": \"2026-01-21T10:45:00.456Z\"\n  }\n}\n</code></pre> <pre><code>{\n  \"type\": \"message\",\n  \"data\": {\n    \"data\": \"CargaFinalizada\",\n    \"IdMovimiento\": 12345,\n    \"Patente\": \"ABCD12\",\n    \"HoraFinCarga\": \"2026-01-21T10:45:00\",\n    \"equipo\": \"CAM-101\",\n    \"timestamp\": \"2026-01-21T10:45:00.789Z\"\n  }\n}\n</code></pre> <pre><code>{\n  \"type\": \"message\",\n  \"data\": {\n    \"data\": \"ViajeFinalizado\",\n    \"IdMovimiento\": 12345,\n    \"Patente\": \"ABCD12\",\n    \"equipo\": \"CAM-101\",\n    \"timestamp\": \"2026-01-21T11:30:00.123Z\"\n  }\n}\n</code></pre>"},{"location":"backend/extraccion/websocket-excavadora/#flujo-de-operacion","title":"\ud83d\udd04 Flujo de Operaci\u00f3n","text":"<pre><code>sequenceDiagram\n    participant C as Cami\u00f3n App\n    participant API as Backend API\n    participant WPS as Azure Web PubSub\n    participant E as Excavadora App\n\n    Note over C,E: Inicio de Jornada\n    C-&gt;&gt;API: POST /viaje/crear\n    API-&gt;&gt;WPS: Publish \"ViajeCreado\"\n    WPS-&gt;&gt;E: WebSocket Event\n    E-&gt;&gt;E: Muestra cami\u00f3n disponible\n\n    Note over C,E: Durante Carga\n    C-&gt;&gt;API: PATCH /viaje/actualizar\n    API-&gt;&gt;WPS: Publish \"ViajeActualizado\"\n    WPS-&gt;&gt;E: WebSocket Event\n    E-&gt;&gt;E: Actualiza estado del viaje\n\n    Note over C,E: Fin de Carga\n    C-&gt;&gt;API: POST /viaje/finalizar-carga\n    API-&gt;&gt;WPS: Publish \"CargaFinalizada\"\n    WPS-&gt;&gt;E: WebSocket Event\n    E-&gt;&gt;E: Cami\u00f3n sale de zona\n\n    Note over C,E: Viaje Completo\n    C-&gt;&gt;API: POST /viaje/finalizar\n    API-&gt;&gt;WPS: Publish \"ViajeFinalizado\"\n    WPS-&gt;&gt;E: WebSocket Event\n    E-&gt;&gt;E: Libera viaje</code></pre>"},{"location":"backend/extraccion/websocket-excavadora/#publicacion-de-eventos","title":"\ud83c\udfaf Publicaci\u00f3n de Eventos","text":""},{"location":"backend/extraccion/websocket-excavadora/#metodo-principal","title":"M\u00e9todo Principal","text":"Publicar a Grupo <pre><code>async def publish_trip_event(\n    event_type: str,\n    data: dict,\n    equipo: str\n):\n    \"\"\"\n    Publica evento a todos los equipos suscritos.\n\n    Args:\n        event_type: Tipo de evento (ViajeCreado, etc.)\n        data: Datos del evento\n        equipo: Identificador del cami\u00f3n emisor\n    \"\"\"\n    message = {\n        \"data\": event_type,\n        \"timestamp\": datetime.utcnow().isoformat(),\n        \"equipo\": equipo,\n        **data\n    }\n\n    # Publicar a grupo de excavadoras\n    await service.send_to_group(\n        hub=hub_name,\n        group=\"excavadoras\",\n        message=message\n    )\n</code></pre>"},{"location":"backend/extraccion/websocket-excavadora/#integracion-en-endpoints","title":"Integraci\u00f3n en Endpoints","text":"Ejemplo: Crear Viaje <pre><code>@router.post(\"/viaje/crear\")\nasync def crear_viaje(viaje: ViajeCreate):\n    \"\"\"Crea viaje y notifica a excavadoras\"\"\"\n\n    # 1. Guardar en base de datos\n    nuevo_viaje = await db.viajes.insert(viaje)\n\n    # 2. Publicar evento WebSocket\n    await publish_trip_event(\n        event_type=\"ViajeCreado\",\n        data={\n            \"trip_data\": {\n                \"IdMovimiento\": nuevo_viaje.id,\n                \"IdJornada\": viaje.id_jornada,\n                \"Patente\": viaje.patente,\n                \"Equipo\": viaje.equipo,\n                # ... resto de datos\n            }\n        },\n        equipo=viaje.equipo\n    )\n\n    return {\"id\": nuevo_viaje.id}\n</code></pre>"},{"location":"backend/extraccion/websocket-excavadora/#seguridad","title":"\ud83d\udd12 Seguridad","text":"Consideraciones de Seguridad <ul> <li>\u2705 Tokens de conexi\u00f3n temporales (1 hora)</li> <li>\u2705 Validaci\u00f3n de <code>user_id</code> contra base de datos</li> <li>\u2705 Grupos separados por rol (excavadoras, camiones)</li> <li>\u2705 Rate limiting en endpoints</li> <li>\u2705 Validaci\u00f3n de permisos por equipo</li> <li>\u274c NO enviar datos sensibles sin encriptar</li> </ul>"},{"location":"backend/extraccion/websocket-excavadora/#validacion-de-usuario","title":"Validaci\u00f3n de Usuario","text":"Middleware de Validaci\u00f3n <pre><code>async def validate_equipment(user_id: str) -&gt; bool:\n    \"\"\"Valida que el equipo existe y est\u00e1 activo\"\"\"\n    equipo = await db.equipos.find_one({\n        \"Codigo\": user_id,\n        \"Activo\": True\n    })\n    return equipo is not None\n</code></pre>"},{"location":"backend/extraccion/websocket-excavadora/#monitoreo","title":"\ud83d\udcca Monitoreo","text":"M\u00e9tricas Clave M\u00e9trica Descripci\u00f3n Alerta Conexiones Activas Equipos conectados &lt; 80% flota Latencia Promedio Tiempo de entrega &gt; 500ms Eventos Publicados Total eventos/hora Anomal\u00edas Errores de Conexi\u00f3n Fallos de WebSocket &gt; 5% Mensajes Perdidos Eventos no entregados &gt; 1%"},{"location":"backend/extraccion/websocket-excavadora/#logging","title":"Logging","text":"Estructura de Logs <pre><code>logger.info(\n    \"WebSocket Event Published\",\n    extra={\n        \"event_type\": \"ViajeCreado\",\n        \"equipment\": \"CAM-101\",\n        \"trip_id\": 12345,\n        \"timestamp\": datetime.utcnow()\n    }\n)\n</code></pre>"},{"location":"backend/extraccion/websocket-excavadora/#manejo-de-errores","title":"\u26a0\ufe0f Manejo de Errores","text":"Errores Comunes Error Causa Soluci\u00f3n Connection Failed Azure service down Retry con backoff Invalid User ID Equipo no existe Validar contra DB Message Too Large Payload &gt; 1MB Comprimir o paginar Rate Limit Exceeded Demasiados eventos Implementar queue Token Expired Sesi\u00f3n &gt; 1 hora Renovar conexi\u00f3n"},{"location":"backend/extraccion/websocket-excavadora/#testing","title":"\ud83e\uddea Testing","text":"Pruebas de Integraci\u00f3n <pre><code>import pytest\nfrom unittest.mock import Mock, patch\n\n@pytest.mark.asyncio\nasync def test_publish_trip_created():\n    \"\"\"Test publicaci\u00f3n de evento ViajeCreado\"\"\"\n\n    with patch('azure.messaging.webpubsubservice') as mock_wps:\n        mock_service = Mock()\n        mock_wps.WebPubSubServiceClient.return_value = mock_service\n\n        await publish_trip_event(\n            event_type=\"ViajeCreado\",\n            data={\"trip_data\": {...}},\n            equipo=\"CAM-101\"\n        )\n\n        mock_service.send_to_group.assert_called_once()\n</code></pre>"},{"location":"backend/extraccion/websocket-excavadora/#ejemplos-de-uso","title":"\ud83d\udcdd Ejemplos de Uso","text":"Script de Publicaci\u00f3n Manual <pre><code># publish_event.py\nimport asyncio\nfrom azure.messaging.webpubsubservice import WebPubSubServiceClient\n\nasync def main():\n    service = WebPubSubServiceClient.from_connection_string(\n        connection_string,\n        hub=\"extraccion\"\n    )\n\n    await service.send_to_group(\n        group=\"excavadoras\",\n        message={\n            \"data\": \"ViajeCreado\",\n            \"trip_data\": {\n                \"IdMovimiento\": 99999,\n                \"Patente\": \"TEST01\"\n            }\n        }\n    )\n\nasyncio.run(main())\n</code></pre>"},{"location":"backend/extraccion/websocket-excavadora/#referencias","title":"\ud83d\udd17 Referencias","text":"Enlaces \u00datiles <ul> <li>Azure Web PubSub SDK Python</li> <li>Web PubSub Protocol</li> <li>Documentaci\u00f3n WebSocket General</li> <li>Frontend: Implementaci\u00f3n Cliente</li> </ul>"},{"location":"backend/levantamiento/windows_linux/","title":"\ud83d\ude80 Gu\u00eda de Configuraci\u00f3n: Entorno de Desarrollo","text":""},{"location":"backend/levantamiento/windows_linux/#requisitos-del-sistema","title":"\ud83d\udcbb Requisitos del Sistema","text":"WindowsLinux Componente Link Azure CLI Descargar \u2b07\ufe0f Functions Core Tools Descargar \u2b07\ufe0f VC++ Redistributable Descargar \u2b07\ufe0f ODBC Driver 17 Descargar \u2b07\ufe0f <pre><code># 1. Azure CLI\ncurl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash\n\n# 2. Functions Core Tools\ncurl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor &gt; microsoft.gpg\nsudo mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg\nsudo sh -c 'echo \"deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-ubuntu-$(lsb_release -cs)-prod $(lsb_release -cs) main\" &gt; /etc/apt/sources.list.d/dotnetdev.list'\nsudo apt-get update\nsudo apt-get install azure-functions-core-tools-4\n\n# 3. ODBC Driver\ncurl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -\nsudo curl https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list &gt; /etc/apt/sources.list.d/mssql-release.list\nsudo apt-get update\nsudo ACCEPT_EULA=Y apt-get install -y msodbcsql17\n</code></pre>"},{"location":"backend/levantamiento/windows_linux/#configuracion-del-entorno","title":"\ud83d\udee0\ufe0f Configuraci\u00f3n del Entorno","text":""},{"location":"backend/levantamiento/windows_linux/#1-autenticacion-azure","title":"1\ufe0f\u20e3 Autenticaci\u00f3n Azure","text":"Windows &amp; Linux <pre><code># Iniciar sesi\u00f3n en Azure\naz login\n</code></pre>"},{"location":"backend/levantamiento/windows_linux/#2-configuracion-del-repositorio","title":"2\ufe0f\u20e3 Configuraci\u00f3n del Repositorio","text":"WindowsLinux <pre><code># Clonar repositorio\ngit clone link_del_repositorio\n\n# Copiar archivo local\ncp localonly .\n\n# Configurar entorno Python\npython -m venv venv\n.\\venv\\Scripts\\activate\npip install -r requirements.txt\n</code></pre> <pre><code># Clonar repositorio\ngit clone link_del_repositorio\n\n# Copiar archivo local\ncp Tracmin/localonly .\n\n# Configurar entorno Python\npython -m venv venv\nsource venv/bin/activate\npip install -r requirements.txt\n</code></pre>"},{"location":"backend/levantamiento/windows_linux/#3-configuracion-azure-functions","title":"3\ufe0f\u20e3 Configuraci\u00f3n Azure Functions","text":"Windows &amp; Linux <pre><code># Obtener configuraci\u00f3n\nfunc azure functionapp fetch-app-settings elalto\n</code></pre>"},{"location":"backend/levantamiento/windows_linux/#4-certificados-https","title":"4\ufe0f\u20e3 Certificados HTTPS","text":"WindowsLinux <pre><code># Generar certificado\n$cert = New-SelfSignedCertificate `\n    -Subject localhost `\n    -DnsName localhost `\n    -FriendlyName \"Functions Development\" `\n    -KeyUsage DigitalSignature `\n    -TextExtension @(\"2.5.29.37={text}1.3.6.1.5.5.7.3.1\")\n\n# Exportar certificado\nExport-PfxCertificate `\n    -Cert $cert `\n    -FilePath certificate.pfx `\n    -Password (ConvertTo-SecureString -String 'password' -Force -AsPlainText)\n</code></pre> <pre><code># HTTPS habilitado por defecto\n# No requiere configuraci\u00f3n adicional\n</code></pre>"},{"location":"backend/levantamiento/windows_linux/#iniciar-el-backend","title":"\ud83d\udea6 Iniciar el Backend","text":"WindowsLinux <pre><code>func start --functions AppLogiPath `\n           --useHttps `\n           --cert certificate.pfx `\n           --password 'password'\n</code></pre> <pre><code>func start --functions AppLogiPath --useHttps\n</code></pre>"},{"location":"backend/levantamiento/windows_linux/#pruebas","title":"\ud83d\udd0d Pruebas","text":"Ejemplo Postman <pre><code>URL: http://localhost:7071/admin/functions/CargasLoadriteRaw\nM\u00e9todo: POST, GET, etc.\nHeaders: Seg\u00fan el caso\n</code></pre>"},{"location":"backend/levantamiento/windows_linux/#verificacion","title":"\u2705 Verificaci\u00f3n","text":"Lista de Verificaci\u00f3n <ul> <li>[ ] Herramientas instaladas</li> <li>[ ] Azure CLI configurado</li> <li>[ ] Repositorio clonado</li> <li>[ ] Entorno virtual activo</li> <li>[ ] Dependencias instaladas</li> <li>[ ] Backend funcionando</li> </ul>"},{"location":"backend/levantamiento/windows_linux/#solucion-de-problemas","title":"\u26a0\ufe0f Soluci\u00f3n de Problemas","text":"Problemas Comunes Problema Windows Linux Permisos Ejecutar como admin Usar sudo Puertos Verificar 7071 Verificar 7071 SSL Regenerar certificados Verificar configuraci\u00f3n Dependencias Actualizar pip Actualizar apt"},{"location":"backend/levantamiento/windows_linux/#recursos","title":"\ud83d\udcda Recursos","text":"Enlaces \u00datiles <ul> <li>Azure Functions</li> <li>Python en Azure</li> <li>Troubleshooting</li> </ul>"},{"location":"backend/levantamiento/wsl/","title":"\ud83d\udc27 WSL: Linux en Windows","text":""},{"location":"backend/levantamiento/wsl/#por-que-wsl","title":"\ud83c\udfaf \u00bfPor qu\u00e9 WSL?","text":"Ventajas de WSL <ul> <li>Entorno Linux nativo en Windows</li> <li>Mejor rendimiento para desarrollo</li> <li>Compatibilidad con herramientas Linux</li> <li>Integraci\u00f3n perfecta con VS Code</li> <li>Acceso a archivos de Windows</li> </ul>"},{"location":"backend/levantamiento/wsl/#instalacion-y-configuracion","title":"\ud83d\ude80 Instalaci\u00f3n y Configuraci\u00f3n","text":""},{"location":"backend/levantamiento/wsl/#1-preparacion-de-windows","title":"1\ufe0f\u20e3 Preparaci\u00f3n de Windows","text":"Activar Caracter\u00edsticas <ol> <li>Abrir \"Windows Features\"</li> <li>Activar:<ul> <li>\u2705 Virtual Machine Platform</li> <li>\u2705 Windows Hypervisor Platform</li> <li>\u2705 Windows Subsystem for Linux</li> </ul> </li> </ol>"},{"location":"backend/levantamiento/wsl/#2-instalacion-wsl","title":"2\ufe0f\u20e3 Instalaci\u00f3n WSL","text":"M\u00e9todo R\u00e1pidoInstalaci\u00f3n Manual <pre><code>wsl --install\n</code></pre> <pre><code># 1. Habilitar WSL\ndism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart\n\n# 2. Habilitar Plataforma Virtual\ndism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart\n\n# 3. Reiniciar Windows\n\n# 4. Establecer WSL 2 como predeterminado\nwsl --set-default-version 2\n</code></pre>"},{"location":"backend/levantamiento/wsl/#herramientas-esenciales","title":"\ud83d\udee0\ufe0f Herramientas Esenciales","text":""},{"location":"backend/levantamiento/wsl/#3-desarrollo","title":"3\ufe0f\u20e3 Desarrollo","text":"Node.js (NVM)Python (Miniconda)Azure Tools <pre><code># Instalar NVM\ncurl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash\n\n# Instalar Node.js\nnvm install node\n</code></pre> <pre><code># Descargar Miniconda\nwget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh\n\n# Instalar\nsh ./Miniconda3-latest-Linux-x86_64.sh\n</code></pre> <pre><code># Azure Functions Core Tools\ncurl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor &gt; microsoft.gpg\nsudo mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg\nsudo sh -c 'echo \"deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-ubuntu-$(lsb_release -cs)-prod $(lsb_release -cs) main\" &gt; /etc/apt/sources.list.d/dotnetdev.list'\nsudo apt-get update\nsudo apt-get install azure-functions-core-tools-4\n</code></pre>"},{"location":"backend/levantamiento/wsl/#vs-code-integration","title":"\ud83d\udcdd VS Code Integration","text":"Configuraci\u00f3n VS Code <ol> <li>Instalar extensi\u00f3n \"WSL\"</li> <li>Comandos \u00fatiles:     <pre><code># Abrir VS Code\ncode .\n\n# Abrir carpeta actual\ncode ./mi-proyecto\n</code></pre></li> </ol>"},{"location":"backend/levantamiento/wsl/#comandos-utiles","title":"\ud83d\udd0d Comandos \u00datiles","text":"Comandos B\u00e1sicos Comando Descripci\u00f3n <code>pwd</code> Directorio actual <code>ls</code> Listar archivos <code>cd</code> Cambiar directorio <code>mkdir</code> Crear carpeta <code>touch</code> Crear archivo Comandos WSL Comando Descripci\u00f3n <code>wsl --list</code> Ver distros instaladas <code>wsl --status</code> Estado de WSL <code>wsl --shutdown</code> Apagar WSL <code>wsl --update</code> Actualizar WSL"},{"location":"backend/levantamiento/wsl/#acceso-a-archivos","title":"\u2699\ufe0f Acceso a Archivos","text":"Sistema de Archivos <ul> <li>Windows desde WSL: <code>/mnt/c/</code></li> <li>WSL desde Windows: <code>\\\\wsl$\\Ubuntu\\home\\usuario</code></li> </ul>"},{"location":"backend/levantamiento/wsl/#verificacion","title":"\u2705 Verificaci\u00f3n","text":"Lista de Verificaci\u00f3n <ul> <li>[ ] WSL instalado y funcionando</li> <li>[ ] VS Code integrado</li> <li>[ ] Node.js/Python configurado</li> <li>[ ] Azure Tools instaladas</li> <li>[ ] Acceso a archivos Windows</li> </ul>"},{"location":"backend/levantamiento/wsl/#solucion-de-problemas","title":"\u26a0\ufe0f Soluci\u00f3n de Problemas","text":"Problemas Comunes Problema Soluci\u00f3n WSL no inicia <code>wsl --shutdown</code> y reiniciar VS Code no conecta Reinstalar extensi\u00f3n WSL Permisos denegados Usar <code>sudo</code> Actualizaci\u00f3n fallida <code>wsl --update</code>"},{"location":"backend/levantamiento/wsl/#recursos","title":"\ud83d\udcda Recursos","text":"Enlaces \u00datiles <ul> <li>Documentaci\u00f3n oficial WSL</li> <li>VS Code con WSL</li> <li>Gu\u00eda de inicio WSL</li> </ul>"},{"location":"backend/sap/draft/","title":"Modo Borrador (Draft Mode) en SAP","text":""},{"location":"backend/sap/draft/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>El Modo Borrador es una caracter\u00edstica que permite validar operaciones sin realizar cambios en la base de datos, ideal para pruebas y validaciones.</p> Caracter\u00edsticas Principales <ul> <li>No modifica la base de datos</li> <li>Valida operaciones</li> <li>Simula respuestas</li> <li>Permite pruebas seguras</li> <li>Disponible en m\u00faltiples servicios</li> </ul>"},{"location":"backend/sap/draft/#implementacion","title":"Implementaci\u00f3n","text":"Sintaxis B\u00e1sicaEjemplo Completo <pre><code>GET /endpoint?draft=true\n</code></pre> <pre><code>GET /b1s/v1/BusinessPartners('C001')?draft=true\n</code></pre>"},{"location":"backend/sap/draft/#casos-de-uso","title":"Casos de Uso","text":"Creaci\u00f3n de Objetos Temporales <pre><code>POST /b1s/v1/BusinessPartners?draft=true\n{\n    \"CardCode\": \"C001\",\n    \"CardName\": \"Cliente Prueba\",\n    \"CardType\": \"cCustomer\"\n}\n</code></pre> Validaci\u00f3n de Relaciones <pre><code>GET /b1s/v1/BusinessPartners('C001')/ContactEmployees?draft=true\n</code></pre> Actualizaci\u00f3n Simulada <pre><code>PATCH /b1s/v1/BusinessPartners('C001')?draft=true\n{\n    \"Phone1\": \"123456789\"\n}\n</code></pre>"},{"location":"backend/sap/draft/#servicios-compatibles","title":"Servicios Compatibles","text":"M\u00f3dulos Principales M\u00f3dulo Disponibilidad Operaciones Business Partners \u2705 Total CRUD Documentos \u2705 Total CRUD Inventario \u2705 Total CRUD Compras \u2705 Total CRUD Ventas \u2705 Total CRUD"},{"location":"backend/sap/draft/#validaciones","title":"Validaciones","text":"Qu\u00e9 se Valida <ol> <li> <p>Estructura de Datos:</p> <ul> <li>Campos requeridos</li> <li>Tipos de datos</li> <li>Longitudes m\u00e1ximas</li> </ul> </li> <li> <p>Reglas de Negocio:</p> <ul> <li>Relaciones entre entidades</li> <li>Restricciones de valores</li> <li>Dependencias</li> </ul> </li> <li> <p>Permisos:</p> <ul> <li>Autorizaciones</li> <li>Roles de usuario</li> <li>Accesos a m\u00f3dulos</li> </ul> </li> </ol>"},{"location":"backend/sap/draft/#ejemplos-practicos","title":"Ejemplos Pr\u00e1cticos","text":"Crear Pedido BorradorValidar Relaciones <pre><code>POST /b1s/v1/Orders?draft=true\n{\n    \"CardCode\": \"C001\",\n    \"DocDueDate\": \"2024-03-20\",\n    \"DocumentLines\": [\n        {\n            \"ItemCode\": \"A001\",\n            \"Quantity\": 10\n        }\n    ]\n}\n</code></pre> <pre><code>GET /b1s/v1/$crossjoin(Orders,Orders/DocumentLines)\n?draft=true\n&amp;$expand=Orders($select=DocEntry),\n         Orders/DocumentLines($select=ItemCode)\n</code></pre> Consideraciones Importantes <ol> <li> <p>Limitaciones:</p> <ul> <li>No genera n\u00fameros de documento</li> <li>No actualiza contadores</li> <li>No crea logs de auditor\u00eda</li> </ul> </li> <li> <p>Rendimiento:</p> <ul> <li>Similar al modo normal</li> <li>No impacta en tiempos de respuesta</li> <li>No consume recursos adicionales</li> </ul> </li> <li> <p>Seguridad:</p> <ul> <li>Requiere mismos permisos</li> <li>Mantiene trazabilidad</li> <li>No compromete datos</li> </ul> </li> </ol> Mejores Pr\u00e1cticas <ol> <li> <p>Uso Recomendado:</p> <ul> <li>Desarrollo de integraciones</li> <li>Pruebas de validaci\u00f3n</li> <li>Verificaci\u00f3n de reglas</li> <li>Simulaci\u00f3n de escenarios</li> </ul> </li> <li> <p>Documentaci\u00f3n:</p> <ul> <li>Documentar pruebas realizadas</li> <li>Mantener casos de prueba</li> <li>Registrar resultados</li> </ul> </li> <li> <p>Mantenimiento:</p> <ul> <li>Actualizar casos de prueba</li> <li>Revisar cambios en reglas</li> <li>Mantener scripts actualizados</li> </ul> </li> </ol>"},{"location":"backend/sap/postman/","title":"Gu\u00eda de Postman para SAP Business Layer","text":""},{"location":"backend/sap/postman/#gestion-de-cookies","title":"Gesti\u00f3n de Cookies","text":"Cookies Importantes <pre><code>B1SESSION: 40e92be0-9142-11ef-8000-fa163ec60aa5\nROUTEID: .node2\n</code></pre> Cookie Descripci\u00f3n Uso B1SESSION Token de sesi\u00f3n Identificaci\u00f3n de sesi\u00f3n activa ROUTEID Nodo del servidor Balance de carga"},{"location":"backend/sap/postman/#configuracion-en-postman","title":"Configuraci\u00f3n en Postman","text":"Autenticaci\u00f3nVariables de EntornoTests Autom\u00e1ticos <pre><code>POST https://servidor:50000/b1s/v1/Login\n{\n    \"CompanyDB\": \"EMPRESA_DB\",\n    \"UserName\": \"USUARIO\",\n    \"Password\": \"CONTRASE\u00d1A\"\n}\n</code></pre> <pre><code>// Pre-request Script\npm.environment.set(\"servidor\", \"mi-sap-server\");\npm.environment.set(\"puerto\", \"50000\");\n</code></pre> <pre><code>// Tests\npm.test(\"Guardar B1SESSION\", function() {\n    pm.environment.set(\"B1SESSION\", \n        pm.cookies.get(\"B1SESSION\"));\n});\n</code></pre>"},{"location":"backend/sap/postman/#consultas-odata","title":"Consultas OData","text":"Filtros B\u00e1sicos <pre><code>GET {{base_url}}/Orders?$filter=DocEntry eq 123\n</code></pre> Ordenamiento <pre><code>GET {{base_url}}/Orders?$orderby=DocEntry desc\n</code></pre> Paginaci\u00f3n <pre><code>GET {{base_url}}/Orders?$skip=20&amp;$top=10\n</code></pre>"},{"location":"backend/sap/postman/#joins-y-consultas-complejas","title":"Joins y Consultas Complejas","text":"$crossjoin B\u00e1sicoFiltros en Joins <pre><code>GET {{base_url}}/$crossjoin(Drafts,Drafts/DocumentLines)\n?$expand=Drafts($select=DocEntry),\n         Drafts/DocumentLines($select=ItemCode)\n</code></pre> <pre><code>GET {{base_url}}/$crossjoin(...)\n?$filter=Drafts/DocEntry eq Drafts/DocumentLines/DocEntry\n</code></pre>"},{"location":"backend/sap/postman/#coleccion-de-ejemplos","title":"Colecci\u00f3n de Ejemplos","text":"Pedidos Recientes <pre><code>GET {{base_url}}/Orders\n?$filter=DocDate ge '2024-01-01'\n&amp;$orderby=DocDate desc\n&amp;$top=10\n</code></pre> Detalles de Cliente <pre><code>GET {{base_url}}/BusinessPartners('C001')\n?$expand=ContactEmployees\n</code></pre>"},{"location":"backend/sap/postman/#manejo-de-errores","title":"Manejo de Errores","text":"C\u00f3digos ComunesScript de Retry C\u00f3digo Descripci\u00f3n Soluci\u00f3n 401 No autorizado Renovar sesi\u00f3n 404 No encontrado Verificar ruta 500 Error interno Contactar soporte <pre><code>// Pre-request Script\nif (pm.response.code === 401) {\n    pm.sendRequest({\n        url: pm.environment.get(\"login_url\"),\n        method: 'POST',\n        header: {'Content-Type': 'application/json'},\n        body: {\n            mode: 'raw',\n            raw: JSON.stringify(loginData)\n        }\n    });\n}\n</code></pre>"},{"location":"backend/sap/postman/#mejores-practicas","title":"Mejores Pr\u00e1cticas","text":"Consideraciones <ol> <li> <p>Sesi\u00f3n:</p> <ul> <li>Guardar cookies autom\u00e1ticamente</li> <li>Manejar expiraci\u00f3n</li> <li>Renovar sesi\u00f3n cuando sea necesario</li> </ul> </li> <li> <p>Rendimiento:</p> <ul> <li>Limitar resultados con $top</li> <li>Usar selecci\u00f3n de campos</li> <li>Optimizar joins</li> </ul> </li> <li> <p>Seguridad:</p> <ul> <li>No compartir cookies</li> <li>Usar variables de entorno</li> <li>Verificar certificados SSL</li> </ul> </li> </ol> Consejos <ul> <li>Organizar colecciones por m\u00f3dulo</li> <li>Documentar ejemplos</li> <li>Usar variables de entorno</li> <li>Implementar tests autom\u00e1ticos</li> <li>Mantener historial de cambios</li> </ul>"},{"location":"backend/sap/que-es-sap/","title":"SAP Business Layer - Documentaci\u00f3n","text":""},{"location":"backend/sap/que-es-sap/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>SAP Business Layer (SAP B1 Service Layer) es una API basada en OData que permite la interacci\u00f3n con SAP Business One a trav\u00e9s de servicios web RESTful.</p> Caracter\u00edsticas Principales <ul> <li>API basada en OData</li> <li>Servicios web RESTful</li> <li>Autenticaci\u00f3n requerida</li> <li>Operaciones CRUD</li> <li>Consultas flexibles</li> </ul>"},{"location":"backend/sap/que-es-sap/#estructura-base","title":"Estructura Base","text":"<pre><code>https://servidor.com:50000/b1s/v1/\n</code></pre> <p>Donde: - <code>servidor.com:50000</code>: Host y puerto del servidor - <code>/b1s/v1/</code>: Versi\u00f3n y punto de entrada</p>"},{"location":"backend/sap/que-es-sap/#operaciones-principales","title":"Operaciones Principales","text":"Autenticaci\u00f3nConsultas B\u00e1sicasOperaciones CRUD <pre><code>POST /b1s/v1/Login\n{\n    \"CompanyDB\": \"NOMBRE_DB\",\n    \"UserName\": \"USUARIO\",\n    \"Password\": \"CONTRASE\u00d1A\"\n}\n</code></pre> Obtener Clientes <pre><code>GET /b1s/v1/BusinessPartners\n</code></pre> Filtrar por Ciudad <pre><code>GET /b1s/v1/BusinessPartners?$filter=City eq 'Santiago'\n</code></pre> Seleccionar Campos <pre><code>GET /b1s/v1/BusinessPartners?$select=CardCode,CardName,City\n</code></pre> Crear (POST) <pre><code>POST /b1s/v1/BusinessPartners\n{\n    \"CardCode\": \"C001\",\n    \"CardName\": \"Cliente Ejemplo\",\n    \"City\": \"Santiago\"\n}\n</code></pre> Leer (GET) <pre><code>GET /b1s/v1/BusinessPartners('C001')\n</code></pre> Actualizar (PATCH) <pre><code>PATCH /b1s/v1/BusinessPartners('C001')\n{\n    \"City\": \"Valpara\u00edso\"\n}\n</code></pre> Eliminar (DELETE) <pre><code>DELETE /b1s/v1/BusinessPartners('C001')\n</code></pre>"},{"location":"backend/sap/que-es-sap/#parametros-odata","title":"Par\u00e1metros OData","text":"Par\u00e1metros Principales Par\u00e1metro Descripci\u00f3n Ejemplo $filter Filtrar resultados <code>?$filter=City eq 'Santiago'</code> $select Seleccionar campos <code>?$select=CardCode,CardName</code> $expand Expandir relaciones <code>?$expand=ContactEmployees</code> $orderby Ordenar resultados <code>?$orderby=CardName desc</code> $top Limitar resultados <code>?$top=10</code> $skip Saltar resultados <code>?$skip=20</code>"},{"location":"backend/sap/que-es-sap/#ejemplos-practicos","title":"Ejemplos Pr\u00e1cticos","text":"Consulta de FacturasCrear Orden de Compra <pre><code>GET /b1s/v1/Invoices?$filter=DocDate ge '2024-01-01'\n</code></pre> <pre><code>POST /b1s/v1/PurchaseOrders\n{\n    \"CardCode\": \"P001\",\n    \"DocDate\": \"2024-03-20\",\n    \"DocumentLines\": [\n        {\n            \"ItemCode\": \"A001\",\n            \"Quantity\": 10\n        }\n    ]\n}\n</code></pre> Consideraciones Importantes <ol> <li> <p>Seguridad:</p> <ul> <li>Mantener seguras las credenciales</li> <li>Usar HTTPS</li> <li>Renovar tokens peri\u00f3dicamente</li> </ul> </li> <li> <p>Rendimiento:</p> <ul> <li>Optimizar consultas</li> <li>Usar paginaci\u00f3n</li> <li>Limitar campos seleccionados</li> </ul> </li> <li> <p>Buenas Pr\u00e1cticas:</p> <ul> <li>Manejar errores apropiadamente</li> <li>Documentar cambios</li> <li>Mantener consistencia en datos</li> </ul> </li> </ol> Recursos Adicionales <ul> <li>Documentaci\u00f3n Oficial SAP</li> <li>Gu\u00eda de OData</li> <li>Ejemplos de Integraci\u00f3n</li> </ul>"},{"location":"backend/tracmin/combustible/","title":"API Combustible - Documentaci\u00f3n (Admin)","text":""},{"location":"backend/tracmin/combustible/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Sistema de gesti\u00f3n de combustible que permite registrar y consultar el consumo de combustible de la flota. Acceso exclusivo para administradores.</p> Notas Importantes <ul> <li>Sistema CRUD para gesti\u00f3n de combustible</li> <li>Acceso restringido a administradores</li> <li>Modelos principales:     modelos<pre><code>class reqSession(BaseModel):\n    Folio: str\n\nclass reqSessionPostStock(BaseModel):\n    Folio: str\n    Planta: str\n    Patente: str\n    FotoDocumento: str  # Base64\n    WarehouseCodeQuantity: List[WarehouseCodeQuantityItem]\n    UnitPrice: float\n\nclass WarehouseCodeQuantityItem(BaseModel):\n    WarehouseCode: str\n    Quantity: float\n</code></pre></li> </ul> Consideraciones de Seguridad <ul> <li>Validaci\u00f3n de key de autorizaci\u00f3n</li> <li>Acceso restringido a administradores</li> <li>Validaci\u00f3n de documentos</li> <li>Protecci\u00f3n de datos sensibles</li> <li>Control de acceso a bodegas</li> </ul> Mejores Pr\u00e1cticas <ul> <li>Validar documentos antes de procesar</li> <li>Mantener registro de transacciones</li> <li>Monitorear niveles de stock</li> <li>Documentar cambios de inventario</li> <li>Notificar eventos importantes</li> </ul> Integraciones <ul> <li>FEBOS:<ul> <li>Consulta de documentos tributarios</li> <li>Validaci\u00f3n de gu\u00edas</li> </ul> </li> <li>SAP:<ul> <li>Control de inventario</li> <li>Registro de movimientos</li> </ul> </li> <li>Azure:<ul> <li>Almacenamiento de documentos</li> <li>Gesti\u00f3n de archivos</li> </ul> </li> <li>Email:<ul> <li>Notificaciones autom\u00e1ticas</li> <li>Alertas de stock</li> </ul> </li> </ul>"},{"location":"backend/tracmin/combustible/#endpoints-combustible","title":"Endpoints Combustible","text":"EndpointsSequence DiagramEjemplos de RespuestaC\u00f3digos de EstadoValidaciones Consultar Gu\u00eda de Combustible POST /api/logipath/get_fuel_guide<pre><code>@router.post(f\"{APP_PATH}/get_fuel_guide\")\nasync def fuel(res: Request, req: reqSession):\n    \"\"\"\n    Obtiene informaci\u00f3n detallada de una gu\u00eda de combustible.\n\n    Args:\n        res (Request): Request con key de autorizaci\u00f3n\n        req (reqSession): Folio de la gu\u00eda\n\n    Returns:\n        dict: {\n            \"documento\": dict,\n            \"tipo_dte\": str,\n            \"folio\": int,\n            \"fecha_emision\": str,\n            \"razon_social_emisor\": str,\n            \"monto_total\": float,\n            \"cantidad\": float,\n            \"PrcItem\": float,\n            \"DirDest\": str,\n            \"CmnaDest\": str,\n            \"CiudadDest\": str\n        }\n\n    Raises:\n        HTTPException: \n            - 401: Si la key es inv\u00e1lida\n            - 500: Error en la consulta\n    \"\"\"\n</code></pre> Consultar Stock de Combustible POST /api/logipath/get_stock_fuel<pre><code>@router.post(f\"{APP_PATH}/get_stock_fuel\")\nasync def fuel(res: Request, req: reqSession):\n    \"\"\"\n    Obtiene el stock actual de combustible por bodega.\n\n    Args:\n        res (Request): Request con key de autorizaci\u00f3n\n        req (reqSession): Datos de consulta\n\n    Returns:\n        dict: {\n            \"bodegas\": [\n                {\n                    \"WarehouseCode\": str,\n                    \"cantidad\": float,\n                    \"WarehouseName\": str,\n                    \"MaximalStock\": float,\n                    \"MinimalStock\": float\n                }\n            ]\n        }\n    \"\"\"\n</code></pre> Registrar Consumo de Combustible POST /api/logipath/post_fuel_stock<pre><code>@router.post(f\"{APP_PATH}/post_fuel_stock\")\nasync def fuel(res: Request, req: reqSessionPostStock):\n    \"\"\"\n    Registra el consumo de combustible y actualiza stock.\n\n    Args:\n        res (Request): Request con key de autorizaci\u00f3n\n        req (reqSessionPostStock): Datos del consumo\n\n    Returns:\n        dict: {\n            \"message\": str,\n            \"IdAzure\": str,\n            \"LinkAzure\": str\n        }\n    \"\"\"\n</code></pre> <pre><code>sequenceDiagram\n    participant Admin\n    participant API\n    participant FEBOS\n    participant SAP\n    participant Azure\n    participant Email\n\n    alt Consulta Gu\u00eda\n        Admin-&gt;&gt;API: POST /get_fuel_guide\n        API-&gt;&gt;API: Validar Key\n        API-&gt;&gt;FEBOS: Consultar Gu\u00eda\n        FEBOS--&gt;&gt;API: XML Gu\u00eda\n        API-&gt;&gt;API: Procesar XML\n        API--&gt;&gt;Admin: Datos Gu\u00eda\n\n    else Consulta Stock\n        Admin-&gt;&gt;API: POST /get_stock_fuel\n        API-&gt;&gt;API: Validar Key\n        API-&gt;&gt;SAP: Login\n        SAP--&gt;&gt;API: Token\n        API-&gt;&gt;SAP: Consultar Stock\n        SAP--&gt;&gt;API: Datos Stock\n        API--&gt;&gt;Admin: Stock por Bodega\n\n    else Registrar Consumo\n        Admin-&gt;&gt;API: POST /post_fuel_stock\n        API-&gt;&gt;API: Validar Key\n        API-&gt;&gt;SAP: Actualizar Stock\n\n        par Almacenar Documento\n            API-&gt;&gt;Azure: Subir Foto\n            Azure--&gt;&gt;API: URL Documento\n        and Notificar\n            API-&gt;&gt;Email: Enviar Notificaci\u00f3n\n        end\n\n        API--&gt;&gt;Admin: Confirmaci\u00f3n\n    end</code></pre> Consulta Gu\u00eda <pre><code>{\n    \"documento\": {\n        \"xmlLink\": \"https://api.febos.cl/...\"\n    },\n    \"tipo_dte\": \"33\",\n    \"folio\": \"123456\",\n    \"fecha_emision\": \"2024-03-20\",\n    \"razon_social_emisor\": \"Empresa Combustibles\",\n    \"monto_total\": 150000.00,\n    \"cantidad\": 100.00,\n    \"PrcItem\": 1500.00\n}\n</code></pre> Consulta Stock <pre><code>{\n    \"bodegas\": [\n        {\n            \"WarehouseCode\": \"BOD1017\",\n            \"cantidad\": 5000.00,\n            \"WarehouseName\": \"Estanque Equipos M\u00f3viles\",\n            \"MaximalStock\": 10000.00,\n            \"MinimalStock\": 1000.00\n        }\n    ]\n}\n</code></pre> C\u00f3digo Descripci\u00f3n 200 Operaci\u00f3n exitosa 401 No autorizado 404 Documento no encontrado 500 Error interno Campo Regla Folio Formato v\u00e1lido Cantidad &gt; 0 FotoDocumento Base64 v\u00e1lido WarehouseCode Existente en SAP"},{"location":"backend/tracmin/estructura/","title":"Arquitectura Tracmin Backend - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/estructura/#arquitectura-del-sistema","title":"Arquitectura del Sistema","text":"Tecnolog\u00edas Core <ul> <li>Framework Principal: FastAPI (Python)</li> <li>Base de Datos: SQL Server</li> <li>Base de Datos: SQL Server</li> </ul> Seguridad <ul> <li>Autenticaci\u00f3n JWT</li> <li>Control de roles y permisos</li> <li>Encriptaci\u00f3n de datos sensibles</li> <li>Logs de auditor\u00eda</li> </ul> Escalabilidad <ul> <li>Arquitectura modular</li> <li>Servicios independientes</li> <li>Cache distribuido</li> <li>Balanceo de carga</li> <li>Monitorizaci\u00f3n</li> <li>Logging centralizado</li> <li>M\u00e9tricas de rendimiento</li> </ul> <pre><code>graph TD\n    A[LogiPath API] --&gt; B[SAP ERP]\n    A --&gt; C[Febos]\n    A --&gt; D[Microsoft Graph]\n    A --&gt; E[Azure Services]\n\n    E --&gt; F[WebPubSub]\n    E --&gt; G[Blob Storage]\n    E --&gt; H[Functions]</code></pre>"},{"location":"backend/tracmin/estructura/#modulos-principales","title":"M\u00f3dulos Principales","text":""},{"location":"backend/tracmin/estructura/#1-gestion-de-viajes","title":"1. Gesti\u00f3n de Viajes","text":"<ul> <li><code>Programaci\u00f3n y seguimiento de viajes</code></li> <li><code>Control de estados y ubicaciones</code></li> <li><code>Gesti\u00f3n de conductores y veh\u00edculos</code></li> </ul>"},{"location":"backend/tracmin/estructura/#2-documentacion-electronica","title":"2. Documentaci\u00f3n Electr\u00f3nica","text":"<ul> <li><code>Integraci\u00f3n con SAP para gu\u00edas de despacho</code></li> <li><code>Validaci\u00f3n y control de documentos</code></li> <li><code>Seguimiento de estados documentales</code></li> </ul>"},{"location":"backend/tracmin/estructura/#3-comunicaciones","title":"3. Comunicaciones","text":"<ul> <li><code>Notificaciones en tiempo real (WebPubSub)</code></li> <li><code>Correos autom\u00e1ticos (Microsoft Graph)</code></li> <li><code>Comunicaci\u00f3n bidireccional con conductores</code></li> </ul>"},{"location":"backend/tracmin/estructura/#4-almacenamiento-y-multimedia","title":"4. Almacenamiento y Multimedia","text":"<ul> <li><code>Gesti\u00f3n de im\u00e1genes y documentos</code></li> <li><code>Almacenamiento en Azure Blob</code></li> <li><code>Respaldos y versionamiento</code></li> </ul> <pre><code>sequenceDiagram\n    participant Cliente\n    participant API\n    participant SAP\n    participant Febos\n    participant Azure WebPubSub\n    participant Azure Form Recognizer\n    participant MS Graph\n    participant Azure Blob\n\n    Cliente-&gt;&gt;API: Solicitud de Viaje\n\n    par Proceso de Gu\u00eda\n        API-&gt;&gt;SAP: Creaci\u00f3n de Gu\u00eda\n        SAP--&gt;&gt;API: Confirmaci\u00f3n\n        API-&gt;&gt;Febos: Generaci\u00f3n Folio\n        Febos--&gt;&gt;API: Folio Generado\n    and Notificaciones\n        API-&gt;&gt;Azure WebPubSub: Broadcast Update\n        Azure WebPubSub--&gt;&gt;Cliente: Actualizaci\u00f3n Tiempo Real\n    end\n\n    Cliente-&gt;&gt;API: Upload Ticket/Imagen\n    API-&gt;&gt;Azure Blob: Almacenar Imagen\n    Azure Blob--&gt;&gt;API: URL Imagen\n\n    par Procesamiento Paralelo\n        API-&gt;&gt;Azure Form Recognizer: An\u00e1lisis de Ticket\n        Azure Form Recognizer--&gt;&gt;API: Datos Extra\u00eddos\n    and Notificaciones Email\n        API-&gt;&gt;MS Graph: Env\u00edo Email Confirmaci\u00f3n\n        MS Graph--&gt;&gt;API: Email Enviado\n    end\n\n    API-&gt;&gt;SAP: Actualizaci\u00f3n con Datos de Ticket\n    SAP--&gt;&gt;API: Confirmaci\u00f3n Final\n\n    par Actualizaciones Finales\n        API-&gt;&gt;Azure WebPubSub: Notificar Completado\n        Azure WebPubSub--&gt;&gt;Cliente: Update Final\n    and Email Final\n        API-&gt;&gt;MS Graph: Email Resumen\n        MS Graph--&gt;&gt;Cliente: Confirmaci\u00f3n Email\n    end</code></pre> Dependencias<pre><code>fastapi = \"^0.68.0\"\nsqlalchemy = \"^1.4.23\"\npyjwt = \"^2.1.0\"\nazure-storage-blob = \"^12.8.1\"\nazure-messaging-webpubsub = \"^1.0.0\"\n</code></pre>"},{"location":"backend/tracmin/gps/","title":"API Coordenadas - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/gps/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Sistema de tracking que integra m\u00faltiples fuentes de geolocalizaci\u00f3n: proveedores GPS externos, GPS de dispositivos m\u00f3viles y visualizaci\u00f3n de coordenadas para seguimiento en tiempo real.</p> Modelos de Datos modelos<pre><code>class transportistaCoordenadas(BaseModel):\n    Transportista: Optional[str] = None\n    Gps: Optional[str] = None\n    Patente: Optional[str] = None\n    Latitud: Optional[float] = None\n    Longitud: Optional[float] = None\n    Velocidad: Optional[float] = None\n    HoraCoordenada: Optional[str] = None\n\nclass CoordinateRequest(BaseModel):\n    IdProgramado: int\n    RutConductor: str\n    HoraInicioJornada: datetime\n    HoraCoordenada: datetime\n    Longitud: float\n    Latitud: float\n\nclass GetCoordinatesRequest(BaseModel):\n    IdViaje: int\n</code></pre>"},{"location":"backend/tracmin/gps/#endpoints-de-coordenadas","title":"Endpoints de Coordenadas","text":"Webhook GPS ExternosGPS M\u00f3vilConsulta CoordenadasSequence DiagramEjemplos de Respuesta Recibir Coordenadas GPS POST /api/logipath/gps_coords<pre><code>@router.post(f\"{APP_PATH}/gps_coords\")\nasync def get_coords(\n    req: Union[transportistaCoordenadas, List[transportistaCoordenadas]],\n    request: Request\n):\n    \"\"\"\n    Webhook para recibir coordenadas de proveedores GPS externos.\n\n    Args:\n        req: Coordenadas del proveedor GPS\n        request: Request con key de autorizaci\u00f3n\n\n    Returns:\n        dict: {\n            \"status\": 200,\n            \"message\": \"Trip added correctly\"\n        }\n\n    Validaciones:\n        - Key de autorizaci\u00f3n v\u00e1lida\n        - Formato de patente\n        - Existencia del viaje\n    \"\"\"\n</code></pre> Enviar Coordenadas App POST /api/logipath/la_ruta<pre><code>@router.post(f\"{APP_PATH}/la_ruta\")\nasync def post_coordinate(\n    sec: Annotated[str, Depends(security_scheme)],\n    req: CoordinateRequest\n):\n    \"\"\"\n    Registra coordenadas desde el GPS del dispositivo m\u00f3vil.\n\n    Args:\n        sec: Token JWT\n        req: Datos de coordenadas\n\n    Returns:\n        dict: {\"message\": \"coordinate added successfully\"}\n\n    Validaciones:\n        - Token JWT v\u00e1lido\n        - Existencia del viaje\n        - Formato de coordenadas\n    \"\"\"\n</code></pre> Obtener Coordenadas POST /api/logipath/get_coords<pre><code>@router.post(f\"{APP_PATH}/get_coords\")\nasync def get_coords(\n    sec: Annotated[str, Depends(security_scheme)],\n    req: Union[GetCoordinatesRequest, List[GetCoordinatesRequest]]\n):\n    \"\"\"\n    Obtiene coordenadas para visualizaci\u00f3n en mapa.\n\n    Args:\n        sec: Token JWT\n        req: ID(s) de viaje(s)\n\n    Returns:\n        dict: {\n            \"results\": [Lista de coordenadas],\n            \"not_found\": [IDs no encontrados]\n        }\n    \"\"\"\n</code></pre> <pre><code>sequenceDiagram\n    participant GPS Provider\n    participant Mobile App\n    participant API\n    participant DB\n    participant Map View\n\n    par GPS Provider\n        GPS Provider-&gt;&gt;API: POST /gps_coords\n        API-&gt;&gt;API: Validar Key\n        API-&gt;&gt;DB: Guardar Coordenadas\n        API--&gt;&gt;GPS Provider: Confirmaci\u00f3n\n\n    and Mobile App\n        Mobile App-&gt;&gt;API: POST /la_ruta\n        API-&gt;&gt;API: Validar JWT\n        API-&gt;&gt;DB: Guardar Coordenadas\n        API--&gt;&gt;Mobile App: Confirmaci\u00f3n\n\n    and Map View\n        Map View-&gt;&gt;API: POST /get_coords\n        API-&gt;&gt;API: Validar JWT\n        API-&gt;&gt;DB: Consultar Coordenadas\n        API--&gt;&gt;Map View: Lista Coordenadas\n    end</code></pre> Webhook GPS <pre><code>{\n    \"status\": 200,\n    \"message\": \"Trip added correctly\"\n}\n</code></pre> Coordenadas App <pre><code>{\n    \"message\": \"coordinate added successfully\"\n}\n</code></pre> Consulta Coordenadas <pre><code>{\n    \"results\": [\n        {\n            \"IdViaje\": 123,\n            \"HoraCoordenada\": \"2024-03-20T10:30:00\",\n            \"Latitud\": -33.4569,\n            \"Longitud\": -70.6483,\n            \"Velocidad\": 60.5,\n            \"Patente\": \"ABCD12\"\n        }\n    ],\n    \"not_found\": []\n}\n</code></pre> Consideraciones de Seguridad <ul> <li>Validaci\u00f3n de fuentes GPS</li> <li>Autenticaci\u00f3n de dispositivos</li> <li>Protecci\u00f3n de datos de ubicaci\u00f3n</li> <li>Control de acceso a coordenadas</li> <li>Encriptaci\u00f3n de comunicaciones</li> </ul> Mejores Pr\u00e1cticas <ol> <li> <p>Validaci\u00f3n de Datos:</p> <ul> <li>Rango de coordenadas v\u00e1lido</li> <li>Timestamps coherentes</li> <li>Velocidades realistas</li> <li>Patentes existentes</li> </ul> </li> <li> <p>Optimizaci\u00f3n:</p> <ul> <li>Filtrado de coordenadas redundantes</li> <li>Compresi\u00f3n de datos</li> <li>Indexaci\u00f3n geoespacial</li> <li>Cach\u00e9 de consultas frecuentes</li> </ul> </li> <li> <p>Monitoreo:</p> <ul> <li>Latencia de webhooks</li> <li>Precisi\u00f3n de coordenadas</li> <li>Frecuencia de actualizaci\u00f3n</li> <li>Cobertura de se\u00f1al</li> </ul> </li> </ol> Detalles T\u00e9cnicos Aspecto Especificaci\u00f3n Formato Coordenadas Decimal Degrees Precisi\u00f3n 6 decimales Timezone UTC Rate Limit 1 req/seg por dispositivo Retenci\u00f3n 30 d\u00edas C\u00f3digos de ErrorIntegraci\u00f3n Mapas C\u00f3digo Descripci\u00f3n 401 No autorizado 404 Viaje no encontrado 422 Coordenadas inv\u00e1lidas 429 Rate limit excedido 500 Error interno <ul> <li>Soporte para m\u00faltiples proveedores</li> <li>Clustering de marcadores</li> <li>Polylines para rutas</li> <li>Geofencing</li> <li>Alertas de desv\u00edo</li> </ul>"},{"location":"backend/tracmin/seguridad/","title":"API Seguridad - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/seguridad/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Sistema de autenticaci\u00f3n y autorizaci\u00f3n basado en JWT (JSON Web Tokens) con manejo de roles y permisos espec\u00edficos.</p> Notas Importantes <ul> <li>Sistema de autenticaci\u00f3n y autorizaci\u00f3n basado en JWT (JSON Web Tokens) con manejo de roles y permisos espec\u00edficos.</li> <li>configuracion basica:      configuracion basica<pre><code>SECRET_KEY = os.environ[\"HASH_KEY\"]\nALGORITHM = \"HS256\"\nACCESS_TOKEN_EXPIRE_MINUTES = 1440  # 24 horas\n\nsecurity_scheme = OAuth2PasswordBearer(tokenUrl=f\"{APP_PATH}/login\")\npwd_context = CryptContext(schemes=[\"bcrypt\"], deprecated=\"auto\")\n</code></pre></li> <li>modelos token:     modelos token<pre><code>class Token(BaseModel):\n    access_token: str\n    token_type: str\n\nclass TokenData(BaseModel):\n    nombre: str | None = None\n</code></pre></li> </ul> Consideraciones de Seguridad <ul> <li>Mantener SECRET_KEY segura (Key Vault)</li> <li>Usar HTTPS</li> <li>Implementar rate limiting</li> <li>Rotar tokens regularmente</li> <li>Validar inputs</li> <li>Mantener dependencias actualizadas</li> </ul> Mejores Pr\u00e1cticas <ul> <li>Usar variables de entorno</li> <li>Implementar logging de seguridad</li> <li>Manejar errores consistentemente</li> <li>Validar permisos granularmente</li> <li>Mantener tokens con scope m\u00ednimo necesario</li> </ul>"},{"location":"backend/tracmin/seguridad/#endpoints-seguridad","title":"Endpoints Seguridad","text":"<ul> <li><code>POST /api/logipath/login</code></li> <li><code>POST /api/logipath/token_activo_admin</code></li> <li><code>POST /api/logipath/token_activo_user</code></li> </ul> FuncionesSequence Diagram Verificaci\u00f3n de Contrase\u00f1a Verificaci\u00f3n de Contrase\u00f1a<pre><code>    def verify_password(plain_password, hashed_password):\n    \"\"\"\n    Verifica si una contrase\u00f1a en texto plano coincide con su hash.\n\n    Args:\n        plain_password (str): Contrase\u00f1a en texto plano\n        hashed_password (str): Hash de la contrase\u00f1a\n\n    Returns:\n        bool: True si coinciden, False si no\n    \"\"\"\n</code></pre> Generaci\u00f3n de Hash de Contrase\u00f1a Generaci\u00f3n de Hash de Contrase\u00f1a<pre><code>    def get_password_hash(password):\n    \"\"\"\n    Genera un hash seguro de una contrase\u00f1a.\n\n    Args:\n        password (str): Contrase\u00f1a en texto plano\n\n    Returns:\n        str: Hash de la contrase\u00f1a\n    \"\"\"\n</code></pre> Decodificaci\u00f3n y Validaci\u00f3n de Token JWT Decodificaci\u00f3n y Validaci\u00f3n de Token JWT<pre><code>    def decode_jwt(token: str, admin: int) -&gt; Any:\n    \"\"\"\n    Decodifica y valida un token JWT.\n\n    Args:\n        token (str): Token JWT a validar\n        admin (int): Nivel de privilegios requerido (0: usuario, 1-2: admin)\n\n    Returns:\n        TokenData: Datos del token decodificado\n\n    Raises:\n        HTTPException: Si el token es inv\u00e1lido o los privilegios son insuficientes\n    \"\"\"\n</code></pre> Generaci\u00f3n de Token JWT Generaci\u00f3n de Token JWT<pre><code>    def create_access_token(data: dict, expires_delta: timedelta | None = None):\n    \"\"\"\n    Genera un nuevo token JWT.\n\n    Args:\n        data (dict): Datos a incluir en el token\n        expires_delta (timedelta, optional): Tiempo de expiraci\u00f3n\n\n    Returns:\n        str: Token JWT generado\n    \"\"\"\n</code></pre> <pre><code>sequenceDiagram\nparticipant Cliente\nparticipant API\nparticipant DB\n\nCliente-&gt;&gt;API: POST /login\nAPI-&gt;&gt;DB: Verificar Credenciales\n\nalt Credenciales V\u00e1lidas\n    DB--&gt;&gt;API: Datos Usuario\n    API-&gt;&gt;API: Generar JWT\n    API--&gt;&gt;Cliente: Token\nelse Credenciales Inv\u00e1lidas\n    API--&gt;&gt;Cliente: Error 401\nend\n\nCliente-&gt;&gt;API: Request con Token\nAPI-&gt;&gt;API: Decodificar JWT\n\nalt Token V\u00e1lido\n    API-&gt;&gt;API: Verificar Permisos\n    alt Permisos Suficientes\n        API--&gt;&gt;Cliente: Respuesta\n    else Permisos Insuficientes\n        API--&gt;&gt;Cliente: Error 403\n    end\nelse Token Inv\u00e1lido\n    API--&gt;&gt;Cliente: Error 401\nend</code></pre>"},{"location":"backend/tracmin/admin/camiones/","title":"API Camiones - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/admin/camiones/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Sistema de gesti\u00f3n de flota que permite crear, modificar y consultar informaci\u00f3n de camiones y acoplados en el sistema.</p> Notas Importantes <ul> <li>Sistema CRUD para gesti\u00f3n de camiones</li> <li>Requiere autenticaci\u00f3n JWT para operaciones</li> <li>Modelo principal:     modelos<pre><code>class DeviceAdminRequest(BaseModel):\n    Patente: Optional[str] = None\n    Id: Optional[int] = None\n    CodigoTransportista: Optional[str] = None\n    Codigo: Optional[str] = None\n    Activo: Optional[bool] = None\n    Acoplado: bool = False\n</code></pre></li> </ul> Consideraciones de Seguridad <ul> <li>Validar permisos de administrador</li> <li>Validar datos \u00fanicos (Patente)</li> <li>Manejar errores de integridad</li> <li>Validar relaci\u00f3n con transportistas</li> <li>Proteger informaci\u00f3n sensible de la flota</li> </ul> Mejores Pr\u00e1cticas <ul> <li>Validar formato de patentes</li> <li>Verificar existencia de transportista</li> <li>Implementar logging de cambios</li> <li>Mantener historial de modificaciones</li> <li>Validar estado de activo/inactivo</li> </ul>"},{"location":"backend/tracmin/admin/camiones/#endpoints-camiones","title":"Endpoints Camiones","text":"<ul> <li><code>POST /api/logipath/get_trucks</code></li> <li><code>POST /api/logipath/admin/devices</code></li> </ul> EndpointsSequence DiagramEjemplos de RespuestaC\u00f3digos de Estado Consultar Camiones POST /api/logipath/get_trucks<pre><code>@router.post(f\"{APP_PATH}/get_trucks\")\nasync def get_trucks(sec: Annotated[str, Depends(security_scheme)]):\n    \"\"\"\n    Retorna lista de camiones y acoplados.\n\n    Args:\n        sec (str): Token JWT de autenticaci\u00f3n\n\n    Returns:\n        dict: {\n            \"results\": [Lista de camiones],\n            \"acoplados\": [Lista de acoplados]\n        }\n\n    Raises:\n        HTTPException: Si el token es inv\u00e1lido\n    \"\"\"\n</code></pre> Agregar/Modificar Cami\u00f3n POST /api/logipath/admin/devices<pre><code>@router.post(f\"{APP_PATH}/admin/devices\")\nasync def add_device(\n    sec: Annotated[str, Depends(security_scheme)], \n    req: DeviceAdminRequest\n):\n    \"\"\"\n    Crea o modifica un cami\u00f3n en el sistema.\n\n    Args:\n        sec (str): Token JWT de administrador\n        req (DeviceAdminRequest): Datos del cami\u00f3n\n\n    Returns:\n        dict: {\"message\": \"truck added/edited correctly\"}\n\n    Raises:\n        HTTPException: \n            - 400: Si la patente ya existe\n            - 401: Si el token es inv\u00e1lido\n    \"\"\"\n</code></pre> <pre><code>sequenceDiagram\n    participant Cliente\n    participant API\n    participant DB\n\n    alt Consultar Camiones\n        Cliente-&gt;&gt;API: POST /get_trucks\n        API-&gt;&gt;API: Validar JWT\n        API-&gt;&gt;DB: Query Camiones\n        DB--&gt;&gt;API: Listas\n        API--&gt;&gt;Cliente: Results + Acoplados\n\n    else Crear/Modificar Cami\u00f3n\n        Cliente-&gt;&gt;API: POST /admin/devices\n        API-&gt;&gt;API: Validar JWT Admin\n        API-&gt;&gt;DB: Verificar Patente\n\n        alt Modificaci\u00f3n\n            API-&gt;&gt;DB: Actualizar Cami\u00f3n\n            DB--&gt;&gt;API: Confirmaci\u00f3n\n            API--&gt;&gt;Cliente: Success\n        else Creaci\u00f3n\n            alt Patente Existe\n                API--&gt;&gt;Cliente: Error 400\n            else\n                API-&gt;&gt;DB: Crear Cami\u00f3n\n                DB--&gt;&gt;API: Confirmaci\u00f3n\n                API--&gt;&gt;Cliente: Success\n            end\n        end\n    end</code></pre> Consulta Exitosa <pre><code>{\n    \"results\": [\n        {\n            \"Id\": 1,\n            \"Patente\": \"ABCD12\",\n            \"CodigoTransportista\": \"TRANS1\",\n            \"Codigo\": \"CAM001\",\n            \"Activo\": true,\n            \"Acoplado\": false\n        }\n    ],\n    \"acoplados\": [\n        {\n            \"Id\": 2,\n            \"Patente\": \"WXYZ34\",\n            \"CodigoTransportista\": \"TRANS1\",\n            \"Codigo\": \"ACO001\",\n            \"Activo\": true,\n            \"Acoplado\": true\n        }\n    ]\n}\n</code></pre> Error Patente Duplicada <pre><code>{\n    \"detail\": {\n        \"message\": \"Patente ya existe, por favor elige una Patente diferente\"\n    }\n}\n</code></pre> <ul> <li><code>200</code>: Operaci\u00f3n exitosa</li> <li><code>400</code>: Error de validaci\u00f3n (patente duplicada)</li> <li><code>401</code>: No autorizado</li> <li><code>403</code>: Permisos insuficientes</li> <li><code>500</code>: Error interno del servidor</li> </ul> Validaciones Importantes <ul> <li>Formato de patente seg\u00fan normativa chilena</li> <li>Existencia del c\u00f3digo de transportista</li> <li>Estado activo/inactivo coherente</li> <li>Relaci\u00f3n correcta entre cami\u00f3n y acoplado</li> <li>Unicidad de c\u00f3digos internos</li> </ul>"},{"location":"backend/tracmin/admin/clientes/","title":"API Clientes - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/admin/clientes/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Sistema de gesti\u00f3n de clientes que permite consultar informaci\u00f3n de clientes registrados en el sistema.</p> Notas Importantes <ul> <li>Requiere autenticaci\u00f3n JWT para todas las operaciones</li> <li>Solo lectura (consulta de clientes)</li> <li>Modelo principal:     modelos<pre><code>class Client(BaseModel):\n    Codigo: str\n    Nombre: str\n    Rut: str\n    Activo: bool\n    Latitud: float\n    Longitud: float\n</code></pre></li> </ul> Consideraciones de Seguridad <ul> <li>Validar permisos de usuario</li> <li>Proteger rutas sensibles</li> <li>No exponer informaci\u00f3n sensible</li> </ul> Mejores Pr\u00e1cticas <ul> <li>Validar el token antes de procesar</li> <li>Manejar errores de forma consistente</li> <li>Mantener consistencia en respuestas</li> <li>Documentar c\u00f3digos de error</li> </ul>"},{"location":"backend/tracmin/admin/clientes/#endpoints-clientes","title":"Endpoints Clientes","text":"<ul> <li><code>POST /api/logipath/get_clients</code></li> </ul> EndpointsSequence DiagramEjemplo de Respuesta Exitosa Consultar Clientes POST /api/logipath/get_clients<pre><code>@router.post(f\"{APP_PATH}/get_clients\")\nasync def get_clients(sec: Annotated[str, Depends(security_scheme)]):\n    \"\"\"\n    Obtiene todos los clientes disponibles.\n    Returns:\n        dict: {\n            \"results\": [Lista de clientes]\n        }\n    \"\"\"\n    # ...\n    return {\n        \"results\": [/* ... */]\n    }\n</code></pre> <pre><code>sequenceDiagram\n    participant Cliente\n    participant API\n    participant DB\n\n    Cliente-&gt;&gt;API: POST /get_clients\n    API-&gt;&gt;API: Validar JWT\n    API-&gt;&gt;DB: Query Clientes\n    DB--&gt;&gt;API: Lista Clientes\n    API--&gt;&gt;Cliente: Results</code></pre> Consulta Exitosa <pre><code>{\n    \"results\": [\n        {\n            \"Codigo\": \"CL001\",\n            \"Nombre\": \"Cliente Ejemplo\",\n            \"Rut\": \"12345678-9\",\n            \"Activo\": true,\n            \"Latitud\": -33.4569,\n            \"Longitud\": -70.6483\n        }\n    ]\n}\n</code></pre>"},{"location":"backend/tracmin/admin/clientes/#api-clientes-documentacion_1","title":"API Clientes - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/admin/clientes/#descripcion-general_1","title":"Descripci\u00f3n General","text":"<p>Sistema de gesti\u00f3n de clientes que permite crear, modificar y consultar informaci\u00f3n de clientes en el sistema.</p> Notas Importantes <ul> <li>Sistema CRUD para gesti\u00f3n de clientes</li> <li>Requiere autenticaci\u00f3n JWT para operaciones</li> <li>Modelo principal:     modelos<pre><code>class clientAdminRequest(BaseModel):\n    Id: Optional[int] = None\n    Rut: Optional[str] = None\n    Codigo: Optional[str] = None\n    Latitud: Optional[float] = None\n    Longitud: Optional[float] = None\n    Direccion: Optional[str] = None\n    Comuna: Optional[str] = None\n    Region: Optional[str] = None\n    Romana: Optional[bool] = None\n    Activo: Optional[bool] = None\n    Mod: Optional[bool] = None\n</code></pre></li> </ul> Consideraciones de Seguridad <ul> <li>Validar permisos de administrador</li> <li>Validar datos \u00fanicos (Rut)</li> <li>Manejar errores de integridad</li> <li>Validar coordenadas geogr\u00e1ficas</li> <li>Proteger informaci\u00f3n sensible del cliente</li> </ul> Mejores Pr\u00e1cticas <ul> <li>Validar formato de Rut</li> <li>Validar coordenadas dentro de rangos v\u00e1lidos</li> <li>Implementar logging de cambios</li> <li>Mantener historial de modificaciones</li> <li>Validar datos de direcci\u00f3n</li> </ul>"},{"location":"backend/tracmin/admin/clientes/#endpoints-clientes_1","title":"Endpoints Clientes","text":"<ul> <li><code>POST /api/logipath/get_clients</code></li> <li><code>POST /api/logipath/admin/clients</code></li> </ul> EndpointsSequence DiagramEjemplos de Respuesta Consultar Clientes POST /api/logipath/get_clients<pre><code>@router.post(f\"{APP_PATH}/get_clients\")\nasync def get_clients(sec: Annotated[str, Depends(security_scheme)]):\n    \"\"\"\n    Retorna lista de todos los clientes registrados.\n\n    Args:\n        sec (str): Token JWT de autenticaci\u00f3n\n\n    Returns:\n        dict: {\n            \"results\": [Lista de clientes]\n        }\n\n    Raises:\n        HTTPException: Si el token es inv\u00e1lido\n    \"\"\"\n</code></pre> Agregar/Modificar Cliente POST /api/logipath/admin/clients<pre><code>@router.post(f\"{APP_PATH}/admin/clients\")\nasync def add_client(\n    sec: Annotated[str, Depends(security_scheme)], \n    req: clientAdminRequest\n):\n    \"\"\"\n    Crea o modifica un cliente en el sistema.\n\n    Args:\n        sec (str): Token JWT de administrador\n        req (clientAdminRequest): Datos del cliente\n\n    Returns:\n        dict: {\"message\": \"usuario agregado/editado correctamente\"}\n\n    Raises:\n        HTTPException: \n            - 400: Si el Rut ya existe\n            - 401: Si el token es inv\u00e1lido\n    \"\"\"\n</code></pre> <pre><code>sequenceDiagram\n    participant Cliente\n    participant API\n    participant DB\n\n    alt Consultar Clientes\n        Cliente-&gt;&gt;API: POST /get_clients\n        API-&gt;&gt;API: Validar JWT\n        API-&gt;&gt;DB: Query Clientes\n        DB--&gt;&gt;API: Lista Clientes\n        API--&gt;&gt;Cliente: Results\n\n    else Crear/Modificar Cliente\n        Cliente-&gt;&gt;API: POST /admin/clients\n        API-&gt;&gt;API: Validar JWT Admin\n        API-&gt;&gt;DB: Verificar Rut\n\n        alt Modificaci\u00f3n\n            API-&gt;&gt;DB: Actualizar Cliente\n            DB--&gt;&gt;API: Confirmaci\u00f3n\n            API--&gt;&gt;Cliente: Success\n        else Creaci\u00f3n\n            alt Rut Existe\n                API--&gt;&gt;Cliente: Error 400\n            else\n                API-&gt;&gt;DB: Crear Cliente\n                DB--&gt;&gt;API: Confirmaci\u00f3n\n                API--&gt;&gt;Cliente: Success\n            end\n        end\n    end</code></pre> Consulta Exitosa <pre><code>{\n    \"results\": [\n        {\n            \"Id\": 1,\n            \"Rut\": \"12345678-9\",\n            \"Codigo\": \"CLI1\",\n            \"Latitud\": -33.4569,\n            \"Longitud\": -70.6483,\n            \"Direccion\": \"Ejemplo 123\",\n            \"Comuna\": \"Santiago\",\n            \"Region\": \"Metropolitana\",\n            \"Romana\": true,\n            \"Activo\": true\n        }\n    ]\n}\n</code></pre> Error Rut Duplicado <pre><code>{\n    \"detail\": {\n        \"message\": \"Cliente ya existe, por favor elige un Rut diferente\"\n    }\n}\n</code></pre>"},{"location":"backend/tracmin/admin/transportistas/","title":"API Transportistas - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/admin/transportistas/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Sistema de gesti\u00f3n de transportistas que permite crear y consultar informaci\u00f3n de empresas transportistas en el sistema.</p> Notas Importantes <ul> <li>Sistema CRUD para gesti\u00f3n de transportistas</li> <li>Requiere autenticaci\u00f3n JWT para todas las operaciones</li> <li>Modelo principal:     modelos<pre><code>class TransportistaRequest(BaseModel):\n    NombreTransportista: str\n    Rut: str\n    Codigo: str\n    Activo: bool\n</code></pre></li> </ul> Consideraciones de Seguridad <ul> <li>Validar permisos de administrador</li> <li>Validar datos \u00fanicos (Rut)</li> <li>Manejar errores de integridad</li> <li>Proteger rutas sensibles</li> <li>Validar formato de Rut</li> </ul> Mejores Pr\u00e1cticas <ul> <li>Validar inputs antes de procesar</li> <li>Manejar errores de forma consistente</li> <li>Implementar logging de operaciones</li> <li>Mantener consistencia en respuestas</li> <li>Documentar c\u00f3digos de error</li> </ul>"},{"location":"backend/tracmin/admin/transportistas/#endpoints-transportistas","title":"Endpoints Transportistas","text":"<ul> <li><code>POST /api/logipath/transportistas</code></li> <li><code>POST /api/logipath/crear_transportista</code></li> <li><code>POST /api/logipath/validar_bbdd</code></li> </ul> EndpointsSequence DiagramEjemplo de Respuesta Exitosa Consultar Transportistas POST /api/logipath/transportistas<pre><code>@router.post(f\"{APP_PATH}/transportistas\")\nasync def return_users(sec: Annotated[str, Depends(security_scheme)]):\n    \"\"\"\n    Retorna lista de todos los transportistas registrados.\n    Returns:\n        dict: {\n            \"message\": \"queried successfully\",\n            \"objects\": [Lista de transportistas]\n        }\n    \"\"\"\n    # ...\n    return {\n        \"message\": \"queried successfully\",\n        \"objects\": [/* ... */]\n    }\n</code></pre> Agregar Transportista, Usuarios y Camiones (Flujo Completo) POST /api/logipath/crear_transportista<pre><code>@router.post(f\"{APP_PATH}/crear_transportista\")\nasync def add_transportistas_flujo(\n    sec: Annotated[str, Depends(security_scheme)],\n    req: TransportistaFlujoRequest\n):\n    \"\"\"\n    Agrega un transportista, sus usuarios y camiones en un solo flujo.\n    Valida unicidad y consistencia de datos antes de insertar.\n    Returns:\n        dict: {\n            \"success\": true,\n            \"message\": \"Datos validados correctamente\",\n            \"resumen\": {...},\n            \"datos_validados\": {...}\n        }\n    \"\"\"\n    # ...\n    return {\n        \"success\": True,\n        \"message\": \"Datos validados correctamente\",\n        \"resumen\": {/* ... */},\n        \"datos_validados\": {/* ... */}\n    }\n</code></pre> Validar existencia en BBDD (Transportista, Usuario, Cami\u00f3n) POST /api/logipath/validar_bbdd<pre><code>@router.post(f\"{APP_PATH}/validar_bbdd\")\nasync def validaciones_datos_bbdd(sec: Annotated[str, Depends(security_scheme)], req: validacion):\n    \"\"\"\n    Valida si existe un transportista, usuario o cami\u00f3n en la base de datos seg\u00fan el tipo y c\u00f3digo/RUT entregado.\n    Returns:\n        dict: {\n            \"message\": \"El transportista ya existe\" | \"No existe\",\n            \"existe\": true | false\n        }\n    \"\"\"\n    # ...\n    return {\n        \"message\": \"El transportista ya existe\",\n        \"existe\": True\n    }\n</code></pre> <pre><code>sequenceDiagram\n    participant Cliente\n    participant API\n    participant DB\n\n    alt Consultar Transportistas\n        Cliente-&gt;&gt;API: POST /transportistas\n        API-&gt;&gt;API: Validar JWT\n        API-&gt;&gt;DB: Query Transportistas\n        DB--&gt;&gt;API: Lista Transportistas\n        API--&gt;&gt;Cliente: Results\n\n    else Alta Transportista/Usuarios/Camiones\n        Cliente-&gt;&gt;API: POST /crear_transportista\n        API-&gt;&gt;API: Validar JWT Admin\n        API-&gt;&gt;DB: Validar datos\n        API-&gt;&gt;DB: Verificar unicidad\n        API-&gt;&gt;DB: Insertar transportista\n        API-&gt;&gt;DB: Insertar usuarios\n        API-&gt;&gt;DB: Insertar camiones\n        DB--&gt;&gt;API: Confirmaci\u00f3n\n        API--&gt;&gt;Cliente: Success\n\n    else Validar existencia en BBDD\n        Cliente-&gt;&gt;API: POST /validar_bbdd\n        API-&gt;&gt;API: Validar JWT\n        API-&gt;&gt;DB: Buscar por tipo y c\u00f3digo\n        DB--&gt;&gt;API: Resultado\n        API--&gt;&gt;Cliente: Existe/No existe\n    end</code></pre> Alta Exitosa <pre><code>{\n    \"success\": true,\n    \"message\": \"Datos validados correctamente\",\n    \"resumen\": {\n        \"transportista\": \"TRANSPORTES EJEMPLO\",\n        \"total_usuarios\": 2,\n        \"usuarios_admin\": 1,\n        \"total_camiones\": 3,\n        \"camiones_acoplados\": 1\n    },\n    \"datos_validados\": {\n        \"transportista\": {\n            \"rut\": \"12345678-9\",\n            \"nombre\": \"TRANSPORTES EJEMPLO\",\n            \"codigo\": \"TRX\",\n            \"activo\": true\n        },\n        \"usuarios\": [\n            {\n                \"rut\": \"11111111-1\",\n                \"nombre_completo\": \"Juan Perez\",\n                \"telefono\": \"987654321\",\n                \"email\": \"juan@ejemplo.cl\",\n                \"activo\": true,\n                \"admin\": true,\n                \"rol\": \"Transportista\"\n            }\n        ],\n        \"camiones\": [\n            {\n                \"codigo\": \"CAM001\",\n                \"patente\": \"AB1234\",\n                \"activo\": true,\n                \"acoplado\": false\n            }\n        ]\n    }\n}\n</code></pre>"},{"location":"backend/tracmin/admin/usuarios/","title":"API Users - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/admin/usuarios/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Sistema de gesti\u00f3n de usuarios y transportistas que permite crear, modificar y consultar informaci\u00f3n de usuarios del sistema.</p> Notas Importantes <ul> <li>Sistema CRUD para gesti\u00f3n de usuarios</li> <li>Requiere autenticaci\u00f3n JWT para operaciones administrativas</li> <li>Modelos principales:     modelos<pre><code>class UserAdminRequest(BaseModel):\n    Rut: Optional[str] = None\n    Id: Optional[int] = None\n    CodigoTransportista: Optional[str] = None\n    Nombre: Optional[str] = None\n    Apellido: Optional[str] = None\n    Telefono: Optional[str] = None\n    Email: Optional[str] = None\n    Activo: Optional[bool] = None\n    Admin: Optional[int] = None\n    Contrasena: Optional[str] = None\n    Mod: Optional[bool] = None\n</code></pre></li> </ul> Consideraciones de Seguridad <ul> <li>Validar permisos de administrador</li> <li>Encriptar contrase\u00f1as</li> <li>Validar datos \u00fanicos (Rut)</li> <li>Manejar errores de integridad</li> <li>Proteger rutas sensibles</li> </ul> Mejores Pr\u00e1cticas <ul> <li>Validar inputs</li> <li>Manejar errores consistentemente</li> <li>Documentar respuestas de error</li> <li>Implementar logging</li> <li>Mantener consistencia en respuestas</li> </ul>"},{"location":"backend/tracmin/admin/usuarios/#endpoints-users","title":"Endpoints Users","text":"<ul> <li><code>POST /api/logipath/admin/users</code></li> <li><code>POST /api/logipath/users</code></li> </ul> EndpointsSequence Diagram Agregar/Modificar Usuario POST /api/logipath/admin/users<pre><code>@router.post(f\"{APP_PATH}/admin/users\")\nasync def add_user(sec: Annotated[str, Depends(security_scheme)], req: UserAdminRequest):\n    \"\"\"\n    Crea o modifica un usuario en el sistema.\n\n    Args:\n        sec (str): Token JWT de administrador\n        req (UserAdminRequest): Datos del usuario\n\n    Returns:\n        dict: Mensaje de confirmaci\u00f3n\n\n    Raises:\n        HTTPException: Si el Rut ya existe o hay errores de validaci\u00f3n\n    \"\"\"\n</code></pre> Consultar Usuarios POST /api/logipath/users<pre><code>@router.post(f\"{APP_PATH}/users\")\nasync def return_users(req: Request):\n    \"\"\"\n    Retorna lista de usuarios del sistema.\n\n    Args:\n        req (Request): Request con key de autorizaci\u00f3n\n\n    Returns:\n        dict: Lista de usuarios con sus datos\n\n    Raises:\n        HTTPException: Si la key es inv\u00e1lida\n    \"\"\"\n</code></pre> <pre><code>sequenceDiagram\n    participant Cliente\n    participant API\n    participant DB\n\n    alt Crear/Modificar Usuario\n        Cliente-&gt;&gt;API: POST /admin/users\n        API-&gt;&gt;API: Validar JWT Admin\n        API-&gt;&gt;DB: Verificar Rut Existente\n\n        alt Rut Existe\n            DB--&gt;&gt;API: Usuario Existente\n            alt Modificaci\u00f3n\n                API-&gt;&gt;DB: Actualizar Usuario\n                DB--&gt;&gt;API: Confirmaci\u00f3n\n                API--&gt;&gt;Cliente: Success\n            else Creaci\u00f3n\n                API--&gt;&gt;Cliente: Error 400\n            end\n        else Rut No Existe\n            API-&gt;&gt;DB: Crear Usuario\n            DB--&gt;&gt;API: Confirmaci\u00f3n\n            API--&gt;&gt;Cliente: Success\n        end\n\n    else Consultar Usuarios\n        Cliente-&gt;&gt;API: POST /users\n        API-&gt;&gt;API: Validar Key\n\n        alt Key V\u00e1lida\n            API-&gt;&gt;DB: Query Usuarios\n            DB--&gt;&gt;API: Lista Usuarios\n            API--&gt;&gt;Cliente: Lista Usuarios\n        else Key Inv\u00e1lida\n            API--&gt;&gt;Cliente: Unauthorized\n        end\n    end</code></pre>"},{"location":"backend/tracmin/fotos/procesamiento_ia/","title":"API Procesamiento IA","text":""},{"location":"backend/tracmin/fotos/procesamiento_ia/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Endpoint para procesar tickets mediante Azure Form Recognizer, extrayendo informaci\u00f3n relevante y almacen\u00e1ndola en la base de datos.</p> Notas Importantes <ul> <li>Utiliza Azure Form Recognizer para OCR</li> <li>Validaci\u00f3n de tickets duplicados</li> <li>Manejo de diferentes escenarios de cliente</li> <li>Procesamiento de peso y validaciones</li> <li>Almacenamiento estructurado de datos extra\u00eddos</li> </ul> Consideraciones Importantes <ul> <li>El link del blob debe ser accesible</li> <li>El modelo de IA debe estar entrenado</li> <li>Validaciones espec\u00edficas de peso</li> <li>Manejo de casos sin romana</li> <li>Tratamiento de errores de IA</li> <li>Validaciones de Peso:     <pre><code>    # Reglas de validaci\u00f3n\n    if len(peso) &lt;= 6:\n        peso = peso.replace(\".\", \"\")\n    if 20000 &gt;= int(peso) &gt;= 35000:\n        peso = \"PESO NO V\u00c1LIDO\"\n    else:\n        peso = \"PESO NO V\u00c1LIDO\"\n</code></pre></li> </ul> Mejores Pr\u00e1cticas <ul> <li>Validar formato de im\u00e1genes</li> <li>Implementar retry logic</li> <li>Monitorear confianza de IA</li> <li>Mantener logs detallados</li> <li>Validar datos extra\u00eddos</li> </ul>"},{"location":"backend/tracmin/fotos/procesamiento_ia/#endpoint-procesamiento-ia","title":"Endpoint Procesamiento IA","text":"<p><code>POST /api/logipath/procesamiento_ia</code></p> Flujo ExplicadoEstados y RespuestasFlujo DiagramaSequence Diagram <pre><code>graph TD\n    A[Cliente] --&gt; B{Validar JWT}\n    B --&gt;|Invalid| C[Error 401]\n    B --&gt;|Valid| D{Verificar Cliente}\n\n    D --&gt;|No Encontrado| E[Crear Ticket Sin Cliente]\n    D --&gt;|Encontrado| F{Tiene Romana?}\n\n    F --&gt;|No| G[Crear Ticket Sin Romana]\n    F --&gt;|Si| H[Procesar con IA]\n\n    H --&gt;|Error| I[Crear Ticket Inv\u00e1lido]\n    H --&gt;|Success| J[Extraer Campos]\n\n    J --&gt; K[Validar Peso]\n    K --&gt; L[Crear Ticket]\n\n    L --&gt; M[Commit DB]\n    M --&gt; N[Return Response]\n\n    E --&gt; N\n    G --&gt; N\n    I --&gt; N</code></pre> <pre><code>sequenceDiagram\n    participant Client\n    participant API\n    participant Form Recognizer\n    participant DB\n\n    Client-&gt;&gt;API: POST /procesamiento_ia\n    API-&gt;&gt;DB: Verificar Cliente\n\n    alt Cliente con Romana\n        API-&gt;&gt;Form Recognizer: Analizar Documento\n\n        alt An\u00e1lisis Exitoso\n            Form Recognizer--&gt;&gt;API: Datos Extra\u00eddos\n            API-&gt;&gt;API: Validar Peso\n            API-&gt;&gt;DB: Guardar Ticket\n        else Error An\u00e1lisis\n            API-&gt;&gt;DB: Guardar Ticket Inv\u00e1lido\n        end\n\n    else Cliente sin Romana\n        API-&gt;&gt;DB: Guardar Ticket Sin Romana\n    else Cliente No Encontrado\n        API-&gt;&gt;DB: Guardar Ticket Sin Cliente\n    end\n\n    DB--&gt;&gt;API: Commit Success\n    API--&gt;&gt;Client: Response</code></pre>"},{"location":"backend/tracmin/fotos/procesamiento_ia/#1-verificacion-inicial","title":"1. Verificaci\u00f3n Inicial","text":"<ul> <li><code>Validaci\u00f3n del token JWT</code></li> <li><code>B\u00fasqueda del cliente</code></li> <li><code>Verificaci\u00f3n de ticket existente</code></li> </ul>"},{"location":"backend/tracmin/fotos/procesamiento_ia/#2-procesamiento-ia","title":"2. Procesamiento IA","text":"<ul> <li><code>Conexi\u00f3n a Form Recognizer</code></li> <li><code>An\u00e1lisis del documento</code></li> <li><code>Extracci\u00f3n de campos</code></li> <li><code>Validaci\u00f3n de peso</code></li> </ul>"},{"location":"backend/tracmin/fotos/procesamiento_ia/#3-almacenamiento","title":"3. Almacenamiento","text":"<ul> <li><code>Creaci\u00f3n de objeto TripTicket</code></li> <li><code>Persistencia en base de datos</code></li> <li><code>Manejo de casos especiales</code></li> </ul> Estructura de API IA<pre><code>{\n    \"Cliente\": \"string\",\n    \"LinkBlob\": \"string\",\n    \"BlobName\": \"string\"\n}\n</code></pre>"},{"location":"backend/tracmin/fotos/procesamiento_ia/#respuestas","title":"Respuestas","text":"<p>\u00c9xito Con Romana<pre><code>{\n    \"IdTicket\": \"TKTxxxx-1234\",\n    \"status_code\": 200,\n    \"PesoConfirmado\": \"25000\"\n}\n</code></pre> Exito Sin Romana<pre><code>{\n    \"IdTicket\": \"TKTxxxx-1234\",\n    \"status_code\": 200\n}\n</code></pre> Error<pre><code>{\n    \"IdTicket\": \"TKTxxxx-1234\",\n    \"status_code\": 409,\n    \"message\": \"Ticket ya existe\"\n}\n</code></pre></p>"},{"location":"backend/tracmin/fotos/upload_photo/","title":"API Upload Photo","text":""},{"location":"backend/tracmin/fotos/upload_photo/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Endpoint para subir fotos de tickets/comprobantes asociados a viajes, con almacenamiento en Azure Blob Storage y actualizaci\u00f3n de referencias en la base de datos.</p> Notas Importantes <ul> <li>Requiere autenticaci\u00f3n JWT</li> <li>Manejo autom\u00e1tico de zonas horarias</li> <li>Generaci\u00f3n aleatoria de nombres de blob</li> <li>Almacenamiento en Azure Blob Storage</li> <li>Actualizaci\u00f3n at\u00f3mica en base de datos</li> </ul> Consideraciones Importantes <ul> <li>La imagen debe estar en formato base64</li> <li>El timestamp debe estar en formato compatible</li> <li>El tama\u00f1o m\u00e1ximo de la imagen puede estar limitado</li> <li>La conexi\u00f3n a Azure debe estar configurada</li> <li>El viaje debe existir en la base de datos</li> </ul> Mejores Pr\u00e1cticas <ul> <li>Validar el formato de la imagen antes del env\u00edo</li> <li>Comprimir im\u00e1genes grandes</li> <li>Implementar retry logic para fallos de Azure</li> <li>Mantener logs detallados  </li> <li>Validar tipos MIME</li> </ul>"},{"location":"backend/tracmin/fotos/upload_photo/#endpoint-upload-photo","title":"Endpoint Upload Photo","text":"<p><code>POST /api/logipath/upload_photo</code></p> Flujo ExplicadoEstados y RespuestasFlujo DiagramaSequence Diagram <pre><code>graph TD\n    A[Cliente] --&gt; B{Validar JWT}\n    B --&gt;|Invalid| C[Error 401]\n    B --&gt;|Valid| D[Decodificar Base64]\n\n    D --&gt; E[Normalizar Timestamp]\n    E --&gt; F[Conectar Azure Blob]\n\n    F --&gt; G[Generar Nombre Blob]\n    G --&gt; H[Upload Imagen]\n\n    H --&gt; I[Buscar Viaje]\n    I --&gt;|No Encontrado| J[Return Not Found]\n    I --&gt;|Encontrado| K[Actualizar IdTicket]\n\n    K --&gt; L[Commit DB]\n    L --&gt; M[Return Success]</code></pre> <pre><code>sequenceDiagram\n    participant Client\n    participant API\n    participant Azure Blob\n    participant DB\n\n    Client-&gt;&gt;API: POST /upload_photo\n    API-&gt;&gt;API: Validar JWT\n\n    API-&gt;&gt;API: Decodificar Base64\n\n    API-&gt;&gt;Azure Blob: Upload Imagen\n    Azure Blob--&gt;&gt;API: URL Imagen\n\n    API-&gt;&gt;DB: Buscar Viaje\n\n    alt Viaje Encontrado\n        API-&gt;&gt;DB: Actualizar IdTicket\n        DB--&gt;&gt;API: Commit Success\n        API--&gt;&gt;Client: Success + URL\n    else Viaje No Encontrado\n        API--&gt;&gt;Client: Not Found Error\n    end</code></pre>"},{"location":"backend/tracmin/fotos/upload_photo/#1-validacion-y-preparacion","title":"1. Validaci\u00f3n y Preparaci\u00f3n","text":"<ul> <li><code>Verificaci\u00f3n del token JWT</code></li> <li><code>Decodificaci\u00f3n de imagen base64</code></li> <li><code>Normalizaci\u00f3n de timestamp</code></li> </ul>"},{"location":"backend/tracmin/fotos/upload_photo/#2-almacenamiento-en-azure","title":"2. Almacenamiento en Azure","text":"<ul> <li><code>Conexi\u00f3n a Blob Storage</code></li> <li><code>Generaci\u00f3n de nombre \u00fanico</code></li> <li><code>Upload de imagen</code></li> <li><code>Configuraci\u00f3n de content type</code></li> </ul>"},{"location":"backend/tracmin/fotos/upload_photo/#3-actualizacion-en-base-de-datos","title":"3. Actualizaci\u00f3n en Base de Datos","text":"<ul> <li><code>B\u00fasqueda del viaje asociado</code></li> <li><code>Actualizaci\u00f3n de referencia</code></li> <li><code>Commit de cambios</code></li> </ul> Estructura de upload photo<pre><code>{\n    \"data\": \"string (base64)\",\n    \"folio\": \"number\",\n    \"cliente\": \"string\",\n    \"IdProgramado\": \"number\",\n    \"RutConductor\": \"string\",\n    \"HoraInicioJornada\": \"datetime\"\n}\n</code></pre>"},{"location":"backend/tracmin/fotos/upload_photo/#respuestas-posibles","title":"Respuestas Posibles","text":"<p>\u00c9xito<pre><code>{\n    \"blob_name\": \"TKTxxxx-1234\",\n    \"link\": \"https://storage.azure.com/...\",\n    \"status_code\": 200\n}\n</code></pre> No se encontr\u00f3 el viaje<pre><code>{\n    \"message\": \"No se encontr\u00f3 el viaje\"\n}\n</code></pre> Error<pre><code>{\n    \"detail\": \"Mensaje espec\u00edfico del error\",\n    \"status_code\": 500\n}\n</code></pre></p>"},{"location":"backend/tracmin/fotos/upload_photo_pending/","title":"API Subir Foto Pendiente - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/fotos/upload_photo_pending/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Endpoint para gestionar la carga de fotos pendientes de viajes anteriores, permitiendo asociar im\u00e1genes a viajes hist\u00f3ricos y actualizar su informaci\u00f3n.</p> Notas Importantes <ul> <li>Manejo de fotos pendientes de viajes pasados</li> <li>Almacenamiento en Azure Blob Storage</li> <li>Actualizaci\u00f3n de registros hist\u00f3ricos</li> <li>Manejo de metadatos del viaje</li> <li>Proceso at\u00f3mico de actualizaci\u00f3n</li> </ul> Consideraciones Importantes <ul> <li>La imagen debe estar en formato base64 v\u00e1lido</li> <li>El viaje debe existir en la base de datos</li> <li>Los campos se actualizan de forma selectiva</li> <li>Se genera un nuevo nombre de blob \u00fanico</li> <li>Se mantiene la trazabilidad del viaje original</li> <li>Configuraci\u00f3n Requerida:     Variables de entorno<pre><code>BLOB_CONN_STRING = \"DefaultEndpointsProtocol=https;...\"\nBLOB_CONTAINER_NAME = \"container-name\"\n</code></pre></li> </ul> Mejores Pr\u00e1cticas <ul> <li>Validar el formato de la imagen</li> <li>Implementar retry logic para Azure</li> <li>Mantener logs detallados</li> <li>Verificar permisos de actualizaci\u00f3n</li> <li>Validar integridad de datos</li> </ul>"},{"location":"backend/tracmin/fotos/upload_photo_pending/#endpoint-upload-photo-pending","title":"Endpoint Upload Photo Pending","text":"<p><code>POST /api/logipath/upload_photo_pending</code></p> Flujo ExplicadoEstados y RespuestasFlujo DiagramaSequence Diagram <pre><code>graph TD\n    A[Cliente] --&gt; B{Validar JWT}\n    B --&gt;|Invalid| C[Error 401]\n    B --&gt;|Valid| D[Decodificar Base64]\n\n    D --&gt; E[Log Info]\n    E --&gt; F[Conectar Azure Blob]\n\n    F --&gt; G[Generar Nombre Blob]\n    G --&gt; H[Upload Imagen]\n\n    H --&gt; I[Buscar ActualTrip]\n    I --&gt;|No Encontrado| J[Error 404]\n    I --&gt;|Encontrado| K[Extraer Metadata]\n\n    K --&gt; L[Actualizar Campos]\n    L --&gt; M[Commit DB]\n    M --&gt; N[Return Success]</code></pre> <pre><code>sequenceDiagram\n    participant Client\n    participant API\n    participant Azure Blob\n    participant DB\n\n    Client-&gt;&gt;API: POST /upload_photo_pending\n    API-&gt;&gt;API: Validar JWT\n\n    API-&gt;&gt;API: Decodificar Base64\n    API-&gt;&gt;API: Log Info\n\n    par Upload a Azure\n        API-&gt;&gt;Azure Blob: Upload Imagen\n        Azure Blob--&gt;&gt;API: URL Imagen\n    and B\u00fasqueda en DB\n        API-&gt;&gt;DB: Buscar ActualTrip\n        DB--&gt;&gt;API: Datos del Viaje\n    end\n\n    API-&gt;&gt;API: Extraer Metadata\n    API-&gt;&gt;DB: Actualizar Campos\n    DB--&gt;&gt;API: Commit Success\n\n    API--&gt;&gt;Client: Response con Metadata</code></pre>"},{"location":"backend/tracmin/fotos/upload_photo_pending/#1-validacion-y-preparacion","title":"1. Validaci\u00f3n y Preparaci\u00f3n","text":"<ul> <li><code>Verificaci\u00f3n del token JWT</code></li> <li><code>Decodificaci\u00f3n de imagen base64</code></li> <li><code>Logging de informaci\u00f3n cr\u00edtica</code></li> </ul>"},{"location":"backend/tracmin/fotos/upload_photo_pending/#2-proceso-de-upload","title":"2. Proceso de Upload","text":"<ul> <li><code>Conexi\u00f3n a Azure Blob Storage</code></li> <li><code>Generaci\u00f3n de nombre \u00fanico</code></li> <li><code>Subida de imagen con metadata</code></li> </ul>"},{"location":"backend/tracmin/fotos/upload_photo_pending/#3-actualizacion-de-viaje","title":"3. Actualizaci\u00f3n de Viaje","text":"<ul> <li><code>B\u00fasqueda del viaje hist\u00f3rico</code></li> <li><code>Extracci\u00f3n de metadata</code></li> <li><code>Actualizaci\u00f3n de campos</code></li> <li><code>Commit de cambios</code></li> </ul> Estructura de API viajes<pre><code>{\n    \"data\": \"string (base64)\",\n    \"folio\": \"number\",\n    \"IdProgramado\": \"number\",\n    \"RutConductor\": \"string\",\n    \"Id\": \"number\"\n}\n</code></pre>"},{"location":"backend/tracmin/fotos/upload_photo_pending/#respuestas","title":"Respuestas","text":"<p>\u00c9xito<pre><code>{\n    \"blob_name\": \"TKTxxxx-1234\",\n    \"link\": \"https://storage.azure.com/...\",\n    \"status_code\": 200,\n    \"Cliente\": \"CLIENTE1\",\n    \"HoraInicioJornada\": \"2024-01-01T12:00:00\"\n}\n</code></pre> Error<pre><code>{\n    \"detail\": \"Mensaje espec\u00edfico del error\",\n    \"status_code\": 500\n}\n</code></pre></p>"},{"location":"backend/tracmin/gu%C3%ADas/cancel-guias/","title":"API SAP Guides - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/gu%C3%ADas/cancel-guias/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Endpoint para la cancelaci\u00f3n de gu\u00edas de despacho integrando SAP y base de datos interna.</p> Notas Importantes <ul> <li>La cancelaci\u00f3n crea un documento de devoluci\u00f3n (Return) en SAP</li> <li>Se mantiene registro de todos los estados y errores en GuiaStatus</li> <li>La cancelaci\u00f3n es irreversible una vez completada</li> <li>Se requiere autenticaci\u00f3n (JWT) para acceder al endpoint</li> </ul> Consideraciones de Rendimiento <ul> <li>Las consultas a SAP son as\u00edncronas para optimizar tiempos de respuesta</li> <li>Se implementa un sistema de retry para manejar fallos temporales de conexi\u00f3n</li> <li>Se mantiene un pool de conexiones a la base de datos para mejor rendimiento</li> </ul> Seguridad <ul> <li>Todas las comunicaciones con SAP son encriptadas</li> <li>Se validan todos los inputs para prevenir inyecciones SQL y XSS</li> <li>Los tokens y credenciales son manejados de forma segura</li> <li>Se mantiene un log de auditor\u00eda de todas las operaciones</li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/cancel-guias/#endpoint-para-cancelar-guias","title":"Endpoint Para Cancelar Gu\u00edas","text":"<p><code>POST /api/logipath/cancel_guide</code></p> Flujo ExplicadoEstados de GuiaStatusFlujo DiagramaFlujo Sequence <pre><code>graph TD\nA[Client] --&gt; B[POST /cancel_guide]\nB --&gt; C{Verificar GuiaStatus}\nC --&gt;|No Existe| D[Error: Gu\u00eda no encontrada]\nC --&gt;|Existe| E[Login SAP]\nE --&gt;|Error| F[Registrar Error Login]\nE --&gt;|Success| G[Buscar Gu\u00eda en SAP]\nG --&gt;|No Existe| H[Registrar Error: No encontrada]\nG --&gt;|Existe| I[Obtener Datos]\nI --&gt; J[Crear Return en SAP]\nJ --&gt;|Error| K[Registrar Error Cancelaci\u00f3n]\nJ --&gt;|Success| L[Actualizar GuiaStatus]\nL --&gt; M[Retornar Respuesta]\n%% Error paths\nD --&gt; N[API Response Error]\nF --&gt; N\nH --&gt; N\nK --&gt; N\n%% Success path\nM --&gt; O[API Response Success]</code></pre> <pre><code>sequenceDiagram\n    participant Client\n    participant API\n    participant DB\n    participant SAP\n    participant WebPubSub\n\n    Client-&gt;&gt;API: POST /cancel_guide\n\n    API-&gt;&gt;DB: Verificar GuiaStatus\n    DB--&gt;&gt;API: Estado de gu\u00eda\n\n    alt Gu\u00eda no existe\n        API--&gt;&gt;Client: Error: Gu\u00eda no encontrada\n    else Gu\u00eda existe\n        API-&gt;&gt;SAP: Login SAP\n\n        alt Login Error\n            API-&gt;&gt;DB: Registrar error_login_sap\n            API--&gt;&gt;Client: Error: Login SAP fallido\n        else Login Success\n            API-&gt;&gt;SAP: Buscar Gu\u00eda\n\n            alt Gu\u00eda no encontrada en SAP\n                API-&gt;&gt;DB: Registrar error_guia_no_encontrada\n                API--&gt;&gt;Client: Error: Gu\u00eda no existe en SAP\n            else Gu\u00eda encontrada\n                API-&gt;&gt;SAP: Crear Return Document\n\n                alt Error en Return\n                    API-&gt;&gt;DB: Registrar error_proceso_cancelacion\n                    API--&gt;&gt;Client: Error: Fallo en cancelaci\u00f3n\n                else Return Success\n                    API-&gt;&gt;DB: Actualizar estado a guia_anulada\n                    API-&gt;&gt;WebPubSub: Notificar cancelaci\u00f3n\n                    API--&gt;&gt;Client: Success: Gu\u00eda anulada correctamente\n                end\n            end\n        end\n    end</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/cancel-guias/#request-body","title":"Request Body","text":"<pre><code>{\n\"Folio\": number,\n\"Aprobacion\": boolean\n}\n</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/cancel-guias/#1-verificacion-inicial","title":"1. Verificaci\u00f3n Inicial","text":"<ul> <li><code>Busca la gu\u00eda en GuiaStatus por n\u00famero de folio</code></li> <li><code>Valida existencia de la gu\u00eda en el sistema</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/cancel-guias/#2-proceso-en-sap","title":"2. Proceso en SAP","text":"<ul> <li><code>Login en SAP</code></li> <li><code>B\u00fasqueda de la gu\u00eda en SAP por folio</code></li> <li><code>Obtenci\u00f3n de datos necesarios para la cancelaci\u00f3n</code></li> <li><code>Creaci\u00f3n del documento de devoluci\u00f3n (Return)</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/cancel-guias/#3-actualizacion-base-de-datos","title":"3. Actualizaci\u00f3n Base de Datos","text":"<ul> <li><code>Actualizaci\u00f3n del estado en GuiaStatus</code></li> <li><code>Registro de la anulaci\u00f3n</code><ul> <li><code>Registro de timestamp de modificaci\u00f3n</code></li> </ul> </li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/cancel-guias/#4-envio-de-notificacion","title":"4. Env\u00edo de Notificaci\u00f3n","text":"<ul> <li><code>Env\u00edo de notificaci\u00f3n WebPubSub</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/cancel-guias/#estados-de-guiastatus","title":"Estados de GuiaStatus","text":"<ul> <li><code>guia_anulada</code></li> <li><code>error_login_sap</code></li> <li><code>error_guia_no_encontrada</code></li> <li><code>error_proceso_cancelacion</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/cancel-guias/#manejo-de-errores","title":"Manejo de Errores","text":"<ul> <li><code>Error de login SAP</code></li> <li><code>Gu\u00eda no encontrada en sistema interno</code></li> <li><code>Gu\u00eda no encontrada en SAP</code></li> <li><code>Errores en proceso de cancelaci\u00f3n</code></li> <li><code>Errores de base de datos</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/cancel-guias/#respuestas","title":"Respuestas","text":"\u00c9xito<pre><code>{\n    \"message\": \"gu\u00eda anulada correctamente\",\n    \"Folio\": \"12345\",\n    \"datalink\": \"https://...\"\n}\n</code></pre> <p>Error<pre><code>{\n    \"message\": \"Error espec\u00edfico\",\n    \"error\": \"Detalle del error\"\n}\n</code></pre> Estructura del Proceso<pre><code>CANCEL_GUIDE/\n\u2502\n\u251c\u2500Verificaci\u00f3n/\n\u2502 \u251c\u2500\u2500 Consulta_GuiaStatus\n\u2502 \u2514\u2500\u2500 Validaci\u00f3n_Existencia\n\u2502\n\u251c\u2500SAP/\n\u2502 \u251c\u2500\u2500 Login\n\u2502 \u251c\u2500\u2500 B\u00fasqueda_Gu\u00eda\n\u2502 \u251c\u2500\u2500 Obtenci\u00f3n_Datos\n\u2502 \u2514\u2500\u2500 Crear_Return\n\u2502\n\u2514\u2500Base_de_Datos/\n\u2514\u2500\u2500 GuiaStatus\n\u251c\u2500\u2500 Actualizaci\u00f3n_Estado\n\u251c\u2500\u2500 Registro_Anulaci\u00f3n\n\u2514\u2500\u2500 Registro_Errores\n</code></pre></p>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/","title":"API Confirmaci\u00f3n de Gu\u00edas - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Endpoints para la confirmaci\u00f3n y rectificaci\u00f3n de gu\u00edas de despacho validando que los pesos registrados en SAP coincidan con los pesos reales de las b\u00e1sculas (tickets).</p> Notas Importantes <ul> <li>El sistema valida diferencias de peso entre gu\u00eda SAP y ticket de b\u00e1scula</li> <li>Umbral de tolerancia: 500 kg de diferencia</li> <li>Maneja tres casos: Confirmaci\u00f3n Normal, Devoluci\u00f3n y Nueva Gu\u00eda</li> <li>Requiere autenticaci\u00f3n especial (header Authorization) para confirmar</li> <li>Las gu\u00edas con tickets objetados no pueden ser confirmadas</li> <li>Se mantiene cach\u00e9 de sesi\u00f3n SAP por ~28 minutos</li> <li>Paginaci\u00f3n autom\u00e1tica para listar gu\u00edas pendientes</li> <li>Las confirmaciones son irreversibles una vez completadas</li> </ul> Consideraciones Importantes <ul> <li>Las diferencias &gt; 500 kg requieren confirmaci\u00f3n manual forzada</li> <li>El proceso es transaccional: si falla, se revierten cambios</li> <li>Las rectificaciones modifican directamente el peso en SAP</li> <li>Las devoluciones crean un documento Return en SAP</li> <li>Las nuevas gu\u00edas crean un documento complementario</li> <li>Se realiza join entre gu\u00edas SAP y viajes locales por Folio</li> </ul> Seguridad <ul> <li>Autenticaci\u00f3n JWT para listar gu\u00edas pendientes</li> <li>Autenticaci\u00f3n por header especial para confirmar gu\u00edas</li> <li>Todas las comunicaciones con SAP son encriptadas</li> <li>Se validan todos los inputs para prevenir inyecciones</li> <li>Log de auditor\u00eda de todas las confirmaciones</li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#endpoints","title":"Endpoints","text":""},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#endpoints_1","title":"Endpoints","text":""},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#1-listar-guias-pendientes","title":"1. Listar Gu\u00edas Pendientes","text":"<p><code>POST /api/logipath/unconfirmed_guides</code></p> Flujo ExplicadoEstados SAPFlujo Diagrama <pre><code>graph TD\n    A[Cliente] --&gt; B{Validar JWT}\n    B --&gt;|Invalid| C[Error 401]\n    B --&gt;|Valid| D[Login SAP con Cach\u00e9]\n\n    D --&gt; E[Consultar Gu\u00edas SAP]\n    E --&gt; F[U_SEI_CONF = N \u00faltimas 2 semanas]\n    F --&gt; G[Paginaci\u00f3n Autom\u00e1tica]\n\n    G --&gt; H[Consultar Viajes Locales]\n    H --&gt; I[ActualTrip con Folio]\n\n    I --&gt; J[Join por Folio]\n    J --&gt; K[Generar Resultado Combinado]\n    K --&gt; L[Retornar JSON]</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#1-autenticacion","title":"1. Autenticaci\u00f3n","text":"<ul> <li><code>Validaci\u00f3n de token JWT</code></li> <li><code>Verificaci\u00f3n de permisos</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#2-consulta-en-sap","title":"2. Consulta en SAP","text":"<ul> <li><code>Login en SAP con cach\u00e9 (TTL 28 minutos)</code></li> <li><code>Filtro: U_SEI_CONF = 'N' y fecha \u00faltimas 2 semanas</code></li> <li><code>Paginaci\u00f3n autom\u00e1tica para obtener todas las gu\u00edas</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#3-consulta-en-base-de-datos-local","title":"3. Consulta en Base de Datos Local","text":"<ul> <li><code>Query a tabla ActualTrip con Folio != NULL</code></li> <li><code>Filtro: fecha \u00faltimas 2 semanas</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#4-join-de-datos","title":"4. Join de Datos","text":"<ul> <li><code>Join entre gu\u00edas SAP y viajes locales por Folio</code></li> <li><code>Generaci\u00f3n de diccionarios para optimizar b\u00fasqueda</code></li> <li><code>Combinaci\u00f3n de informaci\u00f3n SAP y local</code></li> </ul> Request Body<pre><code>{\n    // No requiere par\u00e1metros\n}\n</code></pre> Response<pre><code>{\n    \"message\": \"guides found\",\n    \"results\": {\n        \"total_sap_guides\": 150,\n        \"total_local_trips\": 145,\n        \"total_joined\": 140,\n        \"total_matched_folios\": 138,\n        \"matched_folios\": [12345, 12346],\n        \"joined_results\": [\n            {\n                \"sap_guide\": {\n                    \"FolioNumber\": 12345,\n                    \"DocEntry\": 123456,\n                    \"CardCode\": \"C12345678-9\",\n                    \"U_SEI_CONF\": \"N\",\n                    \"Confirmed\": \"tYES\",\n                    \"DocumentLines\": [...]\n                },\n                \"local_trip\": {\n                    \"Id\": \"uuid\",\n                    \"Folio\": 12345,\n                    \"Patente\": \"ABC123\",\n                    \"Cliente\": \"Cliente Ejemplo\",\n                    \"PesoConfirmadoManual\": 25000\n                }\n            }\n        ]\n    }\n}\n</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#campos-de-control","title":"Campos de Control","text":"Campo Valores Descripci\u00f3n <code>U_SEI_CONF</code> \"N\", \"Y\" Indica si est\u00e1 confirmada <code>Confirmed</code> \"tNO\", \"tYES\" Estado de confirmaci\u00f3n SAP <code>U_SEI_Procesado</code> \"N\", \"P\" Indica si fue procesada"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#combinaciones-de-estados","title":"Combinaciones de Estados","text":"<p>Pendiente de Confirmaci\u00f3n: <pre><code>U_SEI_CONF = \"N\"\nConfirmed = \"tYES\"\nU_SEI_Procesado = \"N\"\n</code></pre></p> <p>Confirmada: <pre><code>U_SEI_CONF = \"Y\"\nConfirmed = \"tYES\"\nU_SEI_Procesado = \"P\"\n</code></pre></p>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#2-confirmar-o-rectificar-guia","title":"2. Confirmar o Rectificar Gu\u00eda","text":"<p><code>POST /api/logipath/confirm_guide</code></p> Flujo ExplicadoCasos de Confirmaci\u00f3nRespuestas y ErroresFlujo Completo <pre><code>graph TD\n    A[Frontend: Confirmar Gu\u00eda] --&gt; B{Validar Authorization}\n    B --&gt;|Invalid| C[Error 401]\n    B --&gt;|Valid| D[Login SAP]\n\n    D --&gt; E[Buscar Gu\u00eda por Folio]\n    E --&gt;|No existe| F[Error: Gu\u00eda no encontrada]\n    E --&gt;|Existe| G[Calcular Diferencia]\n\n    G --&gt; H{Tipo de Operaci\u00f3n}\n\n    H --&gt;|Rectificaci\u00f3n| I[Modificar Peso SAP]\n    H --&gt;|Diferencia &gt; 0| J[Crear Devoluci\u00f3n]\n    H --&gt;|Diferencia &lt; 0| K[Crear Nueva Gu\u00eda]\n    H --&gt;|Normal| L[Actualizar Estado]\n    H --&gt;|Diferencia &gt; 500kg y !Forzar| M[Requiere Confirmaci\u00f3n Manual]\n\n    I --&gt; N[PATCH DeliveryNotes]\n    J --&gt; O[POST Returns + PATCH Original]\n    K --&gt; P[POST DeliveryNotes + PATCH Original]\n    L --&gt; N\n\n    N --&gt; Q[Respuesta \u00c9xito]\n    O --&gt; Q\n    P --&gt; Q\n    M --&gt; R[Respuesta 409: Confirmar Manual]</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#1-validacion-de-seguridad","title":"1. Validaci\u00f3n de Seguridad","text":"<ul> <li><code>Validaci\u00f3n de header Authorization</code></li> <li><code>Verificaci\u00f3n de key especial: confirmar_guia</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#2-busqueda-en-sap","title":"2. B\u00fasqueda en SAP","text":"<ul> <li><code>Login en SAP</code></li> <li><code>B\u00fasqueda por FolioNumber</code></li> <li><code>Obtenci\u00f3n de DocEntry y DocumentLines</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#3-calculo-de-diferencia","title":"3. C\u00e1lculo de Diferencia","text":"<ul> <li><code>Quantity (SAP) - PesoTicket (Real)</code></li> <li><code>Conversi\u00f3n de unidades si es necesario</code></li> <li><code>Validaci\u00f3n de umbral (500 kg)</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#4-procesamiento-segun-caso","title":"4. Procesamiento Seg\u00fan Caso","text":"<ul> <li>Rectificaci\u00f3n Manual: Modificar peso directamente</li> <li>Devoluci\u00f3n: Crear documento Return</li> <li>Nueva Gu\u00eda: Crear gu\u00eda complementaria</li> <li>Normal: Actualizar estado de confirmaci\u00f3n</li> </ul> Request Body<pre><code>{\n    \"Folio\": 12345,\n    \"PesoTicket\": 25000,\n    \"PesoGuia\": 25400,\n    \"ForzarConfirmacion\": false,\n    \"Rectificacion\": false,\n    \"PesoGuiaModificado\": null\n}\n</code></pre> Esquema Pydantic<pre><code>class reqConfirmar(BaseModel):\n    Folio: int                          # Folio de la gu\u00eda\n    PesoTicket: float                   # Peso real b\u00e1scula (kg)\n    PesoGuia: Optional[float]           # Peso SAP (kg)\n    ForzarConfirmacion: bool = False    # Forzar confirmaci\u00f3n manual\n    Rectificacion: bool = False         # Indica rectificaci\u00f3n\n    PesoGuiaModificado: Optional[float] # Nuevo peso rectificaci\u00f3n\n</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#a-rectificacion-manual","title":"A. Rectificaci\u00f3n Manual","text":"<p>Cuando: Usuario modifica peso manualmente</p> L\u00f3gica<pre><code>if req.Rectificacion and req.PesoGuiaModificado:\n    json_patch = {\n        \"U_SEI_CONF\": \"Y\",\n        \"Confirmed\": \"tYES\",\n        \"U_SEI_Procesado\": \"P\",\n        \"U_SEI_PESO\": nuevo_peso,\n        \"Comments\": f\"Rectificaci\u00f3n. Peso modificado a {nuevo_peso} kg.\"\n    }\n    # PATCH a /b1s/v1/DeliveryNotes({docentry})\n</code></pre> Respuesta \u00c9xito<pre><code>{\n    \"message\": \"Gu\u00eda rectificada correctamente\",\n    \"docentry_confirm\": 123456,\n    \"nuevo_peso\": 25500,\n    \"rectificacion\": true\n}\n</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#b-devolucion-peso-guia-peso-ticket","title":"B. Devoluci\u00f3n (Peso Gu\u00eda &gt; Peso Ticket)","text":"<p>Cuando: diferencia &gt; 0 (hay exceso en la gu\u00eda)</p> L\u00f3gica<pre><code>if diferencia &gt; 0:\n    # 1. Crear documento Return\n    json_return = {\n        \"CardCode\": CardCode,\n        \"U_SEI_DocGuiaDev\": req.Folio,\n        \"DocumentLines\": [{\n            \"BaseType\": 15,\n            \"ItemCode\": ItemCode,\n            \"Quantity\": (Quantity - req.PesoTicket)/1000,\n            \"BaseEntry\": docentry,\n            \"BaseLine\": BaseLine\n        }]\n    }\n    # POST a /b1s/v1/Returns\n\n    # 2. Actualizar gu\u00eda original\n    json_patch = {\n        \"U_SEI_CONF\": \"Y\",\n        \"Confirmed\": \"tYES\",\n        \"U_SEI_Procesado\": \"P\",\n        \"U_SEI_DocGuiaDev\": docentry_return,\n        \"U_SEI_PESO\": peso_confirmado/1000\n    }\n    # PATCH a /b1s/v1/DeliveryNotes({docentry})\n</code></pre> Respuesta \u00c9xito<pre><code>{\n    \"message\": \"Gu\u00eda confirmada y devoluci\u00f3n generada\",\n    \"docentry_return\": 123457,\n    \"docentry_confirm\": 123456\n}\n</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#c-nueva-guia-peso-ticket-peso-guia","title":"C. Nueva Gu\u00eda (Peso Ticket &gt; Peso Gu\u00eda)","text":"<p>Cuando: diferencia &lt; 0 (falta peso en la gu\u00eda)</p> L\u00f3gica<pre><code>if diferencia &lt; 0:\n    # Crear gu\u00eda complementaria\n    json_4_sap = {\n        \"DocType\": \"dDocument_Items\",\n        \"CardCode\": CardCode,\n        \"FolioNumber\": req.Folio,\n        \"U_SEI_CONF\": \"Y\",\n        \"Confirmed\": \"tYES\",\n        \"U_SEI_Procesado\": \"P\",\n        \"DocumentLines\": [{\n            \"ItemCode\": ItemCode,\n            \"Quantity\": (req.PesoTicket - Quantity)/1000\n        }]\n    }\n    # POST a /b1s/v1/DeliveryNotes\n\n    # Actualizar gu\u00eda original\n    json_patch = {\n        \"U_SEI_CONF\": \"Y\",\n        \"Confirmed\": \"tYES\",\n        \"U_SEI_Procesado\": \"P\",\n        \"U_SEI_DocGuiaEnt\": docentry_new\n    }\n</code></pre> Respuesta \u00c9xito<pre><code>{\n    \"message\": \"Gu\u00eda confirmada y nueva gu\u00eda generada\",\n    \"docentry_new\": 123457,\n    \"docentry_confirm\": 123456\n}\n</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#d-confirmacion-normal","title":"D. Confirmaci\u00f3n Normal","text":"<p>Cuando: |diferencia| &lt;= 500 kg</p> L\u00f3gica<pre><code>if abs(diferencia) &lt;= 500:\n    json_patch = {\n        \"U_SEI_CONF\": \"Y\",\n        \"Confirmed\": \"tYES\",\n        \"U_SEI_Procesado\": \"P\",\n        \"U_SEI_PESO\": peso_ticket/1000\n    }\n    # PATCH a /b1s/v1/DeliveryNotes({docentry})\n</code></pre> Respuesta \u00c9xito<pre><code>{\n    \"message\": \"Gu\u00eda confirmada correctamente\",\n    \"docentry_confirm\": 123456\n}\n</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#requiere-confirmacion-manual","title":"Requiere Confirmaci\u00f3n Manual","text":"<p>Cuando: |diferencia| &gt; 500 kg y ForzarConfirmacion = false</p> Respuesta<pre><code>{\n    \"message\": \"El peso no se puede confirmar autom\u00e1ticamente, confirme manualmente\",\n    \"diferencia\": 750,\n    \"response_invoices\": {...}\n}\n</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#respuestas-de-error","title":"Respuestas de Error","text":"Error: Gu\u00eda No Encontrada<pre><code>{\n    \"message\": \"no se encontr\u00f3 la gu\u00eda en SAP\",\n    \"status_code\": 500\n}\n</code></pre> Error: Login SAP<pre><code>{\n    \"message\": \"no se pudo iniciar sesi\u00f3n en sap\",\n    \"status_code\": 500\n}\n</code></pre> Error: Autenticaci\u00f3n<pre><code>{\n    \"detail\": \"Unauthorized\",\n    \"status_code\": 401\n}\n</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#modelos-de-base-de-datos","title":"Modelos de Base de Datos","text":"ActualTripGuiaStatus Campos Relevantes<pre><code>class ActualTrip(Base):\n    __tablename__ = \"ActualTrip\"\n\n    Id: UUID                      # PK\n    Folio: int                    # Folio de la gu\u00eda\n    HoraConfirmacionFolio: datetime\n    PesoConfirmadoManual: float   # Peso del ticket\n    IdTicket: str                 # ID del ticket de b\u00e1scula\n    Cancelado: bool\n    Romana: bool                  # Indica si tiene romana\n    Cliente: str\n    Patente: str\n    RutConductor: str\n</code></pre> Control de Estados<pre><code>class GuiaStatus(Base):\n    __tablename__ = \"GuiaStatus\"\n\n    IdViaje: UUID                 # FK -&gt; ActualTrip\n    DocEntry: int                 # DocEntry de SAP\n    Folio: int                    # Folio de la gu\u00eda\n    FebosId: str                  # ID de Febos\n    Status: str                   # Estado actual\n    HoraModificacion: datetime\n</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#sistema-de-cache","title":"Sistema de Cach\u00e9","text":"Implementaci\u00f3nVentajas TTL Cache<pre><code>class TTLCache:\n    def __init__(self, ttl_seconds):\n        self.ttl_seconds = ttl_seconds\n        self.cache = {}\n        self.timestamps = {}\n\n    def get(self, key):\n        if key in self.cache:\n            if time.time() - self.timestamps[key] &lt; self.ttl_seconds:\n                return self.cache[key]\n            else:\n                del self.cache[key]\n                del self.timestamps[key]\n        return None\n\n    def set(self, key, value):\n        self.cache[key] = value\n        self.timestamps[key] = time.time()\n\n# Cach\u00e9 de sesi\u00f3n SAP: ~28 minutos\nsap_session_cache = TTLCache(ttl_seconds=1700)\n</code></pre> <ul> <li>\u2705 Reduce llamadas de login a SAP</li> <li>\u2705 Mejora tiempo de respuesta</li> <li>\u2705 Evita sobrecarga del servidor SAP</li> <li>\u2705 TTL configurable por tipo de cach\u00e9</li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#configuracion","title":"Configuraci\u00f3n","text":"Variables de Entorno config.py<pre><code>LINK_SAP = \"https://elalto.cloudseidor.com:50000\"\nUSER_DESARROLLO = \"usuario_sap\"\nPASS_DESARROLLO = \"password_sap\"\nCOMPANYDB_SAP_MIGRIN = \"SBOMIGRIN\"\nCONFIRMAR_GUIA_SAP = \"confirmar_guia\"  # Key autenticaci\u00f3n\n</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#mejores-practicas","title":"Mejores Pr\u00e1cticas","text":"Validaci\u00f3n de Pesos <ul> <li>Siempre verificar que los pesos sean positivos</li> <li>Convertir toneladas a kilogramos cuando sea necesario  </li> <li>Aplicar umbral de tolerancia (500 kg)</li> <li>Validar formato num\u00e9rico antes de procesar</li> </ul> Manejo de Transacciones <ul> <li>Usar sesiones de BD con context managers</li> <li>Hacer commit solo despu\u00e9s de confirmar en SAP</li> <li>Implementar rollback en caso de error</li> <li>Mantener atomicidad en operaciones cr\u00edticas</li> </ul> Logs y Auditor\u00eda <ul> <li>Registrar todas las confirmaciones exitosas</li> <li>Loguear errores con contexto completo</li> <li>Mantener historial de rectificaciones</li> <li>Timestamp en todas las operaciones</li> </ul> Seguridad <ul> <li>Usar autenticaci\u00f3n por header para endpoints internos</li> <li>Validar JWT para endpoints p\u00fablicos</li> <li>No exponer credenciales de SAP</li> <li>Sanitizar todos los inputs</li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#troubleshooting","title":"Troubleshooting","text":"Sesi\u00f3n SAP Expirada <p>S\u00edntoma: Error de autenticaci\u00f3n en SAP</p> <p>Soluci\u00f3n: El cach\u00e9 de sesiones se regenera autom\u00e1ticamente despu\u00e9s de 28 minutos.</p> <p>Verificar: <pre><code># El sistema maneja autom\u00e1ticamente la reconexi\u00f3n\nsession = get_sap_session()\nif not session:\n    # Se intenta crear nueva sesi\u00f3n\n</code></pre></p> Gu\u00eda No Aparece en Listado <p>S\u00edntoma: La gu\u00eda no se muestra en la lista de pendientes</p> <p>Verificar: - La gu\u00eda tenga <code>U_SEI_CONF = \"N\"</code> - La fecha sea dentro de las \u00faltimas 2 semanas - El viaje tenga Folio asignado - La gu\u00eda no est\u00e9 cancelada</p> Error al Crear Devoluci\u00f3n <p>S\u00edntoma: Falla al crear documento Return</p> <p>Validar: - La gu\u00eda original exista en SAP - Los campos <code>BaseEntry</code> y <code>BaseLine</code> sean correctos - El cliente permita devoluciones - Permisos en SAP para crear Returns</p> Diferencia de Peso Incorrecta <p>S\u00edntoma: El c\u00e1lculo de diferencia no es correcto</p> <p>Verificar: - Unidades de medida (kg vs toneladas) - Conversi\u00f3n: <code>Quantity &lt; 1000 ? Quantity * 1000 : Quantity</code> - Que ambos valores sean num\u00e9ricos v\u00e1lidos</p>"},{"location":"backend/tracmin/gu%C3%ADas/confirmar-guias/#referencias","title":"Referencias","text":"<ul> <li>Documentaci\u00f3n SAP Service Layer</li> <li>Crear Gu\u00edas</li> <li>Cancelar Gu\u00edas</li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/correo/","title":"API Correo Gu\u00eda - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/gu%C3%ADas/correo/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Sistema de notificaci\u00f3n por correo electr\u00f3nico para enviar enlaces de gu\u00edas de despacho a destinatarios espec\u00edficos utilizando Microsoft Graph API.</p> Modelos y Dependencias <pre><code>from fastapi import APIRouter, Request\nfrom fastapi.responses import JSONResponse\nfrom utils import graph_token\n</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/correo/#endpoints","title":"Endpoints","text":"Env\u00edo de CorreoEjemplos Enviar Gu\u00eda por Correo POST /api/logipath/correo_guia<pre><code>@router.post(f\"{APP_PATH}/correo_guia\")\nasync def enviar_correo_con_enlace(req: Request):\n    \"\"\"\n    Env\u00eda un correo electr\u00f3nico con un enlace a una gu\u00eda de despacho.\n\n    Args:\n        req (Request): Request con key de autorizaci\u00f3n y datos JSON\n\n    Body JSON:\n        {\n            \"Correo\": \"destinatario@ejemplo.com\",\n            \"Guia\": \"https://url-guia-despacho\"\n        }\n\n    Returns:\n        JSONResponse: {\n            \"status\": \"success|error\",\n            \"message\": str\n        }\n\n    Raises:\n        401: Si la key es inv\u00e1lida\n    \"\"\"\n</code></pre> Request Exitoso <pre><code>{\n    \"Correo\": \"cliente@empresa.com\",\n    \"Guia\": \"https://ejemplo.com/guia/123\"\n}\n</code></pre> Respuesta Exitosa <pre><code>{\n    \"status\": \"success\",\n    \"message\": \"Email enviado correctamente\"\n}\n</code></pre> Error de Autorizaci\u00f3n <pre><code>{\n    \"message\": \"unauthorized\"\n}\n</code></pre> Consideraciones de Seguridad <ul> <li>Validaci\u00f3n de key en headers</li> <li>Autenticaci\u00f3n Microsoft Graph</li> <li>Validaci\u00f3n de correos destinatarios</li> <li>Sanitizaci\u00f3n de enlaces</li> <li>Control de acceso a gu\u00edas</li> </ul> Mejores Pr\u00e1cticas <ol> <li> <p>Validaci\u00f3n:</p> <ul> <li>Formato de correo electr\u00f3nico</li> <li>URLs v\u00e1lidas</li> <li>Permisos de acceso</li> </ul> </li> <li> <p>Monitoreo:</p> <ul> <li>Tasa de entrega</li> <li>Errores de env\u00edo</li> <li>Tiempo de respuesta</li> </ul> </li> <li> <p>Mantenimiento:</p> <ul> <li>Rotaci\u00f3n de tokens</li> <li>Logging de eventos</li> <li>Gesti\u00f3n de errores</li> </ul> </li> </ol> Detalles T\u00e9cnicos Aspecto Especificaci\u00f3n M\u00e9todo POST Auth Header Key Formato JSON Email From notificaciones@tracmin.cl Retry No Timeout 30s C\u00f3digos de Estado C\u00f3digo Descripci\u00f3n 200 Email enviado correctamente 401 No autorizado 500 Error interno"},{"location":"backend/tracmin/gu%C3%ADas/crear-guias/","title":"API SAP Guides - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/gu%C3%ADas/crear-guias/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Endpoint para la creaci\u00f3n y gesti\u00f3n de gu\u00edas de despacho integrando SAP, Febos y base de datos interna.</p> Notas Importantes <ul> <li>El sistema verifica la existencia de gu\u00edas previas antes de crear una nueva</li> <li>Se realiza una doble validaci\u00f3n de folios para evitar duplicados tanto en SAP como en Febos</li> <li>Los campos de peso (NETO, TARA, BRUT) deben ser consistentes entre s\u00ed</li> <li>El sistema maneja zonas horarias, convirtiendo autom\u00e1ticamente entre hora local (Chile) y UTC</li> <li>Se mantiene un registro detallado de estados yerrores en GuiaStatus</li> <li>Las notificaciones WebPubSub son enviadas autom\u00e1ticamente al completar el proceso</li> <li>Los errores en cualquier etapa son registrados y pueden ser consultados posteriormente</li> <li>El proceso es transaccional: si falla en cualquier punto, se revierten los cambios</li> <li>Se requiere autenticaci\u00f3n (JWT) para acceder al endpoint</li> <li>Los documentos generados cumplen con la normativa del SII (Servicio de Impuestos Internos)</li> <li>El sistema maneja autom\u00e1ticamente la reconexi\u00f3n en caso de fallos de red</li> <li>Los tiempos de respuesta pueden variar dependiendo de la disponibilidad de SAP y Febos</li> </ul> Consideraciones de Rendimiento <ul> <li>Las consultas a SAP y Febos son as\u00edncronas para optimizar tiempos de respuesta</li> <li>Se implementa un sistema de retry para manejar fallos temporales de conexi\u00f3n</li> <li>Los documentos pesados (como XMLs) son manejados en memoria de forma eficiente</li> <li>Se mantiene un pool de conexiones a la base dedatos para mejor rendimiento</li> </ul> Seguridad <ul> <li>Todas las comunicaciones con SAP y Febos son encriptadas</li> <li>Se validan todos los inputs para prevenir inyecciones SQL y XSS</li> <li>Los tokens y credenciales son manejados de forma segura</li> <li>Se mantiene un log de auditor\u00eda de todas las operaciones</li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/crear-guias/#endpoint-para-crear-guias","title":"Endpoint Para Crear Gu\u00edas","text":"<p><code>POST /api/logipath/sap_guides</code></p> Flujo ExplicadoEstados de GuiaStatusFlujo DiagramaFlujo Sequence <pre><code>sequenceDiagram\n    autonumber\n    participant Client\n    participant API\n    participant SAP\n    participant FEBOS\n    participant DB\n    participant WebPubSub\n\n    Client-&gt;&gt;API: POST /sap_guides\n    API-&gt;&gt;DB: Verificar estado gu\u00eda\n\n    alt Gu\u00eda existe\n        DB--&gt;&gt;API: Retornar gu\u00eda existente\n        API--&gt;&gt;Client: Respuesta con gu\u00eda\n    else No existe\n        API-&gt;&gt;SAP: Login\n        SAP--&gt;&gt;API: Session OK\n        API-&gt;&gt;SAP: Crear gu\u00eda\n        SAP--&gt;&gt;API: Gu\u00eda creada\n\n        API-&gt;&gt;DB: Registrar GuiaStatus\n        DB--&gt;&gt;API: Status registrado\n\n        API-&gt;&gt;FEBOS: Crear gu\u00eda + XML\n\n        alt Success FEBOS\n            FEBOS--&gt;&gt;API: Folio asignado\n            API-&gt;&gt;SAP: Actualizar con folio\n            API-&gt;&gt;FEBOS: Obtener link\n            FEBOS--&gt;&gt;API: Link documento\n            API-&gt;&gt;DB: Actualizar ActualTrip\n            API-&gt;&gt;WebPubSub: Notificar cambios\n        else Error FEBOS\n            API-&gt;&gt;SAP: Cancelar gu\u00eda\n            API-&gt;&gt;DB: Registrar error\n        end\n\n        API--&gt;&gt;Client: Respuesta final\n    end</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/crear-guias/#1-verificacion-inicial","title":"1. Verificaci\u00f3n Inicial","text":"<ul> <li><code>Verifica si ya existe una gu\u00eda para el viaje</code></li> <li><code>Si existe y est\u00e1 completa, retorna la informaci\u00f3n</code></li> <li><code>Si existe pero est\u00e1 incompleta, intenta completar el proceso</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/crear-guias/#2-creacion-en-sap","title":"2. Creaci\u00f3n en SAP","text":"<ul> <li><code>Login en SAP</code></li> <li><code>Creaci\u00f3n de la gu\u00eda con datos b\u00e1sicos</code></li> <li><code>Registro en GuiaStatus como \"guia_creada_sap\"</code></li> <li><code>Obtenci\u00f3n de datos adicionales del cliente y detalles</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/crear-guias/#3-creacion-en-febos","title":"3. Creaci\u00f3n en Febos","text":"<ul> <li><code>Generaci\u00f3n del XML</code></li> <li><code>Env\u00edo a Febos para foliar</code></li> <li><code>Verificaci\u00f3n de folio duplicado en SAP</code></li> <li><code>Actualizaci\u00f3n de GuiaStatus seg\u00fan resultado</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/crear-guias/#4-actualizacion-en-sap","title":"4. Actualizaci\u00f3n en SAP","text":"<ul> <li><code>Patch con folio y ID de Febos</code></li> <li><code>Obtenci\u00f3n del link de la imagen</code></li> <li><code>Actualizaci\u00f3n de GuiaStatus</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/crear-guias/#5-actualizacion-base-de-datos","title":"5. Actualizaci\u00f3n Base de Datos","text":"<ul> <li><code>Actualizaci\u00f3n de ActualTrip con folio y datos de ubicaci\u00f3n</code></li> <li><code>Actualizaci\u00f3n final de GuiaStatus</code></li> <li><code>Env\u00edo de notificaci\u00f3n WebPubSub</code></li> </ul> Estructura de la Gu\u00eda<pre><code>{\n    \"DocType\": \"string\",\n    \"CardCode\": \"string\",\n    \"Address\": \"string\",\n    \"DocTotal\": \"number\",\n    \"Comments\": \"string\",\n    \"JournalMemo\": \"string\",\n    \"ShipToCode\": \"string\",\n    \"Indicator\": \"string\",\n    \"FolioPrefixString\": \"string\",\n    \"ControlAccount\": \"string\",\n    \"U_SEI_PTT\": \"string\",\n    \"U_SEI_RTCH\": \"string\",\n    \"U_SEI_RTTR\": \"string\",\n    \"U_SEI_NCHF\": \"string\",\n    \"U_SEI_IND\": \"string\",\n    \"U_SEI_DocGuiaEnt\": \"number\",\n    \"U_SEI_ROMAN\": \"string\",\n    \"U_SEI_ROMA\": \"string\",\n    \"U_SEI_PATE\": \"string\",\n    \"U_SEI_FEBOSID\": \"string\",\n    \"U_SEI_HUME\": \"number\",\n    \"U_SEI_TEMP\": \"number\",\n    \"U_SEI_NETO\": \"number\",\n    \"U_SEI_TARA\": \"number\",\n    \"U_SEI_BRUT\": \"number\",\n    \"U_SEI_CANB\": \"number\",\n    \"LineNum\": \"number\",\n    \"ItemCode\": \"string\",\n    \"Quantity\": \"number\",\n    \"Price\": \"number\",\n    \"Currency\": \"string\",\n    \"WarehouseCode\": \"string\",\n    \"AccountCode\": \"string\",\n    \"InventoryQuantity\": \"number\",\n    \"CardName\": \"string\",\n    \"ItemDescription\": \"string\",\n    \"U_SEI_ITRS\": \"number\",\n    \"DocDueDate\": \"string\",\n    \"Address2\": \"string\",\n    \"IdViaje\": \"number\",\n    \"IdProgramado\": \"number\",\n    \"RutConductor\": \"string\",\n    \"HoraInicioJornada\": \"datetime\",\n    \"Longitud\": \"number\",\n    \"Latitud\": \"number\",\n    \"HoraFolio\": \"datetime\"\n}\n</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/crear-guias/#estados-de-guiastatus","title":"Estados de GuiaStatus","text":"<ul> <li><code>guia_creada_sap</code></li> <li><code>error_folio_repetido</code></li> <li><code>error_verificacion_sap</code></li> <li><code>error_patch_sap</code></li> <li><code>error_obtener_link_febos</code></li> <li><code>guia_creada_sin_link</code></li> <li><code>guia_creada_correctamente</code></li> <li><code>error_viaje_no_encontrado</code></li> <li><code>error_actualizacion_viaje</code></li> <li><code>error_general</code></li> <li><code>proceso_completado</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/crear-guias/#manejo-de-errores","title":"Manejo de Errores","text":"<ul> <li><code>Errores de conexi\u00f3n SAP</code></li> <li><code>Errores de Febos</code></li> <li><code>Folios duplicados</code></li> <li><code>Errores de base de datos</code></li> <li><code>Errores de actualizaci\u00f3n</code></li> <li><code>Errores generales del proceso</code></li> </ul>"},{"location":"backend/tracmin/gu%C3%ADas/crear-guias/#respuestas","title":"Respuestas","text":"\u00c9xito<pre><code>{\n    \"message\": \"gu\u00eda generada correctamente\",\n    \"FolioNumber\": \"12345\",\n    \"datalink\": \"https://...\"\n}\n</code></pre> Error<pre><code>{\n    \"message\": \"Error espec\u00edfico\",\n    \"error\": \"Detalle del error\"\n}\n</code></pre> Estructura de la API<pre><code>SAP_GUIDES/\n\u2502\n\u251c\u2500Verificaci\u00f3n_Inicial/\n\u2502 \u251c\u2500\u2500 Consulta_GuiaStatus\n\u2502 \u2514\u2500\u2500 Verifica_estado_existente\n\u2502\n\u251c\u2500SAP/\n\u2502 \u251c\u2500\u2500 Login\n\u2502 \u251c\u2500\u2500 Crear_Gu\u00eda\n\u2502 \u251c\u2500\u2500 Obtener_Datos_Cliente\n\u2502 \u2514\u2500\u2500 Patch_Folio\n\u2502\n\u251c\u2500Febos/\n\u2502 \u251c\u2500\u2500 Generar_XML\n\u2502 \u251c\u2500\u2500 Obtener_Folio\n\u2502 \u2514\u2500\u2500 Obtener_Link\n\u2502\n\u251c\u2500Base_de_Datos/\n\u2502 \u251c\u2500\u2500 GuiaStatus\n\u2502 \u2502 \u251c\u2500\u2500 Registro_inicial\n\u2502 \u2502 \u251c\u2500\u2500 Actualizaciones_de_estado\n\u2502 \u2502 \u2514\u2500\u2500 Registro_de_errores\n\u2502 \u2502\n\u2502 \u2514\u2500\u2500 ActualTrip\n\u2502 \u2514\u2500\u2500 Actualizaci\u00f3n_con_folio\n\u2502\n\u2514\u2500Notificaciones/\n\u2514\u2500\u2500 WebPubSub\n</code></pre>"},{"location":"backend/tracmin/gu%C3%ADas/crear-guias/#flujo-api-sap-guides","title":"Flujo API SAP Guides","text":"<pre><code>graph TD\n    %% Main Endpoints\n    A[Client] --&gt; B{API Endpoints}\n    B --&gt; C[POST /sap_guides]\n    B --&gt; D[POST /cancel_guide]\n\n    %% SAP Guides Flow\n    C --&gt; E{Verificar Estado Gu\u00eda}\n    E --&gt;|Gu\u00eda Existe| F[Retornar Gu\u00eda Existente]\n    E --&gt;|No Existe| G[Crear Nueva Gu\u00eda]\n\n    %% Create Guide Flow\n    G --&gt; H[Login SAP]\n    H --&gt; I[Crear Gu\u00eda en SAP]\n    I --&gt; J[Registrar en GuiaStatus]\n    J --&gt; K[Crear Gu\u00eda en FEBOS]\n\n    %% FEBOS Processing\n    K --&gt;|Success| L[Actualizar SAP con Folio]\n    K --&gt;|Error| M[Cancelar en SAP]\n\n    %% Final Steps\n    L --&gt; N[Obtener Link FEBOS]\n    N --&gt; O[Actualizar ActualTrip]\n    O --&gt; P[Enviar WebPubSub]\n\n    %% Cancel Guide Flow\n    D --&gt; Q[Verificar Gu\u00eda]\n    Q --&gt; R[Login SAP]\n    R --&gt; S[Crear Return en SAP]\n    S --&gt; T[Actualizar GuiaStatus]\n\n    %% Status Updates\n    J --&gt; U((DB Updates))\n    L --&gt; U\n    O --&gt; U\n    T --&gt; U\n\n    %% Error Handling\n    M --&gt; V[Error Handler]\n    V --&gt; W[Log Error]\n    W --&gt; X[Update Status]\n\n    %% Response Paths\n    F --&gt; Y[API Response]\n    P --&gt; Y\n    T --&gt; Y\n    X --&gt; Y</code></pre>"},{"location":"backend/tracmin/viajes/api-viajes/","title":"API VIAJES - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/viajes/api-viajes/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>APIs para la gesti\u00f3n del ciclo de vida completo de viajes programados y en ejecuci\u00f3n.</p> Notas Importantes <ul> <li>Sistema de gesti\u00f3n dual: viajes programados (ScheduledTrip) y viajes en ejecuci\u00f3n (ActualTrip)</li> <li>Manejo de zonas horarias entre UTC y hora local de Chile</li> <li>Sistema de estados para seguimiento de ejecuci\u00f3n del viaje</li> <li>Integraci\u00f3n con WebPubSub para notificaciones en tiempo real</li> <li>Validaciones geogr\u00e1ficas para confirmaci\u00f3n de ubicaciones</li> <li>Control de acceso basado en JWT</li> <li>Registro detallado de eventos y cambios de estado</li> </ul>"},{"location":"backend/tracmin/viajes/api-viajes/#endpoint-post-trip","title":"Endpoint Post Trip","text":"<p><code>POST /api/logipath/post_trip</code></p> Flujo ExplicadoEstados y RespuestasFlujo DiagramaSequence Diagram <pre><code>graph TD\n    A[Cliente] --&gt; B{Validar JWT}\n    B --&gt;|Invalid| C[Error 401]\n    B --&gt;|Valid| D{Tiene HoraConfirmacion?}\n\n    D --&gt;|Si| E[Buscar Viaje Existente]\n    D --&gt;|No| F[Crear Nuevo Viaje]\n\n    E --&gt; G{Viaje Encontrado?}\n    G --&gt;|No| H[Error 404]\n    G --&gt;|Si| I[Actualizar Campos]\n\n    I --&gt; J{Tiene HoraFinEntrega?}\n    J --&gt;|Si| K[Marcar Scheduled como Terminado]\n\n    I --&gt; L{Esta Cancelado?}\n    L --&gt;|Si| M[Actualizar Estados]\n\n    F --&gt; N[Crear ActualTrip]\n\n    K --&gt; O[WebPubSub]\n    M --&gt; O\n    N --&gt; O\n\n    O --&gt; P[Respuesta Success]</code></pre> <pre><code>sequenceDiagram\n    participant Client\n    participant API\n    participant DB\n    participant WebPubSub\n\n    Client-&gt;&gt;API: POST /post_trip\n    API-&gt;&gt;API: Validar JWT\n\n    alt HoraConfirmacion existe\n        API-&gt;&gt;DB: Buscar \u00faltimo viaje\n        DB--&gt;&gt;API: Viaje encontrado\n        API-&gt;&gt;DB: Actualizar campos\n\n        alt HoraFinEntrega presente\n            API-&gt;&gt;DB: Actualizar ScheduledTrip\n        end\n\n        alt Viaje cancelado\n            API-&gt;&gt;DB: Actualizar estados\n        end\n\n    else HoraConfirmacion no existe\n        API-&gt;&gt;DB: Crear nuevo ActualTrip\n    end\n\n    API-&gt;&gt;WebPubSub: Notificar cambios\n    API--&gt;&gt;Client: Respuesta exitosa</code></pre>"},{"location":"backend/tracmin/viajes/api-viajes/#1-verificacion-inicial","title":"1. Verificaci\u00f3n Inicial","text":"<ul> <li><code>Validaci\u00f3n del token JWT</code></li> <li><code>Normalizaci\u00f3n de timestamps (eliminaci\u00f3n de microsegundos)</code></li> <li><code>Verificaci\u00f3n de viaje existente</code></li> </ul>"},{"location":"backend/tracmin/viajes/api-viajes/#2-actualizacion-de-viaje-existente","title":"2. Actualizaci\u00f3n de Viaje Existente","text":"<ul> <li><code>Si existe HoraConfirmacion:</code></li> <li><code>Busca el \u00faltimo viaje del conductor</code></li> <li><code>Actualiza campos no nulos del request</code></li> <li><code>Maneja estados especiales (finalizaci\u00f3n/cancelaci\u00f3n)</code></li> </ul>"},{"location":"backend/tracmin/viajes/api-viajes/#3-creacion-de-nuevo-viaje","title":"3. Creaci\u00f3n de Nuevo Viaje","text":"<ul> <li><code>Si no hay HoraConfirmacion:</code></li> <li><code>Crea nuevo ActualTrip</code></li> <li><code>Asigna valores iniciales</code></li> <li><code>Maneja estados de cancelaci\u00f3n si aplica</code></li> </ul>"},{"location":"backend/tracmin/viajes/api-viajes/#4-notificaciones","title":"4. Notificaciones","text":"<ul> <li><code>Env\u00edo de actualizaciones v\u00eda WebPubSub</code></li> <li><code>Actualizaci\u00f3n de estados en ScheduledTrip relacionado</code></li> </ul> Estructura de API viajes<pre><code>{\n    \"Id\": \"string?\",\n    \"IdProgramado\": \"number\",\n    \"RutConductor\": \"string\",\n    \"HoraInicioJornada\": \"datetime\",\n    \"PlantaOrigen\": \"string?\",\n    \"Cliente\": \"string?\",\n    \"Patente\": \"string?\",\n    \"LatitudInicioJornada\": \"number?\",\n    \"LongitudInicioJornada\": \"number?\",\n    \"HoraConfirmacion\": \"datetime?\",\n    \"TaraViaje\": \"number?\",\n    \"HoraInicioCarga\": \"datetime?\",\n    \"LatitudInicioCarga\": \"number?\",\n    \"LongitudInicioCarga\": \"number?\",\n    \"HoraFinCarga\": \"datetime?\",\n    \"LatitudFinCarga\": \"number?\",\n    \"LongitudFinCarga\": \"number?\",\n    \"HoraPesaje\": \"datetime?\",\n    \"LatitudPesaje\": \"number?\",\n    \"LongitudPesaje\": \"number?\",\n    \"Folio\": \"number?\",\n    \"HoraConfirmacionFolio\": \"datetime?\",\n    \"LongitudConFolio\": \"number?\",\n    \"LatitudConFolio\": \"number?\",\n    \"CantidadPausa\": \"boolean?\",\n    \"HoraLlegadaCliente\": \"datetime?\",\n    \"LatitudLlegadaCliente\": \"number?\",\n    \"LongitudLlegadaCliente\": \"number?\",\n    \"HoraFinEntrega\": \"datetime?\",\n    \"LatitudFinEntrega\": \"number?\",\n    \"LongitudFinEntrega\": \"number?\",\n    \"IdTicket\": \"string?\",\n    \"PesoConfirmadoManual\": \"number?\",\n    \"Cancelado\": \"boolean?\",\n    \"Comentario\": \"string?\",\n    \"Version\": \"string?\"\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/api-viajes/#estados-del-viaje","title":"Estados del Viaje","text":"<ul> <li><code>Inicio Jornada</code></li> <li><code>Confirmaci\u00f3n</code></li> <li><code>Carga</code></li> <li><code>Pesaje</code></li> <li><code>Con Folio</code></li> <li><code>Llegada Cliente</code></li> <li><code>Fin Entrega</code></li> <li><code>Cancelado</code></li> </ul>"},{"location":"backend/tracmin/viajes/api-viajes/#respuestas","title":"Respuestas","text":"<p>\u00c9xito<pre><code>{\n    \"message\": \"trip updated correctly\",\n    \"id\": 12345\n}\n</code></pre> Error<pre><code>{\n    \"detail\": \"Mensaje espec\u00edfico del error\",\n    \"status_code\": 400/401/404/500\n}\n</code></pre></p>"},{"location":"backend/tracmin/viajes/buscar-cancelado/","title":"API BUSCAR CANCELADO - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/viajes/buscar-cancelado/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Endpoint para verificar el estado de cancelaci\u00f3n de una gu\u00eda/viaje y obtener informaci\u00f3n relevante del viaje activo.</p> Notas Importantes <ul> <li>Endpoint para verificar el estado de cancelaci\u00f3n de una gu\u00eda/viaje y obtener informaci\u00f3n relevante del viaje activo.</li> <li>Normalizaci\u00f3n autom\u00e1tica de timestamps (eliminaci\u00f3n de microsegundos)</li> <li>B\u00fasqueda del viaje m\u00e1s reciente basado en m\u00faltiples criterios</li> <li>Diferenciaci\u00f3n entre viajes cancelados y activos</li> <li>Retorna informaci\u00f3n detallada para viajes activos</li> </ul>"},{"location":"backend/tracmin/viajes/buscar-cancelado/#endpoint-buscar-cancelado","title":"Endpoint Buscar Cancelado","text":"<p><code>POST /api/logipath/search_guide_cancel</code></p> Flujo ExplicadoEstados y RespuestasFlujo DiagramaSequence Diagram <pre><code>graph TD\n    A[Cliente] --&gt; B{Validar JWT}\n    B --&gt;|Invalid| C[Error 401]\n    B --&gt;|Valid| D[Normalizar Timestamp]\n\n    D --&gt; E[Buscar Viaje]\n    E --&gt; F{Viaje Encontrado?}\n\n    F --&gt;|No| G[Error]\n    F --&gt;|Si| H{CantidadPausa = True?}\n\n    H --&gt;|Si| I[Retornar Info Cancelaci\u00f3n]\n    H --&gt;|No| J[Retornar Info Viaje Activo]\n\n    G --&gt; K[Respuesta Error]\n    I --&gt; L[Respuesta]\n    J --&gt; L</code></pre> <pre><code>sequenceDiagram\n    participant Client\n    participant API\n    participant DB\n\n    Client-&gt;&gt;API: POST /search_guide_cancel\n    API-&gt;&gt;API: Validar JWT\n\n    API-&gt;&gt;API: Normalizar HoraInicioJornada\n\n    API-&gt;&gt;DB: Buscar viaje m\u00e1s reciente\n    DB--&gt;&gt;API: Datos del viaje\n\n    alt CantidadPausa = True\n        API--&gt;&gt;Client: Info viaje cancelado\n    else CantidadPausa = False\n        API--&gt;&gt;Client: Info viaje activo\n    end</code></pre>"},{"location":"backend/tracmin/viajes/buscar-cancelado/#1-verificacion-inicial","title":"1. Verificaci\u00f3n Inicial","text":"<ul> <li><code>Validaci\u00f3n del token JWT</code></li> <li><code>Normalizaci\u00f3n de HoraInicioJornada</code></li> </ul>"},{"location":"backend/tracmin/viajes/buscar-cancelado/#2-busqueda-del-viaje","title":"2. B\u00fasqueda del Viaje","text":"<ul> <li><code>Criterios de b\u00fasqueda:</code><ul> <li><code>IdProgramado</code></li> <li><code>RutConductor</code></li> <li><code>HoraInicioJornada</code></li> </ul> </li> <li><code>Ordenamiento por Id descendente</code></li> <li><code>Selecci\u00f3n del registro m\u00e1s reciente</code></li> </ul>"},{"location":"backend/tracmin/viajes/buscar-cancelado/#3-evaluacion-de-estado","title":"3. Evaluaci\u00f3n de Estado","text":"<ul> <li><code>Verificaci\u00f3n de CantidadPausa</code></li> <li><code>Retorno de informaci\u00f3n seg\u00fan estado</code></li> </ul> Estructura de buscar cancelado<pre><code>{\n    \"IdProgramado\": \"number\",\n    \"RutConductor\": \"string\",\n    \"HoraInicioJornada\": \"datetime\"\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/buscar-cancelado/#respuestas","title":"Respuestas","text":"<p>\u00c9xito<pre><code>{\n    \"message\": \"Viaje Cancelado\",\n    \"IdProgramado\": 12345,\n    \"RutConductor\": \"12345678-9\",\n    \"HoraInicioJornada\": \"2024-01-01T12:00:00\"\n}\n</code></pre> \u00c9xito<pre><code>{\n    \"message\": \"Viaje Activo\",\n    \"Tara\": 1000,\n    \"Id\": 12345,\n    \"horaConfirmacion\": \"2024-01-01T12:30:00\",\n    \"latitud\": -33.4569,\n    \"longitud\": -70.6483\n}\n</code></pre> Error<pre><code>{\n    \"message\": \"Invalid request, please fill all the required fields.\",\n    \"error\": \"Error espec\u00edfico\"\n}\n</code></pre></p>"},{"location":"backend/tracmin/viajes/cerrar-viajes/","title":"API Cerrar Viaje","text":""},{"location":"backend/tracmin/viajes/cerrar-viajes/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Endpoint para finalizar (cerrar) un viaje, registrando el peso, duraci\u00f3n, forma de descarga y otros datos relevantes. Permite subir foto del ticket, procesarla con IA, ingresar datos manualmente y actualizar el estado del viaje.</p> Notas Importantes <ul> <li>Permite finalizar viajes pendientes, asegurando el registro correcto de datos.</li> <li>Soporta procesamiento autom\u00e1tico de tickets mediante IA (foto).</li> <li>Permite ingreso manual de datos si la foto no es v\u00e1lida.</li> <li>Actualiza la forma de descarga (silo/acopio).</li> <li>Utiliza m\u00faltiples endpoints para completar el flujo.</li> </ul> Consideraciones Importantes <ul> <li>Todos los endpoints requieren autenticaci\u00f3n JWT</li> <li>El viaje debe existir en la base de datos</li> <li>Validar formatos y datos antes de enviar</li> </ul> Mejores Pr\u00e1cticas <ul> <li>Validar el formato de la imagen antes del env\u00edo</li> <li>Comprimir im\u00e1genes grandes</li> <li>Implementar retry logic para fallos de red</li> <li>Mantener logs detallados</li> </ul>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#endpoints-utilizados","title":"Endpoints Utilizados","text":""},{"location":"backend/tracmin/viajes/cerrar-viajes/#1-obtener-viajes-pendientes","title":"1. Obtener viajes pendientes","text":"<p><code>POST /api/logipath/recent_trips_mes2</code></p> <p>Permite obtener la lista de viajes recientes o pendientes de cierre, filtrados seg\u00fan el transportista y reglas de negocio.</p>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#ejemplo-de-request","title":"Ejemplo de request","text":"Request<pre><code>{\n    \"CodigoTransportista\": \"TM\"\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#ejemplo-de-respuesta","title":"Ejemplo de respuesta","text":"Response<pre><code>{\n    \"results\": [\n        {\n            \"Id\": 123,\n            \"IdProgramado\": 456,\n            \"PlantaOrigen\": \"PLANTA1\",\n            \"Cliente\": \"CLIENTE1\",\n            \"RutConductor\": \"12345678-9\",\n            \"Patente\": \"ABCD12\",\n            \"HoraInicioJornada\": \"2024-01-01T08:00:00\",\n            \"Folio\": 789,\n            \"IdTicket\": null,\n            ...\n        }\n    ]\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#2-subir-foto-del-ticket","title":"2. Subir foto del ticket","text":"<p><code>POST /api/logipath/upload_photo</code></p> <p>Permite subir la foto del ticket de pesaje asociada al viaje.</p>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#ejemplo-de-request_1","title":"Ejemplo de request","text":"Request<pre><code>{\n    \"IdProgramado\": 456,\n    \"RutConductor\": \"12345678-9\",\n    \"HoraInicioJornada\": \"2024-01-01T08:00:00\",\n    \"folio\": \"789\",\n    \"data\": \"&lt;base64 de la imagen&gt;\"\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#ejemplo-de-respuesta_1","title":"Ejemplo de respuesta","text":"Response<pre><code>{\n    \"blob_name\": \"TKT1234-789\",\n    \"link\": \"https://.../TKT1234-789\",\n    \"status_code\": 200\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#3-procesar-ticket-con-ia","title":"3. Procesar ticket con IA","text":"<p><code>POST /api/logipath/procesamiento_ia</code></p> <p>Procesa la imagen del ticket para extraer peso, duraci\u00f3n y otros datos autom\u00e1ticamente.</p>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#ejemplo-de-request_2","title":"Ejemplo de request","text":"Request<pre><code>{\n    \"Cliente\": \"CLIENTE1\",\n    \"LinkBlob\": \"https://.../TKT1234-789\",\n    \"BlobName\": \"TKT1234-789\",\n    \"Folio\": \"789\",\n    \"NombreConductor\": \"Juan Perez\",\n    \"RutConductor\": \"12345678-9\",\n    \"Patente\": \"ABCD12\"\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#ejemplo-de-respuesta_2","title":"Ejemplo de respuesta","text":"Response<pre><code>{\n    \"IdTicket\": \"TKT1234-789\",\n    \"status_code\": 200,\n    \"PesoConfirmado\": \"28070\",\n    \"Duracion\": 90\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#4-actualizar-forma-de-descarga","title":"4. Actualizar forma de descarga","text":"<p><code>POST /api/logipath/forma_descarga</code></p> <p>Permite registrar si la descarga fue en silo o acopio, y actualizar el estado del ticket.</p>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#ejemplo-de-request_3","title":"Ejemplo de request","text":"Request<pre><code>{\n    \"IdTicket\": \"TKT1234-789\",\n    \"FormaDescarga\": \"SILO\",\n    \"Romana\": true\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#ejemplo-de-respuesta_3","title":"Ejemplo de respuesta","text":"Response<pre><code>{\n    \"message\": \"forma descarga actualizada\",\n    \"status_code\": 200\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#5-finalizar-viaje","title":"5. Finalizar viaje","text":"<p><code>POST /api/logipath/post_trip</code></p> <p>Actualiza el viaje con todos los datos finales (peso, duraci\u00f3n, ticket, forma de descarga, comentarios, etc).</p>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#ejemplo-de-request_4","title":"Ejemplo de request","text":"Request<pre><code>{\n    \"IdProgramado\": 456,\n    \"Cliente\": \"CLIENTE1\",\n    \"RutConductor\": \"12345678-9\",\n    \"Patente\": \"ABCD12\",\n    \"HoraInicioJornada\": \"2024-01-01T08:00:00\",\n    \"Folio\": \"789\",\n    \"IdTicket\": \"TKT1234-789\",\n    \"PesoConfirmadoManual\": 28070,\n    \"Recepcionista\": \"Viaje Terminado Por Admin\",\n    \"Comentario\": \"Todo OK\",\n    \"Version\": \"1.0.0\",\n    ...\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#ejemplo-de-respuesta_4","title":"Ejemplo de respuesta","text":"Response<pre><code>{\n    \"message\": \"trip updated correctly\",\n    \"id\": 123,\n    \"romana\": true\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#flujo-explicado","title":"Flujo Explicado","text":"<ol> <li>Se obtiene la lista de viajes pendientes (<code>POST /api/logipath/recent_trips_mes2</code>).</li> <li>Se sube la foto del ticket (<code>POST /api/logipath/upload_photo</code>).</li> <li>Se procesa la foto con IA (<code>POST /api/logipath/procesamiento_ia</code>) para extraer peso y duraci\u00f3n.</li> <li>Si la foto no es v\u00e1lida, se permite ingresar los datos manualmente.</li> <li>Se actualiza la forma de descarga (<code>POST /api/logipath/forma_descarga</code>).</li> <li>Se finaliza el viaje enviando todos los datos (<code>POST /api/logipath/post_trip</code>).</li> <li>El sistema responde con confirmaci\u00f3n o error.</li> </ol>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#diagrama-de-flujo","title":"Diagrama de Flujo","text":"<pre><code>graph TD\n    A[POST /api/logipath/recent_trips_mes2] --&gt; B[POST /api/logipath/upload_photo]\n    B --&gt; C[POST /api/logipath/procesamiento_ia]\n    C --&gt;|V\u00e1lido| D[POST /api/logipath/forma_descarga]\n    C --&gt;|No v\u00e1lido| E[Ingreso manual de datos]\n    D --&gt; F[POST /api/logipath/post_trip]\n    E --&gt; F\n    F --&gt; G[Confirmaci\u00f3n]</code></pre>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#sequence-diagram","title":"Sequence Diagram","text":"<pre><code>sequenceDiagram\n    participant API\n    participant AzureBlob\n    participant IA\n    participant DB\n\n    API-&gt;&gt;DB: POST /api/logipath/recent_trips_mes2\n    API-&gt;&gt;AzureBlob: POST /api/logipath/upload_photo\n    AzureBlob--&gt;&gt;API: URL Imagen\n    API-&gt;&gt;IA: POST /api/logipath/procesamiento_ia\n    IA--&gt;&gt;API: Peso, duraci\u00f3n\n    API-&gt;&gt;DB: POST /api/logipath/forma_descarga\n    API-&gt;&gt;DB: POST /api/logipath/post_trip\n    DB--&gt;&gt;API: Confirmaci\u00f3n</code></pre>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#estados-y-respuestas","title":"Estados y Respuestas","text":""},{"location":"backend/tracmin/viajes/cerrar-viajes/#exito","title":"\u00c9xito","text":"Viaje cerrado correctamente<pre><code>{\n    \"message\": \"trip updated correctly\",\n    \"id\": 123,\n    \"romana\": true\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/cerrar-viajes/#error","title":"Error","text":"Error al cerrar viaje<pre><code>{\n    \"message\": \"trip not found\",\n    \"id\": null\n}\n\n{\n    \"message\": \"No se encontr\u00f3 el viaje\"\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/crear-viaje/","title":"API CREAR VIAJES - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/viajes/crear-viaje/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Endpoint para la creaci\u00f3n r\u00e1pida de viajes programados con validaci\u00f3n de duplicados.</p> Notas Importantes <ul> <li>Requiere autenticaci\u00f3n JWT con permisos de administrador</li> <li>L\u00edmite de 3 viajes similares permitidos</li> <li>Validaci\u00f3n de duplicados basada en m\u00faltiples campos</li> <li>Creaci\u00f3n autom\u00e1tica con estados iniciales predefinidos</li> <li>Transacci\u00f3n at\u00f3mica para garantizar consistencia  </li> </ul> Consideraciones Importantes <ul> <li>El l\u00edmite de 3 viajes similares es una medida de seguridad</li> <li>Los viajes se consideran similares si coinciden en todos los campos clave</li> <li>La fecha programada debe estar en UTC</li> <li>Se requieren permisos de administrador para usar este endpoint</li> <li>La transacci\u00f3n es at\u00f3mica para evitar estados inconsistentes (No existe estados intermedios)</li> <li>Los estados iniciales son no modificables en la creaci\u00f3n</li> </ul>"},{"location":"backend/tracmin/viajes/crear-viaje/#endpoint-quick-trip","title":"Endpoint Quick Trip","text":"<p><code>POST /api/logipath/quick_trip</code></p> Flujo ExplicadoEstados y RespuestasFlujo DiagramaSequence Diagram <pre><code>graph TD\n    A[Cliente] --&gt; B{Validar JWT}\n    B --&gt;|Invalid| C[Error 401]\n    B --&gt;|Valid| D[Verificar Admin]\n\n    D --&gt;|No Admin| E[Error 403]\n    D --&gt;|Admin| F[Buscar Viajes Similares]\n\n    F --&gt; G{Cantidad &gt; 3?}\n    G --&gt;|Si| H[Retornar IDs Existentes]\n    G --&gt;|No| I[Crear Nuevo Viaje]\n\n    I --&gt; J[Inicializar Estados]\n    J --&gt; K[Commit DB]\n    K --&gt; L[Respuesta Success]\n\n    H --&gt; M[Respuesta con IDs]</code></pre> <pre><code>sequenceDiagram\n    participant Client\n    participant API\n    participant DB\n\n    Client-&gt;&gt;API: POST /quick_trip\n    API-&gt;&gt;API: Validar JWT + Admin\n\n    API-&gt;&gt;DB: Buscar viajes similares\n    DB--&gt;&gt;API: Lista de viajes\n\n    alt M\u00e1s de 3 viajes similares\n        API--&gt;&gt;Client: IDs de viajes existentes\n    else Menos de 3 viajes\n        API-&gt;&gt;DB: Crear nuevo ScheduledTrip\n        DB--&gt;&gt;API: Commit successful\n        API--&gt;&gt;Client: Confirmaci\u00f3n de creaci\u00f3n\n    end</code></pre>"},{"location":"backend/tracmin/viajes/crear-viaje/#1-validacion-de-seguridad","title":"1. Validaci\u00f3n de Seguridad","text":"<ul> <li><code>Verificaci\u00f3n de token JWT</code></li> <li><code>Validaci\u00f3n de permisos de administrador</code></li> </ul>"},{"location":"backend/tracmin/viajes/crear-viaje/#2-verificacion-de-duplicados","title":"2. Verificaci\u00f3n de Duplicados","text":"<ul> <li><code>B\u00fasqueda de viajes existentes con criterios m\u00faltiples:</code><ul> <li><code>RutConductor</code></li> <li><code>Cliente</code></li> <li><code>Patente</code></li> <li><code>FechaProgramadaUtc</code></li> <li><code>Programador</code></li> </ul> </li> </ul>"},{"location":"backend/tracmin/viajes/crear-viaje/#3-creacion-del-viaje","title":"3. Creaci\u00f3n del Viaje","text":"<ul> <li><code>Si hay menos de 3 viajes similares:</code><ul> <li><code>Creaci\u00f3n de nuevo ScheduledTrip</code></li> <li><code>Inicializaci\u00f3n de estados</code></li> <li><code>Commit en base de datos</code></li> </ul> </li> </ul> Estructura de API crear viajes<pre><code>{\n    \"FechaProgramadaUtc\": \"datetime\",\n    \"PlantaOrigen\": \"string\",\n    \"Cliente\": \"string\",\n    \"RutConductor\": \"string\",\n    \"Patente\": \"string\",\n    \"Programador\": \"string?\"\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/crear-viaje/#estados-iniciales","title":"Estados Iniciales","text":"<ul> <li><code>Terminado: false</code></li> <li><code>Cancelado: false</code></li> </ul>"},{"location":"backend/tracmin/viajes/crear-viaje/#respuestas","title":"Respuestas","text":"<p>\u00c9xito<pre><code>{\n    \"message\": \"quick trip added successfully\"\n}\n</code></pre> Error Duplicado<pre><code>{\n    \"message\": \"trip is already created\",\n    \"Ids\": [123, 124, 125]\n}\n</code></pre> Error<pre><code>{\n    \"detail\": \"Invalid authentication credentials\",\n    \"status_code\": 401\n}\n</code></pre></p>"},{"location":"backend/tracmin/viajes/pendientes/","title":"API Viajes Pendientes - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/viajes/pendientes/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Sistema de gesti\u00f3n de viajes pendientes que permite consultar y actualizar el estado de viajes que quedaron incompletos, permitiendo su finalizaci\u00f3n desde el panel administrativo.</p> Notas Importantes <ul> <li>Sistema de gesti\u00f3n de viajes pendientes</li> <li>Requiere autenticaci\u00f3n JWT</li> <li>Modelos principales:     modelos<pre><code>class TripRequest(BaseModel):\n    IdProgramado: int\n    RutConductor: str\n    HoraInicioJornada: datetime\n    HoraFinEntrega: Optional[datetime]\n    Cancelado: Optional[bool]\n    Comentario: Optional[str]\n    # ... otros campos opcionales\n\nclass GetScheduleRequest(BaseModel):\n    RutConductor: str\n</code></pre></li> </ul> Consideraciones Importantes <ul> <li>Per\u00edodo de b\u00fasqueda: 30 d\u00edas o desde 12-08-2024</li> <li>Validaci\u00f3n de estados incompletos</li> <li>Actualizaci\u00f3n at\u00f3mica de estados</li> <li>Manejo de transacciones DB</li> <li>Logging de cambios</li> </ul> Mejores Pr\u00e1cticas <ul> <li>Validar datos antes de actualizar</li> <li>Mantener consistencia de estados</li> <li>Documentar cambios realizados</li> <li>Verificar permisos de usuario</li> <li>Mantener trazabilidad</li> </ul> Estados de Viaje <ul> <li>Pendiente: <ul> <li>Con Folio</li> <li>Sin peso confirmado</li> <li>Sin pausas registradas</li> </ul> </li> <li>Finalizado:<ul> <li>HoraFinEntrega registrada</li> <li>Viaje programado marcado como terminado</li> </ul> </li> <li>Cancelado:<ul> <li>Estado cancelado actualizado</li> <li>Comentario registrado</li> <li>Viaje programado marcado como terminado</li> </ul> </li> </ul>"},{"location":"backend/tracmin/viajes/pendientes/#endpoints-viajes-pendientes","title":"Endpoints Viajes Pendientes","text":"EndpointsSequence DiagramCriterios de B\u00fasquedaEjemplos de Respuesta Consultar Viajes Pendientes POST /api/logipath/get_pending_trip<pre><code>@router.post(f\"{APP_PATH}/get_pending_trip\")\nasync def get_pending_trip(\n    sec: Annotated[str, Depends(security_scheme)], \n    req: GetScheduleRequest\n):\n    \"\"\"\n    Retorna los viajes pendientes de finalizaci\u00f3n para un conductor espec\u00edfico.\n\n    Args:\n        sec (str): Token JWT\n        req (GetScheduleRequest): Rut del conductor\n\n    Returns:\n        dict: {\n            \"results\": {\n                Informaci\u00f3n detallada del viaje pendiente\n            }\n        }\n\n    Raises:\n        HTTPException: \n            - 404: Si no hay viajes pendientes\n            - 500: Error interno\n    \"\"\"\n</code></pre> Actualizar Viaje Pendiente POST /api/logipath/post_trip_pending<pre><code>@router.post(f\"{APP_PATH}/post_trip_pending\")\nasync def post_trip(\n    sec: Annotated[str, Depends(security_scheme)], \n    req: TripRequest\n):\n    \"\"\"\n    Actualiza el estado de un viaje pendiente.\n\n    Args:\n        sec (str): Token JWT\n        req (TripRequest): Datos de actualizaci\u00f3n del viaje\n\n    Returns:\n        dict: {\"message\": \"Trip updated correctly\"}\n\n    Raises:\n        HTTPException: Si hay error en la actualizaci\u00f3n\n    \"\"\"\n</code></pre> <pre><code>sequenceDiagram\n    participant Admin\n    participant API\n    participant DB\n\n    alt Consultar Pendientes\n        Admin-&gt;&gt;API: POST /get_pending_trip\n        API-&gt;&gt;API: Validar JWT\n        API-&gt;&gt;DB: Query Viajes Pendientes\n\n        alt Viaje Encontrado\n            DB--&gt;&gt;API: Datos Viaje\n            API--&gt;&gt;Admin: Informaci\u00f3n Viaje\n        else Sin Pendientes\n            API--&gt;&gt;Admin: Error 404\n        end\n\n    else Actualizar Pendiente\n        Admin-&gt;&gt;API: POST /post_trip_pending\n        API-&gt;&gt;API: Validar JWT\n        API-&gt;&gt;DB: Buscar Viaje\n\n        alt Viaje Existe\n            API-&gt;&gt;DB: Actualizar Estados\n            DB--&gt;&gt;API: Confirmaci\u00f3n\n\n            opt Finalizaci\u00f3n\n                API-&gt;&gt;DB: Marcar Programado como Terminado\n            end\n\n            opt Cancelaci\u00f3n\n                API-&gt;&gt;DB: Marcar como Cancelado\n                API-&gt;&gt;DB: Actualizar Comentario\n            end\n\n            API--&gt;&gt;Admin: Success\n        else No Existe\n            API--&gt;&gt;Admin: \"Trip not found\"\n        end\n    end</code></pre> Campo Descripci\u00f3n Folio No nulo HoraConfirmacionFolio &gt;= start_date PesoConfirmadoManual Nulo CantidadPausa Nulo Consulta Viaje Pendiente <pre><code>{\n    \"results\": {\n        \"Id\": 1,\n        \"IdProgramado\": 100,\n        \"PlantaOrigen\": \"Planta A\",\n        \"Cliente\": \"Cliente X\",\n        \"RutConductor\": \"12345678-9\",\n        \"Patente\": \"ABCD12\",\n        \"HoraInicioJornada\": \"2024-03-20T08:00:00\",\n        \"Folio\": \"F001\",\n        \"Comentario\": \"PendingTrip\"\n    }\n}\n</code></pre> Actualizaci\u00f3n Exitosa <pre><code>{\n    \"message\": \"Trip updated correctly\"\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/post-trip-tara/","title":"API VIAJES TARA - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/viajes/post-trip-tara/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Endpoint espec\u00edfico para actualizar la tara de un viaje y gestionar la transici\u00f3n a la etapa de carga.</p> Notas Importantes <ul> <li>Conversi\u00f3n autom\u00e1tica de zona horaria Chile a UTC</li> <li>Notificaci\u00f3n en tiempo real v\u00eda WebPubSub</li> <li>Actualizaci\u00f3n selectiva de campos no nulos</li> <li>Manejo de errores en notificaciones sin afectar la transacci\u00f3n principal</li> <li>Requiere autenticaci\u00f3n JWT sin permisos de administrador</li> </ul> Consideraciones Importantes <ul> <li>La conversi\u00f3n de zona horaria es cr\u00edtica para la consistencia de datos</li> <li>El WebPubSub puede fallar sin afectar la actualizaci\u00f3n del viaje</li> <li>Los campos no proporcionados se mantienen sin cambios</li> <li>La respuesta es exitosa incluso si falla la notificaci\u00f3n WebPubSub</li> <li>Se requiere manejo especial de microsegundos para compatibilidad con la base de datos</li> </ul>"},{"location":"backend/tracmin/viajes/post-trip-tara/#endpoint-post-trip-tara","title":"Endpoint Post Trip Tara","text":"<p><code>POST /api/logipath/post_trip_tara</code></p> Flujo ExplicadoEstados y RespuestasFlujo DiagramaSequence Diagram <pre><code>graph TD\n    A[Cliente] --&gt; B{Validar JWT}\n    B --&gt;|Invalid| C[Error 401]\n    B --&gt;|Valid| D[Convertir Hora a UTC]\n\n    D --&gt; E[Normalizar Timestamps]\n    E --&gt; F[Buscar Viaje]\n\n    F --&gt;|No encontrado| G[Error 404]\n    F --&gt;|Encontrado| H[Actualizar Campos]\n\n    H --&gt; I[Commit DB]\n    I --&gt; J{Enviar WebPubSub}\n\n    J --&gt;|Error| K[Log Error]\n    J --&gt;|Success| L[Continue]\n\n    K --&gt; M[Respuesta Success]\n    L --&gt; M</code></pre> <pre><code>sequenceDiagram\n    participant Client\n    participant API\n    participant DB\n    participant WebPubSub\n\n    Client-&gt;&gt;API: POST /post_trip_tara\n    API-&gt;&gt;API: Validar JWT\n\n    API-&gt;&gt;API: Convertir hora a UTC\n    API-&gt;&gt;API: Normalizar timestamps\n\n    API-&gt;&gt;DB: Buscar viaje\n    DB--&gt;&gt;API: Viaje encontrado\n\n    API-&gt;&gt;DB: Actualizar campos\n    DB--&gt;&gt;API: Commit successful\n\n    API-&gt;&gt;WebPubSub: Notificar \"pantallaCarga\"\n\n    alt Error WebPubSub\n        WebPubSub--&gt;&gt;API: Error\n        API-&gt;&gt;API: Log error\n    end\n\n    API--&gt;&gt;Client: Respuesta exitosa</code></pre>"},{"location":"backend/tracmin/viajes/post-trip-tara/#1-verificacion-inicial","title":"1. Verificaci\u00f3n Inicial","text":"<ul> <li><code>Validaci\u00f3n del token JWT</code></li> <li><code>Normalizaci\u00f3n de timestamps (eliminaci\u00f3n de microsegundos)</code></li> <li><code>Conversi\u00f3n de HoraInicioJornada a UTC</code></li> </ul>"},{"location":"backend/tracmin/viajes/post-trip-tara/#2-actualizacion-de-viaje-existente","title":"2. Actualizaci\u00f3n de Viaje Existente","text":"<ul> <li><code>B\u00fasqueda del viaje por identificadores \u00fanicos:</code><ul> <li><code>IdProgramado</code></li> <li><code>RutConductor</code></li> <li><code>HoraInicioJornada</code></li> </ul> </li> <li><code>Actualizaci\u00f3n selectiva de campos no nulos</code></li> <li><code>Commit de cambios en la base de datos</code></li> </ul>"},{"location":"backend/tracmin/viajes/post-trip-tara/#3-notificacion","title":"3. Notificaci\u00f3n","text":"<ul> <li><code>Env\u00edo de se\u00f1al \"pantallaCarga\" v\u00eda WebPubSub</code></li> <li><code>Manejo de errores de notificaci\u00f3n sin afectar la transacci\u00f3n principal</code></li> </ul> Estructura de API viajes<pre><code>{\n    \"IdProgramado\": \"number\",\n    \"RutConductor\": \"string\",\n    \"HoraInicioJornada\": \"datetime\",\n    \"TaraViaje\": \"number\",\n    \"HoraConfirmacion\": \"datetime\",\n    \"LatitudInicioJornada\": \"number?\",\n    \"LongitudInicioJornada\": \"number?\",\n}\n</code></pre>"},{"location":"backend/tracmin/viajes/post-trip-tara/#respuestas","title":"Respuestas","text":"<p>\u00c9xito<pre><code>{\n    \"message\": \"trip updated correctly\"\n}\n</code></pre> Error JWT<pre><code>{\n    \"detail\": \"Invalid authentication credentials\",\n    \"status_code\": 401\n}\n</code></pre> Error Trip<pre><code>{\n    \"detail\": \"Trip not found\",\n    \"status_code\": 404\n}\n</code></pre></p>"},{"location":"backend/tracmin/viajes/programados_realizados/","title":"API Viajes Programados - Documentaci\u00f3n","text":""},{"location":"backend/tracmin/viajes/programados_realizados/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Sistema de gesti\u00f3n de viajes programados que permite consultar y administrar viajes programados, con diferentes niveles de acceso para administradores y conductores.</p> Notas Importantes <ul> <li>Sistema de gesti\u00f3n de viajes programados</li> <li>Diferentes niveles de acceso (admin/conductor)</li> <li>Modelos principales:     modelos<pre><code>class GetScheduleRequest(BaseModel):\n    RutConductor: str\n\nclass CancelScheduledRequest(BaseModel):\n    Id: int\n    Comentario: Optional[str] = None\n</code></pre></li> </ul> Consideraciones de Seguridad <ul> <li>Validar permisos de usuario vs admin</li> <li>Validar existencia de viajes</li> <li>Manejar estados de cancelaci\u00f3n</li> <li>Proteger informaci\u00f3n sensible</li> <li>Validar tokens JWT seg\u00fan rol</li> </ul>"},{"location":"backend/tracmin/viajes/programados_realizados/#endpoints-viajes-programados","title":"Endpoints Viajes Programados","text":"Endpoints AdministrativosEndpoints ConductoresSequence DiagramEjemplos de RespuestaDiferencias por Rol Listar Todos los Viajes Programados (Admin) POST /api/logipath/scheduled_trips<pre><code>@router.post(f\"{APP_PATH}/scheduled_trips\")\nasync def scheduled_trips(sec: Annotated[str, Depends(security_scheme)]):\n    \"\"\"\n    Retorna todos los viajes programados para visualizaci\u00f3n administrativa.\n    Requiere permisos de administrador.\n\n    Args:\n        sec (str): Token JWT de administrador\n\n    Returns:\n        dict: {\n            \"results\": [\n                {\n                    \"Id\": int,\n                    \"FechaProgramadaUtc\": datetime,\n                    \"PlantaOrigen\": str,\n                    \"Cliente\": str,\n                    \"Programador\": str,\n                    \"RutConductor\": str,\n                    \"Patente\": str,\n                    \"Terminado\": bool,\n                    \"Cancelado\": bool,\n                    \"Comentario\": str,\n                    \"CodigoTransportista\": str,\n                    \"UserName\": str\n                }\n            ]\n        }\n\n    Raises:\n        HTTPException: \n            - 404: Si no hay viajes programados\n            - 401: Si el token es inv\u00e1lido\n            - 403: Si no tiene permisos de admin\n    \"\"\"\n</code></pre> Cancelar Viaje Programado POST /api/logipath/cancel_scheduled<pre><code>@router.post(f\"{APP_PATH}/cancel_scheduled\")\nasync def cancel_scheduled(\n    sec: Annotated[str, Depends(security_scheme)], \n    req: CancelScheduledRequest\n):\n    \"\"\"\n    Cancela un viaje programado espec\u00edfico.\n\n    Args:\n        sec (str): Token JWT de autenticaci\u00f3n\n        req (CancelScheduledRequest): ID del viaje y comentario opcional\n\n    Returns:\n        dict: {\"message\": \"scheduled_trip Id:{id} cancelled successfully\"}\n    \"\"\"\n</code></pre> Consultar Viajes Asignados (Conductor) POST /api/logipath/get_schedule<pre><code>@router.post(f\"{APP_PATH}/get_schedule\")\nasync def get_schedule(\n    sec: Annotated[str, Depends(security_scheme)], \n    req: GetScheduleRequest\n):\n    \"\"\"\n    Retorna los viajes programados para un conductor espec\u00edfico.\n\n    Args:\n        sec (str): Token JWT del conductor\n        req (GetScheduleRequest): Rut del conductor\n\n    Returns:\n        dict: {\"results\": [Lista de viajes programados]}\n    \"\"\"\n</code></pre> <pre><code>sequenceDiagram\n    participant Admin\n    participant Conductor\n    participant API\n    participant DB\n\n    alt Vista Administrativa\n        Admin-&gt;&gt;API: POST /scheduled_trips\n        API-&gt;&gt;API: Validar JWT Admin\n        API-&gt;&gt;DB: Query Todos los Viajes\n        DB-&gt;&gt;DB: Join con Users\n        DB--&gt;&gt;API: Viajes + Info Usuario\n        API--&gt;&gt;Admin: Lista Completa\n\n    else Vista Conductor\n        Conductor-&gt;&gt;API: POST /get_schedule\n        API-&gt;&gt;API: Validar JWT\n        API-&gt;&gt;DB: Query Viajes del Conductor\n        DB--&gt;&gt;API: Viajes Filtrados\n        API--&gt;&gt;Conductor: Viajes Asignados\n\n    else Cancelaci\u00f3n\n        Admin-&gt;&gt;API: POST /cancel_scheduled\n        API-&gt;&gt;API: Validar JWT\n        API-&gt;&gt;DB: Actualizar Estado\n        DB--&gt;&gt;API: Confirmaci\u00f3n\n        API--&gt;&gt;Admin: Success\n    end</code></pre> Lista Administrativa <pre><code>{\n    \"results\": [\n        {\n            \"Id\": 1,\n            \"FechaProgramadaUtc\": \"2024-03-20T10:00:00\",\n            \"PlantaOrigen\": \"Planta A\",\n            \"Cliente\": \"Cliente X\",\n            \"Programador\": \"Admin1\",\n            \"RutConductor\": \"12345678-9\",\n            \"Patente\": \"ABCD12\",\n            \"Terminado\": false,\n            \"Cancelado\": false,\n            \"Comentario\": null,\n            \"CodigoTransportista\": \"TRANS1\",\n            \"UserName\": \"Juan P\u00e9rez\"\n        }\n    ]\n}\n</code></pre> Lista Conductor <pre><code>{\n    \"results\": [\n        {\n            \"Id\": 1,\n            \"FechaProgramadaUtc\": \"2024-03-20T10:00:00\",\n            \"PlantaOrigen\": \"Planta A\",\n            \"Cliente\": \"Cliente X\",\n            \"Patente\": \"ABCD12\"\n        }\n    ]\n}\n</code></pre> Caracter\u00edstica Vista Admin Vista Conductor Alcance Todos los viajes Solo viajes propios Per\u00edodo 2 d\u00edas atr\u00e1s Hoy + 2 d\u00edas Info Usuario Incluida No incluida Permisos Completos Solo lectura Cancelaci\u00f3n Permitida No permitida Detalles T\u00e9cnicos <ul> <li>Vista Admin:<ul> <li>Join con tabla Users</li> <li>Incluye informaci\u00f3n completa</li> <li>Muestra todos los conductores</li> </ul> </li> <li>Vista Conductor:<ul> <li>Filtrada por RutConductor</li> <li>Informaci\u00f3n limitada</li> <li>Rango de fechas espec\u00edfico</li> </ul> </li> <li>Cancelaci\u00f3n:<ul> <li>Actualiza estados</li> <li>Registra comentarios</li> <li>Mantiene historial</li> </ul> </li> </ul>"},{"location":"backend/tracmin/viajes/programados_realizados/#viajes-realizados","title":"Viajes Realizados","text":"Endpoint Viajes Realizados Consultar Viajes Recientes (Admin) POST /api/logipath/recent_trips_mes<pre><code>@router.post(f\"{APP_PATH}/recent_trips_mes\")\nasync def recent_trips_mes(sec: Annotated[str, Depends(security_scheme)]):\n    \"\"\"\n    Retorna los viajes realizados en las \u00faltimas 5 semanas con estad\u00edsticas\n    y detalles de productos desde SAP.\n    Requiere permisos de administrador.\n\n    Args:\n        sec (str): Token JWT de administrador\n\n    Returns:\n        dict: {\n            \"results\": [Lista de viajes con detalles],\n            \"cantidad_x_dia_semana\": [Estad\u00edsticas por d\u00eda]\n        }\n\n    Raises:\n        HTTPException: \n            - 404: Si no hay viajes recientes\n            - 401: Si el token es inv\u00e1lido\n            - 500: Error interno del servidor\n    \"\"\"\n</code></pre> Estructura de Datos Modelo de Respuesta<pre><code>{\n    \"results\": [\n        {\n            \"Id\": int,\n            \"IdProgramado\": int,\n            \"PlantaOrigen\": str,\n            \"Cliente\": str,\n            \"RutConductor\": str,\n            \"Patente\": str,\n            \"HoraInicioJornada\": datetime,\n            \"HoraFinEntrega\": datetime,\n            \"Folio\": str,\n            \"Cancelado\": bool,\n            \"RutTransportista\": str,\n            \"NombreSapTransportista\": str,\n            \"Articulo\": str,\n            \"ItemName\": str,\n            \"ForeignName\": str,\n            # ... m\u00e1s campos\n        }\n    ],\n    \"cantidad_x_dia_semana\": [\n        {\n            \"DiaSemana\": str,\n            \"Cantidad\": int\n        }\n    ]\n}\n</code></pre> Consideraciones Importantes <ul> <li>Integraci\u00f3n con SAP para detalles de productos</li> <li>Conversi\u00f3n de zonas horarias (UTC a Chile)</li> <li>Manejo de coordenadas geogr\u00e1ficas</li> <li>Gesti\u00f3n de estados de viaje</li> <li>Tracking de eventos del viaje</li> </ul> Caracter\u00edsticas Principales <ul> <li>Historial de 5 semanas</li> <li>Estad\u00edsticas por d\u00eda de la semana</li> <li>Informaci\u00f3n detallada de productos</li> <li>Tracking completo del viaje</li> <li>Geolocalizaci\u00f3n en puntos clave</li> </ul> Sequence DiagramEjemplos de RespuestaCampos Relevantes <pre><code>sequenceDiagram\n    participant Admin\n    participant API\n    participant DB\n    participant SAP\n\n    Admin-&gt;&gt;API: POST /recent_trips_mes\n    API-&gt;&gt;API: Validar JWT Admin\n\n    API-&gt;&gt;DB: Query Viajes Recientes\n    DB-&gt;&gt;DB: Join Tables\n    DB--&gt;&gt;API: Datos Base\n\n    API-&gt;&gt;API: Procesar Estad\u00edsticas\n\n    opt Informaci\u00f3n SAP\n        API-&gt;&gt;SAP: Login SAP\n        SAP--&gt;&gt;API: Token\n        API-&gt;&gt;SAP: Query Items\n        SAP--&gt;&gt;API: Datos Productos\n        API-&gt;&gt;API: Enriquecer Datos\n    end\n\n    API--&gt;&gt;Admin: Resultados + Estad\u00edsticas</code></pre> Respuesta Exitosa <pre><code>{\n    \"results\": [\n        {\n            \"Id\": 1,\n            \"PlantaOrigen\": \"Planta Central\",\n            \"Cliente\": \"Cliente A\",\n            \"HoraInicioJornada\": \"2024-03-20T08:00:00-03:00\",\n            \"Folio\": \"F001\",\n            \"Articulo\": \"ART001\",\n            \"ItemName\": \"Arena Fina\",\n            \"Neto\": 28500\n        }\n    ],\n    \"cantidad_x_dia_semana\": [\n        {\n            \"DiaSemana\": \"Monday\",\n            \"Cantidad\": 12\n        },\n        {\n            \"DiaSemana\": \"Tuesday\",\n            \"Cantidad\": 15\n        }\n    ]\n}\n</code></pre> Error Sin Datos <pre><code>{\n    \"detail\": \"No hay viajes recientes.\"\n}\n</code></pre> Campo Descripci\u00f3n Tipo HoraInicioJornada Inicio del viaje datetime HoraFinEntrega Fin del viaje datetime Folio N\u00famero de gu\u00eda string Articulo C\u00f3digo producto string ItemName Nombre producto string Neto Peso neto number Cancelado Estado cancelaci\u00f3n boolean Integraci\u00f3n SAP <ul> <li>Conexi\u00f3n autom\u00e1tica a SAP</li> <li>Obtenci\u00f3n de detalles de productos</li> <li>Manejo de errores de conexi\u00f3n</li> <li>Cach\u00e9 de datos frecuentes</li> <li>Timeout configurable</li> </ul> Mejores Pr\u00e1cticas <ul> <li>Monitorear tiempos de respuesta</li> <li>Implementar cach\u00e9 cuando sea posible</li> <li>Logging de errores SAP</li> <li>Validar datos geogr\u00e1ficos</li> <li>Mantener \u00edndices optimizados</li> </ul>"},{"location":"backend/whatsapp/arquitectura/","title":"Webhook WhatsApp - Arquitectura","text":""},{"location":"backend/whatsapp/arquitectura/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Sistema de mensajer\u00eda inteligente basado en agentes de IA que permite a los usuarios interactuar con Tracmin a trav\u00e9s de WhatsApp, implementando arquitectura de agentes orquestados con acceso a base de datos mediante Model Context Protocol (MCP).</p> Notas Importantes <ul> <li>Arquitectura basada en agentes especializados (Factory Pattern)</li> <li>Multi-capa de seguridad: Content Filter + Guardrails + Validaci\u00f3n RUT</li> <li>Model Context Protocol para acceso seguro a SQL Server</li> <li>Conversaci\u00f3n natural con formato Toon</li> <li>Roles diferenciados: Usuario Normal y Administrador</li> <li>Memoria de conversaci\u00f3n persistente por usuario</li> <li>Autenticaci\u00f3n robusta con vinculaci\u00f3n de cuentas</li> </ul> Consideraciones Importantes <ul> <li>Requiere cuenta de Meta Business y WhatsApp Business API</li> <li>El webhook debe ser p\u00fablico y accesible desde internet</li> <li>Validaci\u00f3n de token en cada request de Meta</li> <li>Los mensajes son procesados de forma as\u00edncrona</li> <li>Timeout de 30 segundos para respuestas de agentes</li> <li>Rate limiting configurable por usuario</li> </ul> Stack Tecnol\u00f3gicoDiagrama Simplificado <pre><code>graph LR\n    A[Express.js] --&gt; B[OpenAI Agents]\n    B --&gt; C[MCP Protocol]\n    C --&gt; D[SQL Server]\n    A --&gt; E[Kapso WhatsApp API]\n    B --&gt; F[Guardrails]\n    B --&gt; G[Toon Formatter]\n\n    style A fill:#68A063\n    style B fill:#74AA9C\n    style D fill:#CC2927\n    style E fill:#25D366</code></pre>"},{"location":"backend/whatsapp/arquitectura/#tecnologias-core","title":"Tecnolog\u00edas Core","text":"Tecnolog\u00eda Versi\u00f3n Prop\u00f3sito Node.js 18+ Runtime JavaScript Express.js 4.21.2 Framework web TypeScript 5.0+ Lenguaje tipado @kapso/whatsapp-cloud-api 0.1.1 Cliente WhatsApp Cloud API"},{"location":"backend/whatsapp/arquitectura/#ia-y-agentes","title":"IA y Agentes","text":"Tecnolog\u00eda Versi\u00f3n Prop\u00f3sito @openai/agents latest Orquestaci\u00f3n de agentes IA @openai/guardrails latest Filtrado de contenido y seguridad @toon-format/toon 0.9.0 Formato natural de respuestas"},{"location":"backend/whatsapp/arquitectura/#base-de-datos-y-protocolos","title":"Base de Datos y Protocolos","text":"Tecnolog\u00eda Versi\u00f3n Prop\u00f3sito @modelcontextprotocol/sdk 1.0.4 Protocolo MCP para BD mssql 11.0.1 Driver SQL Server"},{"location":"backend/whatsapp/arquitectura/#utilidades","title":"Utilidades","text":"Tecnolog\u00eda Versi\u00f3n Prop\u00f3sito node-fetch 3.3.2 Cliente HTTP dotenv 16.4.7 Variables de entorno"},{"location":"backend/whatsapp/arquitectura/#arquitectura-del-sistema","title":"Arquitectura del Sistema","text":"Vista GeneralCapas del SistemaFlujo de Procesamiento <pre><code>graph TB\n    subgraph \"Cliente WhatsApp\"\n        WA[Usuario WhatsApp]\n    end\n\n    subgraph \"API Gateway\"\n        KA[Kapso API&lt;br/&gt;WhatsApp Cloud]\n    end\n\n    subgraph \"Webhook Server\"\n        WH[Express Webhook&lt;br/&gt;POST /]\n        VT[Verificaci\u00f3n Token&lt;br/&gt;GET /]\n        RT[Router]\n    end\n\n    subgraph \"Capa de Seguridad\"\n        CF[Content Filter]\n        GR[Guardrails]\n        RV[RUT Validator]\n        AUTH[Auth Service]\n    end\n\n    subgraph \"Capa de Orquestaci\u00f3n\"\n        UO[User Orchestrator]\n        AO[Admin Orchestrator]\n        PA[Parametros Agent]\n    end\n\n    subgraph \"Capa de Agentes IA\"\n        UA[User Agent]\n        AA[Admin Agent]\n        subgraph \"Database Agents\"\n            DOC[Document Agent]\n            FUEL[Fuel Agent]\n            OP[Operation Agent]\n            VEH[Vehicle Agent]\n            TRP[Transporter Agent]\n        end\n    end\n\n    subgraph \"Capa de Datos\"\n        MCP[MCP Client]\n        MCPS[MCP Server]\n        DB[(SQL Server&lt;br/&gt;Tracmin DB)]\n    end\n\n    subgraph \"Utilidades\"\n        CM[Conversation Memory]\n        MF[Message Formatter]\n        TF[Toon Formatter]\n        IM[Interactive Messages]\n    end\n\n    WA --&gt; KA\n    KA --&gt; WH\n    WH --&gt; RT\n    RT --&gt; CF\n    CF --&gt; GR\n    GR --&gt; RV\n    RV --&gt; AUTH\n    AUTH --&gt; UO\n    AUTH --&gt; AO\n\n    UO --&gt; PA\n    AO --&gt; PA\n\n    UO --&gt; UA\n    AO --&gt; AA\n\n    UA --&gt; DOC\n    UA --&gt; FUEL\n    UA --&gt; OP\n    UA --&gt; VEH\n    UA --&gt; TRP\n\n    AA --&gt; DOC\n    AA --&gt; FUEL\n    AA --&gt; OP\n    AA --&gt; VEH\n    AA --&gt; TRP\n\n    DOC --&gt; MCP\n    FUEL --&gt; MCP\n    OP --&gt; MCP\n    VEH --&gt; MCP\n    TRP --&gt; MCP\n\n    MCP --&gt; MCPS\n    MCPS --&gt; DB\n\n    CM -.-&gt; UO\n    CM -.-&gt; AO\n    MF -.-&gt; RT\n    TF -.-&gt; UO\n    TF -.-&gt; AO\n    IM -.-&gt; RT\n\n    style WA fill:#25D366\n    style KA fill:#128C7E\n    style DB fill:#CC2927\n    style GR fill:#FFA500\n    style AUTH fill:#FF6B6B</code></pre> <p><pre><code>sequenceDiagram\n    participant U as Usuario WhatsApp\n    participant K as Kapso API\n    participant W as Webhook\n    participant CF as Content Filter\n    participant GR as Guardrails\n    participant AUTH as Auth Service\n    participant O as Orchestrator\n    participant A as Agent IA\n    participant MCP as MCP Server\n    participant DB as SQL Server\n\n    U-&gt;&gt;K: Enviar mensaje\n    K-&gt;&gt;W: POST / (webhook)\n    W-&gt;&gt;CF: Validar contenido\n    CF-&gt;&gt;GR: Aplicar guardrails\n    GR-&gt;&gt;AUTH: Verificar usuario\n\n    alt Usuario no registrado\n        AUTH-&gt;&gt;W: Solicitar vinculaci\u00f3n\n        W-&gt;&gt;K: Enviar instrucciones\n        K-&gt;&gt;U: Mensaje vinculaci\u00f3n\n    else Usuario registrado\n        AUTH-&gt;&gt;O: Mensaje + Contexto\n        O-&gt;&gt;A: Procesar con IA\n        A-&gt;&gt;MCP: Query datos\n        MCP-&gt;&gt;DB: SELECT\n        DB--&gt;&gt;MCP: Resultado\n        MCP--&gt;&gt;A: Datos\n        A--&gt;&gt;O: Respuesta IA\n        O-&gt;&gt;W: Formatear respuesta\n        W-&gt;&gt;K: Enviar mensaje\n        K-&gt;&gt;U: Respuesta final\n    end</code></pre> participant MCP as MCP Client participant DB as SQL Server</p> <p>U-&gt;&gt;K: Env\u00eda mensaje K-&gt;&gt;W: POST / webhook event</p> <p>W-&gt;&gt;W: Verificar direcci\u00f3n (inbound) W-&gt;&gt;CF: Filtrar contenido</p> <p>alt Contenido bloqueado     CF--&gt;&gt;W: Mensaje de advertencia     W-&gt;&gt;K: Enviar advertencia     K-&gt;&gt;U: Mostrar advertencia else Contenido v\u00e1lido     CF-&gt;&gt;GR: Verificar guardrails</p> <pre><code>alt Guardrails no pasa\n    GR--&gt;&gt;W: Respuesta segura\n    W-&gt;&gt;K: Enviar respuesta\n    K-&gt;&gt;U: Mostrar respuesta\nelse Guardrails OK\n    GR-&gt;&gt;AUTH: Validar usuario\n\n    alt Usuario no existe\n        AUTH--&gt;&gt;W: Iniciar vinculaci\u00f3n\n        W-&gt;&gt;K: Solicitar RUT/Tel\u00e9fono\n        K-&gt;&gt;U: Formulario vinculaci\u00f3n\n    else Usuario existe\n        AUTH-&gt;&gt;AUTH: Verificar tipo (Admin/User)\n\n        alt Usuario Admin\n            AUTH-&gt;&gt;O: runAdminWorkflow()\n        else Usuario Normal\n            AUTH-&gt;&gt;O: runUserWorkflow()\n        end\n\n        O-&gt;&gt;A: Ejecutar agente IA\n        A-&gt;&gt;MCP: Consulta SQL\n        MCP-&gt;&gt;DB: Ejecutar query\n        DB--&gt;&gt;MCP: Resultados\n        MCP--&gt;&gt;A: Datos\n        A-&gt;&gt;A: Procesar y formatear\n        A--&gt;&gt;O: Respuesta formateada\n        O--&gt;&gt;W: Respuesta final\n        W-&gt;&gt;K: Enviar mensaje\n        K-&gt;&gt;U: Mostrar respuesta\n    end\nend\n</code></pre> <p>end</p> <p>```</p>"},{"location":"backend/whatsapp/arquitectura/#1-capa-de-cliente","title":"1. Capa de Cliente","text":"<ul> <li>Usuario final en WhatsApp</li> <li>Env\u00eda mensajes de texto</li> <li>Recibe respuestas formateadas</li> </ul>"},{"location":"backend/whatsapp/arquitectura/#2-capa-de-gateway","title":"2. Capa de Gateway","text":"<ul> <li>Kapso WhatsApp Cloud API</li> <li>Gesti\u00f3n de mensajes entrantes/salientes</li> <li>Webhook de Meta</li> </ul>"},{"location":"backend/whatsapp/arquitectura/#3-capa-de-seguridad","title":"3. Capa de Seguridad","text":"<ul> <li>Content Filter: Filtrado inicial de contenido</li> <li>Guardrails: Validaci\u00f3n de seguridad IA</li> <li>RUT Validator: Validaci\u00f3n de RUT chileno</li> <li>Auth Service: Autenticaci\u00f3n y autorizaci\u00f3n</li> </ul>"},{"location":"backend/whatsapp/arquitectura/#4-capa-de-orquestacion","title":"4. Capa de Orquestaci\u00f3n","text":"<ul> <li>User Orchestrator: Orquestador para usuarios normales</li> <li>Admin Orchestrator: Orquestador para administradores</li> <li>Parametros Agent: Extracci\u00f3n de par\u00e1metros</li> </ul>"},{"location":"backend/whatsapp/arquitectura/#5-capa-de-agentes","title":"5. Capa de Agentes","text":"<ul> <li>User/Admin Agent: Agentes principales</li> <li>Database Agents: Agentes especializados por dominio</li> <li>Documentos</li> <li>Combustible</li> <li>Operaciones</li> <li>Veh\u00edculos</li> <li>Transportistas</li> </ul>"},{"location":"backend/whatsapp/arquitectura/#6-capa-de-datos","title":"6. Capa de Datos","text":"<ul> <li>MCP Client/Server: Protocolo de contexto de modelo</li> <li>SQL Server: Base de datos Tracmin</li> </ul>"},{"location":"backend/whatsapp/arquitectura/#componentes-principales","title":"Componentes Principales","text":"Express WebhookCapa de SeguridadOrquestadoresAgentes de IAMCP ProtocolUtilidades"},{"location":"backend/whatsapp/arquitectura/#1-express-webhook-appjs-webhookjs","title":"1. Express Webhook (<code>app.js</code>, <code>webhook.js</code>)","text":"<p>Punto de entrada del sistema que recibe eventos de WhatsApp.</p> <p>Endpoints:</p> M\u00e9todo Ruta Descripci\u00f3n <code>GET</code> <code>/</code> Verificaci\u00f3n de webhook (handshake con Kapso) <code>POST</code> <code>/</code> Recepci\u00f3n de mensajes y eventos Flujo de Verificaci\u00f3n <p>```javascript // GET / - Verificaci\u00f3n app.get('/', (req, res) =&gt; {   const mode = req.query['hub.mode'];   const token = req.query['hub.verify_token'];   const challenge = req.query['hub.challenge'];</p> <p>if (mode &amp;&amp; token === VERIFY_TOKEN) {     res.status(200).send(challenge);   } else {     res.sendStatus(403);   } }); ```</p>"},{"location":"backend/whatsapp/arquitectura/#2-capa-de-seguridad","title":"2. Capa de Seguridad","text":""},{"location":"backend/whatsapp/arquitectura/#content-filter-contentfilterjs","title":"Content Filter (<code>contentFilter.js</code>)","text":"<p>Bloquea solicitudes relacionadas con trabajo o c\u00f3digo malicioso.</p> Filtros Activos <ul> <li>Solicitudes de c\u00f3digo</li> <li>Peticiones de empleo</li> <li>Contenido malicioso</li> <li>Inyecci\u00f3n SQL</li> <li>Scripts maliciosos</li> </ul>"},{"location":"backend/whatsapp/arquitectura/#guardrails-guardrailsjs","title":"Guardrails (<code>guardrails.js</code>)","text":"<p>Valida entrada/salida usando OpenAI Moderation API y filtros personalizados.</p> Validaciones <p>Input Guardrails: - Moderaci\u00f3n de contenido con OpenAI - Filtrado de patrones sospechosos - Validaci\u00f3n de intenciones</p> <p>Output Guardrails: - Verificaci\u00f3n de respuestas IA - Filtrado de informaci\u00f3n sensible - Validaci\u00f3n de formato</p>"},{"location":"backend/whatsapp/arquitectura/#rut-validator-rutvalidatorjs","title":"RUT Validator (<code>rutValidator.js</code>)","text":"<p>Valida identidad chilena (RUT) y vinculaci\u00f3n de cuentas.</p>"},{"location":"backend/whatsapp/arquitectura/#auth-service-authservicejs","title":"Auth Service (<code>authService.js</code>)","text":"<p>Gestiona autenticaci\u00f3n y permisos de usuarios.</p>"},{"location":"backend/whatsapp/arquitectura/#3-orquestadores","title":"3. Orquestadores","text":""},{"location":"backend/whatsapp/arquitectura/#user-orchestrator-userorchestratorjs","title":"User Orchestrator (<code>userOrchestrator.js</code>)","text":"<p>Funcionalidades:</p> <ul> <li>Coordina flujo para usuarios normales</li> <li>Aplica restricciones de seguridad por RUT/Transportista</li> <li>Selecciona agente especializado seg\u00fan la consulta</li> </ul> Flujo de Selecci\u00f3n de Agente <p><code>javascript const selectAgent = (userQuery) =&gt; {   if (containsKeywords(query, ['guia', 'documento', 'pdf'])) {     return documentAgent;   } else if (containsKeywords(query, ['combustible', 'diesel'])) {     return fuelAgent;   } else if (containsKeywords(query, ['viaje', 'operacion'])) {     return operationAgent;   } else if (containsKeywords(query, ['vehiculo', 'camion'])) {     return vehicleAgent;   } else if (containsKeywords(query, ['transportista', 'empresa'])) {     return transporterAgent;   }   return userAgent; // Default };</code></p>"},{"location":"backend/whatsapp/arquitectura/#admin-orchestrator-adminorchestratorjs","title":"Admin Orchestrator (<code>adminOrchestrator.js</code>)","text":"<p>Funcionalidades:</p> <ul> <li>Maneja consultas administrativas</li> <li>Acceso sin restricciones a toda la base de datos</li> <li>Proporciona an\u00e1lisis y reportes avanzados</li> </ul>"},{"location":"backend/whatsapp/arquitectura/#4-agentes-de-ia","title":"4. Agentes de IA","text":""},{"location":"backend/whatsapp/arquitectura/#agentes-de-usuario","title":"Agentes de Usuario","text":"Agente Archivo Descripci\u00f3n User Agent <code>userAgent.js</code> Agente conversacional para usuarios finales con restricciones de seguridad Admin Agent <code>adminAgent.js</code> Agente con privilegios administrativos completos"},{"location":"backend/whatsapp/arquitectura/#agentes-de-base-de-datos-factory-pattern","title":"Agentes de Base de Datos (Factory Pattern)","text":"Agente Archivo Especializaci\u00f3n Document Agent <code>documentAgent.js</code> Gu\u00edas, documentos y trazabilidad Fuel Agent <code>fuelAgent.js</code> Combustible y consumos Operation Agent <code>operationAgent.js</code> Operaciones y viajes Vehicle Agent <code>vehicleAgent.js</code> Veh\u00edculos y flotas Transporter Agent <code>transporterAgent.js</code> Informaci\u00f3n de transportistas Factory Pattern <p><code>javascript class AgentFactory {   static createAgent(type, context) {     switch(type) {       case 'document': return new DocumentAgent(context);       case 'fuel': return new FuelAgent(context);       case 'operation': return new OperationAgent(context);       case 'vehicle': return new VehicleAgent(context);       case 'transporter': return new TransporterAgent(context);       default: throw new Error('Unknown agent type');     }   } }</code></p>"},{"location":"backend/whatsapp/arquitectura/#5-model-context-protocol-mcp","title":"5. Model Context Protocol (MCP)","text":""},{"location":"backend/whatsapp/arquitectura/#mcp-client-dbclientjs","title":"MCP Client (<code>dbClient.js</code>)","text":"<p>Cliente que comunica con el servidor MCP para ejecutar operaciones de base de datos.</p> <p>M\u00e9todos principales:</p> M\u00e9todo Descripci\u00f3n <code>executeSQL(query)</code> Ejecuta consultas SQL <code>getUserByPhone(phone)</code> Busca usuario por tel\u00e9fono <code>getUserByConversationId(conversationId)</code> Busca usuario por ID de conversaci\u00f3n <code>updateConversationId(rut, conversationId)</code> Actualiza vinculaci\u00f3n <code>listTables()</code> Lista tablas disponibles <code>getTableSchema(tableName)</code> Obtiene esquema de tabla Ejemplo de Uso <p>```javascript const mcpClient = require('./dbClient');</p> <p>// Ejecutar query SQL const result = await mcpClient.executeSQL(   'SELECT * FROM Guias WHERE RutTransportista = ?',   [userRut] );</p> <p>// Obtener usuario const user = await mcpClient.getUserByPhone('+56912345678'); ```</p>"},{"location":"backend/whatsapp/arquitectura/#mcp-server-dbserverjs","title":"MCP Server (<code>dbServer.js</code>)","text":"<p>Servidor que abstrae el acceso a SQL Server mediante el protocolo MCP.</p> Seguridad MCP <ul> <li>Conexi\u00f3n encriptada</li> <li>Validaci\u00f3n de queries</li> <li>Rate limiting</li> <li>Auditor\u00eda de consultas</li> </ul>"},{"location":"backend/whatsapp/arquitectura/#6-utilidades","title":"6. Utilidades","text":"M\u00f3dulo Archivo Funcionalidad Conversation Memory <code>conversationMemory.js</code> Mantiene contexto y estado de conversaciones en memoria Message Formatter <code>messageFormatter.js</code> Formatea respuestas para WhatsApp Toon Formatter <code>toonFormatter.js</code> Convierte resultados SQL a formato estructurado legible Interactive Messages <code>interactiveMessages.js</code> Genera botones y men\u00fas interactivos de WhatsApp Ejemplo Message Formatter <p>```javascript const formatter = require('./messageFormatter');</p> <p>// Formatear respuesta simple const message = formatter.formatSimpleMessage(   'Tu consulta ha sido procesada' );</p> <p>// Formatear tabla const table = formatter.formatTable(   ['Guia', 'Estado', 'Fecha'],   [     ['12345', 'Confirmada', '2024-01-15'],     ['12346', 'Pendiente', '2024-01-16']   ] ); ```</p>"},{"location":"backend/whatsapp/arquitectura/#variables-de-entorno","title":"Variables de Entorno","text":"Configuraci\u00f3n Completa - .env <p>```</p>"},{"location":"backend/whatsapp/arquitectura/#_1","title":"============================================","text":""},{"location":"backend/whatsapp/arquitectura/#server-configuration","title":"SERVER CONFIGURATION","text":""},{"location":"backend/whatsapp/arquitectura/#_2","title":"============================================","text":"<p>PORT=3000</p>"},{"location":"backend/whatsapp/arquitectura/#_3","title":"============================================","text":""},{"location":"backend/whatsapp/arquitectura/#webhook-verification","title":"WEBHOOK VERIFICATION","text":""},{"location":"backend/whatsapp/arquitectura/#_4","title":"============================================","text":"<p>VERIFY_TOKEN=your_verify_token</p>"},{"location":"backend/whatsapp/arquitectura/#_5","title":"============================================","text":""},{"location":"backend/whatsapp/arquitectura/#kapso-whatsapp-api","title":"KAPSO WHATSAPP API","text":""},{"location":"backend/whatsapp/arquitectura/#_6","title":"============================================","text":"<p>KAPSO_API_KEY=your_kapso_api_key KAPSO_API_URL=https://api.kapso.com</p>"},{"location":"backend/whatsapp/arquitectura/#_7","title":"============================================","text":""},{"location":"backend/whatsapp/arquitectura/#openai-configuration","title":"OPENAI CONFIGURATION","text":""},{"location":"backend/whatsapp/arquitectura/#_8","title":"============================================","text":"<p>OPENAI_API_KEY=your_openai_api_key</p>"},{"location":"backend/whatsapp/arquitectura/#_9","title":"============================================","text":""},{"location":"backend/whatsapp/arquitectura/#database-connection-mcp-server","title":"DATABASE CONNECTION (MCP SERVER)","text":""},{"location":"backend/whatsapp/arquitectura/#_10","title":"============================================","text":"<p>DB_SERVER=your_server.database.windows.net DB_DATABASE=TracminDB DB_USER=your_username DB_PASSWORD=your_password DB_ENCRYPT=true</p> <p>```</p> Variable Descripci\u00f3n Requerido <code>PORT</code> Puerto del servidor webhook \u2705 S\u00ed <code>VERIFY_TOKEN</code> Token de verificaci\u00f3n del webhook de Meta \u2705 S\u00ed <code>KAPSO_API_KEY</code> API Key de Kapso WhatsApp Cloud \u2705 S\u00ed <code>KAPSO_API_URL</code> URL base de la API de Kapso \u2705 S\u00ed <code>OPENAI_API_KEY</code> API Key de OpenAI para agentes IA \u2705 S\u00ed <code>DB_SERVER</code> Servidor SQL Server (MCP) \u2705 S\u00ed <code>DB_DATABASE</code> Nombre de la base de datos \u2705 S\u00ed <code>DB_USER</code> Usuario de la base de datos \u2705 S\u00ed <code>DB_PASSWORD</code> Contrase\u00f1a de la base de datos \u2705 S\u00ed <code>DB_ENCRYPT</code> Cifrado de conexi\u00f3n a BD \u2705 S\u00ed"},{"location":"backend/whatsapp/arquitectura/#referencias","title":"Referencias","text":"Documentaci\u00f3n Relacionada <ul> <li>Flujo de Mensajes - Procesamiento detallado de mensajes</li> <li>Sistema de Agentes - Arquitectura de agentes IA</li> <li>Seguridad y Validaci\u00f3n - Guardrails y validaciones</li> <li>MCP y Base de Datos - Protocolo de contexto de modelo</li> </ul>"},{"location":"backend/whatsapp/flujo-mensajes/","title":"Flujo de Procesamiento de Mensajes","text":""},{"location":"backend/whatsapp/flujo-mensajes/#diagrama-de-flujo-general","title":"Diagrama de Flujo General","text":"<pre><code>flowchart TD\n    Start([Mensaje recibido en Webhook]) --&gt; CheckDirection{\u00bfDirecci\u00f3n&lt;br/&gt;inbound?}\n\n    CheckDirection --&gt;|No| IgnoreOutbound[Ignorar mensaje&lt;br/&gt;outbound/reaction]\n    IgnoreOutbound --&gt; End1([Fin - 200 OK])\n\n    CheckDirection --&gt;|S\u00ed| HasConvId{\u00bfTiene&lt;br/&gt;conversationId?}\n\n    HasConvId --&gt;|No| WarnNoConv[\u26a0\ufe0f Advertencia:&lt;br/&gt;Sin conversationId]\n    WarnNoConv --&gt; End2([Fin - 200 OK])\n\n    HasConvId --&gt;|S\u00ed| CheckLinking{\u00bfVinculaci\u00f3n&lt;br/&gt;en progreso?}\n\n    CheckLinking --&gt;|S\u00ed| HandleLinking[Procesar vinculaci\u00f3n&lt;br/&gt;RUT/Tel\u00e9fono]\n    HandleLinking --&gt; ValidateLinking{\u00bfVinculaci\u00f3n&lt;br/&gt;v\u00e1lida?}\n\n    ValidateLinking --&gt;|No| SendLinkingError[Enviar error&lt;br/&gt;de validaci\u00f3n]\n    SendLinkingError --&gt; End3([Fin - 200 OK])\n\n    ValidateLinking --&gt;|S\u00ed| UpdateUser[Actualizar usuario&lt;br/&gt;en DB]\n    UpdateUser --&gt; SendSuccess[Enviar confirmaci\u00f3n]\n    SendSuccess --&gt; End4([Fin - 200 OK])\n\n    CheckLinking --&gt;|No| CheckUser{\u00bfUsuario&lt;br/&gt;existe?}\n\n    CheckUser --&gt;|No| SearchByPhone[Buscar por&lt;br/&gt;tel\u00e9fono]\n    SearchByPhone --&gt; UserFound{\u00bfUsuario&lt;br/&gt;encontrado?}\n\n    UserFound --&gt;|No| StartLinking[Iniciar proceso&lt;br/&gt;de vinculaci\u00f3n]\n    StartLinking --&gt; RequestRut[Solicitar RUT&lt;br/&gt;al usuario]\n    RequestRut --&gt; End5([Fin - 200 OK])\n\n    UserFound --&gt;|S\u00ed| UpdateConvId[Actualizar&lt;br/&gt;conversationId]\n    UpdateConvId --&gt; ProcessMsg[Continuar procesamiento]\n\n    CheckUser --&gt;|S\u00ed| ProcessMsg\n\n    ProcessMsg --&gt; ContentFilter[Content Filter]\n    ContentFilter --&gt; FilterResult{\u00bfContenido&lt;br/&gt;bloqueado?}\n\n    FilterResult --&gt;|S\u00ed| SendWarning[Enviar mensaje&lt;br/&gt;de advertencia]\n    SendWarning --&gt; End6([Fin - 200 OK])\n\n    FilterResult --&gt;|No| Guardrails[Verificar Guardrails]\n    Guardrails --&gt; GuardrailPass{\u00bfPasa&lt;br/&gt;guardrails?}\n\n    GuardrailPass --&gt;|No| SendSafeResponse[Enviar respuesta&lt;br/&gt;segura filtrada]\n    SendSafeResponse --&gt; End7([Fin - 200 OK])\n\n    GuardrailPass --&gt;|S\u00ed| CheckAdmin{\u00bfUsuario&lt;br/&gt;Admin?}\n\n    CheckAdmin --&gt;|S\u00ed| AdminFlow[Admin Orchestrator]\n    CheckAdmin --&gt;|No| UserFlow[User Orchestrator]\n\n    AdminFlow --&gt; ExecuteQuery[Ejecutar consulta&lt;br/&gt;sin restricciones]\n    UserFlow --&gt; ApplySecurity[Aplicar filtros&lt;br/&gt;de seguridad]\n    ApplySecurity --&gt; ExecuteQuery\n\n    ExecuteQuery --&gt; NeedsDB{\u00bfNecesita&lt;br/&gt;base de datos?}\n\n    NeedsDB --&gt;|No| DirectResponse[Respuesta directa&lt;br/&gt;del agente]\n    DirectResponse --&gt; FormatResponse\n\n    NeedsDB --&gt;|S\u00ed| SelectAgent[Seleccionar agente&lt;br/&gt;especializado]\n    SelectAgent --&gt; GenerateSQL[Generar consulta SQL]\n    GenerateSQL --&gt; ExecuteSQL[Ejecutar SQL via MCP]\n    ExecuteSQL --&gt; ProcessResults[Procesar resultados]\n    ProcessResults --&gt; FormatResponse[Formatear respuesta]\n\n    FormatResponse --&gt; OutputGuardrails[Guardrails de salida]\n    OutputGuardrails --&gt; SendResponse[Enviar respuesta&lt;br/&gt;a WhatsApp]\n    SendResponse --&gt; End8([Fin - 200 OK])\n\n    style Start fill:#25D366\n    style End1 fill:#90EE90\n    style End2 fill:#90EE90\n    style End3 fill:#90EE90\n    style End4 fill:#90EE90\n    style End5 fill:#90EE90\n    style End6 fill:#90EE90\n    style End7 fill:#90EE90\n    style End8 fill:#90EE90\n    style SendWarning fill:#FFA500\n    style SendLinkingError fill:#FFA500\n    style ContentFilter fill:#FFD700\n    style Guardrails fill:#FFD700</code></pre>"},{"location":"backend/whatsapp/flujo-mensajes/#fases-del-procesamiento","title":"Fases del Procesamiento","text":""},{"location":"backend/whatsapp/flujo-mensajes/#fase-1-recepcion-y-validacion-inicial","title":"Fase 1: Recepci\u00f3n y Validaci\u00f3n Inicial","text":"<pre><code>sequenceDiagram\n    participant K as Kapso API\n    participant W as Webhook Router\n    participant L as Logger\n\n    K-&gt;&gt;W: POST / con mensaje\n    W-&gt;&gt;L: Log timestamp\n    W-&gt;&gt;L: Log body completo\n    W-&gt;&gt;W: Extraer message\n    W-&gt;&gt;W: Extraer conversationId\n    W-&gt;&gt;L: Log tipo y direcci\u00f3n\n\n    alt Mensaje no es inbound\n        W-&gt;&gt;L: Log ignorar outbound\n        W-&gt;&gt;K: 200 OK\n    else Es inbound\n        alt Sin conversationId\n            W-&gt;&gt;L: Warning sin conversationId\n            W-&gt;&gt;K: 200 OK\n        else Con conversationId\n            W-&gt;&gt;W: Continuar procesamiento\n        end\n    end</code></pre>"},{"location":"backend/whatsapp/flujo-mensajes/#fase-2-autenticacion-y-vinculacion","title":"Fase 2: Autenticaci\u00f3n y Vinculaci\u00f3n","text":"<pre><code>sequenceDiagram\n    participant W as Webhook\n    participant CM as Conversation Memory\n    participant AUTH as Auth Service\n    participant DB as Database\n    participant U as Usuario WhatsApp\n\n    W-&gt;&gt;CM: isAwaitingAccountLinking(convId)\n\n    alt Vinculaci\u00f3n en progreso\n        CM--&gt;&gt;W: true\n        W-&gt;&gt;W: Extraer RUT del mensaje\n        W-&gt;&gt;AUTH: validateRutForLinking()\n\n        alt RUT inv\u00e1lido\n            AUTH--&gt;&gt;W: Error validaci\u00f3n\n            W-&gt;&gt;U: Mensaje error formato\n        else RUT v\u00e1lido\n            AUTH-&gt;&gt;DB: Buscar usuario por RUT\n            alt Usuario no existe\n                DB--&gt;&gt;AUTH: null\n                AUTH--&gt;&gt;W: Error usuario no existe\n                W-&gt;&gt;U: Usuario no encontrado\n            else Usuario existe\n                DB--&gt;&gt;AUTH: userData\n                AUTH-&gt;&gt;DB: updateConversationId()\n                DB--&gt;&gt;AUTH: actualizado\n                AUTH-&gt;&gt;CM: clearLinkingProcess()\n                AUTH--&gt;&gt;W: Vinculaci\u00f3n exitosa\n                W-&gt;&gt;U: \u2705 Cuenta vinculada\n            end\n        end\n    else Sin vinculaci\u00f3n pendiente\n        CM--&gt;&gt;W: false\n        W-&gt;&gt;AUTH: getUserInfo(convId)\n\n        alt Usuario no existe\n            AUTH--&gt;&gt;W: null\n            W-&gt;&gt;DB: getUserByPhone()\n\n            alt Encontrado por tel\u00e9fono\n                DB--&gt;&gt;W: userData\n                W-&gt;&gt;DB: updateConversationId()\n                W-&gt;&gt;W: Continuar procesamiento\n            else No encontrado\n                W-&gt;&gt;CM: setAwaitingAccountLinking()\n                W-&gt;&gt;U: Solicitar RUT para vincular\n            end\n        else Usuario existe\n            AUTH--&gt;&gt;W: userData\n            W-&gt;&gt;W: Continuar procesamiento\n        end\n    end</code></pre>"},{"location":"backend/whatsapp/flujo-mensajes/#fase-3-filtrado-y-seguridad","title":"Fase 3: Filtrado y Seguridad","text":"<pre><code>sequenceDiagram\n    participant W as Webhook\n    participant CF as Content Filter\n    participant GR as Guardrails\n    participant OAI as OpenAI API\n    participant O as Orchestrator\n\n    W-&gt;&gt;CF: shouldBlockMessage(text)\n    CF-&gt;&gt;CF: Verificar palabras prohibidas\n    CF-&gt;&gt;CF: Detectar solicitudes de c\u00f3digo\n\n    alt Contenido bloqueado\n        CF--&gt;&gt;W: true + warning message\n        W-&gt;&gt;W: Enviar advertencia\n    else Contenido OK\n        CF--&gt;&gt;W: false\n        W-&gt;&gt;GR: checkGuardrails(text, isInput=true)\n        GR-&gt;&gt;OAI: moderations.create()\n        OAI--&gt;&gt;GR: moderation result\n\n        alt Moderaci\u00f3n falla\n            GR-&gt;&gt;GR: Generar respuesta segura\n            GR--&gt;&gt;W: passed=false + safeText\n            W-&gt;&gt;W: Enviar respuesta segura\n        else Moderaci\u00f3n OK\n            GR--&gt;&gt;W: passed=true + safeText\n            W-&gt;&gt;O: Enviar a orchestrator\n        end\n    end</code></pre>"},{"location":"backend/whatsapp/flujo-mensajes/#fase-4-orquestacion-y-ejecucion","title":"Fase 4: Orquestaci\u00f3n y Ejecuci\u00f3n","text":"<pre><code>sequenceDiagram\n    participant W as Webhook\n    participant O as Orchestrator\n    participant AF as Agent Factory\n    participant A as Agent IA\n    participant MCP as MCP Client\n    participant DB as SQL Server\n\n    W-&gt;&gt;O: runUserWorkflow() / runAdminWorkflow()\n    O-&gt;&gt;O: Obtener userInfo\n    O-&gt;&gt;O: Construir security context\n    O-&gt;&gt;O: Analizar mensaje\n\n    alt Necesita DB\n        O-&gt;&gt;AF: selectAgent(message, isAdmin)\n        AF-&gt;&gt;AF: Analizar keywords\n        AF--&gt;&gt;O: Agent especializado\n\n        O-&gt;&gt;A: Fase 1: Generar SQL\n        A-&gt;&gt;A: Procesar con contexto\n        A--&gt;&gt;O: SQL query\n\n        O-&gt;&gt;MCP: executeSQL(query)\n        MCP-&gt;&gt;DB: Ejecutar query\n        DB--&gt;&gt;MCP: Resultados\n        MCP--&gt;&gt;O: Data\n\n        O-&gt;&gt;O: Formatear con Toon\n        O-&gt;&gt;A: Fase 2: Formatear respuesta\n        A-&gt;&gt;A: Generar respuesta en lenguaje natural\n        A--&gt;&gt;O: Respuesta formateada\n    else No necesita DB\n        O-&gt;&gt;A: Procesar mensaje\n        A--&gt;&gt;O: Respuesta directa\n    end\n\n    O-&gt;&gt;GR: checkGuardrails(output, isInput=false)\n    GR--&gt;&gt;O: Respuesta filtrada\n    O--&gt;&gt;W: Respuesta final\n    W-&gt;&gt;W: Enviar a WhatsApp</code></pre>"},{"location":"backend/whatsapp/flujo-mensajes/#manejo-de-casos-especiales","title":"Manejo de Casos Especiales","text":""},{"location":"backend/whatsapp/flujo-mensajes/#menu-interactivo","title":"Men\u00fa Interactivo","text":"<pre><code>stateDiagram-v2\n    [*] --&gt; DetectMenuRequest: Usuario dice \"men\u00fa\" o \"opciones\"\n    DetectMenuRequest --&gt; CheckUserType: Identificar tipo\n\n    CheckUserType --&gt; AdminMenu: Usuario Admin\n    CheckUserType --&gt; UserMenu: Usuario Normal\n\n    AdminMenu --&gt; SendAdminButtons: Botones administrativos\n    UserMenu --&gt; SendUserButtons: Botones usuarios\n\n    SendAdminButtons --&gt; WaitSelection: Esperar interacci\u00f3n\n    SendUserButtons --&gt; WaitSelection\n\n    WaitSelection --&gt; ProcessButton: Usuario presiona bot\u00f3n\n    ProcessButton --&gt; ExecuteAction: Ejecutar acci\u00f3n\n    ExecuteAction --&gt; [*]</code></pre>"},{"location":"backend/whatsapp/flujo-mensajes/#solicitud-de-parametros","title":"Solicitud de Par\u00e1metros","text":"<pre><code>sequenceDiagram\n    participant U as Usuario\n    participant W as Webhook\n    participant PA as Parametros Agent\n    participant CM as Conversation Memory\n\n    U-&gt;&gt;W: \"Quiero ver mis viajes\"\n    W-&gt;&gt;PA: analyzeAndRequestParameters()\n    PA-&gt;&gt;PA: Detectar par\u00e1metros faltantes\n\n    alt Faltan par\u00e1metros\n        PA-&gt;&gt;CM: Guardar contexto de consulta\n        PA--&gt;&gt;W: Mensaje solicitud par\u00e1metros\n        W-&gt;&gt;U: \"\u00bfDe qu\u00e9 fecha a qu\u00e9 fecha?\"\n\n        U-&gt;&gt;W: \"Del 1 al 31 de diciembre\"\n        W-&gt;&gt;CM: Obtener contexto guardado\n        CM--&gt;&gt;W: Consulta original\n        W-&gt;&gt;PA: Combinar consulta + par\u00e1metros\n        PA--&gt;&gt;W: Consulta completa\n        W-&gt;&gt;W: Ejecutar workflow normal\n    else Par\u00e1metros completos\n        PA--&gt;&gt;W: Continuar con consulta\n        W-&gt;&gt;W: Ejecutar workflow normal\n    end</code></pre>"},{"location":"backend/whatsapp/flujo-mensajes/#respuestas-asincronas","title":"Respuestas As\u00edncronas","text":"<p>El webhook siempre responde inmediatamente con 200 OK a Kapso, luego procesa el mensaje de forma as\u00edncrona:</p> <pre><code>// Respuesta inmediata\nres.status(200).end();\n\n// Procesamiento as\u00edncrono\n(async () =&gt; {\n  try {\n    const response = await processMessage();\n    await sendWhatsAppMessage(conversationId, response);\n  } catch (error) {\n    console.error('Error:', error);\n    await sendWhatsAppMessage(conversationId, '\u274c Error procesando mensaje');\n  }\n})();\n</code></pre>"},{"location":"backend/whatsapp/flujo-mensajes/#logs-y-debugging","title":"Logs y Debugging","text":"<p>Cada fase del procesamiento genera logs estructurados:</p> <pre><code>[DEPURACI\u00d3N] Webhook recibido 2025-12-26 10:30:00\n[DEPURACI\u00d3N] \ud83d\udce6 Body completo: {...}\n[DEPURACI\u00d3N] \ud83d\udce8 Tipo de mensaje: text\n[DEPURACI\u00d3N] \ud83d\udce8 Direcci\u00f3n: inbound\n[User Orchestrator] \ud83d\udd0d Iniciando flujo de usuario...\n[User Orchestrator] \ud83e\udd16 AGENTE SELECCIONADO: Document Agent\n[MCP Client] Ejecutando SQL query...\n[DEPURACI\u00d3N] \u2705 Respuesta enviada\n</code></pre>"},{"location":"backend/whatsapp/flujo-mensajes/#proximos-pasos","title":"Pr\u00f3ximos Pasos","text":"<ul> <li>Sistema de Agentes</li> <li>Seguridad y Validaci\u00f3n</li> <li>MCP y Base de Datos</li> </ul>"},{"location":"backend/whatsapp/mcp-database/","title":"Model Context Protocol (MCP) y Base de Datos","text":""},{"location":"backend/whatsapp/mcp-database/#que-es-mcp","title":"\u00bfQu\u00e9 es MCP?","text":"<p>El Model Context Protocol es un protocolo est\u00e1ndar para la comunicaci\u00f3n entre agentes de IA y fuentes de datos. Permite que los modelos de lenguaje accedan a informaci\u00f3n estructurada de manera segura y eficiente.</p> <pre><code>graph LR\n    A[Agent IA] --&gt;|Solicitud MCP| B[MCP Client]\n    B --&gt;|Protocolo stdio| C[MCP Server]\n    C --&gt;|SQL Query| D[(Database)]\n    D --&gt;|Results| C\n    C --&gt;|JSON Response| B\n    B --&gt;|Datos formateados| A\n\n    style B fill:#FFD700\n    style C fill:#87CEEB\n    style D fill:#CC2927</code></pre>"},{"location":"backend/whatsapp/mcp-database/#arquitectura-mcp-en-el-webhook","title":"Arquitectura MCP en el Webhook","text":"<pre><code>graph TB\n    subgraph \"Agentes IA\"\n        UA[User Agent]\n        AA[Admin Agent]\n        DA[Database Agents]\n    end\n\n    subgraph \"MCP Client Layer\"\n        MC[DatabaseMCPClient&lt;br/&gt;Singleton]\n        TRANS[Transport Layer&lt;br/&gt;stdio]\n    end\n\n    subgraph \"MCP Server Process\"\n        MS[MCP Server&lt;br/&gt;dbServer.js]\n        TOOLS[Tools Registry]\n        EXEC[SQL Executor]\n    end\n\n    subgraph \"Database Layer\"\n        POOL[Connection Pool&lt;br/&gt;mssql]\n        DB[(SQL Server&lt;br/&gt;TracminDB)]\n    end\n\n    UA --&gt; MC\n    AA --&gt; MC\n    DA --&gt; MC\n\n    MC --&gt; TRANS\n    TRANS --&gt;|stdio IPC| MS\n    MS --&gt; TOOLS\n    TOOLS --&gt; EXEC\n    EXEC --&gt; POOL\n    POOL --&gt; DB\n\n    DB --&gt;|Results| POOL\n    POOL --&gt;|Data| EXEC\n    EXEC --&gt;|JSON| TOOLS\n    TOOLS --&gt;|Response| MS\n    MS --&gt;|stdio| TRANS\n    TRANS --&gt;|Parsed| MC\n    MC --&gt;|Formatted| UA\n\n    style MC fill:#4A90E2\n    style MS fill:#E24A90\n    style TOOLS fill:#90E24A</code></pre>"},{"location":"backend/whatsapp/mcp-database/#mcp-client","title":"MCP Client","text":""},{"location":"backend/whatsapp/mcp-database/#singleton-pattern","title":"Singleton Pattern","text":"<p>El cliente MCP usa patr\u00f3n Singleton para reutilizar la conexi\u00f3n:</p> <pre><code>class DatabaseMCPClient {\n  constructor() {\n    this.client = null;\n    this.transport = null;\n    this.isConnecting = false;\n    this.connectionPromise = null;\n  }\n\n  async connect() {\n    // Si ya existe conexi\u00f3n, retornarla\n    if (this.client) {\n      return this.client;\n    }\n\n    // Si est\u00e1 conectando, esperar la promesa existente\n    if (this.isConnecting) {\n      return this.connectionPromise;\n    }\n\n    // Iniciar nueva conexi\u00f3n\n    this.isConnecting = true;\n    this.connectionPromise = this._connect();\n\n    try {\n      await this.connectionPromise;\n      return this.client;\n    } finally {\n      this.isConnecting = false;\n    }\n  }\n}\n\n// Exportar instancia \u00fanica\nlet clientInstance = null;\n\nfunction getDBClient() {\n  if (!clientInstance) {\n    clientInstance = new DatabaseMCPClient();\n  }\n  return clientInstance;\n}\n</code></pre>"},{"location":"backend/whatsapp/mcp-database/#flujo-de-conexion","title":"Flujo de Conexi\u00f3n","text":"<pre><code>sequenceDiagram\n    participant A as Agent\n    participant C as MCP Client\n    participant T as Transport\n    participant S as MCP Server\n    participant DB as Database\n\n    A-&gt;&gt;C: getDBClient()\n\n    alt Primera conexi\u00f3n\n        C-&gt;&gt;C: Crear nueva instancia\n        C-&gt;&gt;T: new StdioClientTransport()\n        T-&gt;&gt;S: Spawn proceso node\n        S-&gt;&gt;DB: Crear connection pool\n        DB--&gt;&gt;S: Pool ready\n        S--&gt;&gt;T: Server ready\n        T--&gt;&gt;C: Connected\n        C-&gt;&gt;C: Listar herramientas\n        C--&gt;&gt;A: Client ready\n    else Conexi\u00f3n existente\n        C--&gt;&gt;A: Retornar client existente\n    end\n\n    A-&gt;&gt;C: executeSQL(query)\n    C-&gt;&gt;S: call_tool('execute_sql')\n    S-&gt;&gt;DB: Execute query\n    DB--&gt;&gt;S: Results\n    S--&gt;&gt;C: JSON response\n    C--&gt;&gt;A: Parsed data</code></pre>"},{"location":"backend/whatsapp/mcp-database/#metodos-del-cliente","title":"M\u00e9todos del Cliente","text":"<pre><code>class DatabaseMCPClient {\n  // Ejecutar SQL personalizado\n  async executeSQL(query, params = {}) {\n    await this.connect();\n    return await this.client.callTool('execute_sql', {\n      query,\n      parameters: params\n    });\n  }\n\n  // Listar todas las tablas\n  async listTables() {\n    await this.connect();\n    return await this.client.callTool('list_tables', {});\n  }\n\n  // Obtener esquema de una tabla\n  async getTableSchema(tableName) {\n    await this.connect();\n    return await this.client.callTool('get_table_schema', {\n      table_name: tableName\n    });\n  }\n\n  // Buscar usuario por tel\u00e9fono\n  async getUserByPhone(phoneNumber) {\n    const query = `\n      SELECT \n        Rut,\n        Nombre,\n        Email,\n        CodigoTransportista,\n        IdConversacion,\n        Admin,\n        Activo\n      FROM Usuarios\n      WHERE Telefono = @phone\n      AND Activo = 1\n    `;\n\n    const result = await this.executeSQL(query, { phone: phoneNumber });\n    return result.length &gt; 0 ? result[0] : null;\n  }\n\n  // Actualizar conversationId\n  async updateConversationId(rut, conversationId) {\n    const query = `\n      UPDATE Usuarios\n      SET IdConversacion = @conversationId,\n          FechaActualizacion = GETDATE()\n      WHERE Rut = @rut\n    `;\n\n    return await this.executeSQL(query, { rut, conversationId });\n  }\n}\n</code></pre>"},{"location":"backend/whatsapp/mcp-database/#mcp-server","title":"MCP Server","text":""},{"location":"backend/whatsapp/mcp-database/#registro-de-tools","title":"Registro de Tools","text":"<pre><code>const server = new Server(\n  {\n    name: 'tracmin-database-server',\n    version: '1.0.0',\n  },\n  {\n    capabilities: {\n      tools: {},\n    },\n  }\n);\n\n// Registrar herramientas disponibles\nserver.setRequestHandler(ListToolsRequestSchema, async () =&gt; {\n  return {\n    tools: [\n      {\n        name: 'execute_sql',\n        description: 'Execute a SQL query and return results',\n        inputSchema: {\n          type: 'object',\n          properties: {\n            query: {\n              type: 'string',\n              description: 'SQL query to execute'\n            },\n            parameters: {\n              type: 'object',\n              description: 'Query parameters'\n            }\n          },\n          required: ['query']\n        }\n      },\n      {\n        name: 'list_tables',\n        description: 'List all available tables in the database',\n        inputSchema: {\n          type: 'object',\n          properties: {}\n        }\n      },\n      {\n        name: 'get_table_schema',\n        description: 'Get the schema of a specific table',\n        inputSchema: {\n          type: 'object',\n          properties: {\n            table_name: {\n              type: 'string',\n              description: 'Name of the table'\n            }\n          },\n          required: ['table_name']\n        }\n      }\n    ]\n  };\n});\n</code></pre>"},{"location":"backend/whatsapp/mcp-database/#handler-de-herramientas","title":"Handler de Herramientas","text":"<pre><code>flowchart TD\n    Start([Call Tool Request]) --&gt; Parse[Parse tool name y arguments]\n\n    Parse --&gt; CheckTool{\u00bfQu\u00e9 tool?}\n\n    CheckTool --&gt;|execute_sql| ValidateSQL[Validar SQL]\n    CheckTool --&gt;|list_tables| ListTables[Listar tablas]\n    CheckTool --&gt;|get_table_schema| GetSchema[Obtener esquema]\n\n    ValidateSQL --&gt; CheckParams{\u00bfTiene&lt;br/&gt;par\u00e1metros?}\n    CheckParams --&gt;|S\u00ed| PrepareParams[Preparar params]\n    CheckParams --&gt;|No| PrepareQuery[Preparar query]\n    PrepareParams --&gt; PrepareQuery\n\n    PrepareQuery --&gt; ExecuteSQL[Ejecutar en SQL Server]\n    ListTables --&gt; ExecuteSQL\n    GetSchema --&gt; ExecuteSQL\n\n    ExecuteSQL --&gt; CheckError{\u00bfError?}\n\n    CheckError --&gt;|S\u00ed| LogError[Log error]\n    LogError --&gt; ReturnError[Retornar error]\n    ReturnError --&gt; End([End])\n\n    CheckError --&gt;|No| FormatResults[Formatear resultados&lt;br/&gt;a JSON]\n    FormatResults --&gt; ReturnSuccess[Retornar success]\n    ReturnSuccess --&gt; End\n\n    style ExecuteSQL fill:#87CEEB\n    style LogError fill:#FF6B6B\n    style FormatResults fill:#90EE90</code></pre>"},{"location":"backend/whatsapp/mcp-database/#implementacion-de-execute_sql","title":"Implementaci\u00f3n de execute_sql","text":"<pre><code>server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {\n  const { name, arguments: args } = request.params;\n\n  if (name === 'execute_sql') {\n    try {\n      const { query, parameters = {} } = args;\n\n      console.log('[MCP Server] Ejecutando SQL:', query);\n      console.log('[MCP Server] Par\u00e1metros:', parameters);\n\n      // Conectar al pool\n      await ensureConnection();\n\n      // Crear request\n      const sqlRequest = pool.request();\n\n      // Agregar par\u00e1metros\n      for (const [key, value] of Object.entries(parameters)) {\n        sqlRequest.input(key, value);\n      }\n\n      // Ejecutar query\n      const result = await sqlRequest.query(query);\n\n      console.log(`[MCP Server] \u2705 Query exitosa: ${result.recordset.length} filas`);\n\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify(result.recordset, null, 2)\n          }\n        ]\n      };\n\n    } catch (error) {\n      console.error('[MCP Server] \u274c Error ejecutando SQL:', error);\n\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify({\n              error: error.message,\n              code: error.code\n            })\n          }\n        ],\n        isError: true\n      };\n    }\n  }\n\n  if (name === 'list_tables') {\n    const query = `\n      SELECT \n        TABLE_SCHEMA,\n        TABLE_NAME,\n        TABLE_TYPE\n      FROM INFORMATION_SCHEMA.TABLES\n      WHERE TABLE_TYPE = 'BASE TABLE'\n      ORDER BY TABLE_SCHEMA, TABLE_NAME\n    `;\n\n    // Ejecutar y retornar...\n  }\n\n  if (name === 'get_table_schema') {\n    const query = `\n      SELECT \n        COLUMN_NAME,\n        DATA_TYPE,\n        IS_NULLABLE,\n        CHARACTER_MAXIMUM_LENGTH,\n        COLUMN_DEFAULT\n      FROM INFORMATION_SCHEMA.COLUMNS\n      WHERE TABLE_NAME = @tableName\n      ORDER BY ORDINAL_POSITION\n    `;\n\n    // Ejecutar y retornar...\n  }\n});\n</code></pre>"},{"location":"backend/whatsapp/mcp-database/#connection-pooling","title":"Connection Pooling","text":""},{"location":"backend/whatsapp/mcp-database/#configuracion-del-pool","title":"Configuraci\u00f3n del Pool","text":"<pre><code>const config = {\n  server: process.env.DB_SERVER,\n  database: process.env.DB_DATABASE,\n  user: process.env.DB_USER,\n  password: process.env.DB_PASSWORD,\n  options: {\n    encrypt: true,\n    trustServerCertificate: false,\n    enableArithAbort: true,\n    connectTimeout: 30000,\n    requestTimeout: 30000\n  },\n  pool: {\n    max: 10,\n    min: 2,\n    idleTimeoutMillis: 30000,\n    acquireTimeoutMillis: 30000\n  }\n};\n\nlet pool = null;\n\nasync function ensureConnection() {\n  if (!pool || !pool.connected) {\n    console.log('[MCP Server] Conectando a SQL Server...');\n    pool = await sql.connect(config);\n    console.log('[MCP Server] \u2705 Conectado a SQL Server');\n  }\n  return pool;\n}\n</code></pre>"},{"location":"backend/whatsapp/mcp-database/#lifecycle-del-pool","title":"Lifecycle del Pool","text":"<pre><code>stateDiagram-v2\n    [*] --&gt; Disconnected\n\n    Disconnected --&gt; Connecting: ensureConnection()\n\n    Connecting --&gt; Connected: Success\n    Connecting --&gt; Error: Connection failed\n\n    Error --&gt; Disconnected: Retry\n\n    Connected --&gt; Active: Execute query\n    Active --&gt; Connected: Query complete\n\n    Connected --&gt; Idle: No activity\n    Idle --&gt; Connected: New request\n    Idle --&gt; Disconnected: Timeout\n\n    Connected --&gt; Error: Network issue\n\n    Error --&gt; [*]: Fatal error\n    Disconnected --&gt; [*]: Shutdown</code></pre>"},{"location":"backend/whatsapp/mcp-database/#schema-del-proyecto","title":"Schema del Proyecto","text":""},{"location":"backend/whatsapp/mcp-database/#archivo-dbschemajson","title":"Archivo dbSchema.json","text":"<p>El esquema de base de datos est\u00e1 documentado en formato JSON para que los agentes lo entiendan:</p> <pre><code>{\n  \"database\": \"TracminDB\",\n  \"tables\": {\n    \"Usuarios\": {\n      \"description\": \"Usuarios del sistema con informaci\u00f3n de autenticaci\u00f3n\",\n      \"columns\": {\n        \"Rut\": \"VARCHAR(12) - RUT del usuario (PK)\",\n        \"Nombre\": \"VARCHAR(200) - Nombre completo\",\n        \"Email\": \"VARCHAR(200) - Correo electr\u00f3nico\",\n        \"Telefono\": \"VARCHAR(20) - N\u00famero telef\u00f3nico\",\n        \"IdConversacion\": \"VARCHAR(100) - ID de conversaci\u00f3n WhatsApp\",\n        \"CodigoTransportista\": \"VARCHAR(20) - C\u00f3digo del transportista\",\n        \"Admin\": \"BIT - Es administrador\",\n        \"Activo\": \"BIT - Usuario activo\"\n      },\n      \"indexes\": [\"Rut\", \"IdConversacion\", \"Telefono\"]\n    },\n    \"GuiasDespacho\": {\n      \"description\": \"Gu\u00edas de despacho de mercanc\u00edas\",\n      \"columns\": {\n        \"IdGuia\": \"INT IDENTITY - ID \u00fanico (PK)\",\n        \"NumeroFolio\": \"VARCHAR(50) - N\u00famero de folio\",\n        \"RutTransportista\": \"VARCHAR(12) - RUT del transportista\",\n        \"FechaEmision\": \"DATETIME - Fecha de emisi\u00f3n\",\n        \"Estado\": \"VARCHAR(50) - Estado actual\",\n        \"TipoDocumento\": \"VARCHAR(50) - Tipo de documento\"\n      },\n      \"security\": {\n        \"user_filter\": \"RutTransportista = @userRut\",\n        \"admin_filter\": \"none\"\n      }\n    },\n    \"Operaciones\": {\n      \"description\": \"Operaciones de transporte y viajes\",\n      \"columns\": {\n        \"IdOperacion\": \"INT IDENTITY - ID \u00fanico (PK)\",\n        \"RutTransportista\": \"VARCHAR(12) - RUT del transportista\",\n        \"Patente\": \"VARCHAR(10) - Patente del veh\u00edculo\",\n        \"FechaOperacion\": \"DATE - Fecha de operaci\u00f3n\",\n        \"Estado\": \"VARCHAR(50) - Estado de la operaci\u00f3n\"\n      },\n      \"security\": {\n        \"user_filter\": \"RutTransportista = @userRut\",\n        \"admin_filter\": \"none\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"backend/whatsapp/mcp-database/#integracion-con-agentes","title":"Integraci\u00f3n con Agentes","text":""},{"location":"backend/whatsapp/mcp-database/#uso-desde-un-agente","title":"Uso desde un Agente","text":"<pre><code>async function queryUserDocuments(userRut, startDate, endDate) {\n  const dbClient = getDBClient();\n\n  const query = `\n    SELECT \n      NumeroFolio,\n      FechaEmision,\n      Estado,\n      TipoDocumento\n    FROM GuiasDespacho\n    WHERE RutTransportista = @rut\n    AND FechaEmision BETWEEN @startDate AND @endDate\n    ORDER BY FechaEmision DESC\n  `;\n\n  const results = await dbClient.executeSQL(query, {\n    rut: userRut,\n    startDate,\n    endDate\n  });\n\n  return results;\n}\n</code></pre>"},{"location":"backend/whatsapp/mcp-database/#formato-de-resultados-con-toon","title":"Formato de Resultados con Toon","text":"<pre><code>const { formatToon, wrapToonForLLM } = require('../utils/toonFormatter');\n\nfunction formatDatabaseResult(results, queryContext) {\n  // Convertir a formato Toon\n  const toonData = formatToon(results);\n\n  // Envolver para LLM\n  const wrappedToon = wrapToonForLLM(toonData, queryContext);\n\n  return wrappedToon;\n}\n</code></pre>"},{"location":"backend/whatsapp/mcp-database/#manejo-de-errores","title":"Manejo de Errores","text":""},{"location":"backend/whatsapp/mcp-database/#tipos-de-errores","title":"Tipos de Errores","text":"<pre><code>graph TD\n    E[Error en MCP] --&gt; T{Tipo de error}\n\n    T --&gt;|Connection| C[Error de conexi\u00f3n]\n    T --&gt;|Query| Q[Error de SQL]\n    T --&gt;|Timeout| TO[Timeout]\n    T --&gt;|Permission| P[Error de permisos]\n\n    C --&gt; R1[Reintentar conexi\u00f3n]\n    R1 --&gt; L1[Log error]\n\n    Q --&gt; A1[Analizar query]\n    A1 --&gt; L2[Log query + error]\n\n    TO --&gt; I1[Incrementar timeout]\n    I1 --&gt; L3[Log warning]\n\n    P --&gt; N1[Notificar admin]\n    N1 --&gt; L4[Log critical]\n\n    L1 --&gt; U[Mensaje usuario]\n    L2 --&gt; U\n    L3 --&gt; U\n    L4 --&gt; U\n\n    style C fill:#FFA500\n    style Q fill:#FF6B6B\n    style TO fill:#FFD700\n    style P fill:#FF0000</code></pre>"},{"location":"backend/whatsapp/mcp-database/#reintentos-y-fallback","title":"Reintentos y Fallback","text":"<pre><code>async function executeWithRetry(fn, maxRetries = 3) {\n  let lastError;\n\n  for (let i = 0; i &lt; maxRetries; i++) {\n    try {\n      return await fn();\n    } catch (error) {\n      lastError = error;\n      console.log(`[MCP] Intento ${i + 1} fall\u00f3:`, error.message);\n\n      // Esperar antes de reintentar\n      await new Promise(resolve =&gt; setTimeout(resolve, 1000 * (i + 1)));\n    }\n  }\n\n  throw new Error(`Fall\u00f3 despu\u00e9s de ${maxRetries} intentos: ${lastError.message}`);\n}\n\n// Uso\nconst results = await executeWithRetry(() =&gt; \n  dbClient.executeSQL(query, params)\n);\n</code></pre>"},{"location":"backend/whatsapp/mcp-database/#performance-y-optimizacion","title":"Performance y Optimizaci\u00f3n","text":""},{"location":"backend/whatsapp/mcp-database/#caching-de-esquemas","title":"Caching de Esquemas","text":"<pre><code>class DatabaseMCPClient {\n  constructor() {\n    this.schemaCache = new Map();\n  }\n\n  async getTableSchema(tableName) {\n    // Check cache\n    if (this.schemaCache.has(tableName)) {\n      return this.schemaCache.get(tableName);\n    }\n\n    // Fetch from DB\n    const schema = await this._fetchSchema(tableName);\n\n    // Cache por 1 hora\n    this.schemaCache.set(tableName, schema);\n    setTimeout(() =&gt; {\n      this.schemaCache.delete(tableName);\n    }, 3600000);\n\n    return schema;\n  }\n}\n</code></pre>"},{"location":"backend/whatsapp/mcp-database/#query-optimization","title":"Query Optimization","text":"<ul> <li>Usar \u00edndices apropiados</li> <li>Limitar resultados con TOP o LIMIT</li> <li>Evitar SELECT * en producci\u00f3n</li> <li>Usar par\u00e1metros para prevenir SQL injection</li> <li>Aplicar filtros de seguridad siempre</li> </ul>"},{"location":"backend/whatsapp/mcp-database/#monitoreo","title":"Monitoreo","text":""},{"location":"backend/whatsapp/mcp-database/#logs-de-mcp","title":"Logs de MCP","text":"<pre><code>function logMCPOperation(operation, details) {\n  console.log(JSON.stringify({\n    timestamp: new Date().toISOString(),\n    component: 'MCP',\n    operation,\n    ...details\n  }));\n}\n\n// Uso\nlogMCPOperation('execute_sql', {\n  query: query.substring(0, 100),\n  params: Object.keys(params),\n  duration: endTime - startTime,\n  rows: result.recordset.length\n});\n</code></pre>"},{"location":"backend/whatsapp/mcp-database/#proximos-pasos","title":"Pr\u00f3ximos Pasos","text":"<ul> <li>Configuraci\u00f3n y Despliegue</li> <li>Troubleshooting</li> <li>Best Practices</li> </ul>"},{"location":"backend/whatsapp/seguridad/","title":"Seguridad y Validaci\u00f3n","text":""},{"location":"backend/whatsapp/seguridad/#arquitectura-de-seguridad","title":"Arquitectura de Seguridad","text":"<pre><code>graph TB\n    subgraph \"Entrada de Usuario\"\n        MSG[Mensaje WhatsApp]\n    end\n\n    subgraph \"Capa 1: Content Filtering\"\n        CF[Content Filter]\n        BL[Blacklist Keywords]\n        CD[Code Detection]\n    end\n\n    subgraph \"Capa 2: AI Guardrails\"\n        GR[Guardrails Service]\n        MOD[OpenAI Moderation API]\n        CF2[Custom Filters]\n    end\n\n    subgraph \"Capa 3: Identity Validation\"\n        RV[RUT Validator]\n        RF[Format Check]\n        RD[Digit Validation]\n        RO[Ownership Validation]\n    end\n\n    subgraph \"Capa 4: Authentication\"\n        AUTH[Auth Service]\n        USR[User Lookup]\n        PERM[Permission Check]\n    end\n\n    subgraph \"Capa 5: Data Security\"\n        SEC[Security Context]\n        FILT[SQL Filters]\n        SCOPE[Scope Restrictions]\n    end\n\n    subgraph \"Capa 6: Output Filtering\"\n        OUT[Output Guardrails]\n        CLEAN[Clean Response]\n    end\n\n    MSG --&gt; CF\n    CF --&gt; BL\n    CF --&gt; CD\n\n    CF --&gt;|Pasa| GR\n    BL --&gt;|Bloqueado| WARN[Warning Message]\n    CD --&gt;|Bloqueado| WARN\n\n    GR --&gt; MOD\n    GR --&gt; CF2\n    MOD --&gt;|Falla| SAFE[Safe Response]\n\n    GR --&gt;|Pasa| RV\n    RV --&gt; RF\n    RF --&gt; RD\n    RD --&gt; RO\n\n    RV --&gt;|Valid| AUTH\n    RO --&gt;|Invalid| ERR[Error Message]\n\n    AUTH --&gt; USR\n    AUTH --&gt; PERM\n    PERM --&gt;|OK| SEC\n\n    SEC --&gt; FILT\n    FILT --&gt; SCOPE\n    SCOPE --&gt; PROC[Process Query]\n\n    PROC --&gt; OUT\n    OUT --&gt; CLEAN\n    CLEAN --&gt; RESP[Response to User]\n\n    style CF fill:#FFA500\n    style GR fill:#FF6B6B\n    style RV fill:#4ECDC4\n    style AUTH fill:#45B7D1\n    style SEC fill:#96CEB4\n    style OUT fill:#FFEAA7</code></pre>"},{"location":"backend/whatsapp/seguridad/#1-content-filter","title":"1. Content Filter","text":""},{"location":"backend/whatsapp/seguridad/#filtro-de-contenido-prohibido","title":"Filtro de Contenido Prohibido","text":"<pre><code>flowchart TD\n    Start([Mensaje del usuario]) --&gt; Extract[Extraer texto]\n    Extract --&gt; Lower[Convertir a min\u00fasculas]\n\n    Lower --&gt; CheckWork{\u00bfContiene palabras&lt;br/&gt;de trabajo prohibidas?}\n\n    CheckWork --&gt;|S\u00ed| WorkWarn[\u26a0\ufe0f Advertencia:&lt;br/&gt;Solicitud de trabajo]\n    WorkWarn --&gt; End1([Bloquear mensaje])\n\n    CheckWork --&gt;|No| CheckCode{\u00bfSolicita c\u00f3digo&lt;br/&gt;o desarrollo?}\n\n    CheckCode --&gt;|S\u00ed| CodeWarn[\u26a0\ufe0f Advertencia:&lt;br/&gt;Solicitud de c\u00f3digo]\n    CodeWarn --&gt; End2([Bloquear mensaje])\n\n    CheckCode --&gt;|No| Pass[\u2705 Contenido v\u00e1lido]\n    Pass --&gt; NextLayer([Siguiente capa])\n\n    style WorkWarn fill:#FF6B6B\n    style CodeWarn fill:#FF6B6B\n    style Pass fill:#90EE90</code></pre>"},{"location":"backend/whatsapp/seguridad/#implementacion","title":"Implementaci\u00f3n","text":"<pre><code>// Lista de palabras prohibidas relacionadas con trabajo\nconst workBlacklist = [\n  'hacer un trabajo',\n  'tarea para',\n  'proyecto sobre',\n  'hacer mi tarea',\n  'resolver este ejercicio',\n  'examen de',\n  'ayudame con mi tarea'\n];\n\n// Detecci\u00f3n de solicitudes de c\u00f3digo\nfunction containsCodeRequest(text) {\n  const codePatterns = [\n    /escribeme?\\s+(un\\s+)?codigo/i,\n    /crea?\\s+(un\\s+)?(codigo|programa|script)/i,\n    /genera?\\s+(un\\s+)?codigo/i,\n    /programa\\s+en\\s+(python|java|javascript)/i\n  ];\n\n  return codePatterns.some(pattern =&gt; pattern.test(text));\n}\n\nfunction shouldBlockMessage(text) {\n  const lowerText = text.toLowerCase();\n\n  // Verificar blacklist\n  if (workBlacklist.some(term =&gt; lowerText.includes(term))) {\n    return { \n      blocked: true, \n      reason: 'work_request',\n      message: WORK_WARNING_MESSAGE \n    };\n  }\n\n  // Verificar solicitudes de c\u00f3digo\n  if (containsCodeRequest(text)) {\n    return { \n      blocked: true, \n      reason: 'code_request',\n      message: CODE_WARNING_MESSAGE \n    };\n  }\n\n  return { blocked: false };\n}\n</code></pre>"},{"location":"backend/whatsapp/seguridad/#mensajes-de-advertencia","title":"Mensajes de Advertencia","text":"<pre><code>const WORK_WARNING_MESSAGE = `\n\u26a0\ufe0f *Pol\u00edtica de Uso*\n\nEste sistema est\u00e1 dise\u00f1ado para consultas relacionadas con operaciones de Tracmin.\n\n\u274c No est\u00e1 permitido:\n- Solicitar ayuda con tareas escolares\n- Solicitar trabajos o proyectos\n- Resolver ex\u00e1menes\n\n\u2705 Puedes consultar sobre:\n- Tus documentos y gu\u00edas\n- Operaciones de transporte\n- Consumo de combustible\n- Estado de veh\u00edculos\n`;\n\nconst CODE_WARNING_MESSAGE = `\n\u26a0\ufe0f *Pol\u00edtica de Uso*\n\nEste sistema no genera c\u00f3digo de programaci\u00f3n.\n\n\u274c No disponible:\n- Crear scripts o programas\n- Escribir c\u00f3digo fuente\n- Generar algoritmos\n\n\u2705 Puedes consultar sobre:\n- Informaci\u00f3n de tu cuenta\n- Operaciones de transporte\n- Datos de tu flota\n`;\n</code></pre>"},{"location":"backend/whatsapp/seguridad/#2-ai-guardrails","title":"2. AI Guardrails","text":""},{"location":"backend/whatsapp/seguridad/#flujo-de-verificacion","title":"Flujo de Verificaci\u00f3n","text":"<pre><code>sequenceDiagram\n    participant M as Mensaje\n    participant G as Guardrails\n    participant OAI as OpenAI Moderation\n    participant CF as Custom Filters\n    participant R as Response\n\n    M-&gt;&gt;G: checkGuardrails(text, isInput)\n\n    rect rgb(200, 220, 240)\n        Note over G,OAI: Verificaci\u00f3n OpenAI\n        G-&gt;&gt;OAI: moderations.create()\n        OAI-&gt;&gt;OAI: Analizar contenido\n        OAI--&gt;&gt;G: Resultado moderaci\u00f3n\n\n        alt Contenido inapropiado\n            OAI--&gt;&gt;G: flagged = true\n            G-&gt;&gt;G: Generar respuesta segura\n            G--&gt;&gt;R: \u274c Contenido bloqueado\n        else Contenido OK\n            OAI--&gt;&gt;G: flagged = false\n        end\n    end\n\n    rect rgb(200, 240, 200)\n        Note over G,CF: Filtros Personalizados\n        G-&gt;&gt;CF: Aplicar filtros custom\n        CF-&gt;&gt;CF: Verificar patrones prohibidos\n        CF-&gt;&gt;CF: Limpiar c\u00f3digo si existe\n        CF--&gt;&gt;G: Texto filtrado\n    end\n\n    G--&gt;&gt;R: \u2705 Texto seguro y validado</code></pre>"},{"location":"backend/whatsapp/seguridad/#implementacion-de-guardrails","title":"Implementaci\u00f3n de Guardrails","text":"<pre><code>async function checkGuardrails(text, isInput = true) {\n  try {\n    // 1. Verificar con OpenAI Moderation API\n    const moderation = await openai.moderations.create({\n      input: text,\n      model: \"text-moderation-stable\"\n    });\n\n    const result = moderation.results[0];\n\n    // Si OpenAI detecta contenido inapropiado\n    if (result.flagged) {\n      console.log('[Guardrails] \u274c Contenido flagged por OpenAI:', result.categories);\n\n      return {\n        passed: false,\n        safeText: generateSafeResponse(result.categories)\n      };\n    }\n\n    // 2. Aplicar filtros personalizados\n    let safeText = text;\n\n    // Filtrar c\u00f3digo si est\u00e1 en la salida\n    if (!isInput) {\n      safeText = filterCodeFromResponse(safeText);\n    }\n\n    // 3. Verificar longitud\n    if (safeText.length &gt; 4000) {\n      safeText = safeText.substring(0, 3997) + '...';\n      console.log('[Guardrails] \u26a0\ufe0f Texto truncado por longitud');\n    }\n\n    return {\n      passed: true,\n      safeText: safeText\n    };\n\n  } catch (error) {\n    console.error('[Guardrails] Error:', error);\n    // En caso de error, ser conservador\n    return {\n      passed: true,\n      safeText: text\n    };\n  }\n}\n</code></pre>"},{"location":"backend/whatsapp/seguridad/#categorias-de-moderacion","title":"Categor\u00edas de Moderaci\u00f3n","text":"Categor\u00eda Descripci\u00f3n Acci\u00f3n <code>hate</code> Contenido de odio Bloquear <code>harassment</code> Acoso Bloquear <code>self-harm</code> Autolesi\u00f3n Bloquear <code>sexual</code> Contenido sexual Bloquear <code>violence</code> Violencia Bloquear <code>hate/threatening</code> Odio con amenazas Bloquear <code>violence/graphic</code> Violencia gr\u00e1fica Bloquear"},{"location":"backend/whatsapp/seguridad/#filtrado-de-codigo","title":"Filtrado de C\u00f3digo","text":"<pre><code>function filterCodeFromResponse(text) {\n  // Remover bloques de c\u00f3digo\n  let filtered = text.replace(/```[\\s\\S]*?```/g, '[C\u00f3digo removido por seguridad]');\n\n  // Remover c\u00f3digo inline\n  filtered = filtered.replace(/`[^`]+`/g, '[C\u00f3digo removido]');\n\n  // Remover patrones SQL peligrosos\n  filtered = filtered.replace(/DROP\\s+TABLE/gi, '[Operaci\u00f3n no permitida]');\n  filtered = filtered.replace(/DELETE\\s+FROM/gi, '[Operaci\u00f3n no permitida]');\n  filtered = filtered.replace(/TRUNCATE/gi, '[Operaci\u00f3n no permitida]');\n\n  return filtered;\n}\n</code></pre>"},{"location":"backend/whatsapp/seguridad/#3-rut-validator","title":"3. RUT Validator","text":""},{"location":"backend/whatsapp/seguridad/#flujo-de-validacion-de-rut","title":"Flujo de Validaci\u00f3n de RUT","text":"<pre><code>stateDiagram-v2\n    [*] --&gt; ReceiveInput: Usuario env\u00eda RUT\n\n    ReceiveInput --&gt; FormatCheck: Validar formato\n\n    FormatCheck --&gt; ValidFormat: Formato correcto\n    FormatCheck --&gt; InvalidFormat: Formato incorrecto\n\n    InvalidFormat --&gt; SendError: Enviar mensaje de error\n    SendError --&gt; [*]\n\n    ValidFormat --&gt; NormalizeRUT: Normalizar RUT&lt;br/&gt;(remover puntos/guiones)\n\n    NormalizeRUT --&gt; DigitCheck: Validar d\u00edgito verificador\n\n    DigitCheck --&gt; ValidDigit: D\u00edgito v\u00e1lido\n    DigitCheck --&gt; InvalidDigit: D\u00edgito inv\u00e1lido\n\n    InvalidDigit --&gt; SendError\n\n    ValidDigit --&gt; DBLookup: Buscar en base de datos\n\n    DBLookup --&gt; UserFound: Usuario encontrado\n    DBLookup --&gt; UserNotFound: Usuario no encontrado\n\n    UserNotFound --&gt; SendNotFound: RUT no registrado\n    SendNotFound --&gt; [*]\n\n    UserFound --&gt; UpdateConversation: Vincular conversationId\n    UpdateConversation --&gt; Success: \u2705 Vinculaci\u00f3n exitosa\n    Success --&gt; [*]</code></pre>"},{"location":"backend/whatsapp/seguridad/#validacion-de-formato","title":"Validaci\u00f3n de Formato","text":"<pre><code>function isValidRutFormat(rut) {\n  // Formato: 12345678-9 o 12.345.678-9\n  const rutPattern = /^(\\d{1,2}\\.?\\d{3}\\.?\\d{3})-?[\\dkK]$/;\n  return rutPattern.test(rut);\n}\n\nfunction normalizeRut(rut) {\n  // Remover puntos y guiones, convertir K a may\u00fascula\n  return rut.replace(/\\./g, '')\n            .replace(/-/g, '')\n            .toUpperCase();\n}\n</code></pre>"},{"location":"backend/whatsapp/seguridad/#algoritmo-de-digito-verificador","title":"Algoritmo de D\u00edgito Verificador","text":"<pre><code>function validateRutDigit(rut) {\n  const normalized = normalizeRut(rut);\n  const rutDigits = normalized.slice(0, -1);\n  const verifierDigit = normalized.slice(-1);\n\n  // Algoritmo m\u00f3dulo 11\n  let sum = 0;\n  let multiplier = 2;\n\n  for (let i = rutDigits.length - 1; i &gt;= 0; i--) {\n    sum += parseInt(rutDigits[i]) * multiplier;\n    multiplier = multiplier === 7 ? 2 : multiplier + 1;\n  }\n\n  const remainder = sum % 11;\n  const calculatedDigit = 11 - remainder;\n\n  let expectedDigit;\n  if (calculatedDigit === 11) {\n    expectedDigit = '0';\n  } else if (calculatedDigit === 10) {\n    expectedDigit = 'K';\n  } else {\n    expectedDigit = calculatedDigit.toString();\n  }\n\n  return verifierDigit === expectedDigit;\n}\n</code></pre>"},{"location":"backend/whatsapp/seguridad/#mensajes-de-validacion","title":"Mensajes de Validaci\u00f3n","text":"<pre><code>function generateRutRequestMessage() {\n  return `\n\ud83d\udd10 *Vinculaci\u00f3n de Cuenta*\n\nPara continuar, necesito validar tu identidad.\n\nPor favor, env\u00eda tu RUT en el siguiente formato:\n\ud83d\udcdd Ejemplo: 12.345.678-9\n\n\u2139\ufe0f *Importante*:\n- Incluye el d\u00edgito verificador\n- Puedes usar puntos y gui\u00f3n o solo n\u00fameros\n- Tu RUT debe estar registrado en el sistema\n`;\n}\n\nfunction generateValidationErrorMessage(reason) {\n  const messages = {\n    'invalid_format': `\n\u274c *Formato Inv\u00e1lido*\n\nEl RUT ingresado no tiene un formato v\u00e1lido.\n\nFormato correcto: 12.345.678-9\nIntenta nuevamente.\n`,\n    'invalid_digit': `\n\u274c *D\u00edgito Verificador Incorrecto*\n\nEl d\u00edgito verificador del RUT no es v\u00e1lido.\nVerifica que hayas ingresado correctamente tu RUT.\n`,\n    'not_found': `\n\u274c *Usuario No Encontrado*\n\nEl RUT no est\u00e1 registrado en nuestro sistema.\nContacta al administrador para registrar tu cuenta.\n`,\n    'database_error': `\n\u274c *Error del Sistema*\n\nOcurri\u00f3 un error al validar tu RUT.\nPor favor, intenta nuevamente en unos momentos.\n`\n  };\n\n  return messages[reason] || messages['database_error'];\n}\n</code></pre>"},{"location":"backend/whatsapp/seguridad/#4-authentication-authorization","title":"4. Authentication &amp; Authorization","text":""},{"location":"backend/whatsapp/seguridad/#flujo-de-autenticacion","title":"Flujo de Autenticaci\u00f3n","text":"<pre><code>sequenceDiagram\n    participant U as Usuario\n    participant W as Webhook\n    participant A as Auth Service\n    participant DB as Database\n    participant CM as Conversation Memory\n\n    U-&gt;&gt;W: Mensaje entrante\n    W-&gt;&gt;A: getUserInfo(conversationId)\n\n    alt Usuario encontrado por conversationId\n        A-&gt;&gt;DB: SELECT * FROM Usuarios&lt;br/&gt;WHERE IdConversacion = ?\n        DB--&gt;&gt;A: userData\n        A--&gt;&gt;W: userInfo\n    else Usuario no encontrado\n        A--&gt;&gt;W: null\n        W-&gt;&gt;DB: getUserByPhone(phoneNumber)\n\n        alt Usuario encontrado por tel\u00e9fono\n            DB--&gt;&gt;W: userData\n            W-&gt;&gt;DB: updateConversationId()\n            W-&gt;&gt;W: Continuar con usuario\n        else Usuario no encontrado\n            W-&gt;&gt;CM: setAwaitingAccountLinking()\n            W-&gt;&gt;U: Solicitar RUT\n        end\n    end\n\n    W-&gt;&gt;A: isAdmin(conversationId)\n    A-&gt;&gt;DB: SELECT Admin FROM Usuarios&lt;br/&gt;WHERE IdConversacion = ?\n    DB--&gt;&gt;A: Admin flag\n    A--&gt;&gt;W: true/false\n\n    alt Es Admin\n        W-&gt;&gt;W: runAdminWorkflow()\n    else Es User\n        W-&gt;&gt;W: runUserWorkflow()\n    end</code></pre>"},{"location":"backend/whatsapp/seguridad/#auth-service","title":"Auth Service","text":"<pre><code>class AuthService {\n  async getUserInfo(conversationId) {\n    try {\n      const dbClient = getDBClient();\n      const user = await dbClient.getUserByConversationId(conversationId);\n      return user;\n    } catch (error) {\n      console.error('[Auth] Error obteniendo usuario:', error);\n      return null;\n    }\n  }\n\n  async isAdmin(conversationId) {\n    const user = await this.getUserInfo(conversationId);\n    return user?.Admin === true;\n  }\n\n  async validateUser(rut) {\n    try {\n      const dbClient = getDBClient();\n      const query = `\n        SELECT \n          Rut, \n          Nombre, \n          Email, \n          CodigoTransportista,\n          Admin\n        FROM Usuarios\n        WHERE Rut = @rut\n        AND Activo = 1\n      `;\n\n      const result = await dbClient.executeSQL(query, { rut });\n      return result.length &gt; 0 ? result[0] : null;\n    } catch (error) {\n      console.error('[Auth] Error validando usuario:', error);\n      return null;\n    }\n  }\n}\n</code></pre>"},{"location":"backend/whatsapp/seguridad/#5-security-context-sql-filters","title":"5. Security Context &amp; SQL Filters","text":""},{"location":"backend/whatsapp/seguridad/#context-de-seguridad-para-usuarios","title":"Context de Seguridad para Usuarios","text":"<pre><code>function buildSecurityContext(userInfo, isAdmin) {\n  if (isAdmin) {\n    return `\nPRIVILEGIOS DE ADMINISTRADOR:\n- Acceso completo a todos los datos\n- Sin restricciones por RUT o Transportista\n- Puede consultar cualquier informaci\u00f3n\n`;\n  }\n\n  return `\nRESTRICCIONES DE SEGURIDAD:\n- RUT del usuario: ${userInfo.Rut}\n- C\u00f3digo Transportista: ${userInfo.CodigoTransportista}\n\nREGLAS OBLIGATORIAS:\n1. TODAS las consultas SQL DEBEN incluir:\n   - WHERE RutTransportista = '${userInfo.Rut}' O\n   - WHERE CodigoTransportista = '${userInfo.CodigoTransportista}'\n\n2. NO mostrar informaci\u00f3n de otros usuarios\n3. NO acceder a datos de otros transportistas\n4. Aplicar filtros en TODAS las tablas consultadas\n\nEJEMPLO DE CONSULTA SEGURA:\nSELECT * FROM Operaciones \nWHERE RutTransportista = '${userInfo.Rut}'\nAND FechaOperacion &gt;= '2025-01-01'\n`;\n}\n</code></pre>"},{"location":"backend/whatsapp/seguridad/#validacion-de-sql","title":"Validaci\u00f3n de SQL","text":"<pre><code>flowchart TD\n    Start([SQL generado por IA]) --&gt; Extract[Extraer tablas y filtros]\n    Extract --&gt; Check{\u00bfEs usuario&lt;br/&gt;normal?}\n\n    Check --&gt;|No, es Admin| Allow[\u2705 Permitir query]\n    Allow --&gt; Execute[Ejecutar SQL]\n\n    Check --&gt;|S\u00ed, es User| Validate[Validar filtros de seguridad]\n\n    Validate --&gt; HasRUT{\u00bfIncluye filtro&lt;br/&gt;por RUT?}\n    HasRUT --&gt;|S\u00ed| Correct1[\u2705 Filtro correcto]\n    Correct1 --&gt; Execute\n\n    HasRUT --&gt;|No| HasTransporter{\u00bfIncluye filtro por&lt;br/&gt;Transportista?}\n\n    HasTransporter --&gt;|S\u00ed| Correct2[\u2705 Filtro correcto]\n    Correct2 --&gt; Execute\n\n    HasTransporter --&gt;|No| Reject[\u274c Query insegura]\n    Reject --&gt; Error[Error: Falta filtro&lt;br/&gt;de seguridad]\n    Error --&gt; End([No ejecutar])\n\n    Execute --&gt; Results[Retornar resultados]\n    Results --&gt; End2([Fin])\n\n    style Reject fill:#FF6B6B\n    style Error fill:#FF6B6B\n    style Correct1 fill:#90EE90\n    style Correct2 fill:#90EE90</code></pre>"},{"location":"backend/whatsapp/seguridad/#6-conversation-memory","title":"6. Conversation Memory","text":""},{"location":"backend/whatsapp/seguridad/#gestion-de-estado","title":"Gesti\u00f3n de Estado","text":"<pre><code>class ConversationMemory {\n  constructor() {\n    this.memory = new Map();\n    this.linkingProcess = new Map();\n    this.rutValidations = new Map();\n  }\n\n  // Almacenar contexto de conversaci\u00f3n\n  setContext(conversationId, context) {\n    this.memory.set(conversationId, {\n      ...context,\n      timestamp: Date.now()\n    });\n  }\n\n  getContext(conversationId) {\n    return this.memory.get(conversationId);\n  }\n\n  // Gesti\u00f3n de proceso de vinculaci\u00f3n\n  setAwaitingAccountLinking(conversationId, phone) {\n    this.linkingProcess.set(conversationId, {\n      phone,\n      startedAt: Date.now(),\n      step: 'waiting_rut'\n    });\n  }\n\n  isAwaitingAccountLinking(conversationId) {\n    return this.linkingProcess.has(conversationId);\n  }\n\n  clearLinkingProcess(conversationId) {\n    this.linkingProcess.delete(conversationId);\n  }\n\n  // Validaci\u00f3n de RUT\n  markRutValidated(conversationId, rut) {\n    this.rutValidations.set(conversationId, {\n      rut,\n      validatedAt: Date.now()\n    });\n  }\n\n  isRutValidated(conversationId) {\n    return this.rutValidations.has(conversationId);\n  }\n\n  // Limpieza de memoria (ejecutar peri\u00f3dicamente)\n  cleanup(maxAge = 3600000) { // 1 hora\n    const now = Date.now();\n\n    for (const [key, value] of this.memory.entries()) {\n      if (now - value.timestamp &gt; maxAge) {\n        this.memory.delete(key);\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"backend/whatsapp/seguridad/#mejores-practicas-de-seguridad","title":"Mejores Pr\u00e1cticas de Seguridad","text":""},{"location":"backend/whatsapp/seguridad/#hacer","title":"\u2705 Hacer","text":"<ol> <li>Siempre validar entrada del usuario</li> <li>Usar Content Filter</li> <li>Aplicar Guardrails</li> <li> <p>Validar formato de datos</p> </li> <li> <p>Aplicar principio de m\u00ednimo privilegio</p> </li> <li>Filtrar por RUT/Transportista</li> <li>Verificar permisos antes de ejecutar</li> <li> <p>Limitar alcance de consultas</p> </li> <li> <p>Logging de seguridad</p> </li> <li>Registrar intentos de acceso</li> <li>Log de queries ejecutadas</li> <li> <p>Alertas de comportamiento sospechoso</p> </li> <li> <p>Sanitizar salidas</p> </li> <li>Filtrar c\u00f3digo en respuestas</li> <li>Remover informaci\u00f3n sensible</li> <li>Verificar longitud de mensajes</li> </ol>"},{"location":"backend/whatsapp/seguridad/#no-hacer","title":"\u274c No Hacer","text":"<ol> <li>No confiar en entrada del usuario</li> <li>Nunca ejecutar SQL sin validar</li> <li>No asumir formato correcto</li> <li> <p>No saltarse validaciones</p> </li> <li> <p>No exponer informaci\u00f3n sensible</p> </li> <li>Nunca mostrar queries SQL al usuario</li> <li>No revelar estructura de DB</li> <li> <p>No mostrar errores t\u00e9cnicos detallados</p> </li> <li> <p>No reusar tokens o sesiones</p> </li> <li>No compartir conversationId</li> <li>No cachear informaci\u00f3n sensible</li> <li>Limpiar memoria regularmente</li> </ol>"},{"location":"backend/whatsapp/seguridad/#proximos-pasos","title":"Pr\u00f3ximos Pasos","text":"<ul> <li>MCP y Base de Datos</li> <li>Configuraci\u00f3n y Despliegue</li> <li>Troubleshooting</li> </ul>"},{"location":"backend/whatsapp/sistema-agentes/","title":"Sistema de Agentes de IA","text":""},{"location":"backend/whatsapp/sistema-agentes/#arquitectura-de-agentes","title":"Arquitectura de Agentes","text":"<pre><code>graph TB\n    subgraph \"Capa de Orquestaci\u00f3n\"\n        UO[User Orchestrator]\n        AO[Admin Orchestrator]\n    end\n\n    subgraph \"Agentes Conversacionales\"\n        UA[User Agent&lt;br/&gt;Conversacional seguro]\n        AA[Admin Agent&lt;br/&gt;Privilegios elevados]\n    end\n\n    subgraph \"Agentes Especializados - Factory Pattern\"\n        AF[Agent Factory&lt;br/&gt;Selector inteligente]\n\n        subgraph \"Database Agents\"\n            DA[Document Agent&lt;br/&gt;Gu\u00edas y documentos]\n            FA[Fuel Agent&lt;br/&gt;Combustible y consumos]\n            OA[Operation Agent&lt;br/&gt;Operaciones y viajes]\n            VA[Vehicle Agent&lt;br/&gt;Veh\u00edculos y flotas]\n            TA[Transporter Agent&lt;br/&gt;Transportistas]\n        end\n    end\n\n    subgraph \"Capa de Datos\"\n        MCP[MCP Client]\n        DB[(SQL Server)]\n    end\n\n    UO --&gt; UA\n    AO --&gt; AA\n\n    UO --&gt; AF\n    AO --&gt; AF\n\n    AF -.selecciona.-&gt; DA\n    AF -.selecciona.-&gt; FA\n    AF -.selecciona.-&gt; OA\n    AF -.selecciona.-&gt; VA\n    AF -.selecciona.-&gt; TA\n\n    DA --&gt; MCP\n    FA --&gt; MCP\n    OA --&gt; MCP\n    VA --&gt; MCP\n    TA --&gt; MCP\n\n    MCP --&gt; DB\n\n    style AF fill:#FFD700\n    style UA fill:#4A90E2\n    style AA fill:#E24A4A</code></pre>"},{"location":"backend/whatsapp/sistema-agentes/#factory-pattern-seleccion-de-agentes","title":"Factory Pattern - Selecci\u00f3n de Agentes","text":""},{"location":"backend/whatsapp/sistema-agentes/#agent-factory","title":"Agent Factory","text":"<p>El <code>DatabaseAgentFactory</code> selecciona autom\u00e1ticamente el agente m\u00e1s apropiado seg\u00fan el contenido del mensaje.</p> <pre><code>flowchart TD\n    Start([Mensaje del usuario]) --&gt; Factory[Agent Factory]\n\n    Factory --&gt; AnalyzeKeywords[Analizar keywords&lt;br/&gt;en mensaje]\n\n    AnalyzeKeywords --&gt; CheckDocument{\u00bfContiene:&lt;br/&gt;documento, gu\u00eda,&lt;br/&gt;folio, tracmin?}\n    CheckDocument --&gt;|S\u00ed| DocumentAgent[\ud83d\udcc4 Document Agent&lt;br/&gt;Especialista en gu\u00edas]\n\n    CheckDocument --&gt;|No| CheckFuel{\u00bfContiene:&lt;br/&gt;combustible, consumo,&lt;br/&gt;litros, diesel?}\n    CheckFuel --&gt;|S\u00ed| FuelAgent[\u26fd Fuel Agent&lt;br/&gt;Especialista en combustible]\n\n    CheckFuel --&gt;|No| CheckOperation{\u00bfContiene:&lt;br/&gt;operaci\u00f3n, viaje,&lt;br/&gt;ruta, transporte?}\n    CheckOperation --&gt;|S\u00ed| OperationAgent[\ud83d\ude9a Operation Agent&lt;br/&gt;Especialista en operaciones]\n\n    CheckOperation --&gt;|No| CheckVehicle{\u00bfContiene:&lt;br/&gt;veh\u00edculo, cami\u00f3n,&lt;br/&gt;patente, flota?}\n    CheckVehicle --&gt;|S\u00ed| VehicleAgent[\ud83d\ude9b Vehicle Agent&lt;br/&gt;Especialista en veh\u00edculos]\n\n    CheckVehicle --&gt;|No| CheckTransporter{\u00bfContiene:&lt;br/&gt;transportista,&lt;br/&gt;empresa, proveedor?}\n    CheckTransporter --&gt;|S\u00ed| TransporterAgent[\ud83c\udfe2 Transporter Agent&lt;br/&gt;Especialista en transportistas]\n\n    CheckTransporter --&gt;|No| DefaultAgent[\ud83d\udcca Operation Agent&lt;br/&gt;Agente por defecto]\n\n    DocumentAgent --&gt; Execute[Ejecutar agente seleccionado]\n    FuelAgent --&gt; Execute\n    OperationAgent --&gt; Execute\n    VehicleAgent --&gt; Execute\n    TransporterAgent --&gt; Execute\n    DefaultAgent --&gt; Execute\n\n    Execute --&gt; End([Respuesta al usuario])\n\n    style Factory fill:#FFD700\n    style DocumentAgent fill:#87CEEB\n    style FuelAgent fill:#FFA500\n    style OperationAgent fill:#90EE90\n    style VehicleAgent fill:#DDA0DD\n    style TransporterAgent fill:#F0E68C</code></pre>"},{"location":"backend/whatsapp/sistema-agentes/#codigo-del-factory","title":"C\u00f3digo del Factory","text":"<pre><code>class DatabaseAgentFactory {\n  static selectAgent(userMessage, isAdmin = false) {\n    const lowerMessage = userMessage.toLowerCase();\n\n    // Keywords para cada tipo de agente\n    const documentKeywords = ['documento', 'guia', 'gu\u00eda', 'folio', 'tracmin'];\n    const fuelKeywords = ['combustible', 'consumo', 'litros', 'diesel', 'gasolina'];\n    const operationKeywords = ['operacion', 'operaci\u00f3n', 'viaje', 'ruta', 'transporte'];\n    const vehicleKeywords = ['vehiculo', 'veh\u00edculo', 'camion', 'cami\u00f3n', 'patente', 'flota'];\n    const transporterKeywords = ['transportista', 'empresa', 'proveedor'];\n\n    // Selecci\u00f3n por keywords\n    if (documentKeywords.some(kw =&gt; lowerMessage.includes(kw))) {\n      return documentAgent;\n    }\n    if (fuelKeywords.some(kw =&gt; lowerMessage.includes(kw))) {\n      return fuelAgent;\n    }\n    if (vehicleKeywords.some(kw =&gt; lowerMessage.includes(kw))) {\n      return vehicleAgent;\n    }\n    if (transporterKeywords.some(kw =&gt; lowerMessage.includes(kw))) {\n      return transporterAgent;\n    }\n    if (operationKeywords.some(kw =&gt; lowerMessage.includes(kw))) {\n      return operationAgent;\n    }\n\n    // Agente por defecto\n    return operationAgent;\n  }\n}\n</code></pre>"},{"location":"backend/whatsapp/sistema-agentes/#flujo-de-ejecucion-de-agentes","title":"Flujo de Ejecuci\u00f3n de Agentes","text":""},{"location":"backend/whatsapp/sistema-agentes/#proceso-de-dos-fases","title":"Proceso de Dos Fases","text":"<pre><code>sequenceDiagram\n    participant O as Orchestrator\n    participant AF as Agent Factory\n    participant A as Agente Especializado\n    participant MCP as MCP Client\n    participant DB as Database\n\n    O-&gt;&gt;O: Construir security context\n    O-&gt;&gt;AF: selectAgent(mensaje)\n    AF--&gt;&gt;O: Agente seleccionado\n\n    rect rgb(200, 220, 240)\n        Note over O,A: FASE 1: Generaci\u00f3n SQL\n        O-&gt;&gt;A: Generar SQL con contexto\n        A-&gt;&gt;A: Analizar esquema DB\n        A-&gt;&gt;A: Aplicar restricciones seguridad\n        A-&gt;&gt;A: Construir query optimizada\n        A--&gt;&gt;O: SQL Query\n    end\n\n    O-&gt;&gt;MCP: executeSQL(query)\n    MCP-&gt;&gt;DB: Ejecutar query\n    DB--&gt;&gt;MCP: Resultados\n    MCP--&gt;&gt;O: Data (JSON)\n\n    O-&gt;&gt;O: Formatear con Toon\n\n    rect rgb(200, 240, 200)\n        Note over O,A: FASE 2: Formateo Respuesta\n        O-&gt;&gt;A: Formatear respuesta con datos\n        A-&gt;&gt;A: Analizar resultados\n        A-&gt;&gt;A: Generar texto natural\n        A-&gt;&gt;A: Agregar contexto y an\u00e1lisis\n        A--&gt;&gt;O: Respuesta formateada\n    end\n\n    O--&gt;&gt;O: Respuesta final</code></pre>"},{"location":"backend/whatsapp/sistema-agentes/#agentes-especializados","title":"Agentes Especializados","text":""},{"location":"backend/whatsapp/sistema-agentes/#1-document-agent","title":"1. Document Agent","text":"<p>Especialidad: Gu\u00edas, documentos, folios, trazabilidad</p> <pre><code>graph LR\n    A[Document Agent] --&gt; B[Gu\u00edas de despacho]\n    A --&gt; C[Documentos de transporte]\n    A --&gt; D[Folios y n\u00fameros]\n    A --&gt; E[Estados y trazabilidad]\n\n    B --&gt; F[Creaci\u00f3n]\n    B --&gt; G[Consulta]\n    B --&gt; H[Cancelaci\u00f3n]\n\n    C --&gt; I[Validaci\u00f3n]\n    C --&gt; J[Seguimiento]\n\n    E --&gt; K[Historial]\n    E --&gt; L[Estados actuales]</code></pre> <p>Tablas principales: - <code>GuiasDespacho</code> - <code>DocumentosTransporte</code> - <code>EstadosGuias</code> - <code>TrazabilidadDocumentos</code></p> <p>Queries t\u00edpicas: <pre><code>-- Buscar gu\u00edas por RUT\nSELECT * FROM GuiasDespacho \nWHERE RutTransportista = @rut\nAND FechaEmision &gt;= @fechaInicio\n\n-- Estado de gu\u00eda espec\u00edfica\nSELECT g.*, e.Estado, e.FechaActualizacion\nFROM GuiasDespacho g\nINNER JOIN EstadosGuias e ON g.IdGuia = e.IdGuia\nWHERE g.NumeroFolio = @folio\n</code></pre></p>"},{"location":"backend/whatsapp/sistema-agentes/#2-fuel-agent","title":"2. Fuel Agent","text":"<p>Especialidad: Combustible, consumos, litros, rendimiento</p> <pre><code>graph LR\n    A[Fuel Agent] --&gt; B[Consumos]\n    A --&gt; C[Abastecimientos]\n    A --&gt; D[Rendimiento]\n    A --&gt; E[Costos]\n\n    B --&gt; F[Por veh\u00edculo]\n    B --&gt; G[Por per\u00edodo]\n    B --&gt; H[Por ruta]\n\n    D --&gt; I[Km/litro]\n    D --&gt; J[Eficiencia]\n\n    E --&gt; K[Gastos totales]\n    E --&gt; L[Proyecciones]</code></pre> <p>Tablas principales: - <code>ConsumosCombustible</code> - <code>AbastecimientosCombustible</code> - <code>RendimientoVehiculos</code></p> <p>Queries t\u00edpicas: <pre><code>-- Consumo mensual por veh\u00edculo\nSELECT \n    Patente,\n    SUM(LitrosConsumidos) as TotalLitros,\n    AVG(RendimientoKmLitro) as RendimientoPromedio\nFROM ConsumosCombustible\nWHERE RutTransportista = @rut\nAND MONTH(Fecha) = @mes\nGROUP BY Patente\n\n-- Gasto total en combustible\nSELECT \n    SUM(LitrosAbastecidos * PrecioPorLitro) as GastoTotal\nFROM AbastecimientosCombustible\nWHERE RutTransportista = @rut\nAND Fecha BETWEEN @fechaInicio AND @fechaFin\n</code></pre></p>"},{"location":"backend/whatsapp/sistema-agentes/#3-operation-agent","title":"3. Operation Agent","text":"<p>Especialidad: Operaciones, viajes, rutas, transportes</p> <pre><code>graph LR\n    A[Operation Agent] --&gt; B[Viajes]\n    A --&gt; C[Rutas]\n    A --&gt; D[Cargas]\n    A --&gt; E[Tiempos]\n\n    B --&gt; F[Programados]\n    B --&gt; G[En curso]\n    B --&gt; H[Completados]\n\n    C --&gt; I[Origen-Destino]\n    C --&gt; J[Distancias]\n\n    E --&gt; K[Duraci\u00f3n]\n    E --&gt; L[Retrasos]</code></pre> <p>Tablas principales: - <code>Operaciones</code> - <code>Viajes</code> - <code>Rutas</code> - <code>CargasTransporte</code></p> <p>Queries t\u00edpicas: <pre><code>-- Viajes del d\u00eda\nSELECT \n    o.IdOperacion,\n    v.Patente,\n    r.Origen,\n    r.Destino,\n    o.Estado\nFROM Operaciones o\nINNER JOIN Viajes v ON o.IdViaje = v.IdViaje\nINNER JOIN Rutas r ON v.IdRuta = r.IdRuta\nWHERE o.FechaOperacion = @fecha\nAND v.RutTransportista = @rut\n\n-- Estad\u00edsticas de viajes\nSELECT \n    COUNT(*) as TotalViajes,\n    SUM(CASE WHEN Estado = 'Completado' THEN 1 ELSE 0 END) as Completados,\n    AVG(DATEDIFF(hour, FechaInicio, FechaFin)) as DuracionPromedio\nFROM Operaciones\nWHERE RutTransportista = @rut\nAND FechaOperacion &gt;= @fechaInicio\n</code></pre></p>"},{"location":"backend/whatsapp/sistema-agentes/#4-vehicle-agent","title":"4. Vehicle Agent","text":"<p>Especialidad: Veh\u00edculos, flotas, patentes, mantenciones</p> <pre><code>graph LR\n    A[Vehicle Agent] --&gt; B[Informaci\u00f3n veh\u00edculos]\n    A --&gt; C[Estado flota]\n    A --&gt; D[Mantenciones]\n    A --&gt; E[Documentaci\u00f3n]\n\n    B --&gt; F[Patentes]\n    B --&gt; G[Caracter\u00edsticas]\n    B --&gt; H[Asignaciones]\n\n    C --&gt; I[Disponibles]\n    C --&gt; J[En operaci\u00f3n]\n    C --&gt; K[En mantenci\u00f3n]\n\n    D --&gt; L[Historial]\n    D --&gt; M[Pr\u00f3ximas]</code></pre> <p>Tablas principales: - <code>Vehiculos</code> - <code>FlotaTransportista</code> - <code>MantencionesVehiculos</code> - <code>DocumentacionVehiculos</code></p> <p>Queries t\u00edpicas: <pre><code>-- Flota del transportista\nSELECT \n    v.Patente,\n    v.Marca,\n    v.Modelo,\n    v.A\u00f1o,\n    v.Estado,\n    v.TipoVehiculo\nFROM Vehiculos v\nINNER JOIN FlotaTransportista f ON v.IdVehiculo = f.IdVehiculo\nWHERE f.CodigoTransportista = @codigoTransportista\n\n-- Mantenciones pendientes\nSELECT \n    v.Patente,\n    m.TipoMantencion,\n    m.FechaProgramada,\n    m.Estado\nFROM MantencionesVehiculos m\nINNER JOIN Vehiculos v ON m.IdVehiculo = v.IdVehiculo\nWHERE v.RutPropietario = @rut\nAND m.Estado = 'Pendiente'\nORDER BY m.FechaProgramada\n</code></pre></p>"},{"location":"backend/whatsapp/sistema-agentes/#5-transporter-agent","title":"5. Transporter Agent","text":"<p>Especialidad: Transportistas, empresas, proveedores</p> <pre><code>graph LR\n    A[Transporter Agent] --&gt; B[Informaci\u00f3n empresa]\n    A --&gt; C[Contratos]\n    A --&gt; D[Desempe\u00f1o]\n    A --&gt; E[Contactos]\n\n    B --&gt; F[Datos legales]\n    B --&gt; G[Certificaciones]\n\n    C --&gt; H[Activos]\n    C --&gt; I[Hist\u00f3ricos]\n\n    D --&gt; J[M\u00e9tricas]\n    D --&gt; K[Evaluaciones]</code></pre> <p>Tablas principales: - <code>Transportistas</code> - <code>ContratosTransportistas</code> - <code>DesempenoTransportistas</code></p> <p>Queries t\u00edpicas: <pre><code>-- Informaci\u00f3n del transportista\nSELECT \n    t.RazonSocial,\n    t.RUT,\n    t.Direccion,\n    t.Telefono,\n    t.Email,\n    t.Estado\nFROM Transportistas t\nWHERE t.CodigoTransportista = @codigo\n\n-- Desempe\u00f1o mensual\nSELECT \n    COUNT(o.IdOperacion) as TotalOperaciones,\n    SUM(CASE WHEN o.Estado = 'Completado' THEN 1 ELSE 0 END) as Completadas,\n    AVG(o.CalificacionServicio) as CalificacionPromedio\nFROM Operaciones o\nWHERE o.CodigoTransportista = @codigo\nAND MONTH(o.FechaOperacion) = @mes\n</code></pre></p>"},{"location":"backend/whatsapp/sistema-agentes/#context-y-prompts-de-agentes","title":"Context y Prompts de Agentes","text":""},{"location":"backend/whatsapp/sistema-agentes/#user-agent-context","title":"User Agent Context","text":"<pre><code>const userContext = `\nINFORMACI\u00d3N DEL USUARIO AUTENTICADO:\n- RUT: ${userInfo.Rut}\n- Nombre: ${userInfo.Nombre}\n- C\u00f3digo Transportista: ${userInfo.CodigoTransportista}\n\nRESTRICCIONES DE SEGURIDAD:\n- SOLO puede ver informaci\u00f3n relacionada con su RUT: ${userInfo.Rut}\n- SOLO puede ver informaci\u00f3n de su transportista: ${userInfo.CodigoTransportista}\n- NO mostrar informaci\u00f3n de otros usuarios o transportistas\n- Todas las consultas SQL deben incluir filtros de seguridad apropiados\n`;\n</code></pre>"},{"location":"backend/whatsapp/sistema-agentes/#admin-agent-context","title":"Admin Agent Context","text":"<pre><code>const adminContext = `\nINFORMACI\u00d3N DEL ADMINISTRADOR:\n- RUT: ${adminInfo.Rut}\n- Nombre: ${adminInfo.Nombre}\n- Rol: ADMINISTRADOR (acceso completo)\n\nPERMISOS ADMINISTRATIVOS:\n- Puede ver informaci\u00f3n de TODOS los usuarios\n- Puede consultar TODOS los transportistas\n- Puede acceder a TODAS las operaciones\n- No hay restricciones por CodigoTransportista o RUT\n`;\n</code></pre>"},{"location":"backend/whatsapp/sistema-agentes/#proximos-pasos","title":"Pr\u00f3ximos Pasos","text":"<ul> <li>Seguridad y Validaci\u00f3n</li> <li>MCP y Base de Datos</li> <li>Configuraci\u00f3n y Despliegue</li> </ul>"},{"location":"frontend/control-acceso/","title":"\ud83d\udcf1 Control de Acceso - React Native","text":"<p>Sistema de control remoto de portones inteligentes mediante geolocalizaci\u00f3n y dispositivos IoT Shelly.</p>"},{"location":"frontend/control-acceso/#que-es-control-de-acceso","title":"\ud83c\udfaf \u00bfQu\u00e9 es Control de Acceso?","text":"<p>Aplicaci\u00f3n m\u00f3vil que permite a usuarios autorizados abrir y cerrar portones mediante su smartphone cuando se encuentran dentro del rango de alcance definido (300 metros). Utiliza GPS para validar la ubicaci\u00f3n y se comunica con dispositivos Shelly mediante MQTT para controlar los portones f\u00edsicos.</p>"},{"location":"frontend/control-acceso/#caracteristicas-destacadas","title":"Caracter\u00edsticas Destacadas","text":"<p>\u2705 Control basado en ubicaci\u00f3n - Geofencing con radio de 300 metros \u2705 Mapa interactivo - Visualizaci\u00f3n en tiempo real con Mapbox \u2705 Sistema de invitados - Acceso temporal con c\u00f3digos de 4 d\u00edgitos \u2705 M\u00faltiples portones - Gesti\u00f3n de varios puntos de acceso \u2705 IoT Integration - Dispositivos Shelly con protocolo MQTT \u2705 Cross-platform - iOS y Android con React Native</p>"},{"location":"frontend/control-acceso/#documentacion","title":"\ud83d\udcda Documentaci\u00f3n","text":""},{"location":"frontend/control-acceso/#arquitectura-general","title":"Arquitectura General","text":"<ul> <li>Stack tecnol\u00f3gico completo</li> <li>Estructura del proyecto</li> <li>Componentes principales</li> <li>Gesti\u00f3n de estado con Redux</li> <li>Sistema de mapas y geolocalizaci\u00f3n</li> </ul>"},{"location":"frontend/control-acceso/#pantallas-y-flujos","title":"Pantallas y Flujos","text":"<ul> <li>Splash Screen</li> <li>Login (normal e invitado)</li> <li>Control Screen (mapa y portones)</li> <li>Invitar Screen</li> <li>Navegaci\u00f3n entre pantallas</li> </ul>"},{"location":"frontend/control-acceso/#integraciones-iot-y-backend","title":"Integraciones IoT y Backend","text":"<ul> <li>API REST endpoints</li> <li>Autenticaci\u00f3n JWT</li> <li>Dispositivos Shelly</li> <li>Protocolo MQTT</li> <li>Base de datos SQL Server</li> </ul>"},{"location":"frontend/control-acceso/#quick-start","title":"\ud83d\ude80 Quick Start","text":""},{"location":"frontend/control-acceso/#instalacion","title":"Instalaci\u00f3n","text":"<pre><code># Clonar repositorio\ncd control-acceso\n\n# Instalar dependencias\nnpm install\n\n# Configurar Mapbox token\nexport MAPBOX_DOWNLOADS_TOKEN=your_token\n</code></pre>"},{"location":"frontend/control-acceso/#desarrollo","title":"Desarrollo","text":"<pre><code># Iniciar metro bundler\nnpm run dev\n\n# Android\nnpm run android\n\n# iOS\nnpm run ios\n</code></pre>"},{"location":"frontend/control-acceso/#build-produccion","title":"Build Producci\u00f3n","text":"<pre><code># Build Android\neas build -p android --profile production\n\n# Build iOS\neas build -p ios --profile production\n</code></pre>"},{"location":"frontend/control-acceso/#casos-de-uso","title":"\ud83d\udcca Casos de Uso","text":""},{"location":"frontend/control-acceso/#1-usuario-normal-control-de-porton","title":"1. Usuario Normal - Control de Port\u00f3n","text":"<pre><code>graph LR\n    A[Usuario llega&lt;br/&gt;al port\u00f3n] --&gt; B[Abre app]\n    B --&gt; C[App valida&lt;br/&gt;ubicaci\u00f3n]\n    C --&gt; D{\u00bfDentro de&lt;br/&gt;300m?}\n    D --&gt;|S\u00ed| E[Habilita bot\u00f3n]\n    D --&gt;|No| F[Bot\u00f3n deshabilitado]\n    E --&gt; G[Usuario presiona&lt;br/&gt;Abrir]\n    G --&gt; H[Env\u00eda comando&lt;br/&gt;MQTT]\n    H --&gt; I[Port\u00f3n se abre]</code></pre>"},{"location":"frontend/control-acceso/#2-admin-crear-invitado","title":"2. Admin - Crear Invitado","text":"<pre><code>graph LR\n    A[Admin abre&lt;br/&gt;Invitar] --&gt; B[Completa&lt;br/&gt;formulario]\n    B --&gt; C[Selecciona&lt;br/&gt;portones]\n    C --&gt; D[Define fechas&lt;br/&gt;inicio/fin]\n    D --&gt; E[Env\u00eda al&lt;br/&gt;backend]\n    E --&gt; F[Backend genera&lt;br/&gt;c\u00f3digo 4 d\u00edgitos]\n    F --&gt; G[Admin recibe&lt;br/&gt;c\u00f3digo]\n    G --&gt; H[Env\u00eda c\u00f3digo&lt;br/&gt;al invitado]</code></pre>"},{"location":"frontend/control-acceso/#3-invitado-acceso-temporal","title":"3. Invitado - Acceso Temporal","text":"<pre><code>graph LR\n    A[Invitado recibe&lt;br/&gt;c\u00f3digo] --&gt; B[Descarga app]\n    B --&gt; C[Selecciona modo&lt;br/&gt;invitado]\n    C --&gt; D[Ingresa c\u00f3digo&lt;br/&gt;4 d\u00edgitos]\n    D --&gt; E{\u00bfC\u00f3digo v\u00e1lido&lt;br/&gt;y activo?}\n    E --&gt;|S\u00ed| F[Acceso concedido]\n    E --&gt;|No| G[Error: c\u00f3digo&lt;br/&gt;inv\u00e1lido/expirado]\n    F --&gt; H[Solo ve portones&lt;br/&gt;permitidos]</code></pre>"},{"location":"frontend/control-acceso/#tecnologias-clave","title":"\ud83c\udfd7\ufe0f Tecnolog\u00edas Clave","text":"Tecnolog\u00eda Versi\u00f3n Prop\u00f3sito React Native 0.81.5 Framework m\u00f3vil Expo ~54.0 Desarrollo y build Mapbox Maps ^10.2.7 Mapas interactivos Redux Toolkit ^2.11.0 Estado global NativeWind ^4.2.1 Estilos Tailwind Firebase ^12.6.0 Push notifications Expo Location ~19.0.8 GPS/Geolocalizaci\u00f3n"},{"location":"frontend/control-acceso/#seguridad","title":"\ud83d\udd10 Seguridad","text":"<ul> <li>JWT Authentication - Tokens con expiraci\u00f3n</li> <li>Geofencing - Validaci\u00f3n de distancia</li> <li>HTTPS Only - Comunicaci\u00f3n encriptada</li> <li>C\u00f3digos temporales - Acceso limitado por fecha</li> <li>Permisos granulares - Control por port\u00f3n</li> <li>Logs de acceso - Auditor\u00eda completa</li> </ul>"},{"location":"frontend/control-acceso/#plataformas-soportadas","title":"\ud83d\udcf1 Plataformas Soportadas","text":"<ul> <li>\u2705 iOS 13.0+</li> <li>\u2705 Android 8.0+ (API 26+)</li> <li>\u2705 Expo Go (para desarrollo)</li> </ul>"},{"location":"frontend/control-acceso/#equipo","title":"\ud83e\udd1d Equipo","text":"<p>Desarrollo El Alto https://www.gestionelalto.cl/</p>"},{"location":"frontend/control-acceso/#licencia","title":"\ud83d\udcc4 Licencia","text":"<p>Proyecto privado \u00a9 El Alto 2025</p>"},{"location":"frontend/control-acceso/arquitectura/","title":"\ud83d\udcf1 Control de Acceso - Aplicaci\u00f3n M\u00f3vil","text":""},{"location":"frontend/control-acceso/arquitectura/#descripcion-general","title":"\ud83d\udccb Descripci\u00f3n General","text":"<p>Aplicaci\u00f3n m\u00f3vil React Native desarrollada con Expo que permite el control remoto de portones inteligentes mediante geolocalizaci\u00f3n. Los usuarios pueden abrir y cerrar portones autorizados cuando se encuentran dentro del radio de alcance definido.</p> <pre><code>graph TB\n    subgraph \"Usuario\"\n        U[Usuario M\u00f3vil]\n        I[Invitado]\n    end\n\n    subgraph \"Aplicaci\u00f3n M\u00f3vil\"\n        APP[App React Native]\n        MAP[Mapbox Maps]\n        GPS[GPS/Location]\n        NOTIF[Notificaciones]\n    end\n\n    subgraph \"Backend\"\n        API[API REST]\n        AUTH[Autenticaci\u00f3n JWT]\n        MQTT[MQTT Broker]\n    end\n\n    subgraph \"IoT\"\n        SHELLY[Dispositivos Shelly]\n        PORTON[Portones]\n    end\n\n    U --&gt;|Login| APP\n    I --&gt;|C\u00f3digo 4 d\u00edgitos| APP\n    APP --&gt;|Request| API\n    API --&gt;|JWT Token| AUTH\n    APP --&gt; MAP\n    APP --&gt; GPS\n    APP --&gt; NOTIF\n    APP --&gt;|Comando| MQTT\n    MQTT --&gt;|Control| SHELLY\n    SHELLY --&gt;|Activa| PORTON\n\n    style APP fill:#61DAFB\n    style API fill:#4A90E2\n    style MQTT fill:#660066\n    style SHELLY fill:#00A8E1</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#caracteristicas-principales","title":"\ud83c\udfaf Caracter\u00edsticas Principales","text":""},{"location":"frontend/control-acceso/arquitectura/#control-de-acceso-basado-en-ubicacion","title":"\u2705 Control de Acceso Basado en Ubicaci\u00f3n","text":"<ul> <li>Geofencing - Radio de 300 metros alrededor de cada port\u00f3n</li> <li>Mapa interactivo - Visualizaci\u00f3n en tiempo real con Mapbox</li> <li>Validaci\u00f3n de distancia - Control habilitado solo dentro del rango</li> </ul>"},{"location":"frontend/control-acceso/arquitectura/#gestion-de-usuarios","title":"\u2705 Gesti\u00f3n de Usuarios","text":"<ul> <li>Login tradicional - RUT/Email + contrase\u00f1a</li> <li>Modo invitado - C\u00f3digo de 4 d\u00edgitos temporal</li> <li>Roles diferenciados - Admin y usuarios regulares</li> <li>Permisos por port\u00f3n - Control granular de accesos</li> </ul>"},{"location":"frontend/control-acceso/arquitectura/#sistema-de-invitaciones","title":"\u2705 Sistema de Invitaciones","text":"<ul> <li>Crear invitados - Formulario completo de registro</li> <li>Acceso temporal - Fechas de inicio y fin</li> <li>Selecci\u00f3n de portones - M\u00faltiples portones por invitado</li> <li>C\u00f3digo \u00fanico - Generaci\u00f3n autom\u00e1tica de c\u00f3digo de acceso</li> </ul>"},{"location":"frontend/control-acceso/arquitectura/#integracion-iot","title":"\u2705 Integraci\u00f3n IoT","text":"<ul> <li>Dispositivos Shelly - Control de portones inteligentes</li> <li>Protocolo MQTT - Comunicaci\u00f3n en tiempo real</li> <li>Estados de port\u00f3n - Abierto/Cerrado/Error</li> <li>Feedback visual - Animaciones de estado</li> </ul>"},{"location":"frontend/control-acceso/arquitectura/#arquitectura-tecnica","title":"\ud83c\udfd7\ufe0f Arquitectura T\u00e9cnica","text":""},{"location":"frontend/control-acceso/arquitectura/#stack-tecnologico","title":"Stack Tecnol\u00f3gico","text":"<pre><code>graph LR\n    subgraph \"Frontend\"\n        RN[React Native 0.81.5]\n        EXPO[Expo 54]\n        ER[Expo Router 6]\n    end\n\n    subgraph \"UI/UX\"\n        NW[NativeWind 4.2]\n        TW[Tailwind CSS]\n        RNR[RN Reusables]\n        LR[Lucide React Native]\n    end\n\n    subgraph \"Mapa\"\n        MB[Mapbox Maps 10.2]\n        LOC[Expo Location 19]\n    end\n\n    subgraph \"Estado\"\n        RTK[Redux Toolkit 2.11]\n        AS[AsyncStorage 2.2]\n    end\n\n    subgraph \"Servicios\"\n        FB[Firebase 12.6]\n        PN[Push Notifications]\n    end\n\n    RN --&gt; EXPO\n    EXPO --&gt; ER\n    NW --&gt; TW\n    RNR --&gt; TW\n    MB --&gt; LOC\n    RTK --&gt; AS\n    FB --&gt; PN\n\n    style RN fill:#61DAFB\n    style EXPO fill:#000020\n    style MB fill:#4264FB\n    style RTK fill:#764ABC</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#dependencias-principales","title":"Dependencias Principales","text":"Librer\u00eda Versi\u00f3n Uso React Native 0.81.5 Framework base Expo ~54.0.30 Desarrollo y build Expo Router ~6.0.21 Navegaci\u00f3n basada en archivos @rnmapbox/maps ^10.2.7 Mapas interactivos Redux Toolkit ^2.11.0 Gesti\u00f3n de estado NativeWind ^4.2.1 Estilos con Tailwind Firebase ^12.6.0 Push notifications expo-location ~19.0.8 Geolocalizaci\u00f3n expo-notifications ~0.32.15 Notificaciones push"},{"location":"frontend/control-acceso/arquitectura/#estructura-del-proyecto","title":"\ud83d\udcc2 Estructura del Proyecto","text":"<pre><code>control-acceso/\n\u251c\u2500\u2500 app/                          # Screens (Expo Router)\n\u2502   \u251c\u2500\u2500 _layout.tsx              # Layout principal\n\u2502   \u251c\u2500\u2500 _reduxLayout.tsx         # Redux Provider\n\u2502   \u251c\u2500\u2500 index.tsx                # Splash Screen\n\u2502   \u251c\u2500\u2500 LoginScreen.tsx          # Pantalla de login\n\u2502   \u251c\u2500\u2500 ControlScreen.tsx        # Pantalla principal (mapa)\n\u2502   \u251c\u2500\u2500 InvitarScreen.tsx        # Crear invitados\n\u2502   \u251c\u2500\u2500 store.ts                 # Redux Store\n\u2502   \u251c\u2500\u2500 services/                # Servicios externos\n\u2502   \u2502   \u251c\u2500\u2500 authService.ts       # Autenticaci\u00f3n\n\u2502   \u2502   \u2514\u2500\u2500 api/\n\u2502   \u2502       \u2514\u2500\u2500 client.ts        # API Client\n\u2502   \u2514\u2500\u2500 slices/                  # Redux Slices\n\u2502       \u2514\u2500\u2500 globalSlice.ts       # Estado global\n\u251c\u2500\u2500 components/                   # Componentes reutilizables\n\u2502   \u2514\u2500\u2500 ui/                      # UI Components\n\u2502       \u251c\u2500\u2500 button.tsx\n\u2502       \u251c\u2500\u2500 card.tsx\n\u2502       \u251c\u2500\u2500 input.tsx\n\u2502       \u251c\u2500\u2500 select.tsx\n\u2502       \u2514\u2500\u2500 ...\n\u251c\u2500\u2500 context/                     # React Context\n\u2502   \u2514\u2500\u2500 NotificationContext.tsx  # Context de notificaciones\n\u251c\u2500\u2500 hooks/                       # Custom Hooks\n\u2502   \u2514\u2500\u2500 useAuth.ts              # Hook de autenticaci\u00f3n\n\u251c\u2500\u2500 utils/                       # Utilidades\n\u2502   \u251c\u2500\u2500 registerForPushNotificationAsync.ts\n\u2502   \u2514\u2500\u2500 widgetSync.ts           # Sincronizaci\u00f3n con widgets\n\u251c\u2500\u2500 assets/                      # Recursos est\u00e1ticos\n\u2502   \u251c\u2500\u2500 fonts/\n\u2502   \u2514\u2500\u2500 images/\n\u251c\u2500\u2500 android/                     # Configuraci\u00f3n Android\n\u251c\u2500\u2500 ios/                         # Configuraci\u00f3n iOS\n\u251c\u2500\u2500 app.json                     # Configuraci\u00f3n Expo\n\u251c\u2500\u2500 eas.json                     # EAS Build config\n\u2514\u2500\u2500 package.json\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#autenticacion-y-seguridad","title":"\ud83d\udd10 Autenticaci\u00f3n y Seguridad","text":""},{"location":"frontend/control-acceso/arquitectura/#flujo-de-login","title":"Flujo de Login","text":"<pre><code>sequenceDiagram\n    participant U as Usuario\n    participant APP as App\n    participant API as Backend API\n    participant DB as Database\n    participant REDUX as Redux Store\n\n    U-&gt;&gt;APP: Ingresa credenciales\n    APP-&gt;&gt;API: POST /login\n    API-&gt;&gt;DB: Validar usuario\n    DB--&gt;&gt;API: Datos usuario\n    API-&gt;&gt;API: Generar JWT Token\n    API--&gt;&gt;APP: Token + UserData\n    APP-&gt;&gt;REDUX: setUserData()\n    APP-&gt;&gt;APP: AsyncStorage.setItem()\n    APP-&gt;&gt;API: GET /portones\n    API--&gt;&gt;APP: Lista portones\n    APP-&gt;&gt;APP: Guardar portones\n    APP-&gt;&gt;U: Navegar a ControlScreen</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#flujo-de-login-invitado","title":"Flujo de Login Invitado","text":"<pre><code>sequenceDiagram\n    participant I as Invitado\n    participant APP as App\n    participant API as Backend API\n    participant DB as Database\n\n    I-&gt;&gt;APP: Ingresa c\u00f3digo 4 d\u00edgitos\n    APP-&gt;&gt;API: POST /invitados/login\n    API-&gt;&gt;DB: Buscar invitado activo\n\n    alt Invitado v\u00e1lido\n        DB--&gt;&gt;API: Datos invitado + portones\n        API--&gt;&gt;APP: Token + permisos limitados\n        APP-&gt;&gt;APP: Filtrar portones permitidos\n        APP-&gt;&gt;I: Acceso concedido\n    else C\u00f3digo inv\u00e1lido\n        API--&gt;&gt;APP: Error 401\n        APP-&gt;&gt;I: C\u00f3digo incorrecto\n    else Fuera de rango de fechas\n        API--&gt;&gt;APP: Error 403\n        APP-&gt;&gt;I: Acceso expirado\n    end</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#gestion-de-tokens","title":"Gesti\u00f3n de Tokens","text":"<pre><code>// Almacenamiento de token\nawait AsyncStorage.setItem('userToken', token);\nawait AsyncStorage.setItem('userData', JSON.stringify(userData));\n\n// Headers de autenticaci\u00f3n\nconst options = {\n  method: 'POST',\n  headers: {\n    'Content-Type': 'application/json',\n    Authorization: `Bearer ${token}`,\n  },\n  body: JSON.stringify(data),\n};\n\n// Validaci\u00f3n de sesi\u00f3n\nconst token = await AsyncStorage.getItem('userToken');\nif (!token) {\n  router.replace('/LoginScreen');\n}\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#sistema-de-mapas-y-geolocalizacion","title":"\ud83d\uddfa\ufe0f Sistema de Mapas y Geolocalizaci\u00f3n","text":""},{"location":"frontend/control-acceso/arquitectura/#configuracion-de-mapbox","title":"Configuraci\u00f3n de Mapbox","text":"<pre><code>const MAPBOX_TOKEN = 'pk.eyJ1IjoiYXBpbm9jaGV0IiwiYSI6ImNsbWIyZHY2ZzB3N3AzY3JxNmVpNHBzYm8ifQ.u9-Qo5NdgUEK0ylbzUAqpg';\nconst MAPBOX_STYLE = 'mapbox://styles/apinochet/cmif0sp8b000y01s05hai5dp3';\nconst DEFAULT_CENTER = [-70.6483, -33.4569]; // Santiago, Chile\nconst DEFAULT_ZOOM = 15;\n\nMapboxGL.setAccessToken(MAPBOX_TOKEN);\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#calculo-de-distancia-haversine","title":"C\u00e1lculo de Distancia (Haversine)","text":"<pre><code>const getDistanceMeters = (\n  lat1: number,\n  lon1: number,\n  lat2: number,\n  lon2: number\n): number =&gt; {\n  const R = 6371000; // Radio de la tierra en metros\n  const dLat = ((lat2 - lat1) * Math.PI) / 180;\n  const dLon = ((lon2 - lon1) * Math.PI) / 180;\n  const a =\n    Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n    Math.cos((lat1 * Math.PI) / 180) *\n      Math.cos((lat2 * Math.PI) / 180) *\n      Math.sin(dLon / 2) *\n      Math.sin(dLon / 2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n  return R * c;\n};\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#geofencing","title":"Geofencing","text":"<pre><code>graph TD\n    Start([Ubicaci\u00f3n actualizada]) --&gt; GetLocation[Obtener GPS]\n    GetLocation --&gt; LoopPortones[Iterar portones]\n    LoopPortones --&gt; CalcDist[Calcular distancia]\n    CalcDist --&gt; CheckDist{\u00bfDistancia &lt; 300m?}\n\n    CheckDist --&gt;|S\u00ed| EnableControl[\u2705 Habilitar control]\n    CheckDist --&gt;|No| DisableControl[\u274c Deshabilitar control]\n\n    EnableControl --&gt; ShowCircle[Mostrar c\u00edrculo verde]\n    DisableControl --&gt; ShowCircle2[Mostrar c\u00edrculo rojo]\n\n    ShowCircle --&gt; UpdateUI[Actualizar UI]\n    ShowCircle2 --&gt; UpdateUI\n    UpdateUI --&gt; End([Fin])\n\n    style EnableControl fill:#90EE90\n    style DisableControl fill:#FFB6B6</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#renderizado-de-circulos","title":"Renderizado de C\u00edrculos","text":"<pre><code>const getCirclePolygon = (\n  lon: number,\n  lat: number,\n  radiusMeters: number,\n  points = 64\n) =&gt; {\n  const coords = [];\n  const earthRadius = 6378137;\n\n  for (let i = 0; i &lt; points; i++) {\n    const angle = (i * 360) / points;\n    const radians = (angle * Math.PI) / 180;\n    const dx = radiusMeters * Math.cos(radians);\n    const dy = radiusMeters * Math.sin(radians);\n\n    coords.push([\n      lon + (dx / (earthRadius * Math.cos((Math.PI * lat) / 180))) * (180 / Math.PI),\n      lat + (dy / earthRadius) * (180 / Math.PI),\n    ]);\n  }\n  coords.push(coords[0]); // cerrar el pol\u00edgono\n\n  return { type: 'Polygon', coordinates: [coords] };\n};\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#control-de-portones","title":"\ud83d\udeaa Control de Portones","text":""},{"location":"frontend/control-acceso/arquitectura/#flujo-de-aperturacierre","title":"Flujo de Apertura/Cierre","text":"<pre><code>sequenceDiagram\n    participant U as Usuario\n    participant APP as App\n    participant API as Backend API\n    participant MQTT as MQTT Broker\n    participant SHELLY as Dispositivo Shelly\n    participant PORTON as Port\u00f3n\n\n    U-&gt;&gt;APP: Presiona bot\u00f3n\n    APP-&gt;&gt;APP: Validar distancia\n\n    alt Dentro del rango\n        APP-&gt;&gt;APP: Mostrar animaci\u00f3n\n        APP-&gt;&gt;API: POST /mqtt_test\n        Note over API: Lugar, Comando, Topico\n        API-&gt;&gt;MQTT: Publish comando\n        MQTT-&gt;&gt;SHELLY: Recibe comando\n        SHELLY-&gt;&gt;PORTON: Activar rel\u00e9\n        PORTON-&gt;&gt;PORTON: Abrir/Cerrar\n        SHELLY--&gt;&gt;MQTT: Estado actualizado\n        MQTT--&gt;&gt;API: Confirmaci\u00f3n\n        API--&gt;&gt;APP: Success\n        APP-&gt;&gt;U: Notificaci\u00f3n success\n    else Fuera de rango\n        APP-&gt;&gt;U: Error: Demasiado lejos\n    end</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#comando-mqtt","title":"Comando MQTT","text":"<pre><code>const abrirPorton = async (porton: Porton) =&gt; {\n  const mqttData = {\n    Lugar: porton.IdShelly,\n    Comando: 'toggle',  // o 'on' / 'off'\n    Topico: 'shellies/command'\n  };\n\n  try {\n    const response = await apiClient.mqttTest(mqttData, token);\n    console.log('Port\u00f3n activado:', response);\n    Alert.alert('\u2705 \u00c9xito', 'Comando enviado al port\u00f3n');\n  } catch (error) {\n    console.error('Error:', error);\n    Alert.alert('\u274c Error', 'No se pudo controlar el port\u00f3n');\n  }\n};\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#estados-del-porton","title":"Estados del Port\u00f3n","text":"<pre><code>stateDiagram-v2\n    [*] --&gt; Cerrado\n\n    Cerrado --&gt; Abriendo: Comando abrir\n    Abriendo --&gt; Abierto: Completo\n    Abriendo --&gt; Error: Falla\n\n    Abierto --&gt; Cerrando: Comando cerrar\n    Cerrando --&gt; Cerrado: Completo\n    Cerrando --&gt; Error: Falla\n\n    Error --&gt; Cerrado: Reset\n    Error --&gt; [*]: Timeout\n\n    note right of Abriendo\n        Animaci\u00f3n en progreso\n        Usuario no puede enviar\n        m\u00e1s comandos\n    end note\n\n    note right of Error\n        Mostrar mensaje de error\n        Reintentar disponible\n    end note</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#sistema-de-invitaciones_1","title":"\ud83d\udc65 Sistema de Invitaciones","text":""},{"location":"frontend/control-acceso/arquitectura/#crear-invitado","title":"Crear Invitado","text":"<pre><code>flowchart TD\n    Start([Admin selecciona invitar]) --&gt; Form[Formulario de invitaci\u00f3n]\n    Form --&gt; FillData[Llenar datos:&lt;br/&gt;RUT, Nombre, Apellido&lt;br/&gt;Tel\u00e9fono, Email, Empresa]\n    FillData --&gt; SelectDates[Seleccionar fechas&lt;br/&gt;inicio y fin]\n    SelectDates --&gt; SelectPortones[Seleccionar portones&lt;br/&gt;permitidos]\n    SelectPortones --&gt; AddMotivo[Agregar motivo]\n    AddMotivo --&gt; Validate{\u00bfDatos v\u00e1lidos?}\n\n    Validate --&gt;|No| ShowError[Mostrar errores]\n    ShowError --&gt; Form\n\n    Validate --&gt;|S\u00ed| SendAPI[POST /invitados/crear]\n    SendAPI --&gt; CheckResponse{\u00bf\u00c9xito?}\n\n    CheckResponse --&gt;|S\u00ed| GenerateCode[Backend genera&lt;br/&gt;c\u00f3digo 4 d\u00edgitos]\n    GenerateCode --&gt; ShowCode[Mostrar c\u00f3digo&lt;br/&gt;al admin]\n    ShowCode --&gt; SendCode[Admin env\u00eda c\u00f3digo&lt;br/&gt;al invitado]\n    SendCode --&gt; End([Fin])\n\n    CheckResponse --&gt;|No| ShowAPIError[Mostrar error API]\n    ShowAPIError --&gt; Form\n\n    style GenerateCode fill:#90EE90\n    style ShowCode fill:#FFD700</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#estructura-de-datos","title":"Estructura de Datos","text":"<pre><code>interface InvitadoData {\n  Rut: string;\n  Nombre: string;\n  Apellido: string;\n  Telefono: string;\n  Mail: string;\n  FechaInicial: string;      // YYYY-MM-DD\n  FechaFinal: string;         // YYYY-MM-DD\n  Empresa: string;\n  Motivo: string;\n  IdInvitante: number;        // ID del admin\n  PortonesIds: (string | number)[]; // IDs de portones permitidos\n}\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#calendario-de-fechas","title":"Calendario de Fechas","text":"<pre><code>// Configuraci\u00f3n del calendario\n&lt;Calendar\n  onDayPress={(day: DateData) =&gt; {\n    setFechaInicial(day.dateString);\n    setShowCalendarInicial(false);\n  }}\n  markedDates={{\n    [fechaInicial]: {\n      selected: true,\n      selectedColor: '#3b82f6'\n    }\n  }}\n  theme={{\n    todayTextColor: '#3b82f6',\n    selectedDayBackgroundColor: '#3b82f6',\n    selectedDayTextColor: '#ffffff'\n  }}\n  minDate={new Date().toISOString().split('T')[0]}\n/&gt;\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#gestion-de-estado-redux","title":"\ud83d\udcca Gesti\u00f3n de Estado (Redux)","text":""},{"location":"frontend/control-acceso/arquitectura/#global-slice","title":"Global Slice","text":"<pre><code>graph TB\n    subgraph \"Redux Store\"\n        GS[Global Slice]\n        US[User State]\n        PS[Portones State]\n        AS[Auth State]\n    end\n\n    subgraph \"Actions\"\n        SET[setUserData]\n        RESET[resetGlobal]\n        UPDATE[updateUser]\n    end\n\n    subgraph \"Persistence\"\n        ASYNC[AsyncStorage]\n    end\n\n    GS --&gt; US\n    GS --&gt; PS\n    GS --&gt; AS\n\n    SET --&gt; GS\n    RESET --&gt; GS\n    UPDATE --&gt; GS\n\n    GS -.sync.-&gt; ASYNC\n    ASYNC -.load.-&gt; GS\n\n    style GS fill:#764ABC\n    style ASYNC fill:#FFD700</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#state-structure","title":"State Structure","text":"<pre><code>interface GlobalState {\n  id: number | null;\n  nombre: string;\n  apellido: string;\n  mail: string;\n  admin: boolean;\n  token: string;\n  invitar: boolean;\n  isGuest: boolean;\n  empresa?: string;\n  fechaInicial?: string;\n  fechaFinal?: string;\n  portones?: Porton[];\n  portonesIds?: (string | number)[];\n}\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#acciones","title":"Acciones","text":"<pre><code>// Set user data\ndispatch(setUserData({\n  id: response.id,\n  nombre: response.nombre,\n  apellido: response.apellido,\n  mail: response.mail,\n  admin: response.admin,\n  token: response.token,\n  invitar: response.admin,\n  isGuest: false\n}));\n\n// Reset (logout)\ndispatch(resetGlobal());\nawait AsyncStorage.clear();\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#push-notifications","title":"\ud83d\udd14 Push Notifications","text":""},{"location":"frontend/control-acceso/arquitectura/#configuracion-firebase","title":"Configuraci\u00f3n Firebase","text":"<pre><code>{\n  \"expo\": {\n    \"android\": {\n      \"googleServicesFile\": \"./google-services.json\"\n    },\n    \"plugins\": [\n      [\n        \"expo-notifications\",\n        {\n          \"icon\": \"./assets/images/notification-icon.png\",\n          \"color\": \"#ffffff\"\n        }\n      ]\n    ]\n  }\n}\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#registro-de-token","title":"Registro de Token","text":"<pre><code>const registerForPushNotificationsAsync = async () =&gt; {\n  let token;\n\n  if (Platform.OS === 'android') {\n    await Notifications.setNotificationChannelAsync('default', {\n      name: 'default',\n      importance: Notifications.AndroidImportance.MAX,\n      vibrationPattern: [0, 250, 250, 250],\n      lightColor: '#FF231F7C',\n    });\n  }\n\n  const { status: existingStatus } = await Notifications.getPermissionsAsync();\n  let finalStatus = existingStatus;\n\n  if (existingStatus !== 'granted') {\n    const { status } = await Notifications.requestPermissionsAsync();\n    finalStatus = status;\n  }\n\n  if (finalStatus !== 'granted') {\n    alert('Failed to get push token for push notification!');\n    return;\n  }\n\n  token = (await Notifications.getExpoPushTokenAsync()).data;\n  console.log('Push token:', token);\n\n  return token;\n};\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#plataformas-y-build","title":"\ud83d\udcf1 Plataformas y Build","text":""},{"location":"frontend/control-acceso/arquitectura/#ios-configuration","title":"iOS Configuration","text":"<pre><code>{\n  \"ios\": {\n    \"supportsTablet\": true,\n    \"bundleIdentifier\": \"com.desarrolloelalto.controlacceso\",\n    \"infoPlist\": {\n      \"NSLocationWhenInUseUsageDescription\": \"Esta aplicaci\u00f3n utiliza la ubicaci\u00f3n para mostrar tu posici\u00f3n en el mapa y calcular la distancia a los portones.\",\n      \"NSLocationAlwaysAndWhenInUseUsageDescription\": \"Esta aplicaci\u00f3n utiliza la ubicaci\u00f3n para mostrar tu posici\u00f3n en el mapa y calcular la distancia a los portones.\"\n    }\n  }\n}\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#android-configuration","title":"Android Configuration","text":"<pre><code>{\n  \"android\": {\n    \"edgeToEdgeEnabled\": true,\n    \"package\": \"com.desarrolloelalto.controlacceso\",\n    \"googleServicesFile\": \"./google-services.json\",\n    \"permissions\": [\n      \"android.permission.ACCESS_COARSE_LOCATION\",\n      \"android.permission.ACCESS_FINE_LOCATION\",\n      \"android.permission.FOREGROUND_SERVICE\",\n      \"android.permission.FOREGROUND_SERVICE_LOCATION\"\n    ]\n  }\n}\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#eas-build","title":"EAS Build","text":"<pre><code>{\n  \"build\": {\n    \"development\": {\n      \"developmentClient\": true,\n      \"distribution\": \"internal\",\n      \"ios\": {\n        \"simulator\": true\n      }\n    },\n    \"preview\": {\n      \"distribution\": \"internal\",\n      \"android\": {\n        \"buildType\": \"apk\"\n      }\n    },\n    \"production\": {\n      \"autoIncrement\": true\n    }\n  }\n}\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#instalacion-y-desarrollo","title":"\ud83d\ude80 Instalaci\u00f3n y Desarrollo","text":""},{"location":"frontend/control-acceso/arquitectura/#requisitos-previos","title":"Requisitos Previos","text":"<ul> <li>Node.js 18+</li> <li>npm o yarn</li> <li>Expo CLI</li> <li>Android Studio (para Android)</li> <li>Xcode (para iOS, solo macOS)</li> </ul>"},{"location":"frontend/control-acceso/arquitectura/#instalacion","title":"Instalaci\u00f3n","text":"<pre><code># Clonar repositorio\ngit clone &lt;repo-url&gt;\ncd control-acceso\n\n# Instalar dependencias\nnpm install\n\n# Configurar variables de entorno\ncp .env.example .env\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#desarrollo","title":"Desarrollo","text":"<pre><code># Iniciar desarrollo\nnpm run dev\n\n# Android\nnpm run android\n\n# iOS\nnpm run ios\n\n# Web\nnpm run web\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#build-de-produccion","title":"Build de Producci\u00f3n","text":"<pre><code># Build Android APK\neas build -p android --profile preview\n\n# Build iOS\neas build -p ios --profile production\n\n# Submit a stores\neas submit -p android\neas submit -p ios\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#testing","title":"\ud83e\uddea Testing","text":""},{"location":"frontend/control-acceso/arquitectura/#pruebas-manuales","title":"Pruebas Manuales","text":"<ol> <li>Login</li> <li>\u2705 Login con RUT v\u00e1lido</li> <li>\u2705 Login con email v\u00e1lido</li> <li>\u2705 Login modo invitado</li> <li> <p>\u274c Credenciales inv\u00e1lidas</p> </li> <li> <p>Geolocalizaci\u00f3n</p> </li> <li>\u2705 Permiso de ubicaci\u00f3n</li> <li>\u2705 C\u00e1lculo de distancia</li> <li> <p>\u2705 Actualizaci\u00f3n en tiempo real</p> </li> <li> <p>Control de Portones</p> </li> <li>\u2705 Apertura dentro de rango</li> <li>\u274c Apertura fuera de rango</li> <li>\u2705 Animaci\u00f3n de estado</li> <li> <p>\u2705 Feedback visual</p> </li> <li> <p>Invitaciones</p> </li> <li>\u2705 Crear invitado</li> <li>\u2705 Selecci\u00f3n de portones</li> <li>\u2705 Validaci\u00f3n de fechas</li> <li>\u2705 Generaci\u00f3n de c\u00f3digo</li> </ol>"},{"location":"frontend/control-acceso/arquitectura/#troubleshooting","title":"\ud83d\udd27 Troubleshooting","text":""},{"location":"frontend/control-acceso/arquitectura/#error-de-mapbox","title":"Error de Mapbox","text":"<pre><code># Android: Configurar token\nexport MAPBOX_DOWNLOADS_TOKEN=&lt;tu_token&gt;\nnpm run android:build\n\n# iOS: Pod install\nnpm run ios:pod-install\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#error-de-permisos-de-ubicacion","title":"Error de Permisos de Ubicaci\u00f3n","text":"<pre><code># Android: Verificar AndroidManifest.xml\n&lt;uses-permission android:name=\"android.permission.ACCESS_FINE_LOCATION\" /&gt;\n\n# iOS: Verificar Info.plist\nNSLocationWhenInUseUsageDescription\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#error-de-build-android","title":"Error de Build Android","text":"<pre><code># Limpiar cache\ncd android\n./gradlew clean\ncd ..\nnpm run android:build\n</code></pre>"},{"location":"frontend/control-acceso/arquitectura/#licencia","title":"\ud83d\udcc4 Licencia","text":"<p>Este proyecto es privado y pertenece a El Alto.</p>"},{"location":"frontend/control-acceso/arquitectura/#contacto","title":"\ud83d\udc65 Contacto","text":"<p>Desarrollo El Alto - https://www.gestionelalto.cl/</p>"},{"location":"frontend/control-acceso/integraciones-iot/","title":"Integraciones IoT y Backend","text":""},{"location":"frontend/control-acceso/integraciones-iot/#arquitectura-de-integracion","title":"\ufffd Arquitectura de Integraci\u00f3n","text":"<pre><code>graph TB\n    subgraph \"Aplicaci\u00f3n M\u00f3vil\"\n        APP[React Native App]\n        API_CLIENT[API Client]\n        MQTT_SERVICE[MQTT Service]\n    end\n\n    subgraph \"Backend Azure\"\n        REST_API[API REST]\n        AUTH[Auth JWT]\n        DB[SQL Server]\n        MQTT_BROKER[MQTT Broker]\n    end\n\n    subgraph \"Dispositivos IoT\"\n        SHELLY1[Shelly Device 1]\n        SHELLY2[Shelly Device 2]\n        SHELLYN[Shelly Device N]\n    end\n\n    subgraph \"Portones F\u00edsicos\"\n        PORTON1[Port\u00f3n 1]\n        PORTON2[Port\u00f3n 2]\n        PORTONN[Port\u00f3n N]\n    end\n\n    APP --&gt; API_CLIENT\n    API_CLIENT --&gt; REST_API\n    REST_API --&gt; AUTH\n    REST_API --&gt; DB\n    REST_API --&gt; MQTT_BROKER\n\n    MQTT_BROKER &lt;--&gt; SHELLY1\n    MQTT_BROKER &lt;--&gt; SHELLY2\n    MQTT_BROKER &lt;--&gt; SHELLYN\n\n    SHELLY1 -.controla.-&gt; PORTON1\n    SHELLY2 -.controla.-&gt; PORTON2\n    SHELLYN -.controla.-&gt; PORTONN\n\n    style APP fill:#61DAFB\n    style REST_API fill:#4A90E2\n    style MQTT_BROKER fill:#660066\n    style SHELLY1 fill:#00A8E1\n    style SHELLY2 fill:#00A8E1\n    style SHELLYN fill:#00A8E1</code></pre> <p>Nota: Para documentaci\u00f3n completa del backend, ver Backend Control de Acceso</p>"},{"location":"frontend/control-acceso/integraciones-iot/#api-rest","title":"\ud83d\udce1 API REST","text":""},{"location":"frontend/control-acceso/integraciones-iot/#base-url","title":"Base URL","text":"<pre><code>const API_URLS = {\n  primary: 'https://elaltodev-g7dmcff9djcgdyay.eastus-01.azurewebsites.net/appaccesocontrol',\n  fallback: 'https://elaltodev.azurewebsites.net/appaccesocontrol',\n};\n</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#endpoints","title":"Endpoints","text":""},{"location":"frontend/control-acceso/integraciones-iot/#1-autenticacion","title":"1. Autenticaci\u00f3n","text":"<p>Login Usuario Normal</p> <pre><code>POST /login\nContent-Type: application/json\n\n{\n  \"rutOrMail\": \"12345678-9\",\n  \"password\": \"mypassword\"\n}\n</code></pre> <p>Response</p> <pre><code>{\n  \"id\": 123,\n  \"nombre\": \"Juan\",\n  \"apellido\": \"P\u00e9rez\",\n  \"mail\": \"juan@example.com\",\n  \"rut\": \"12345678-9\",\n  \"admin\": false,\n  \"invitar\": false,\n  \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\"\n}\n</code></pre> <p>Login Invitado</p> <pre><code>POST /invitados/login\nContent-Type: application/json\n\n{\n  \"CodigoAcceso\": \"1234\"\n}\n</code></pre> <p>Response</p> <pre><code>{\n  \"IdInvitante\": 123,\n  \"Nombre\": \"Pedro\",\n  \"Apellido\": \"Gonz\u00e1lez\",\n  \"Mail\": \"pedro@empresa.com\",\n  \"Empresa\": \"Empresa XYZ\",\n  \"FechaInicial\": \"2025-12-26\",\n  \"FechaFinal\": \"2025-12-31\",\n  \"Portones\": [1, 3, 5],\n  \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\"\n}\n</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#2-portones","title":"2. Portones","text":"<p>Obtener Portones del Usuario</p> <pre><code>POST /portones\nAuthorization: Bearer {token}\nContent-Type: application/json\n</code></pre> <p>Response</p> <pre><code>{\n  \"portones\": [\n    {\n      \"IdPorton\": 1,\n      \"NombrePorton\": \"Port\u00f3n Principal\",\n      \"LatitudPorton\": -33.4569,\n      \"LongitudPorton\": -70.6483,\n      \"Distancia\": 0,\n      \"IdShelly\": \"shellyplus1-a8032ab12345\"\n    },\n    {\n      \"IdPorton\": 2,\n      \"NombrePorton\": \"Port\u00f3n Estacionamiento\",\n      \"LatitudPorton\": -33.4570,\n      \"LongitudPorton\": -70.6485,\n      \"Distancia\": 0,\n      \"IdShelly\": \"shellyplus1-a8032ab12346\"\n    }\n  ]\n}\n</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#3-control-mqtt","title":"3. Control MQTT","text":"<p>Enviar Comando al Port\u00f3n</p> <pre><code>POST /mqtt_test\nContent-Type: application/json\nkey: {api_key}\n\n{\n  \"Lugar\": \"shellyplus1-a8032ab12345\",\n  \"Comando\": \"toggle\",\n  \"Topico\": \"shellies/command\"\n}\n</code></pre> <p>Comandos disponibles: - <code>toggle</code> - Alternar estado (abrir si est\u00e1 cerrado, cerrar si est\u00e1 abierto) - <code>on</code> - Activar rel\u00e9 (abrir port\u00f3n) - <code>off</code> - Desactivar rel\u00e9 (cerrar port\u00f3n)</p> <p>Response</p> <pre><code>{\n  \"status\": \"success\",\n  \"message\": \"Comando enviado correctamente\",\n  \"device\": \"shellyplus1-a8032ab12345\",\n  \"command\": \"toggle\"\n}\n</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#4-invitados","title":"4. Invitados","text":"<p>Crear Invitado (Solo Admin)</p> <pre><code>POST /invitados/crear\nAuthorization: Bearer {token}\nContent-Type: application/json\n\n{\n  \"Rut\": \"11111111-1\",\n  \"Nombre\": \"Carlos\",\n  \"Apellido\": \"Silva\",\n  \"Telefono\": \"+56912345678\",\n  \"Mail\": \"carlos@empresa.com\",\n  \"FechaInicial\": \"2025-12-26\",\n  \"FechaFinal\": \"2025-12-31\",\n  \"Empresa\": \"Constructora ABC\",\n  \"Motivo\": \"Visita de obra\",\n  \"IdInvitante\": 123,\n  \"PortonesIds\": [1, 3]\n}\n</code></pre> <p>Response</p> <pre><code>{\n  \"status\": \"success\",\n  \"message\": \"Invitado creado correctamente\",\n  \"codigo\": \"5678\",\n  \"invitado\": {\n    \"id\": 456,\n    \"rut\": \"11111111-1\",\n    \"nombre\": \"Carlos\",\n    \"apellido\": \"Silva\",\n    \"codigo_acceso\": \"5678\"\n  }\n}\n</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#api-client-implementation","title":"API Client Implementation","text":"<pre><code>class ApiClient {\n  private baseURL: string;\n\n  constructor() {\n    this.baseURL = API_URLS.primary;\n  }\n\n  async makeRequest(\n    endpoint: string, \n    options: RequestInit, \n    useBackup = false\n  ) {\n    try {\n      const url = useBackup ? API_URLS.fallback : API_URLS.primary;\n      const response = await fetch(`${url}${endpoint}`, options);\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        throw new Error(`HTTP ${response.status}: ${errorText}`);\n      }\n\n      return await response.json();\n    } catch (error) {\n      if (!useBackup) {\n        return this.makeRequest(endpoint, options, true);\n      }\n      throw error;\n    }\n  }\n\n  async login(rutOrMail: string, password: string) {\n    return this.makeRequest('/login', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ rutOrMail, password })\n    });\n  }\n\n  async guestLogin(code: string) {\n    return this.makeRequest('/invitados/login', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ CodigoAcceso: code })\n    });\n  }\n\n  async getPortones(token: string) {\n    return this.makeRequest('/portones', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${token}`\n      }\n    });\n  }\n\n  async mqttTest(\n    data: { Lugar: string; Comando: string; Topico: string }, \n    key: string\n  ) {\n    return this.makeRequest('/mqtt_test', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'key': key\n      },\n      body: JSON.stringify(data)\n    });\n  }\n\n  async crearInvitado(data: any, token: string) {\n    return this.makeRequest('/invitados/crear', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${token}`\n      },\n      body: JSON.stringify(data)\n    });\n  }\n}\n\nexport const apiClient = new ApiClient();\n</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#autenticacion-jwt","title":"\ud83d\udd10 Autenticaci\u00f3n JWT","text":"<p>Nota: Para documentaci\u00f3n completa del backend, ver Backend Control de Acceso.</p>"},{"location":"frontend/control-acceso/integraciones-iot/#estructura-del-token","title":"Estructura del Token","text":"<pre><code>{\n  \"header\": {\n    \"alg\": \"HS256\",\n    \"typ\": \"JWT\"\n  },\n  \"payload\": {\n    \"sub\": \"12345678-9\",\n    \"id\": 123,\n    \"nombre\": \"Juan P\u00e9rez\",\n    \"admin\": false,\n    \"exp\": 1735257600,\n    \"iat\": 1735171200\n  },\n  \"signature\": \"...\"\n}\n</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#manejo-de-token","title":"Manejo de Token","text":"<pre><code>class AuthService {\n  private static TOKEN_KEY = 'userToken';\n  private static USER_KEY = 'userData';\n\n  static async saveToken(token: string) {\n    await AsyncStorage.setItem(this.TOKEN_KEY, token);\n  }\n\n  static async getToken(): Promise&lt;string | null&gt; {\n    return await AsyncStorage.getItem(this.TOKEN_KEY);\n  }\n\n  static async saveUserData(userData: any) {\n    await AsyncStorage.setItem(this.USER_KEY, JSON.stringify(userData));\n  }\n\n  static async getUserData(): Promise&lt;any | null&gt; {\n    const data = await AsyncStorage.getItem(this.USER_KEY);\n    return data ? JSON.parse(data) : null;\n  }\n\n  static async clearAuth() {\n    await AsyncStorage.multiRemove([this.TOKEN_KEY, this.USER_KEY]);\n  }\n\n  static async isTokenValid(token: string): Promise&lt;boolean&gt; {\n    try {\n      // Decodificar JWT sin verificar (solo para obtener exp)\n      const [, payload] = token.split('.');\n      const decoded = JSON.parse(atob(payload));\n      const now = Math.floor(Date.now() / 1000);\n      return decoded.exp &gt; now;\n    } catch {\n      return false;\n    }\n  }\n}\n</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#refresh-token-strategy","title":"Refresh Token Strategy","text":"<pre><code>sequenceDiagram\n    participant APP as App\n    participant AS as Auth Service\n    participant API as Backend API\n    participant STORE as AsyncStorage\n\n    APP-&gt;&gt;AS: Hacer request\n    AS-&gt;&gt;STORE: getToken()\n    STORE--&gt;&gt;AS: token\n\n    AS-&gt;&gt;AS: isTokenValid()\n\n    alt Token v\u00e1lido\n        AS-&gt;&gt;API: Request con token\n        API--&gt;&gt;AS: Response\n        AS--&gt;&gt;APP: Data\n    else Token expirado\n        AS-&gt;&gt;API: POST /refresh\n\n        alt Refresh exitoso\n            API--&gt;&gt;AS: Nuevo token\n            AS-&gt;&gt;STORE: saveToken(newToken)\n            AS-&gt;&gt;API: Reintentar request\n            API--&gt;&gt;AS: Response\n            AS--&gt;&gt;APP: Data\n        else Refresh falla\n            AS-&gt;&gt;STORE: clearAuth()\n            AS--&gt;&gt;APP: Error: Sesi\u00f3n expirada\n            APP-&gt;&gt;APP: Navegar a Login\n        end\n    end</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#dispositivos-shelly","title":"\ud83d\udd0c Dispositivos Shelly","text":""},{"location":"frontend/control-acceso/integraciones-iot/#caracteristicas","title":"Caracter\u00edsticas","text":"<ul> <li>Modelo: Shelly Plus 1 / Shelly Plus 2PM</li> <li>Protocolo: MQTT / HTTP</li> <li>Voltaje: 110-240V AC</li> <li>Conectividad: WiFi 2.4GHz</li> <li>Salidas: 1 o 2 rel\u00e9s</li> </ul>"},{"location":"frontend/control-acceso/integraciones-iot/#configuracion-mqtt","title":"Configuraci\u00f3n MQTT","text":"<pre><code>{\n  \"mqtt\": {\n    \"enable\": true,\n    \"server\": \"mqtt.elalto.cl:1883\",\n    \"user\": \"shelly_user\",\n    \"pass\": \"shelly_password\",\n    \"id\": \"shellyplus1-a8032ab12345\",\n    \"clean_session\": true,\n    \"keep_alive\": 60,\n    \"max_qos\": 0,\n    \"retain\": false,\n    \"update_period\": 30\n  }\n}\n</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#topics-mqtt","title":"Topics MQTT","text":"Acci\u00f3n Topic Payload Descripci\u00f3n Estado <code>shellies/{device_id}/relay/0</code> <code>on</code> / <code>off</code> Lee estado actual Comando <code>shellies/{device_id}/relay/0/command</code> <code>on</code> / <code>off</code> / <code>toggle</code> Env\u00eda comando Estado confirmaci\u00f3n <code>shellies/{device_id}/relay/0/status</code> <code>{\"ison\":true,\"has_timer\":false}</code> Confirmaci\u00f3n estado"},{"location":"frontend/control-acceso/integraciones-iot/#flujo-de-control","title":"Flujo de Control","text":"<pre><code>sequenceDiagram\n    participant U as Usuario\n    participant APP as App\n    participant API as Backend API\n    participant MQTT as MQTT Broker\n    participant S as Shelly Device\n    participant R as Rel\u00e9 Port\u00f3n\n\n    U-&gt;&gt;APP: Presiona \"Abrir Port\u00f3n\"\n    APP-&gt;&gt;APP: Validar distancia\n\n    alt Dentro de rango (&lt; 300m)\n        APP-&gt;&gt;API: POST /mqtt_test\n        Note over APP,API: {Lugar, Comando, Topico}\n\n        API-&gt;&gt;MQTT: PUBLISH shellies/{id}/relay/0/command\n        Note over MQTT: Payload: \"toggle\"\n\n        MQTT-&gt;&gt;S: Recibe comando\n        S-&gt;&gt;S: Procesar comando\n        S-&gt;&gt;R: Activar rel\u00e9\n\n        Note over R: Port\u00f3n se abre&lt;br/&gt;(5-10 segundos)\n\n        R--&gt;&gt;S: Estado cambiado\n        S-&gt;&gt;MQTT: PUBLISH shellies/{id}/relay/0/status\n        MQTT-&gt;&gt;API: Estado actualizado\n        API--&gt;&gt;APP: Success response\n\n        APP-&gt;&gt;U: \u2705 Port\u00f3n activado\n        APP-&gt;&gt;APP: Animaci\u00f3n completada\n    else Fuera de rango\n        APP-&gt;&gt;U: \u274c Ac\u00e9rcate m\u00e1s al port\u00f3n\n    end</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#manejo-de-estados","title":"Manejo de Estados","text":"<pre><code>enum PortonEstado {\n  CERRADO = 'cerrado',\n  ABRIENDO = 'abriendo',\n  ABIERTO = 'abierto',\n  CERRANDO = 'cerrando',\n  ERROR = 'error'\n}\n\ninterface PortonControl {\n  id: string;\n  estado: PortonEstado;\n  ultimaActivacion: Date | null;\n  intentosReintento: number;\n}\n\nclass PortonController {\n  private estados: Map&lt;string, PortonControl&gt; = new Map();\n\n  async activarPorton(porton: Porton, comando: 'toggle' | 'on' | 'off') {\n    const control = this.getControl(porton.IdPorton);\n\n    // Prevenir m\u00faltiples activaciones\n    if (control.estado === PortonEstado.ABRIENDO) {\n      throw new Error('El port\u00f3n ya est\u00e1 en proceso de apertura');\n    }\n\n    // Actualizar estado\n    control.estado = PortonEstado.ABRIENDO;\n    this.estados.set(porton.IdPorton, control);\n\n    try {\n      const response = await apiClient.mqttTest({\n        Lugar: porton.IdShelly,\n        Comando: comando,\n        Topico: 'shellies/command'\n      }, token);\n\n      control.ultimaActivacion = new Date();\n      control.estado = PortonEstado.ABIERTO;\n      control.intentosReintento = 0;\n\n      // Auto-cerrar despu\u00e9s de 10 segundos\n      setTimeout(() =&gt; {\n        control.estado = PortonEstado.CERRADO;\n        this.estados.set(porton.IdPorton, control);\n      }, 10000);\n\n      return response;\n    } catch (error) {\n      control.estado = PortonEstado.ERROR;\n      control.intentosReintento++;\n\n      // Reintentar hasta 3 veces\n      if (control.intentosReintento &lt; 3) {\n        await new Promise(resolve =&gt; setTimeout(resolve, 2000));\n        return this.activarPorton(porton, comando);\n      }\n\n      throw error;\n    }\n  }\n\n  private getControl(idPorton: string | number): PortonControl {\n    if (!this.estados.has(String(idPorton))) {\n      this.estados.set(String(idPorton), {\n        id: String(idPorton),\n        estado: PortonEstado.CERRADO,\n        ultimaActivacion: null,\n        intentosReintento: 0\n      });\n    }\n    return this.estados.get(String(idPorton))!;\n  }\n}\n</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#timeout-y-reintentos","title":"Timeout y Reintentos","text":"<pre><code>flowchart TD\n    Start([Enviar comando]) --&gt; Send[POST /mqtt_test]\n    Send --&gt; Wait[Esperar respuesta&lt;br/&gt;Timeout: 10s]\n\n    Wait --&gt; CheckResponse{\u00bfRespuesta&lt;br/&gt;recibida?}\n\n    CheckResponse --&gt;|S\u00ed| Success[\u2705 Comando exitoso]\n    Success --&gt; UpdateUI[Actualizar UI]\n    UpdateUI --&gt; End([Fin])\n\n    CheckResponse --&gt;|No - Timeout| CheckRetries{\u00bfIntentos &lt; 3?}\n\n    CheckRetries --&gt;|S\u00ed| Retry[Esperar 2s]\n    Retry --&gt; Send\n\n    CheckRetries --&gt;|No| Error[\u274c Error: Timeout]\n    Error --&gt; ShowError[Mostrar error al usuario]\n    ShowError --&gt; ResetState[Resetear estado port\u00f3n]\n    ResetState --&gt; End\n\n    style Success fill:#90EE90\n    style Error fill:#FFB6B6</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#base-de-datos","title":"\ud83d\udcca Base de Datos","text":""},{"location":"frontend/control-acceso/integraciones-iot/#tablas-principales","title":"Tablas Principales","text":""},{"location":"frontend/control-acceso/integraciones-iot/#usuarios","title":"Usuarios","text":"<pre><code>CREATE TABLE Usuarios (\n    Id INT PRIMARY KEY IDENTITY(1,1),\n    Rut VARCHAR(12) UNIQUE NOT NULL,\n    Nombre NVARCHAR(100) NOT NULL,\n    Apellido NVARCHAR(100) NOT NULL,\n    Mail VARCHAR(200),\n    Password NVARCHAR(255) NOT NULL,\n    Admin BIT DEFAULT 0,\n    Activo BIT DEFAULT 1,\n    FechaCreacion DATETIME DEFAULT GETDATE()\n);\n</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#portones","title":"Portones","text":"<pre><code>CREATE TABLE Portones (\n    IdPorton INT PRIMARY KEY IDENTITY(1,1),\n    NombrePorton NVARCHAR(100) NOT NULL,\n    LatitudPorton DECIMAL(10, 8) NOT NULL,\n    LongitudPorton DECIMAL(11, 8) NOT NULL,\n    IdShelly VARCHAR(100) UNIQUE NOT NULL,\n    RadioMetros INT DEFAULT 300,\n    Activo BIT DEFAULT 1,\n    FechaCreacion DATETIME DEFAULT GETDATE()\n);\n</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#invitados","title":"Invitados","text":"<pre><code>CREATE TABLE Invitados (\n    Id INT PRIMARY KEY IDENTITY(1,1),\n    Rut VARCHAR(12) NOT NULL,\n    Nombre NVARCHAR(100) NOT,\n    Apellido NVARCHAR(100) NOT NULL,\n    Telefono VARCHAR(20),\n    Mail VARCHAR(200),\n    CodigoAcceso VARCHAR(4) UNIQUE NOT NULL,\n    IdInvitante INT FOREIGN KEY REFERENCES Usuarios(Id),\n    FechaInicial DATE NOT NULL,\n    FechaFinal DATE NOT NULL,\n    Empresa NVARCHAR(200),\n    Motivo NVARCHAR(500),\n    Activo BIT DEFAULT 1,\n    FechaCreacion DATETIME DEFAULT GETDATE()\n);\n</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#portonesinvitados-relacion-nn","title":"PortonesInvitados (Relaci\u00f3n N:N)","text":"<pre><code>CREATE TABLE PortonesInvitados (\n    Id INT PRIMARY KEY IDENTITY(1,1),\n    IdInvitado INT FOREIGN KEY REFERENCES Invitados(Id),\n    IdPorton INT FOREIGN KEY REFERENCES Portones(IdPorton),\n    FechaAsignacion DATETIME DEFAULT GETDATE()\n);\n</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#usuariosportones-relacion-nn","title":"UsuariosPortones (Relaci\u00f3n N:N)","text":"<pre><code>CREATE TABLE UsuariosPortones (\n    Id INT PRIMARY KEY IDENTITY(1,1),\n    IdUsuario INT FOREIGN KEY REFERENCES Usuarios(Id),\n    IdPorton INT FOREIGN KEY REFERENCES Portones(IdPorton),\n    FechaAsignacion DATETIME DEFAULT GETDATE()\n);\n</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#logs-de-acceso","title":"Logs de Acceso","text":"<pre><code>CREATE TABLE LogsAcceso (\n    Id INT PRIMARY KEY IDENTITY(1,1),\n    IdUsuario INT NULL FOREIGN KEY REFERENCES Usuarios(Id),\n    IdInvitado INT NULL FOREIGN KEY REFERENCES Invitados(Id),\n    IdPorton INT FOREIGN KEY REFERENCES Portones(IdPorton),\n    Accion VARCHAR(50) NOT NULL, -- 'abrir', 'cerrar', 'toggle'\n    Latitud DECIMAL(10, 8),\n    Longitud DECIMAL(11, 8),\n    Distancia DECIMAL(10, 2),\n    Exitoso BIT NOT NULL,\n    MensajeError NVARCHAR(500),\n    FechaHora DATETIME DEFAULT GETDATE()\n);\n</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#diagrama-er","title":"Diagrama ER","text":"<pre><code>erDiagram\n    USUARIOS ||--o{ USUARIOS_PORTONES : tiene\n    PORTONES ||--o{ USUARIOS_PORTONES : asignado\n    USUARIOS ||--o{ INVITADOS : crea\n    INVITADOS ||--o{ PORTONES_INVITADOS : tiene\n    PORTONES ||--o{ PORTONES_INVITADOS : asignado\n    USUARIOS ||--o{ LOGS_ACCESO : registra\n    INVITADOS ||--o{ LOGS_ACCESO : registra\n    PORTONES ||--o{ LOGS_ACCESO : recibe\n\n    USUARIOS {\n        int Id PK\n        varchar Rut UK\n        nvarchar Nombre\n        nvarchar Apellido\n        varchar Mail\n        nvarchar Password\n        bit Admin\n        bit Activo\n        datetime FechaCreacion\n    }\n\n    PORTONES {\n        int IdPorton PK\n        nvarchar NombrePorton\n        decimal LatitudPorton\n        decimal LongitudPorton\n        varchar IdShelly UK\n        int RadioMetros\n        bit Activo\n        datetime FechaCreacion\n    }\n\n    INVITADOS {\n        int Id PK\n        varchar Rut\n        nvarchar Nombre\n        nvarchar Apellido\n        varchar Telefono\n        varchar Mail\n        varchar CodigoAcceso UK\n        int IdInvitante FK\n        date FechaInicial\n        date FechaFinal\n        nvarchar Empresa\n        nvarchar Motivo\n        bit Activo\n        datetime FechaCreacion\n    }\n\n    LOGS_ACCESO {\n        int Id PK\n        int IdUsuario FK\n        int IdInvitado FK\n        int IdPorton FK\n        varchar Accion\n        decimal Latitud\n        decimal Longitud\n        decimal Distancia\n        bit Exitoso\n        nvarchar MensajeError\n        datetime FechaHora\n    }</code></pre>"},{"location":"frontend/control-acceso/integraciones-iot/#proximos-pasos","title":"Pr\u00f3ximos Pasos","text":"<ul> <li>Pantallas y Flujos</li> <li>Despliegue y Build</li> <li>Troubleshooting</li> </ul>"},{"location":"frontend/control-acceso/pantallas/","title":"Pantallas y Flujos de Usuario","text":""},{"location":"frontend/control-acceso/pantallas/#navegacion-principal","title":"\ud83d\udcf1 Navegaci\u00f3n Principal","text":"<pre><code>graph TD\n    Splash[Splash Screen] --&gt; CheckAuth{\u00bfUsuario&lt;br/&gt;autenticado?}\n\n    CheckAuth --&gt;|No| Login[Login Screen]\n    CheckAuth --&gt;|S\u00ed| Control[Control Screen]\n\n    Login --&gt; ModoLogin{Modo de login}\n    ModoLogin --&gt;|Normal| FormLogin[Formulario RUT/Email]\n    ModoLogin --&gt;|Invitado| FormGuest[C\u00f3digo 4 d\u00edgitos]\n\n    FormLogin --&gt; ValidateLogin{\u00bfCredenciales&lt;br/&gt;v\u00e1lidas?}\n    FormGuest --&gt; ValidateGuest{\u00bfC\u00f3digo&lt;br/&gt;v\u00e1lido?}\n\n    ValidateLogin --&gt;|No| ErrorLogin[Error: Credenciales&lt;br/&gt;incorrectas]\n    ValidateLogin --&gt;|S\u00ed| LoadPortones[Cargar portones]\n\n    ValidateGuest --&gt;|No| ErrorGuest[Error: C\u00f3digo&lt;br/&gt;inv\u00e1lido/expirado]\n    ValidateGuest --&gt;|S\u00ed| LoadPortonesGuest[Cargar portones&lt;br/&gt;permitidos]\n\n    ErrorLogin --&gt; FormLogin\n    ErrorGuest --&gt; FormGuest\n\n    LoadPortones --&gt; Control\n    LoadPortonesGuest --&gt; Control\n\n    Control --&gt; CheckAdmin{\u00bfEs admin?}\n    CheckAdmin --&gt;|S\u00ed| ShowInvitar[Mostrar bot\u00f3n&lt;br/&gt;Invitar]\n    CheckAdmin --&gt;|No| HideInvitar[Ocultar bot\u00f3n]\n\n    ShowInvitar --&gt; CanInvite[Puede navegar&lt;br/&gt;a InvitarScreen]\n    CanInvite --&gt; Invitar[Invitar Screen]\n\n    style Splash fill:#000020\n    style Login fill:#4A90E2\n    style Control fill:#61DAFB\n    style Invitar fill:#90EE90</code></pre>"},{"location":"frontend/control-acceso/pantallas/#1-splash-screen","title":"1. Splash Screen","text":""},{"location":"frontend/control-acceso/pantallas/#descripcion","title":"Descripci\u00f3n","text":"<p>Pantalla inicial que se muestra mientras la aplicaci\u00f3n valida la sesi\u00f3n del usuario.</p>"},{"location":"frontend/control-acceso/pantallas/#flujo","title":"Flujo","text":"<pre><code>sequenceDiagram\n    participant U as Usuario\n    participant S as Splash Screen\n    participant AS as AsyncStorage\n    participant API as Backend API\n    participant R as Router\n\n    U-&gt;&gt;S: Abre aplicaci\u00f3n\n    S-&gt;&gt;AS: getItem('userToken')\n\n    alt Token existe\n        AS--&gt;&gt;S: token\n        S-&gt;&gt;AS: getItem('userData')\n        AS--&gt;&gt;S: userData\n        S-&gt;&gt;API: Validar token\n\n        alt Token v\u00e1lido\n            API--&gt;&gt;S: Token OK\n            S-&gt;&gt;R: navigate('/ControlScreen')\n        else Token inv\u00e1lido/expirado\n            API--&gt;&gt;S: Error 401\n            S-&gt;&gt;AS: clear()\n            S-&gt;&gt;R: navigate('/LoginScreen')\n        end\n    else No hay token\n        AS--&gt;&gt;S: null\n        S-&gt;&gt;R: navigate('/LoginScreen')\n    end</code></pre>"},{"location":"frontend/control-acceso/pantallas/#implementacion","title":"Implementaci\u00f3n","text":"<pre><code>useEffect(() =&gt; {\n  const checkAuth = async () =&gt; {\n    try {\n      const token = await AsyncStorage.getItem('userToken');\n      const userData = await AsyncStorage.getItem('userData');\n\n      if (token &amp;&amp; userData) {\n        const user = JSON.parse(userData);\n        dispatch(setUserData(user));\n\n        // Cargar portones\n        const portones = await AsyncStorage.getItem('portones');\n        if (portones) {\n          // Validar sesi\u00f3n con backend\n          router.replace('/ControlScreen');\n        } else {\n          router.replace('/LoginScreen');\n        }\n      } else {\n        router.replace('/LoginScreen');\n      }\n    } catch (error) {\n      console.error('Error checking auth:', error);\n      router.replace('/LoginScreen');\n    }\n  };\n\n  setTimeout(checkAuth, 1500); // Mostrar splash por 1.5s\n}, []);\n</code></pre>"},{"location":"frontend/control-acceso/pantallas/#2-login-screen","title":"2. Login Screen","text":""},{"location":"frontend/control-acceso/pantallas/#descripcion_1","title":"Descripci\u00f3n","text":"<p>Pantalla de autenticaci\u00f3n con dos modos: usuario normal e invitado.</p>"},{"location":"frontend/control-acceso/pantallas/#ui-components","title":"UI Components","text":"<pre><code>graph TB\n    subgraph \"Login Screen\"\n        Logo[Logo El Alto]\n        Title[T\u00edtulo: Control de Acceso]\n        Toggle[Toggle: Normal/Invitado]\n\n        subgraph \"Modo Normal\"\n            InputRUT[Input: RUT o Email]\n            InputPass[Input: Password]\n            ShowPass[Bot\u00f3n: Ver/Ocultar]\n            BtnLogin[Bot\u00f3n: Iniciar Sesi\u00f3n]\n        end\n\n        subgraph \"Modo Invitado\"\n            InputCode[Input: C\u00f3digo 4 d\u00edgitos]\n            BtnGuest[Bot\u00f3n: Acceder]\n        end\n\n        Loading[Spinner de carga]\n        Error[Mensaje de error]\n    end\n\n    Logo --&gt; Title\n    Title --&gt; Toggle\n    Toggle -.switch.-&gt; InputRUT\n    Toggle -.switch.-&gt; InputCode\n\n    InputRUT --&gt; InputPass\n    InputPass --&gt; ShowPass\n    ShowPass --&gt; BtnLogin\n\n    InputCode --&gt; BtnGuest\n\n    BtnLogin -.loading.-&gt; Loading\n    BtnGuest -.loading.-&gt; Loading\n\n    BtnLogin -.error.-&gt; Error\n    BtnGuest -.error.-&gt; Error</code></pre>"},{"location":"frontend/control-acceso/pantallas/#validaciones","title":"Validaciones","text":"<pre><code>// Validaci\u00f3n RUT\nconst validarRUT = (rut: string): boolean =&gt; {\n  // Formato: 12345678-9\n  const rutPattern = /^(\\d{7,8})-?[\\dkK]$/;\n  return rutPattern.test(rut);\n};\n\n// Validaci\u00f3n Email\nconst validarEmail = (email: string): boolean =&gt; {\n  const emailPattern = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailPattern.test(email);\n};\n\n// Validaci\u00f3n c\u00f3digo invitado\nconst validarCodigo = (codigo: string): boolean =&gt; {\n  return codigo.length === 4 &amp;&amp; /^\\d{4}$/.test(codigo);\n};\n</code></pre>"},{"location":"frontend/control-acceso/pantallas/#estados-de-ui","title":"Estados de UI","text":"Estado Descripci\u00f3n UI <code>idle</code> Estado inicial Formulario vac\u00edo <code>loading</code> Enviando request Spinner + deshabilitar inputs <code>error</code> Error en login Mensaje de error en rojo <code>success</code> Login exitoso Navegar a ControlScreen"},{"location":"frontend/control-acceso/pantallas/#flujo-de-login-normal","title":"Flujo de Login Normal","text":"<pre><code>sequenceDiagram\n    participant U as Usuario\n    participant UI as Login UI\n    participant V as Validador\n    participant API as API Client\n    participant S as AsyncStorage\n    participant R as Redux\n\n    U-&gt;&gt;UI: Ingresa RUT/Email\n    U-&gt;&gt;UI: Ingresa password\n    U-&gt;&gt;UI: Click \"Iniciar Sesi\u00f3n\"\n\n    UI-&gt;&gt;V: Validar formato\n\n    alt Formato inv\u00e1lido\n        V--&gt;&gt;UI: Error de formato\n        UI-&gt;&gt;U: Mostrar error\n    else Formato v\u00e1lido\n        UI-&gt;&gt;UI: setIsLoading(true)\n        UI-&gt;&gt;API: POST /login\n\n        alt Credenciales correctas\n            API--&gt;&gt;UI: Token + UserData\n            UI-&gt;&gt;S: Guardar token\n            UI-&gt;&gt;S: Guardar userData\n            UI-&gt;&gt;R: setUserData()\n\n            UI-&gt;&gt;API: GET /portones\n            API--&gt;&gt;UI: Lista portones\n            UI-&gt;&gt;S: Guardar portones\n\n            UI-&gt;&gt;U: Navegar a Control\n        else Credenciales incorrectas\n            API--&gt;&gt;UI: Error 401\n            UI-&gt;&gt;U: Error: Usuario/contrase\u00f1a incorrectos\n        else Error de red\n            API--&gt;&gt;UI: Error conexi\u00f3n\n            UI-&gt;&gt;U: Error: No se pudo conectar\n        end\n\n        UI-&gt;&gt;UI: setIsLoading(false)\n    end</code></pre>"},{"location":"frontend/control-acceso/pantallas/#flujo-de-login-invitado","title":"Flujo de Login Invitado","text":"<pre><code>sequenceDiagram\n    participant I as Invitado\n    participant UI as Login UI\n    participant API as API Client\n    participant DB as Database\n    participant S as AsyncStorage\n\n    I-&gt;&gt;UI: Ingresa c\u00f3digo 4 d\u00edgitos\n    I-&gt;&gt;UI: Click \"Acceder\"\n\n    UI-&gt;&gt;UI: Validar formato (4 d\u00edgitos)\n\n    alt Formato inv\u00e1lido\n        UI-&gt;&gt;I: Error: C\u00f3digo debe ser 4 d\u00edgitos\n    else Formato v\u00e1lido\n        UI-&gt;&gt;API: POST /invitados/login\n        API-&gt;&gt;DB: Buscar invitado\n\n        alt Invitado encontrado y activo\n            DB-&gt;&gt;DB: Validar fechas\n\n            alt Dentro de rango de fechas\n                DB--&gt;&gt;API: Datos + portones permitidos\n                API--&gt;&gt;UI: Token + permisos\n                UI-&gt;&gt;S: Guardar sesi\u00f3n invitado\n                UI-&gt;&gt;API: GET /portones (filtrados)\n                API--&gt;&gt;UI: Portones permitidos\n                UI-&gt;&gt;I: \u2705 Acceso concedido\n            else Fuera de rango\n                DB--&gt;&gt;API: Error 403\n                API--&gt;&gt;UI: Acceso expirado\n                UI-&gt;&gt;I: \u274c Tu acceso ha expirado\n            end\n        else C\u00f3digo no existe\n            DB--&gt;&gt;API: Error 401\n            API--&gt;&gt;UI: C\u00f3digo inv\u00e1lido\n            UI-&gt;&gt;I: \u274c C\u00f3digo incorrecto\n        end\n    end</code></pre>"},{"location":"frontend/control-acceso/pantallas/#3-control-screen-pantalla-principal","title":"3. Control Screen (Pantalla Principal)","text":""},{"location":"frontend/control-acceso/pantallas/#descripcion_2","title":"Descripci\u00f3n","text":"<p>Pantalla principal con mapa interactivo que muestra la ubicaci\u00f3n del usuario y los portones disponibles.</p>"},{"location":"frontend/control-acceso/pantallas/#layout","title":"Layout","text":"<pre><code>graph TB\n    subgraph \"Control Screen\"\n        Header[Header]\n        Map[Mapa Mapbox]\n        PortonList[Lista de Portones]\n        Footer[Footer/Acciones]\n    end\n\n    subgraph \"Header\"\n        Welcome[Bienvenido Usuario]\n        LogoutBtn[Bot\u00f3n Logout]\n    end\n\n    subgraph \"Mapa\"\n        UserMarker[\ud83d\udccd Usuario]\n        PortonMarkers[\ud83d\udeaa Portones]\n        GeofenceCircles[\u2b55 C\u00edrculos 300m]\n        MapControls[Controles zoom]\n    end\n\n    subgraph \"Lista Portones\"\n        PortonCard1[Card Port\u00f3n 1]\n        PortonCard2[Card Port\u00f3n 2]\n        PortonCardN[Card Port\u00f3n N]\n    end\n\n    subgraph \"Port\u00f3n Card\"\n        Name[Nombre Port\u00f3n]\n        Distance[\ud83d\udccf Distancia]\n        Status[Estado: Dentro/Fuera]\n        ActionBtn[Bot\u00f3n Abrir/Cerrar]\n    end\n\n    Header --&gt; Map\n    Map --&gt; PortonList\n    PortonList --&gt; Footer\n\n    PortonCard1 --&gt; Name\n    PortonCard1 --&gt; Distance\n    PortonCard1 --&gt; Status\n    PortonCard1 --&gt; ActionBtn</code></pre>"},{"location":"frontend/control-acceso/pantallas/#estados-del-mapa","title":"Estados del Mapa","text":"<pre><code>interface MapState {\n  userLocation: {\n    latitude: number;\n    longitude: number;\n  } | null;\n  portones: Porton[];\n  selectedPorton: Porton | null;\n  isLoadingLocation: boolean;\n  locationPermission: 'granted' | 'denied' | 'undetermined';\n}\n</code></pre>"},{"location":"frontend/control-acceso/pantallas/#actualizacion-de-ubicacion","title":"Actualizaci\u00f3n de Ubicaci\u00f3n","text":"<pre><code>sequenceDiagram\n    participant GPS as GPS Device\n    participant L as Location Service\n    participant C as Control Screen\n    participant M as Mapa\n    participant P as Portones\n\n    loop Cada 5 segundos\n        GPS-&gt;&gt;L: Nueva ubicaci\u00f3n\n        L-&gt;&gt;C: onLocationUpdate()\n        C-&gt;&gt;C: Guardar nueva ubicaci\u00f3n\n        C-&gt;&gt;M: Actualizar marcador usuario\n\n        C-&gt;&gt;P: Calcular distancias\n        loop Para cada port\u00f3n\n            P-&gt;&gt;P: getDistanceMeters()\n            P-&gt;&gt;P: Actualizar estado\n\n            alt Distancia &lt; 300m\n                P-&gt;&gt;P: Habilitar control\n                P-&gt;&gt;M: Mostrar c\u00edrculo verde\n            else Distancia &gt;= 300m\n                P-&gt;&gt;P: Deshabilitar control\n                P-&gt;&gt;M: Mostrar c\u00edrculo rojo\n            end\n        end\n\n        C-&gt;&gt;C: Actualizar UI portones\n    end</code></pre>"},{"location":"frontend/control-acceso/pantallas/#card-de-porton","title":"Card de Port\u00f3n","text":"<pre><code>interface PortonCardProps {\n  porton: Porton;\n  distance: number;\n  onPress: () =&gt; void;\n}\n\nconst PortonCard = ({ porton, distance, onPress }: PortonCardProps) =&gt; {\n  const dentroRango = distance &lt;= 300;\n  const distanceText = distance &lt; 1000 \n    ? `${distance.toFixed(0)}m` \n    : `${(distance / 1000).toFixed(2)}km`;\n\n  return (\n    &lt;Card&gt;\n      &lt;CardHeader&gt;\n        &lt;CardTitle&gt;{porton.NombrePorton}&lt;/CardTitle&gt;\n        &lt;CardDescription&gt;\n          {distanceText} {dentroRango ? '\u2705' : '\ud83d\udeab'}\n        &lt;/CardDescription&gt;\n      &lt;/CardHeader&gt;\n      &lt;CardContent&gt;\n        {dentroRango ? (\n          &lt;Button onPress={onPress}&gt;\n            &lt;DoorOpen /&gt; Abrir Port\u00f3n\n          &lt;/Button&gt;\n        ) : (\n          &lt;Text&gt;Ac\u00e9rcate m\u00e1s para habilitar&lt;/Text&gt;\n        )}\n      &lt;/CardContent&gt;\n    &lt;/Card&gt;\n  );\n};\n</code></pre>"},{"location":"frontend/control-acceso/pantallas/#animacion-de-apertura","title":"Animaci\u00f3n de Apertura","text":"<pre><code>const [isOpening, setIsOpening] = useState(false);\nconst rotateAnim = useRef(new Animated.Value(0)).current;\n\nconst animateOpen = () =&gt; {\n  setIsOpening(true);\n\n  Animated.sequence([\n    Animated.timing(rotateAnim, {\n      toValue: 1,\n      duration: 500,\n      easing: Easing.bezier(0.4, 0, 0.2, 1),\n      useNativeDriver: true,\n    }),\n    Animated.timing(rotateAnim, {\n      toValue: 0,\n      duration: 500,\n      easing: Easing.bezier(0.4, 0, 0.2, 1),\n      useNativeDriver: true,\n    }),\n  ]).start(() =&gt; setIsOpening(false));\n};\n\nconst rotation = rotateAnim.interpolate({\n  inputRange: [0, 1],\n  outputRange: ['0deg', '90deg'],\n});\n</code></pre>"},{"location":"frontend/control-acceso/pantallas/#permisos-de-ubicacion","title":"Permisos de Ubicaci\u00f3n","text":"<pre><code>stateDiagram-v2\n    [*] --&gt; Undetermined\n\n    Undetermined --&gt; Requesting: App solicita permiso\n    Requesting --&gt; Granted: Usuario acepta\n    Requesting --&gt; Denied: Usuario rechaza\n\n    Granted --&gt; Active: Obtener ubicaci\u00f3n\n    Active --&gt; Tracking: Actualizar cada 5s\n\n    Denied --&gt; ShowError: Mostrar mensaje\n    ShowError --&gt; Settings: Abrir configuraci\u00f3n\n    Settings --&gt; [*]\n\n    note right of Granted\n        Permisos:\n        - ACCESS_FINE_LOCATION\n        - NSLocationWhenInUseUsageDescription\n    end note</code></pre>"},{"location":"frontend/control-acceso/pantallas/#4-invitar-screen","title":"4. Invitar Screen","text":""},{"location":"frontend/control-acceso/pantallas/#descripcion_3","title":"Descripci\u00f3n","text":"<p>Pantalla para crear nuevos invitados (solo accesible para administradores).</p>"},{"location":"frontend/control-acceso/pantallas/#formulario-completo","title":"Formulario Completo","text":"<pre><code>graph TB\n    subgraph \"Invitar Screen\"\n        T[T\u00edtulo: Crear Invitado]\n\n        subgraph \"Datos Personales\"\n            RUT[Input: RUT]\n            Nombre[Input: Nombre]\n            Apellido[Input: Apellido]\n            Tel[Input: Tel\u00e9fono]\n            Email[Input: Email]\n        end\n\n        subgraph \"Datos Empresa\"\n            Empresa[Input: Empresa]\n            Motivo[TextArea: Motivo visita]\n        end\n\n        subgraph \"Fechas\"\n            FI[Selector: Fecha Inicial]\n            FF[Selector: Fecha Final]\n            CalI[Calendario Inicial]\n            CalF[Calendario Final]\n        end\n\n        subgraph \"Portones\"\n            Title[Portones Disponibles:]\n            P1[Checkbox: Port\u00f3n 1]\n            P2[Checkbox: Port\u00f3n 2]\n            PN[Checkbox: Port\u00f3n N]\n        end\n\n        Submit[Bot\u00f3n: Crear Invitado]\n        Cancel[Bot\u00f3n: Cancelar]\n    end\n\n    T --&gt; RUT\n    RUT --&gt; Nombre --&gt; Apellido --&gt; Tel --&gt; Email\n    Email --&gt; Empresa --&gt; Motivo\n    Motivo --&gt; FI\n    FI -.click.-&gt; CalI\n    CalI --&gt; FF\n    FF -.click.-&gt; CalF\n    CalF --&gt; Title\n    Title --&gt; P1 --&gt; P2 --&gt; PN\n    PN --&gt; Submit\n    Submit --&gt; Cancel</code></pre>"},{"location":"frontend/control-acceso/pantallas/#validaciones_1","title":"Validaciones","text":"<pre><code>const validateForm = (): string[] =&gt; {\n  const errors: string[] = [];\n\n  if (!rut || !validarRUT(rut)) {\n    errors.push('RUT inv\u00e1lido');\n  }\n  if (!nombre || nombre.length &lt; 2) {\n    errors.push('Nombre es requerido');\n  }\n  if (!apellido || apellido.length &lt; 2) {\n    errors.push('Apellido es requerido');\n  }\n  if (!telefono || telefono.length &lt; 9) {\n    errors.push('Tel\u00e9fono inv\u00e1lido');\n  }\n  if (!mail || !validarEmail(mail)) {\n    errors.push('Email inv\u00e1lido');\n  }\n  if (!fechaInicial) {\n    errors.push('Fecha inicial requerida');\n  }\n  if (!fechaFinal) {\n    errors.push('Fecha final requerida');\n  }\n  if (fechaInicial &amp;&amp; fechaFinal &amp;&amp; fechaInicial &gt;= fechaFinal) {\n    errors.push('Fecha final debe ser posterior a inicial');\n  }\n  if (!empresa || empresa.length &lt; 2) {\n    errors.push('Empresa es requerida');\n  }\n  if (portonesSeleccionados.length === 0) {\n    errors.push('Selecciona al menos un port\u00f3n');\n  }\n\n  return errors;\n};\n</code></pre>"},{"location":"frontend/control-acceso/pantallas/#flujo-de-creacion","title":"Flujo de Creaci\u00f3n","text":"<pre><code>sequenceDiagram\n    participant A as Admin\n    participant UI as Invitar UI\n    participant V as Validador\n    participant API as Backend API\n    participant DB as Database\n    participant N as Notification\n\n    A-&gt;&gt;UI: Completa formulario\n    A-&gt;&gt;UI: Selecciona fechas\n    A-&gt;&gt;UI: Selecciona portones\n    A-&gt;&gt;UI: Click \"Crear Invitado\"\n\n    UI-&gt;&gt;V: Validar formulario\n\n    alt Errores de validaci\u00f3n\n        V--&gt;&gt;UI: Lista de errores\n        UI-&gt;&gt;A: Mostrar errores\n    else Formulario v\u00e1lido\n        UI-&gt;&gt;UI: setIsLoading(true)\n        UI-&gt;&gt;API: POST /invitados/crear\n\n        API-&gt;&gt;DB: Insertar invitado\n        DB-&gt;&gt;DB: Generar c\u00f3digo 4 d\u00edgitos\n        DB--&gt;&gt;API: C\u00f3digo generado\n\n        API-&gt;&gt;N: Enviar notificaci\u00f3n (opcional)\n\n        API--&gt;&gt;UI: Success + c\u00f3digo\n\n        UI-&gt;&gt;A: Modal con c\u00f3digo\n        rect rgb(200, 255, 200)\n            Note over A,UI: C\u00f3digo: 1234&lt;br/&gt;Env\u00eda este c\u00f3digo al invitado\n        end\n\n        UI-&gt;&gt;UI: Limpiar formulario\n        UI-&gt;&gt;UI: setIsLoading(false)\n    end</code></pre>"},{"location":"frontend/control-acceso/pantallas/#seleccion-de-portones","title":"Selecci\u00f3n de Portones","text":"<pre><code>const PortonSelector = ({ portones, selected, onToggle }) =&gt; {\n  return (\n    &lt;View&gt;\n      &lt;Text&gt;Selecciona los portones permitidos:&lt;/Text&gt;\n      {portones.map((porton) =&gt; (\n        &lt;TouchableOpacity\n          key={porton.IdPorton}\n          onPress={() =&gt; onToggle(porton.IdPorton)}\n          className={`p-4 mb-2 rounded-lg ${\n            selected.includes(porton.IdPorton)\n              ? 'bg-blue-100 border-blue-500'\n              : 'bg-gray-100 border-gray-300'\n          }`}\n        &gt;\n          &lt;View className=\"flex-row items-center\"&gt;\n            {selected.includes(porton.IdPorton) &amp;&amp; (\n              &lt;Check className=\"text-blue-500 mr-2\" /&gt;\n            )}\n            &lt;Text className=\"font-semibold\"&gt;{porton.NombrePorton}&lt;/Text&gt;\n          &lt;/View&gt;\n          &lt;Text className=\"text-sm text-gray-600\"&gt;\n            {porton.LatitudPorton}, {porton.LongitudPorton}\n          &lt;/Text&gt;\n        &lt;/TouchableOpacity&gt;\n      ))}\n    &lt;/View&gt;\n  );\n};\n</code></pre>"},{"location":"frontend/control-acceso/pantallas/#modal-de-codigo-generado","title":"Modal de C\u00f3digo Generado","text":"<pre><code>const CodigoModal = ({ visible, codigo, onClose }) =&gt; {\n  return (\n    &lt;AlertDialog open={visible} onOpenChange={onClose}&gt;\n      &lt;AlertDialogContent&gt;\n        &lt;AlertDialogHeader&gt;\n          &lt;AlertDialogTitle&gt;\u2705 Invitado Creado&lt;/AlertDialogTitle&gt;\n          &lt;AlertDialogDescription&gt;\n            C\u00f3digo de acceso generado:\n          &lt;/AlertDialogDescription&gt;\n        &lt;/AlertDialogHeader&gt;\n\n        &lt;View className=\"items-center py-6\"&gt;\n          &lt;Text className=\"text-4xl font-bold text-blue-600\"&gt;\n            {codigo}\n          &lt;/Text&gt;\n          &lt;Text className=\"text-sm text-gray-600 mt-2\"&gt;\n            Env\u00eda este c\u00f3digo al invitado\n          &lt;/Text&gt;\n        &lt;/View&gt;\n\n        &lt;AlertDialogFooter&gt;\n          &lt;Button onPress={() =&gt; {\n            // Copiar al portapapeles\n            Clipboard.setString(codigo);\n          }}&gt;\n            Copiar C\u00f3digo\n          &lt;/Button&gt;\n          &lt;Button variant=\"outline\" onPress={onClose}&gt;\n            Cerrar\n          &lt;/Button&gt;\n        &lt;/AlertDialogFooter&gt;\n      &lt;/AlertDialogContent&gt;\n    &lt;/AlertDialog&gt;\n  );\n};\n</code></pre>"},{"location":"frontend/control-acceso/pantallas/#navegacion-entre-pantallas","title":"Navegaci\u00f3n entre Pantallas","text":""},{"location":"frontend/control-acceso/pantallas/#router-configuration","title":"Router Configuration","text":"<pre><code>// app/_layout.tsx\nexport default function Layout() {\n  return (\n    &lt;Stack&gt;\n      &lt;Stack.Screen \n        name=\"index\" \n        options={{ headerShown: false }} \n      /&gt;\n      &lt;Stack.Screen \n        name=\"LoginScreen\" \n        options={{ headerShown: false }} \n      /&gt;\n      &lt;Stack.Screen \n        name=\"ControlScreen\" \n        options={{ \n          title: 'Control de Acceso',\n          headerLeft: () =&gt; &lt;LogoutButton /&gt;\n        }} \n      /&gt;\n      &lt;Stack.Screen \n        name=\"InvitarScreen\" \n        options={{ \n          title: 'Crear Invitado',\n          headerLeft: () =&gt; &lt;BackButton /&gt;\n        }} \n      /&gt;\n    &lt;/Stack&gt;\n  );\n}\n</code></pre>"},{"location":"frontend/control-acceso/pantallas/#proximos-pasos","title":"Pr\u00f3ximos Pasos","text":"<ul> <li>Integraciones IoT</li> <li>API y Backend</li> <li>Despliegue</li> </ul>"},{"location":"frontend/extraccion/websocket-comunicacion/","title":"\ud83d\udd04 WebSocket Cami\u00f3n-Excavadora (Frontend)","text":""},{"location":"frontend/extraccion/websocket-comunicacion/#descripcion-general","title":"\ud83d\udcf1 Descripci\u00f3n General","text":"<p>Implementaci\u00f3n del cliente WebSocket en React Native (Expo) para comunicaci\u00f3n en tiempo real entre camiones y excavadoras en operaciones de extracci\u00f3n minera.</p> <pre><code>graph TB\n    subgraph \"Frontend Architecture\"\n        Layout[_layout.tsx]\n        Store[Redux Store]\n        AsyncS[AsyncStorage]\n        WS[WebSocket Client]\n\n        Layout --&gt;|Inicializa| WS\n        WS --&gt;|Eventos| Layout\n        Layout --&gt;|Actualiza| Store\n        Layout --&gt;|Persiste| AsyncS\n    end\n\n    subgraph \"Azure\"\n        AWPS[Web PubSub]\n    end\n\n    WS &lt;--&gt;|wss://| AWPS\n\n    style AWPS fill:#0078D4,stroke:#fff,stroke-width:2px,color:#fff</code></pre>"},{"location":"frontend/extraccion/websocket-comunicacion/#arquitectura","title":"\ud83c\udfd7\ufe0f Arquitectura","text":""},{"location":"frontend/extraccion/websocket-comunicacion/#ubicacion-de-archivos","title":"Ubicaci\u00f3n de Archivos","text":"Estructura de Proyecto <pre><code>app/\n\u251c\u2500\u2500 (pantallas)/\n\u2502   \u2514\u2500\u2500 Main/\n\u2502       \u251c\u2500\u2500 maquinariaV2/          # Camiones\n\u2502       \u2502   \u251c\u2500\u2500 _layout.tsx        \u2b50 WebSocket Cami\u00f3n\n\u2502       \u2502   \u251c\u2500\u2500 index.tsx          # UI Cami\u00f3n\n\u2502       \u2502   \u2514\u2500\u2500 excavadora/\n\u2502       \u2502       \u2514\u2500\u2500 index.tsx      \u2b50 UI Excavadora\n\u2502       \u2514\u2500\u2500 minacentro/            # Excavadoras\n\u2502           \u2514\u2500\u2500 _layout.tsx        \u2b50 WebSocket Excavadora\n</code></pre>"},{"location":"frontend/extraccion/websocket-comunicacion/#inicializacion-websocket","title":"\ud83d\udd0c Inicializaci\u00f3n WebSocket","text":""},{"location":"frontend/extraccion/websocket-comunicacion/#layout-principal-excavadora","title":"Layout Principal (Excavadora)","text":"maquinariaV2/_layout.tsx <pre><code>export default function Layout() {\n  const [wsConnection, setWsConnection] = useState&lt;WebSocket | null&gt;(null);\n  const [isConnected, setIsConnected] = useState(false);\n  const Equipo = useSelector((state: RootState) =&gt; state.global.Equipo);\n\n  // Sistema de deduplicaci\u00f3n\n  const processedMessagesRef = React.useRef(new Set&lt;string&gt;());\n\n  const initializeWebSocket = async () =&gt; {\n    if (!Equipo) {\n      console.log('[MAQUINARIA] No hay Equipo disponible');\n      return;\n    }\n\n    try {\n      // 1. Obtener URL de negociaci\u00f3n\n      const response = await fetch(\n        `https://elaltodev.azurewebsites.net/ws/negotiate?user_id=${Equipo}`,\n        {\n          method: 'GET',\n          headers: { 'Content-Type': 'application/json' }\n        }\n      );\n\n      const responseData = await response.json();\n      const url = responseData.url;\n\n      // 2. Crear conexi\u00f3n WebSocket\n      const ws = new WebSocket(url, 'json.webpubsub.azure.v1');\n\n      ws.onopen = () =&gt; {\n        console.log(`[MAQUINARIA] WebSocket conectado: ${Equipo}`);\n        setWsConnection(ws);\n        setIsConnected(true);\n      };\n\n      ws.onmessage = (event) =&gt; {\n        handleMessage(event);\n      };\n\n      ws.onerror = (error) =&gt; {\n        console.error('[MAQUINARIA] WebSocket error:', error);\n        setIsConnected(false);\n      };\n\n      ws.onclose = () =&gt; {\n        console.log('[MAQUINARIA] WebSocket cerrado, reconectando...');\n        setIsConnected(false);\n        setTimeout(initializeWebSocket, 3000);\n      };\n    } catch (error) {\n      console.error('[MAQUINARIA] Failed to initialize:', error);\n    }\n  };\n\n  // Inicializar al tener Equipo\n  useEffect(() =&gt; {\n    if (Equipo) {\n      initializeWebSocket();\n    }\n\n    return () =&gt; {\n      wsConnection?.close();\n    };\n  }, [Equipo]);\n\n  return (\n    &lt;BackgroundHeader&gt;\n      &lt;View className=\"flex-1\"&gt;\n        &lt;Slot /&gt;\n      &lt;/View&gt;\n    &lt;/BackgroundHeader&gt;\n  );\n}\n</code></pre>"},{"location":"frontend/extraccion/websocket-comunicacion/#manejo-de-eventos","title":"\ud83d\udce8 Manejo de Eventos","text":""},{"location":"frontend/extraccion/websocket-comunicacion/#procesamiento-de-mensajes","title":"Procesamiento de Mensajes","text":"Sistema de Deduplicaci\u00f3n <pre><code>ws.onmessage = (event) =&gt; {\n  try {\n    const json_data = JSON.parse(event.data);\n\n    // Ignorar mensajes de sistema\n    if (json_data.type === 'system') return;\n    if (json_data.type !== 'message' || !json_data.data) return;\n\n    const messageData = json_data.data;\n    const messageType = messageData?.data || messageData?.message;\n\n    if (!messageType) return;\n\n    // CREAR ID \u00daNICO PARA DEDUPLICACI\u00d3N\n    const idMovimiento = messageData?.IdMovimiento || \n                         messageData?.trip_data?.IdMovimiento;\n    const equipoMsg = messageData?.equipo || \n                      messageData?.trip_data?.Equipo || '';\n    const timestamp = messageData?.timestamp || \n                      json_data?.timestamp || '';\n    const messageId = `${messageType}-${idMovimiento}-${equipoMsg}-${timestamp}`;\n\n    // Verificar si ya procesamos este mensaje\n    if (processedMessagesRef.current.has(messageId)) {\n      return; // Duplicado, ignorar\n    }\n\n    // Marcar como procesado\n    processedMessagesRef.current.add(messageId);\n\n    // Limpiar despu\u00e9s de 5 segundos\n    setTimeout(() =&gt; {\n      processedMessagesRef.current.delete(messageId);\n    }, 5000);\n\n    // Procesar evento\n    handleEvent(messageType, messageData);\n  } catch (error) {\n    console.error('[MAQUINARIA] Error al procesar:', error);\n  }\n};\n</code></pre>"},{"location":"frontend/extraccion/websocket-comunicacion/#handlers-por-tipo-de-evento","title":"Handlers por Tipo de Evento","text":"ViajeCreadoViajeActualizadoCargaFinalizadaViajeFinalizadoViajeCancelado <pre><code>case 'ViajeCreado':\n  const tripData = messageData?.trip_data;\n  if (tripData) {\n    console.log('[EXCAVADORA] Nuevo viaje:', tripData.IdMovimiento);\n\n    // Guardar en AsyncStorage\n    AsyncStorage.getItem('websocket_trips').then(existing =&gt; {\n      const trips = existing ? JSON.parse(existing) : [];\n      const newTrips = [...trips, {\n        ...tripData,\n        receivedAt: new Date().toISOString()\n      }];\n      AsyncStorage.setItem('websocket_trips', JSON.stringify(newTrips));\n    });\n\n    // Mostrar notificaci\u00f3n\n    showNotification({\n      title: 'Nuevo Viaje',\n      message: `Cami\u00f3n ${tripData.Patente} disponible`,\n      type: 'info'\n    });\n  }\n  break;\n</code></pre> <pre><code>case 'ViajeActualizado':\n  const idMovimiento = messageData?.IdMovimiento;\n  const horaFinCarga = messageData?.HoraFinCarga;\n\n  // Validar si es finalizaci\u00f3n de carga\n  const tieneHoraFinCarga = horaFinCarga &amp;&amp; \n                            horaFinCarga !== null &amp;&amp; \n                            horaFinCarga !== 'null' &amp;&amp; \n                            horaFinCarga !== 'none' &amp;&amp; \n                            horaFinCarga !== '' &amp;&amp; \n                            String(horaFinCarga).trim() !== '';\n\n  if (tieneHoraFinCarga) {\n    console.log('[EXCAVADORA] Carga finalizada:', idMovimiento);\n\n    // Actualizar viaje en storage\n    AsyncStorage.getItem('websocket_trips').then(existing =&gt; {\n      if (existing) {\n        const trips = JSON.parse(existing);\n        const updatedTrips = trips.map(trip =&gt;\n          trip.IdMovimiento === idMovimiento\n            ? { ...trip, HoraFinCarga: horaFinCarga, estado: 'cargado' }\n            : trip\n        );\n        AsyncStorage.setItem('websocket_trips', JSON.stringify(updatedTrips));\n      }\n    });\n\n    showNotification({\n      title: 'Carga Completa',\n      message: `Viaje ${idMovimiento} cargado exitosamente`,\n      type: 'success'\n    });\n  } else {\n    console.log('[EXCAVADORA] Actualizaci\u00f3n de viaje:', idMovimiento);\n  }\n  break;\n</code></pre> <pre><code>case 'CargaFinalizada':\n  const idMovimientoCarga = messageData?.IdMovimiento;\n  console.log('[EXCAVADORA] CargaFinalizada:', idMovimientoCarga);\n\n  // Guardar se\u00f1al para auto-finalizaci\u00f3n\n  AsyncStorage.setItem(\n    `carga_finalizada_${idMovimientoCarga}`,\n    new Date().toISOString()\n  );\n\n  // Remover de lista activa\n  AsyncStorage.getItem('websocket_trips').then(existing =&gt; {\n    if (existing) {\n      const trips = JSON.parse(existing);\n      const filteredTrips = trips.filter(\n        trip =&gt; trip.IdMovimiento !== idMovimientoCarga\n      );\n      AsyncStorage.setItem('websocket_trips', JSON.stringify(filteredTrips));\n    }\n  });\n  break;\n</code></pre> <pre><code>case 'ViajeFinalizado':\n  const idMovimientoFin = messageData?.IdMovimiento;\n  console.log('[EXCAVADORA] ViajeFinalizado:', idMovimientoFin);\n\n  // Limpiar completamente\n  AsyncStorage.multiRemove([\n    `carga_finalizada_${idMovimientoFin}`,\n    `viaje_activo_${idMovimientoFin}`\n  ]);\n\n  // Actualizar contador de viajes completados\n  AsyncStorage.getItem('viajes_completados_hoy').then(count =&gt; {\n    const newCount = (parseInt(count || '0') + 1).toString();\n    AsyncStorage.setItem('viajes_completados_hoy', newCount);\n  });\n\n  showNotification({\n    title: 'Viaje Finalizado',\n    message: `Viaje ${idMovimientoFin} completado`,\n    type: 'success'\n  });\n  break;\n</code></pre> <pre><code>case 'ViajeCancelado':\n  const idMovimientoCancelado = messageData?.IdMovimiento;\n  console.log('[EXCAVADORA] ViajeCancelado:', idMovimientoCancelado);\n\n  // Remover de storage\n  AsyncStorage.getItem('websocket_trips').then(existing =&gt; {\n    if (existing) {\n      const trips = JSON.parse(existing);\n      const filteredTrips = trips.filter(\n        trip =&gt; trip.IdMovimiento !== idMovimientoCancelado\n      );\n      AsyncStorage.setItem('websocket_trips', JSON.stringify(filteredTrips));\n    }\n  });\n\n  showNotification({\n    title: 'Viaje Cancelado',\n    message: `Viaje ${idMovimientoCancelado} ha sido cancelado`,\n    type: 'warning'\n  });\n  break;\n</code></pre>"},{"location":"frontend/extraccion/websocket-comunicacion/#ui-lista-de-viajes-disponibles","title":"\ud83c\udfa8 UI: Lista de Viajes Disponibles","text":""},{"location":"frontend/extraccion/websocket-comunicacion/#componente-excavadora","title":"Componente Excavadora","text":"excavadora/index.tsx - Viajes WebSocket <pre><code>export default function PantallaExcavadora() {\n  const [viajesDisponibles, setViajesDisponibles] = useState&lt;ViajeAPI[]&gt;([]);\n  const [viajeSeleccionado, setViajeSeleccionado] = useState&lt;ViajeAPI | null&gt;(null);\n  const [currentViajeIndex, setCurrentViajeIndex] = useState(0);\n\n  // Cargar viajes desde AsyncStorage\n  useEffect(() =&gt; {\n    const loadTrips = async () =&gt; {\n      try {\n        const stored = await AsyncStorage.getItem('websocket_trips');\n        if (stored) {\n          const trips = JSON.parse(stored);\n          setViajesDisponibles(trips);\n\n          if (trips.length &gt; 0 &amp;&amp; !viajeSeleccionado) {\n            setViajeSeleccionado(trips[0]);\n            setCurrentViajeIndex(0);\n          }\n        }\n      } catch (error) {\n        console.error('Error loading trips:', error);\n      }\n    };\n\n    loadTrips();\n\n    // Recargar cada 2 segundos\n    const interval = setInterval(loadTrips, 2000);\n    return () =&gt; clearInterval(interval);\n  }, []);\n\n  // Navegaci\u00f3n entre viajes\n  const handleNextTrip = () =&gt; {\n    if (currentViajeIndex &lt; viajesDisponibles.length - 1) {\n      const nextIndex = currentViajeIndex + 1;\n      setCurrentViajeIndex(nextIndex);\n      setViajeSeleccionado(viajesDisponibles[nextIndex]);\n    }\n  };\n\n  const handlePrevTrip = () =&gt; {\n    if (currentViajeIndex &gt; 0) {\n      const prevIndex = currentViajeIndex - 1;\n      setCurrentViajeIndex(prevIndex);\n      setViajeSeleccionado(viajesDisponibles[prevIndex]);\n    }\n  };\n\n  return (\n    &lt;View&gt;\n      {viajesDisponibles.length &gt; 0 ? (\n        &lt;View&gt;\n          {/* Indicador de posici\u00f3n */}\n          &lt;Text&gt;\n            Viaje {currentViajeIndex + 1} de {viajesDisponibles.length}\n          &lt;/Text&gt;\n\n          {/* Datos del viaje actual */}\n          &lt;ViajeCard viaje={viajeSeleccionado} /&gt;\n\n          {/* Navegaci\u00f3n */}\n          &lt;View style={styles.navigation}&gt;\n            &lt;Button \n              onPress={handlePrevTrip}\n              disabled={currentViajeIndex === 0}\n            &gt;\n              Anterior\n            &lt;/Button&gt;\n\n            &lt;Button \n              onPress={handleNextTrip}\n              disabled={currentViajeIndex === viajesDisponibles.length - 1}\n            &gt;\n              Siguiente\n            &lt;/Button&gt;\n          &lt;/View&gt;\n\n          {/* Bot\u00f3n de iniciar carga */}\n          &lt;Button \n            onPress={() =&gt; iniciarCarga(viajeSeleccionado.IdMovimiento)}\n          &gt;\n            Iniciar Carga\n          &lt;/Button&gt;\n        &lt;/View&gt;\n      ) : (\n        &lt;EmptyState message=\"No hay viajes disponibles\" /&gt;\n      )}\n    &lt;/View&gt;\n  );\n}\n</code></pre>"},{"location":"frontend/extraccion/websocket-comunicacion/#reconexion-automatica","title":"\ud83d\udd04 Reconexi\u00f3n Autom\u00e1tica","text":"Sistema de Reconexi\u00f3n <pre><code>ws.onclose = () =&gt; {\n  console.log('[MAQUINARIA] WebSocket cerrado, reconectando en 3s...');\n  setIsConnected(false);\n  setWsConnection(null);\n\n  // Intentar reconectar\n  const reconnectTimeout = setTimeout(() =&gt; {\n    initializeWebSocket();\n  }, 3000);\n\n  return () =&gt; clearTimeout(reconnectTimeout);\n};\n</code></pre> Estrategia de Reconexi\u00f3n <ul> <li>\u23f1\ufe0f Delay fijo: 3 segundos</li> <li>\u267e\ufe0f Intentos ilimitados</li> <li>\ud83d\udd04 Reinicia autom\u00e1ticamente</li> <li>\ud83d\udcdd Logs detallados de cada intento</li> <li>\u2705 Preserva estado de la aplicaci\u00f3n</li> </ul>"},{"location":"frontend/extraccion/websocket-comunicacion/#persistencia-de-datos","title":"\ud83d\udcbe Persistencia de Datos","text":""},{"location":"frontend/extraccion/websocket-comunicacion/#asyncstorage-schema","title":"AsyncStorage Schema","text":"Estructura de Datos <pre><code>interface WebSocketTrip {\n  IdMovimiento: number;\n  IdJornada: number;\n  Usuario: string;\n  Equipo: string;\n  Patente: string;\n  IdProducto: number;\n  DescripcionProducto: string;\n  Conductor: string;\n  HoraInicio: string;\n  HoraCarga?: string;\n  HoraFinCarga?: string;\n  LatitudCarga: string;\n  LongitudCarga: string;\n  receivedAt: string; // Timestamp de recepci\u00f3n\n  estado?: 'pendiente' | 'en_carga' | 'cargado' | 'finalizado';\n}\n\n// Keys de AsyncStorage\nconst STORAGE_KEYS = {\n  TRIPS: 'websocket_trips',\n  CARGA_FINALIZADA: (id) =&gt; `carga_finalizada_${id}`,\n  VIAJE_ACTIVO: (id) =&gt; `viaje_activo_${id}`,\n  VIAJES_COMPLETADOS: 'viajes_completados_hoy'\n};\n</code></pre>"},{"location":"frontend/extraccion/websocket-comunicacion/#limpieza-de-datos","title":"Limpieza de Datos","text":"Limpieza al Iniciar Jornada <pre><code>useEffect(() =&gt; {\n  if (Equipo) {\n    // Limpiar viajes antiguos\n    AsyncStorage.getItem('websocket_trips').then(existing =&gt; {\n      if (existing) {\n        console.log('[MAQUINARIA] Limpiando viajes antiguos');\n        AsyncStorage.removeItem('websocket_trips');\n      }\n    });\n\n    initializeWebSocket();\n  }\n}, [Equipo]);\n</code></pre>"},{"location":"frontend/extraccion/websocket-comunicacion/#notificaciones","title":"\ud83d\udd14 Notificaciones","text":"Sistema de Notificaciones <pre><code>import * as Notifications from 'expo-notifications';\n\n// Configuraci\u00f3n\nNotifications.setNotificationHandler({\n  handleNotification: async () =&gt; ({\n    shouldShowAlert: true,\n    shouldPlaySound: true,\n    shouldSetBadge: false,\n  }),\n});\n\n// Mostrar notificaci\u00f3n\nasync function showNotification(data: {\n  title: string;\n  message: string;\n  type: 'info' | 'success' | 'warning' | 'error';\n}) {\n  await Notifications.scheduleNotificationAsync({\n    content: {\n      title: data.title,\n      body: data.message,\n      data: { type: data.type }\n    },\n    trigger: null // Inmediato\n  });\n}\n</code></pre>"},{"location":"frontend/extraccion/websocket-comunicacion/#debugging","title":"\ud83d\udc1b Debugging","text":"Herramientas de Debug <pre><code>// Consola de eventos\nconst [debugLogs, setDebugLogs] = useState&lt;string[]&gt;([]);\n\nconst addDebugLog = (message: string) =&gt; {\n  const timestamp = new Date().toISOString();\n  setDebugLogs(prev =&gt; [\n    `[${timestamp}] ${message}`,\n    ...prev.slice(0, 49) // Mantener \u00faltimos 50\n  ]);\n};\n\n// En cada evento\nws.onmessage = (event) =&gt; {\n  addDebugLog(`Received: ${event.data}`);\n  // ...resto del c\u00f3digo\n};\n\n// UI de debug\n&lt;ScrollView style={styles.debugConsole}&gt;\n  {debugLogs.map((log, i) =&gt; (\n    &lt;Text key={i} style={styles.logText}&gt;{log}&lt;/Text&gt;\n  ))}\n&lt;/ScrollView&gt;\n</code></pre>"},{"location":"frontend/extraccion/websocket-comunicacion/#manejo-de-errores","title":"\u26a0\ufe0f Manejo de Errores","text":"Errores Comunes Error Causa Soluci\u00f3n <code>Connection refused</code> Backend ca\u00eddo Verificar endpoint <code>Token expired</code> Sesi\u00f3n &gt; 1 hora Renovar en negotiate <code>Duplicate message</code> Retry del servidor Sistema de deduplicaci\u00f3n <code>Parse error</code> JSON malformado Validar estructura <code>AsyncStorage full</code> Demasiados viajes Limpiar peri\u00f3dicamente"},{"location":"frontend/extraccion/websocket-comunicacion/#estados-de-conexion","title":"\ud83d\udcca Estados de Conexi\u00f3n","text":"Indicador Visual <pre><code>function ConnectionIndicator() {\n  const [isConnected, setIsConnected] = useState(false);\n\n  return (\n    &lt;View style={styles.indicator}&gt;\n      &lt;View \n        style={[\n          styles.dot, \n          { backgroundColor: isConnected ? '#10b981' : '#ef4444' }\n        ]} \n      /&gt;\n      &lt;Text&gt;\n        {isConnected ? 'Conectado' : 'Desconectado'}\n      &lt;/Text&gt;\n    &lt;/View&gt;\n  );\n}\n</code></pre>"},{"location":"frontend/extraccion/websocket-comunicacion/#testing","title":"\ud83e\uddea Testing","text":"Pruebas del Cliente <pre><code>import { renderHook, act } from '@testing-library/react-hooks';\nimport WS from 'jest-websocket-mock';\n\ndescribe('WebSocket Client', () =&gt; {\n  let server: WS;\n\n  beforeEach(async () =&gt; {\n    server = new WS('ws://localhost:1234');\n  });\n\n  afterEach(() =&gt; {\n    WS.clean();\n  });\n\n  it('should connect successfully', async () =&gt; {\n    const { result } = renderHook(() =&gt; useWebSocket());\n\n    await act(async () =&gt; {\n      await server.connected;\n    });\n\n    expect(result.current.isConnected).toBe(true);\n  });\n\n  it('should handle ViajeCreado event', async () =&gt; {\n    const { result } = renderHook(() =&gt; useWebSocket());\n\n    await server.connected;\n\n    act(() =&gt; {\n      server.send(JSON.stringify({\n        type: 'message',\n        data: {\n          data: 'ViajeCreado',\n          trip_data: { IdMovimiento: 123 }\n        }\n      }));\n    });\n\n    expect(result.current.trips).toHaveLength(1);\n  });\n});\n</code></pre>"},{"location":"frontend/extraccion/websocket-comunicacion/#compatibilidad","title":"\ud83d\udcf1 Compatibilidad","text":"Requisitos <ul> <li>React Native / Expo SDK 49+</li> <li>AsyncStorage</li> <li>WebSocket API nativa</li> <li>Permisos de notificaciones (opcional)</li> <li>Android 8.0+ / iOS 13.0+</li> </ul>"},{"location":"frontend/extraccion/websocket-comunicacion/#referencias","title":"\ud83d\udd17 Referencias","text":"Enlaces \u00datiles <ul> <li>React Native WebSocket</li> <li>Expo AsyncStorage</li> <li>Azure Web PubSub Client Protocol</li> <li>Backend: API WebSocket</li> </ul>"},{"location":"frontend/knock/knock-nextjs/","title":"Integraci\u00f3n Knock (Next.js / React) \ud83d\udd14","text":""},{"location":"frontend/knock/knock-nextjs/#resumen","title":"Resumen","text":"<p>Gu\u00eda para integrar Knock en la web (Next.js). Describe los providers, el componente <code>NotificationBell</code> y manejo de acciones (leer, archivar, marcar todo le\u00eddo). Incluye notas sobre manejo del feed y de errores observados en el repositorio.</p> Archivos clave <ul> <li><code>components/knock/KnockProvider.tsx</code> (provider wrapper)</li> <li><code>components/knock/NotificationBell.tsx</code> (campana y l\u00f3gica de feed)</li> <li><code>app/(LogiPath)/.../layout.tsx</code> (uso de <code>KnockProviderWrapper</code> desde el layout de admin)</li> </ul>"},{"location":"frontend/knock/knock-nextjs/#instalacion-y-setup","title":"Instalaci\u00f3n y setup","text":"<ul> <li>Paquetes: <code>@knocklabs/react</code> (web)</li> <li>Configura <code>NEXT_PUBLIC_KNOCK_API_KEY</code> en variables de entorno para el cliente.</li> </ul> <p>\u26a0\ufe0f Igual que en m\u00f3vil: no exponer <code>KNOCK_API_SECRET</code> en el cliente. Los triggers que requieren la secret deber\u00edan ejecutarse desde un backend seguro.</p>"},{"location":"frontend/knock/knock-nextjs/#providers-y-uso","title":"Providers y uso","text":"<p>El repo tiene un <code>KnockProviderWrapper</code> que lee la <code>apiKey</code> desde <code>process.env.NEXT_PUBLIC_KNOCK_API_KEY</code> y envuelve la app con <code>KnockProvider</code> y <code>KnockFeedProvider</code>.</p> <pre><code>&lt;KnockProvider apiKey={apiKey} userId={userId} userToken={userToken}&gt;\n  &lt;KnockFeedProvider feedId={feedId}&gt;{children}&lt;/KnockFeedProvider&gt;\n&lt;/KnockProvider&gt;\n</code></pre>"},{"location":"frontend/knock/knock-nextjs/#puntos-importantes-de-conexion-con-knock","title":"Puntos importantes de conexi\u00f3n con Knock \ud83d\udd17","text":"<ul> <li><code>KNOCK_FEED_ID</code>: Identificador del feed in-app (feedId / channel del feed usado por la UI web para mostrar notificaciones en el dashboard).</li> <li><code>KNOCK_EXPO_CHANNEL_ID</code>: Channel ID del canal de push (si tambi\u00e9n registras dispositivos m\u00f3viles desde la web o integras con Expo).</li> <li>Campos din\u00e1micos en payloads:</li> <li><code>titulo</code>: Permite personalizar el t\u00edtulo de la notificaci\u00f3n desde el trigger (ej. <code>titulo: '\u274c Conductor cancel\u00f3 viaje'</code>).</li> <li><code>descripcion</code>: El texto del mensaje (p. ej. <code>El conductor ${Nombre} ha cancelado el viaje #${viaje.Id}</code>) se muestra como <code>descripcion</code> en el dashboard de Knock y en los bloques de la notificaci\u00f3n.</li> <li><code>recipients</code>: Puedes direccionar notificaciones a usuarios/roles (<code>{ id: 'pruebaKnock' }</code>) sin crear canales separados por cada evento.</li> </ul>"},{"location":"frontend/knock/knock-nextjs/#notificationbell","title":"<code>NotificationBell</code>","text":"<ul> <li>Usa <code>useKnockFeed()</code> para obtener <code>feedClient</code>.</li> <li>Ejecuta <code>feed.fetch()</code> e intenta <code>feed.listenForUpdates()</code> para real-time.</li> <li>Provee acciones: marcar como le\u00eddo, marcar todo como le\u00eddo, archivar.</li> </ul> <p>Comportamientos observados en el c\u00f3digo: - <code>handleArchiveNotification</code> intenta <code>feedClient.feedClient.markAsArchived([item])</code>. Si falla, intenta otros enfoques (p.ej. <code>messages.batchUpdateStatuses</code>). Se registran errores para mostrar al usuario. - <code>unreadCount</code> y <code>items</code> se obtienen de <code>feedClient.useFeedStore().metadata.unread_count</code> y <code>.items</code>.</p>"},{"location":"frontend/knock/knock-nextjs/#ejemplo-de-flujo-cancelacion-de-viaje","title":"Ejemplo de flujo (Cancelaci\u00f3n de viaje)","text":"<p>Aunque la cancelaci\u00f3n se hace desde la app m\u00f3vil en el repo, en web la notificaci\u00f3n llegar\u00e1 al feed/usuarios cuando el workflow sea disparado. El flujo:</p> <pre><code>sequenceDiagram\n  participant App as App M\u00f3vil\n  participant Knock as Knock\n  participant Web as Web Admin\n  App-&gt;&gt;Knock: Trigger workflow (cancelaci\u00f3n)\n  Knock--&gt;&gt;Web: Nueva notificaci\u00f3n en feed\n  Web-&gt;&gt;Knock: markAsRead / markAsArchived (acciones del admin)</code></pre>"},{"location":"frontend/knock/knock-nextjs/#api-y-triggers-recap","title":"API y triggers (recap)","text":"<p>Si tu servicio backend debe disparar workflows en Knock:</p> <pre><code>curl -X POST \"https://api.knock.app/v1/workflows/YOUR_WORKFLOW_KEY/trigger\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer $KNOCK_API_SECRET\" \\\n  -d '{\"data\": {...}, \"recipients\": [{\"id\":\"pruebaKnock\"}] }'\n</code></pre>"},{"location":"frontend/knock/knock-nextjs/#manejo-de-errores-y-debugging","title":"Manejo de errores y debugging","text":"<ul> <li>Si <code>feed.fetch()</code> falla, revisar consola y permisos de la <code>apiKey</code>/<code>feedId</code>.</li> <li>Para archivado: revisar <code>item.message_id</code>, <code>item.message?.id</code> o <code>item.data?.message_id</code> \u2014 el c\u00f3digo del repo trata de varios candidatos antes de reclamar error al usuario.</li> </ul>"},{"location":"frontend/knock/knock-nextjs/#buenas-practicas","title":"Buenas pr\u00e1cticas","text":"<ul> <li>Almacenar <code>NEXT_PUBLIC_*</code> para claves p\u00fablicas y <code>KNOCK_API_SECRET</code> \u00fanicamente en servidor.</li> <li>Manejar y mostrar errores de archivado para que los administradores sepan si la acci\u00f3n no se ejecut\u00f3 correctamente.</li> </ul>"},{"location":"frontend/knock/knock-nextjs/#referencias-en-el-repo","title":"Referencias en el repo","text":"<ul> <li><code>components/knock/KnockProvider.tsx</code></li> <li><code>components/knock/NotificationBell.tsx</code></li> <li><code>app/(LogiPath)/.../layout.tsx</code> (donde se usa <code>KnockProviderWrapper</code>)</li> </ul>"},{"location":"frontend/knock/knock-react-native/","title":"Integraci\u00f3n Knock (React Native / Expo) \ud83d\udd14","text":""},{"location":"frontend/knock/knock-react-native/#resumen","title":"Resumen","text":"<p>Documentaci\u00f3n de la integraci\u00f3n de Knock en la aplicaci\u00f3n m\u00f3vil (Expo + React Native). Aqu\u00ed se muestran los ficheros relevantes del repositorio, flujos concretos (ej. cancelaci\u00f3n de viaje) y ejemplos de uso sin exponer credenciales.</p> Archivos clave <ul> <li><code>app/services/knock.ts</code> (cliente y utilidades)</li> <li><code>app/(main)/v2Admin/_layout.tsx</code> (registro de token con <code>KnockPushRegistrar</code>)</li> <li><code>components/viajes_card.tsx</code> (ejemplo de uso: <code>notificarSistema</code> en cancelaci\u00f3n)</li> </ul>"},{"location":"frontend/knock/knock-react-native/#paquetes-y-configuracion","title":"Paquetes y configuraci\u00f3n \ud83d\udd27","text":"<ul> <li>Paquete principal (m\u00f3vil): <code>@knocklabs/react-native</code></li> </ul> <p>Variables de entorno (no subir secretos al repo): - <code>NEXT_PUBLIC_KNOCK_API_KEY</code> o <code>KNOCK_PUBLIC_API_KEY</code> (clave p\u00fablica) - <code>KNOCK_API_SECRET</code> (clave secreta \u2014 no usar en clientes m\u00f3viles en producci\u00f3n) - <code>KNOCK_FEED_ID</code> - <code>KNOCK_EXPO_CHANNEL_ID</code></p>"},{"location":"frontend/knock/knock-react-native/#puntos-importantes-de-conexion-con-knock","title":"Puntos importantes de conexi\u00f3n con Knock \ud83d\udd17","text":"<ul> <li><code>KNOCK_FEED_ID</code>: Identificador del feed in-app (feedId / channel del feed que se muestra dentro de la app). Usado por <code>KnockFeedProvider</code> para mostrar notificaciones en la UI.</li> <li><code>KNOCK_EXPO_CHANNEL_ID</code>: Channel ID del canal de push para Expo (usado por <code>user.setChannelData</code> para registrar tokens y enviar push a dispositivos).</li> <li>Campos din\u00e1micos en payloads:</li> <li><code>titulo</code>: Permite personalizar el t\u00edtulo de la notificaci\u00f3n desde el c\u00f3digo (ej. <code>titulo: '\u274c Conductor cancel\u00f3 viaje'</code>).</li> <li><code>descripcion</code>: El texto como <code>`El conductor ${Nombre} ha cancelado el viaje #${viaje.Id}`</code> se mapea a <code>descripcion</code> en el dashboard de Knock y se muestra en el feed; as\u00ed personalizas el contenido sin crear channels nuevos.</li> <li><code>recipients</code>: Lista de destinatarios (p. ej. <code>{ id: 'oruebaKnock' }</code>) para direccionar la notificaci\u00f3n a usuarios o roles sin crear un channel por evento.</li> </ul> <p>\u26a0\ufe0f En el c\u00f3digo del repo se usa un <code>fetch</code> directo a la API de Knock desde el cliente (<code>app/services/knock.ts</code>). Esto funciona, pero como buena pr\u00e1ctica se recomienda ejecutar triggers de workflows que requieren <code>KNOCK_API_SECRET</code> desde un backend para no exponer secretos en la app.</p>"},{"location":"frontend/knock/knock-react-native/#como-se-registra-el-dispositivo-push","title":"C\u00f3mo se registra el dispositivo (push)","text":"<ol> <li>En <code>_layout.tsx</code> se obtiene el <code>userId</code> (por ejemplo <code>Usuario</code>, <code>CodigoTransportista</code> o <code>RutConductor</code>).</li> <li><code>registerForPushNotificationsAsync()</code> obtiene el token de Expo (o de la plataforma).</li> <li><code>KnockPushRegistrar</code> (componente) usa <code>useKnockClient(userId)</code> y llama a <code>registrarTokenPush(knockClient, pushToken)</code>.</li> </ol> <p>Ejemplo (resumen):</p> <pre><code>// _layout.tsx (KnockPushRegistrar)\nconst knockClient = useKnockClient(userId);\nReact.useEffect(() =&gt; {\n  const registerPush = async () =&gt; {\n    const pushToken = await registerForPushNotificationsAsync();\n    await registrarTokenPush(knockClient, pushToken);\n  };\n  registerPush();\n}, [userId, knockClient]);\n</code></pre>"},{"location":"frontend/knock/knock-react-native/#ejemplo-de-trigger-cancelacion-de-viaje","title":"Ejemplo de trigger (cancelaci\u00f3n de viaje)","text":"<p>En <code>components/viajes_card.tsx</code> existe la funci\u00f3n <code>handleCancelarViaje</code> que realiza el flujo:</p> <ol> <li>Llama al endpoint de backend para marcar el viaje como cancelado.</li> <li>Llama a <code>notificarSistema(...)</code> para notificar via Knock al feed o a usuarios espec\u00edficos.</li> </ol> <p>Snippet (uso dentro de <code>handleCancelarViaje</code>):</p> <pre><code>await notificarSistema(\n  'test-notification', // workflowKey\n  'logi-path', // sistema\n  `El conductor ${Nombre} ha cancelado el viaje #${viaje.Id}`,\n  {\n    titulo: '\u274c Conductor cancel\u00f3 viaje',\n    viajeId: viaje.Id,\n    conductor: Nombre,\n    motivo: 'Cancelado por conductor',\n    fecha_cancelacion: new Date().toISOString(),\n  },\n  [{ id: 'pruebaKnock', name: 'Admin Principal' }]\n);\n</code></pre>"},{"location":"frontend/knock/knock-react-native/#diagrama-de-secuencia-cancelacion","title":"Diagrama de secuencia (Cancelaci\u00f3n)","text":"<pre><code>sequenceDiagram\n  actor Conductor\n  participant App as App M\u00f3vil\n  participant API as Backend\n  participant Knock as Knock\n  Conductor-&gt;&gt;App: Acciona cancelar viaje\n  App-&gt;&gt;API: POST /cancel_scheduled_admin (Bearer Token)\n  API--&gt;&gt;App: { success }\n  App-&gt;&gt;Knock: Trigger Workflow `test-notification`\n  Knock--&gt;&gt;Admins: Push/Feed notification</code></pre> <p>\ud83d\udca1 Nota: en el repo actual el <code>trigger</code> se hace en la app (fetch a <code>https://api.knock.app/v1/workflows/{workflowKey}/trigger</code>). Si decides ejecutar ese <code>trigger</code> desde tu backend, reemplaza la llamada desde el cliente por un endpoint seguro en server.</p>"},{"location":"frontend/knock/knock-react-native/#ejemplos-de-peticion-no-publicar-claves","title":"Ejemplos de petici\u00f3n (no publicar claves)","text":"<p>cURL (server-side):</p> <pre><code>curl -X POST \"https://api.knock.app/v1/workflows/YOUR_WORKFLOW_KEY/trigger\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer $KNOCK_API_SECRET\" \\\n  -d '{\"data\": {\"titulo\":\"Conductor cancel\u00f3 viaje\",\"viajeId\":123}, \"recipients\":[{\"id\":\"pruebaKnock\"}]}'\n</code></pre> <p>Fetch (desde backend Node):</p> <pre><code>await fetch(`https://api.knock.app/v1/workflows/${workflowKey}/trigger`, {\n  method: 'POST',\n  headers: {\n    'Content-Type': 'application/json',\n    'Authorization': `Bearer ${process.env.KNOCK_API_SECRET}`,\n  },\n  body: JSON.stringify({ data, recipients }),\n});\n</code></pre>"},{"location":"frontend/knock/knock-react-native/#buenas-practicas-y-seguridad","title":"Buenas pr\u00e1cticas y seguridad \ud83d\udd10","text":"<ul> <li>Nunca incluir <code>KNOCK_API_SECRET</code> en c\u00f3digo cliente (apps m\u00f3viles o web). Guardarlo en variables de entorno del servidor.</li> <li>Registrar tokens del dispositivo con el <code>Knock</code> client desde componentes que tengan acceso al userId.</li> <li>Validar y sanear los payloads enviados a Knock (evitar inyecci\u00f3n de HTML si generas bloques personalizados).</li> </ul>"},{"location":"frontend/knock/knock-react-native/#referencias-en-el-repo","title":"Referencias en el repo","text":"<ul> <li><code>app/services/knock.ts</code> \u2014 implementaci\u00f3n de <code>useKnockClient</code>, <code>registrarTokenPush</code>, <code>enviarNotificacion</code>, <code>notificarSistema</code>.</li> <li><code>app/(main)/v2Admin/_layout.tsx</code> \u2014 provider y registro del push para administradores.</li> <li><code>components/viajes_card.tsx</code> \u2014 flujo de cancelaci\u00f3n y ejemplo de <code>notificarSistema</code>.</li> </ul>"},{"location":"frontend/react/actualizar_native/","title":"\ud83d\udd04 Actualizaciones de la App","text":""},{"location":"frontend/react/actualizar_native/#proceso-de-actualizacion","title":"Proceso de Actualizaci\u00f3n","text":"Generar Nueva Versi\u00f3n <ol> <li> <p>Actualizar Versi\u00f3n <pre><code>// app.json\n{\n  \"expo\": {\n    \"name\": \"Mi App\",\n    \"version\": \"1.0.1\", // Incrementar versi\u00f3n\n    \"android\": {\n      \"versionCode\": 2 // Incrementar c\u00f3digo\n    }\n  }\n}\n</code></pre></p> </li> <li> <p>Generar nuevo build <pre><code># Generar nuevo .aab\neas build -p android\n</code></pre></p> </li> </ol>"},{"location":"frontend/react/actualizar_native/#subir-actualizacion-a-play-store","title":"\ud83d\udcf1 Subir Actualizaci\u00f3n a Play Store","text":"Paso a Paso <ol> <li>Acceder a Google Play Console</li> <li>Seleccionar tu aplicaci\u00f3n</li> <li>Navegar a <code>Production</code> en el men\u00fa lateral</li> <li>Click en <code>Create new release</code></li> <li>Subir el archivo <code>.aab</code> generado por Expo</li> <li>Completar notas de la versi\u00f3n</li> <li>Revisar y enviar para revisi\u00f3n</li> </ol> Detalles del Proceso Paso Descripci\u00f3n Tiempo Estimado Subir .aab Archivo generado por <code>eas build</code> 5-10 min Revisi\u00f3n Google Proceso autom\u00e1tico/manual 1-3 d\u00edas Distribuci\u00f3n Disponible en Play Store 1-2 horas"},{"location":"frontend/react/actualizar_native/#lista-de-verificacion-para-updates","title":"\u2705 Lista de Verificaci\u00f3n para Updates","text":"Antes de Subir <ul> <li>[ ] Incrementar <code>version</code> en app.json</li> <li>[ ] Incrementar <code>versionCode</code> en app.json</li> <li>[ ] Probar app en modo release</li> <li>[ ] Preparar notas de la versi\u00f3n</li> <li>[ ] Generar nuevo .aab</li> <li>[ ] Verificar cambios importantes</li> </ul>"},{"location":"frontend/react/actualizar_native/#notas-de-la-version","title":"\ud83d\udcdd Notas de la Versi\u00f3n","text":"Ejemplo de Notas <pre><code>Versi\u00f3n 1.0.1:\n\u2022 Correcci\u00f3n de errores menores\n\u2022 Mejoras de rendimiento\n\u2022 Nuevas caracter\u00edsticas:\n  - Feature 1\n  - Feature 2\n</code></pre>"},{"location":"frontend/react/actualizar_native/#consideraciones-importantes","title":"\u26a0\ufe0f Consideraciones Importantes","text":"Puntos a Tener en Cuenta <ul> <li>No se puede bajar la versi\u00f3n una vez publicada</li> <li>El <code>versionCode</code> debe ser mayor al anterior</li> <li>La revisi\u00f3n puede requerir informaci\u00f3n adicional</li> <li>Mantener respaldo de versiones anteriores</li> <li>Considerar actualizaciones graduales</li> </ul>"},{"location":"frontend/react/actualizar_native/#monitoreo-post-actualizacion","title":"\ud83d\udd0d Monitoreo Post-Actualizaci\u00f3n","text":"M\u00e9tricas a Observar <ul> <li>Tasa de adopci\u00f3n de la nueva versi\u00f3n</li> <li>Reportes de errores</li> <li>Comentarios de usuarios</li> <li>Desinstalaciones</li> <li>Crashes en la nueva versi\u00f3n</li> </ul>"},{"location":"frontend/react/actualizar_native/#solucion-de-problemas-comunes","title":"\ud83c\udd98 Soluci\u00f3n de Problemas Comunes","text":"Problemas y Soluciones Problema Soluci\u00f3n Rechazo de actualizaci\u00f3n Revisar pol\u00edticas de Google Error en .aab Regenerar build Versi\u00f3n incorrecta Verificar app.json Distribuci\u00f3n lenta Esperar 24h"},{"location":"frontend/react/actualizar_native/#seguimiento-de-versiones","title":"\ud83d\udcca Seguimiento de Versiones","text":"Registro de Actualizaciones <pre><code># Historial de Versiones\n\n## v1.0.1 (2024-03-20)\n- Build: 2\n- Changes: Bug fixes\n\n## v1.0.0 (2024-03-01)\n- Build: 1\n- Changes: Initial release\n</code></pre>"},{"location":"frontend/react/levantar-react-native/","title":"\ud83d\udcf1 Gu\u00eda de Desarrollo React Native con Expo","text":""},{"location":"frontend/react/levantar-react-native/#prerequisitos","title":"\ud83c\udfaf Prerequisitos","text":"Requisitos del Sistema <ul> <li>Node.js (versi\u00f3n LTS)</li> <li>VS Code o editor preferido</li> <li>Expo Go (App m\u00f3vil)</li> <li>Cuenta de Google Play Console</li> <li>macOS, Linux, o Windows (PowerShell/WSL2)</li> </ul>"},{"location":"frontend/react/levantar-react-native/#configuracion-inicial","title":"\ud83d\udee0\ufe0f Configuraci\u00f3n Inicial","text":""},{"location":"frontend/react/levantar-react-native/#1-crear-cuenta-google-play-console","title":"1\ufe0f\u20e3 Crear Cuenta Google Play Console","text":"Registro en Google Play Console <ol> <li>Visitar Google Play Console</li> <li>Pagar tarifa \u00fanica de $25 USD</li> <li>Completar informaci\u00f3n de la cuenta:<ul> <li>Datos personales/empresa</li> <li>Informaci\u00f3n de pago</li> <li>Verificaci\u00f3n de identidad</li> </ul> </li> </ol>"},{"location":"frontend/react/levantar-react-native/#2-instalacion-de-herramientas","title":"2\ufe0f\u20e3 Instalaci\u00f3n de Herramientas","text":"Expo CLIExpo Go App <pre><code># Instalar Expo CLI globalmente\nnpm install -g expo-cli\n\n# Verificar instalaci\u00f3n\nexpo --version\n</code></pre> <ol> <li>Descargar Expo Go:<ul> <li>Android Play Store</li> <li>iOS App Store</li> </ul> </li> </ol>"},{"location":"frontend/react/levantar-react-native/#crear-nuevo-proyecto","title":"\ud83d\ude80 Crear Nuevo Proyecto","text":""},{"location":"frontend/react/levantar-react-native/#3-inicializar-proyecto","title":"3\ufe0f\u20e3 Inicializar Proyecto","text":"Crear ProyectoEstructura de Archivos <pre><code># Crear nuevo proyecto\nnpx create-expo-app@latest MiApp\n\n# Navegar al directorio\ncd MiApp\n</code></pre> <pre><code>MiApp/\n\u251c\u2500\u2500 app/\n\u2502   \u251c\u2500\u2500 index.tsx\n\u2502   \u2514\u2500\u2500 _layout.tsx\n\u251c\u2500\u2500 assets/\n\u2502   \u2514\u2500\u2500 images/\n\u251c\u2500\u2500 package.json\n\u2514\u2500\u2500 app.json\n</code></pre>"},{"location":"frontend/react/levantar-react-native/#desarrollo","title":"\ud83d\udcbb Desarrollo","text":""},{"location":"frontend/react/levantar-react-native/#4-configuracion-basica","title":"4\ufe0f\u20e3 Configuraci\u00f3n B\u00e1sica","text":"App.json <pre><code>{\n  \"expo\": {\n    \"name\": \"Mi Aplicaci\u00f3n\",\n    \"slug\": \"mi-app\",\n    \"version\": \"1.0.0\",\n    \"orientation\": \"portrait\",\n    \"icon\": \"./assets/icon.png\",\n    \"splash\": {\n      \"image\": \"./assets/splash.png\",\n      \"backgroundColor\": \"#ffffff\"\n    }\n  }\n}\n</code></pre>"},{"location":"frontend/react/levantar-react-native/#5-ejecutar-aplicacion","title":"5\ufe0f\u20e3 Ejecutar Aplicaci\u00f3n","text":"Desarrollo LocalOpciones de Ejecuci\u00f3n <pre><code># Iniciar servidor de desarrollo\nnpx expo start\n</code></pre> Tecla Acci\u00f3n a Abrir Android i Abrir iOS w Abrir Web r Recargar m Men\u00fa"},{"location":"frontend/react/levantar-react-native/#pruebas-en-dispositivo","title":"\ud83d\udcf1 Pruebas en Dispositivo","text":"Usando Expo Go <ol> <li>Abrir Expo Go en el dispositivo</li> <li>Escanear QR del terminal</li> <li>La app se cargar\u00e1 autom\u00e1ticamente</li> </ol> Ejemplo B\u00e1sico <pre><code>import { Text, View, StyleSheet } from 'react-native';\n\nexport default function App() {\n  return (\n    &lt;View style={styles.container}&gt;\n      &lt;Text style={styles.text}&gt;\n        \u00a1Hola Mundo!\n      &lt;/Text&gt;\n    &lt;/View&gt;\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: '#25292e',\n    alignItems: 'center',\n    justifyContent: 'center',\n  },\n  text: {\n    color: '#fff',\n  },\n});\n</code></pre>"},{"location":"frontend/react/levantar-react-native/#publicacion-en-google-play","title":"\ud83d\udce6 Publicaci\u00f3n en Google Play","text":""},{"location":"frontend/react/levantar-react-native/#6-preparacion-para-produccion","title":"6\ufe0f\u20e3 Preparaci\u00f3n para Producci\u00f3n","text":"Requisitos Google Play <ul> <li>Icono de app (512x512)</li> <li>Screenshots (m\u00ednimo 2)</li> <li>Descripci\u00f3n corta y larga</li> <li>Pol\u00edtica de privacidad</li> <li>Clasificaci\u00f3n de contenido</li> </ul> Generar APK <pre><code># Configurar eas.json\neas build:configure\n\n# Crear build para Android\neas build -p android\n</code></pre>"},{"location":"frontend/react/levantar-react-native/#7-proceso-de-publicacion","title":"7\ufe0f\u20e3 Proceso de Publicaci\u00f3n","text":"<ol> <li>Acceder a Google Play Console</li> <li>Crear nueva aplicaci\u00f3n</li> <li>Completar ficha de Play Store</li> <li>Subir APK/Bundle</li> <li>Publicar en producci\u00f3n</li> </ol>"},{"location":"frontend/react/levantar-react-native/#solucion-de-problemas","title":"\u26a0\ufe0f Soluci\u00f3n de Problemas","text":"Problemas Comunes Problema Soluci\u00f3n Metro bundler error Limpiar cache Expo Go no conecta Verificar red Build falla Revisar eas.json APK rechazado Revisar pol\u00edticas"},{"location":"frontend/react/levantar-react-native/#recursos","title":"\ud83d\udcda Recursos","text":"Enlaces \u00datiles <ul> <li>Documentaci\u00f3n Expo</li> <li>React Native Docs</li> <li>Google Play Console</li> <li>Gu\u00edas de Publicaci\u00f3n</li> </ul>"},{"location":"frontend/react/levantar-react-native/#proceso-de-actualizacion","title":"Proceso de Actualizaci\u00f3n","text":"Generar Nueva Versi\u00f3n <ol> <li> <p>Actualizar Versi\u00f3n <pre><code>// app.json\n{\n  \"expo\": {\n    \"name\": \"Mi App\",\n    \"version\": \"1.0.1\", // Incrementar versi\u00f3n\n    \"android\": {\n      \"versionCode\": 2 // Incrementar c\u00f3digo\n    }\n  }\n}\n</code></pre></p> </li> <li> <p>Generar nuevo build <pre><code># Generar nuevo .aab\neas build -p android\n</code></pre></p> </li> </ol>"},{"location":"frontend/react/levantar-react-native/#subir-actualizacion-a-play-store","title":"\ud83d\udcf1 Subir Actualizaci\u00f3n a Play Store","text":"Paso a Paso <ol> <li>Acceder a Google Play Console</li> <li>Seleccionar tu aplicaci\u00f3n</li> <li>Navegar a <code>Production</code> en el men\u00fa lateral</li> <li>Click en <code>Create new release</code></li> <li>Subir el archivo <code>.aab</code> generado por Expo</li> <li>Completar notas de la versi\u00f3n</li> <li>Revisar y enviar para revisi\u00f3n</li> </ol> Detalles del Proceso Paso Descripci\u00f3n Tiempo Estimado Subir .aab Archivo generado por <code>eas build</code> 5-10 min Revisi\u00f3n Google Proceso autom\u00e1tico/manual 1-3 d\u00edas Distribuci\u00f3n Disponible en Play Store 1-2 horas"},{"location":"frontend/react/levantar-react-native/#lista-de-verificacion-para-updates","title":"\u2705 Lista de Verificaci\u00f3n para Updates","text":"Antes de Subir <ul> <li>[ ] Incrementar <code>version</code> en app.json</li> <li>[ ] Incrementar <code>versionCode</code> en app.json</li> <li>[ ] Probar app en modo release</li> <li>[ ] Preparar notas de la versi\u00f3n</li> <li>[ ] Generar nuevo .aab</li> <li>[ ] Verificar cambios importantes</li> </ul>"},{"location":"frontend/react/levantar-react-native/#notas-de-la-version","title":"\ud83d\udcdd Notas de la Versi\u00f3n","text":"Ejemplo de Notas <pre><code>Versi\u00f3n 1.0.1:\n\u2022 Correcci\u00f3n de errores menores\n\u2022 Mejoras de rendimiento\n\u2022 Nuevas caracter\u00edsticas:\n  - Feature 1\n  - Feature 2\n</code></pre>"},{"location":"frontend/react/levantar-react-native/#consideraciones-importantes","title":"\u26a0\ufe0f Consideraciones Importantes","text":"Puntos a Tener en Cuenta <ul> <li>No se puede bajar la versi\u00f3n una vez publicada</li> <li>El <code>versionCode</code> debe ser mayor al anterior</li> <li>La revisi\u00f3n puede requerir informaci\u00f3n adicional</li> <li>Mantener respaldo de versiones anteriores</li> <li>Considerar actualizaciones graduales</li> </ul>"},{"location":"frontend/react/levantar-react-native/#monitoreo-post-actualizacion","title":"\ud83d\udd0d Monitoreo Post-Actualizaci\u00f3n","text":"M\u00e9tricas a Observar <ul> <li>Tasa de adopci\u00f3n de la nueva versi\u00f3n</li> <li>Reportes de errores</li> <li>Comentarios de usuarios</li> <li>Desinstalaciones</li> <li>Crashes en la nueva versi\u00f3n</li> </ul>"},{"location":"frontend/react/levantar-react-native/#solucion-de-problemas-comunes","title":"\ud83c\udd98 Soluci\u00f3n de Problemas Comunes","text":"Problemas y Soluciones Problema Soluci\u00f3n Rechazo de actualizaci\u00f3n Revisar pol\u00edticas de Google Error en .aab Regenerar build Versi\u00f3n incorrecta Verificar app.json Distribuci\u00f3n lenta Esperar 24h"},{"location":"frontend/react/levantar-react-native/#seguimiento-de-versiones","title":"\ud83d\udcca Seguimiento de Versiones","text":"Registro de Actualizaciones <pre><code># Historial de Versiones\n\n## v1.0.1 (2024-03-20)\n- Build: 2\n- Changes: Bug fixes\n\n## v1.0.0 (2024-03-01)\n- Build: 1\n- Changes: Initial release\n</code></pre>"},{"location":"frontend/react/levantar/","title":"\ud83d\ude80 Gu\u00eda de Instalaci\u00f3n: Next.js + Shadcn/UI","text":""},{"location":"frontend/react/levantar/#prerequisitos","title":"\ud83d\udccb Prerequisitos","text":"Requisitos del Sistema <ul> <li>Node.js 18.17 o superior</li> <li>pnpm, npm, yarn o bun</li> <li>Editor de c\u00f3digo (VS Code recomendado)</li> </ul>"},{"location":"frontend/react/levantar/#instalacion","title":"\ud83d\udee0\ufe0f Instalaci\u00f3n","text":""},{"location":"frontend/react/levantar/#1-crear-proyecto-nextjs","title":"1\ufe0f\u20e3 Crear Proyecto Next.js","text":"Con pnpmCon npmCon yarn <pre><code>pnpm create next-app my-app\ncd my-app\n</code></pre> <pre><code>npx create-next-app my-app\ncd my-app\n</code></pre> <pre><code>yarn create next-app my-app\ncd my-app\n</code></pre>"},{"location":"frontend/react/levantar/#2-configurar-shadcnui","title":"2\ufe0f\u20e3 Configurar Shadcn/UI","text":"Inicializaci\u00f3n <pre><code># M\u00e9todo Interactivo\npnpm dlx shadcn@latest init\n\n# M\u00e9todo con Defaults (-d)\npnpm dlx shadcn@latest init -d\n</code></pre> Preguntas de Configuraci\u00f3n Pregunta Opciones Recomendado Style Default/New York New York Color Base Slate/Zinc/... Zinc CSS Variables Yes/No Yes"},{"location":"frontend/react/levantar/#3-instalar-componentes","title":"3\ufe0f\u20e3 Instalar Componentes","text":"M\u00e9todo IndividualComponentes Populares <pre><code># Instalar un componente\npnpm dlx shadcn@latest add button\n\n# Instalar m\u00faltiples componentes\npnpm dlx shadcn@latest add card form input\n</code></pre> <pre><code># UI B\u00e1sica\npnpm dlx shadcn@latest add button card input form dialog\n\n# Navegaci\u00f3n\npnpm dlx shadcn@latest add navigation-menu dropdown-menu\n\n# Datos\npnpm dlx shadcn@latest add table select combobox\n</code></pre>"},{"location":"frontend/react/levantar/#uso-de-componentes","title":"\ud83d\udcbb Uso de Componentes","text":"Ejemplo B\u00e1sico <pre><code>import { Button } from \"@/components/ui/button\"\nimport { Card } from \"@/components/ui/card\"\n\nexport default function Home() {\n  return (\n    &lt;Card&gt;\n      &lt;Button&gt;Click me&lt;/Button&gt;\n    &lt;/Card&gt;\n  )\n}\n</code></pre> Formulario <pre><code>import { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Form } from \"@/components/ui/form\"\n\nexport default function LoginForm() {\n  return (\n    &lt;Form&gt;\n      &lt;Input placeholder=\"Email\" /&gt;\n      &lt;Input type=\"password\" placeholder=\"Password\" /&gt;\n      &lt;Button&gt;Login&lt;/Button&gt;\n    &lt;/Form&gt;\n  )\n}\n</code></pre>"},{"location":"frontend/react/levantar/#personalizacion","title":"\ud83c\udfa8 Personalizaci\u00f3n","text":"Temas <pre><code>// globals.css\n@layer base {\n  :root {\n    --background: 0 0% 100%;\n    --foreground: 240 10% 3.9%;\n    /* A\u00f1adir m\u00e1s variables seg\u00fan necesidad */\n  }\n}\n</code></pre> Componentes <pre><code>// components/ui/custom-button.tsx\nimport { Button } from \"@/components/ui/button\"\nimport { cn } from \"@/lib/utils\"\n\nexport function CustomButton({ className, ...props }) {\n  return (\n    &lt;Button \n      className={cn(\"bg-primary text-white\", className)} \n      {...props} \n    /&gt;\n  )\n}\n</code></pre>"},{"location":"frontend/react/levantar/#verificacion","title":"\u2705 Verificaci\u00f3n","text":"Lista de Verificaci\u00f3n <ul> <li>[ ] Next.js instalado y funcionando</li> <li>[ ] Shadcn/UI inicializado</li> <li>[ ] Componentes necesarios instalados</li> <li>[ ] Temas configurados</li> <li>[ ] Estructura de carpetas correcta</li> </ul>"},{"location":"frontend/react/levantar/#solucion-de-problemas","title":"\u26a0\ufe0f Soluci\u00f3n de Problemas","text":"Problemas Comunes Problema Soluci\u00f3n Componente no encontrado Verificar instalaci\u00f3n Estilos no aplicados Revisar globals.css TypeScript errors Actualizar tipos Build fails Limpiar cache y node_modules"},{"location":"frontend/react/levantar/#recursos","title":"\ud83d\udcda Recursos","text":"Enlaces \u00datiles <ul> <li>Documentaci\u00f3n Shadcn/UI</li> <li>Next.js Docs</li> <li>Ejemplos de Componentes</li> <li>GitHub Repo</li> </ul>"},{"location":"frontend/tracmin/que-es-tracmin/","title":"\ud83d\ude9b TRACMIN - Documentaci\u00f3n Frontend","text":""},{"location":"frontend/tracmin/que-es-tracmin/#descripcion-general","title":"\ud83d\udcf1 Descripci\u00f3n General","text":"<p>Tracmin es una aplicaci\u00f3n de gesti\u00f3n de transporte minero que opera en dos plataformas: - \ud83c\udf10 Aplicaci\u00f3n Web (PWA) - \ud83d\udcf1 Aplicaci\u00f3n M\u00f3vil (Android)</p>"},{"location":"frontend/tracmin/que-es-tracmin/#tecnologias-principales","title":"Tecnolog\u00edas Principales","text":"Stack Tecnol\u00f3gico Tecnolog\u00eda Uso Versi\u00f3n Next.js + TypeScript Framework principal 14.x Shadcn UI Componentes UI Latest Tailwind CSS Estilos 3.x Redux Estado global Latest IndexedDB Almacenamiento local - WebSocket Tiempo real - React Native (Expo) App m\u00f3vil Latest"},{"location":"frontend/tracmin/que-es-tracmin/#aplicacion-web-pwa","title":"\ud83c\udf10 Aplicaci\u00f3n Web (PWA)","text":""},{"location":"frontend/tracmin/que-es-tracmin/#ambientes","title":"Ambientes","text":"URLs de Acceso Ambiente URL Descripci\u00f3n \ud83d\ude80 Producci\u00f3n tracmin.cl Ambiente productivo \ud83e\uddea QA qa.azure Pruebas \ud83d\udee0\ufe0f Desarrollo dev.azure Desarrollo"},{"location":"frontend/tracmin/que-es-tracmin/#arquitectura","title":"Arquitectura","text":"<pre><code>graph TB\n    subgraph \"Frontend Architecture\"\n        UI[UI Components]\n        Redux[Redux Store]\n        WS[WebSocket]\n        IDB[IndexedDB]\n\n        UI --&gt; Redux\n        UI --&gt; WS\n        UI --&gt; IDB\n    end</code></pre>"},{"location":"frontend/tracmin/que-es-tracmin/#roles-de-usuario","title":"Roles de Usuario","text":"Perfiles de Acceso Rol Descripci\u00f3n Accesos \ud83d\ude9a Conductor Operador de veh\u00edculo Viajes, rutas \ud83d\udc65 Admin Transportista Gesti\u00f3n de flota Dashboard, reportes \ud83c\udfe2 Cliente Usuario final Seguimiento \u2696\ufe0f Admin Romana Control de peso Pesajes, registros"},{"location":"frontend/tracmin/que-es-tracmin/#aplicacion-movil","title":"\ud83d\udcf1 Aplicaci\u00f3n M\u00f3vil","text":"Detalles Play Store <ul> <li>\ud83d\udce5 Descargar App</li> <li>\ud83d\udce6 100+ Descargas</li> <li>\ud83d\udd12 Datos encriptados</li> <li>\ud83d\udcf1 Compatible: Android</li> </ul>"},{"location":"frontend/tracmin/que-es-tracmin/#caracteristicas-pwa","title":"Caracter\u00edsticas PWA","text":"Capacidades PWA <ul> <li>\u2705 Instalable</li> <li>\u2705 Offline-first</li> <li>\u2705 Push notifications</li> <li>\u2705 Responsive design</li> <li>\u2705 App-like experience</li> </ul>"},{"location":"frontend/tracmin/que-es-tracmin/#gestion-de-datos","title":"\ud83d\udcbe Gesti\u00f3n de Datos","text":""},{"location":"frontend/tracmin/que-es-tracmin/#redux-store","title":"Redux Store","text":"Estado Global <pre><code>interface RootState {\n  user: UserState;\n  trips: TripState;\n  notifications: NotificationState;\n  // ...otros estados\n}\n</code></pre>"},{"location":"frontend/tracmin/que-es-tracmin/#indexeddb","title":"IndexedDB","text":"Estructura de Datos <pre><code>interface DBSchema {\n  trips: TripRecord[];\n  userPrefs: UserPreferences;\n  offlineData: OfflineStorage;\n}\n</code></pre>"},{"location":"frontend/tracmin/que-es-tracmin/#tiempo-real","title":"\ud83d\udd04 Tiempo Real","text":"WebSocket Events <pre><code>// Eventos principales\nenum WSEvents {\n  TRIP_UPDATE = 'trip:update',\n  LOCATION_CHANGE = 'location:change',\n  NEW_NOTIFICATION = 'notification:new'\n}\n</code></pre>"},{"location":"frontend/tracmin/que-es-tracmin/#desarrollo","title":"\ud83d\udee0\ufe0f Desarrollo","text":""},{"location":"frontend/tracmin/que-es-tracmin/#configuracion-local","title":"Configuraci\u00f3n Local","text":"<pre><code># Instalar dependencias\nnpm install\n\n# Desarrollo\nnpm run dev\n\n# Build\nnpm run build\n</code></pre>"},{"location":"frontend/tracmin/que-es-tracmin/#variables-de-entorno","title":"Variables de Entorno","text":"Configuraci\u00f3n <pre><code>NEXT_PUBLIC_API_URL=\nNEXT_PUBLIC_WS_URL=\nNEXT_PUBLIC_MAPS_KEY=\n</code></pre>"},{"location":"frontend/tracmin/que-es-tracmin/#monitoreo","title":"\ud83d\udcca Monitoreo","text":"Herramientas <ul> <li>Azure Application Insights</li> <li>Google Analytics</li> <li>Error tracking</li> <li>Performance monitoring</li> </ul>"},{"location":"frontend/tracmin/que-es-tracmin/#seguridad","title":"\ud83d\udd10 Seguridad","text":"Consideraciones <ul> <li>Autenticaci\u00f3n JWT</li> <li>Datos encriptados</li> <li>HTTPS</li> <li>Validaci\u00f3n de roles</li> <li>Sanitizaci\u00f3n de datos</li> </ul>"},{"location":"frontend/tracmin/que-es-tracmin/#recursos","title":"\ud83d\udcda Recursos","text":"Enlaces \u00datiles <ul> <li>Documentaci\u00f3n API</li> <li>Gu\u00eda Actualizar Native</li> </ul>"},{"location":"iot/configuracion/azure/","title":"\ud83d\udce1 Conexi\u00f3n de Dispositivos a Azure IoT Hub","text":""},{"location":"iot/configuracion/azure/#requisitos-previos","title":"\ud83d\udcdf Requisitos Previos","text":"<ul> <li>Azure IoT Hub configurado y en funcionamiento.</li> <li>Dispositivo registrado en el IoT Hub con autenticaci\u00f3n mediante certificado X.509 o SAS token.</li> <li>Certificados necesarios:</li> <li>CA (Autoridad Certificadora)</li> <li>Certificado del dispositivo</li> <li>Clave privada del dispositivo</li> <li>Herramientas instaladas:</li> <li>Azure IoT Explorer</li> <li>MQTTX</li> <li>Python 3.x con las bibliotecas <code>paho-mqtt</code> y <code>ssl</code></li> </ul>"},{"location":"iot/configuracion/azure/#autenticacion-con-certificado-x509","title":"\ud83d\udd10 Autenticaci\u00f3n con Certificado X.509","text":""},{"location":"iot/configuracion/azure/#estructura-de-certificados","title":"\ud83d\udcc1 Estructura de Certificados","text":"<pre><code>graph TD\n    A[Certificado Ra\u00edz (CA)] --&gt; B[Certificado del Dispositivo]\n    B --&gt; C[Clave Privada del Dispositivo]</code></pre>"},{"location":"iot/configuracion/azure/#descarga-de-certificados-ejemplos","title":"\ud83d\udcc5 Descarga de Certificados (ejemplos)","text":"<p>Descargar Ejemplos</p> <ul> <li>CA: <code>DigiCertGlobalRootG2.crt.pem</code> </li> <li>Certificado del dispositivo: <code>UC-300-primary.crt</code> </li> <li>Clave privada del dispositivo: <code>UC-300-primary.key</code> </li> </ul> <p>Aseg\u00farate de almacenar estos archivos en un directorio seguro y accesible para tu aplicaci\u00f3n.</p>"},{"location":"iot/configuracion/azure/#codigo-de-ejemplo-en-python","title":"\ud83e\uddea C\u00f3digo de Ejemplo en Python","text":"<pre><code>import ssl\nimport paho.mqtt.client as mqtt\n\n# Par\u00e1metros de conexi\u00f3n\nbroker = \"elaltoiot.azure-devices.net\"\nport = 8883\ndevice_id = \"UC-300\"\nusername = f\"{broker}/{device_id}/?api-version=2018-06-30\"\npassword = \"\"\ntopic = f\"devices/{device_id}/messages/events/\"\n\n# Rutas a los certificados\nca_cert = \"DigiCertGlobalRootG2.crt.pem\"\nclient_cert = \"UC-300-primary.crt\"\nclient_key = \"UC-300-primary.key\"\n\ndef on_connect(client, userdata, flags, rc):\n    if rc == 0:\n        print(\"\u2705 Conectado exitosamente a Azure IoT Hub.\")\n        payload = '{\"message\": \"Hola desde Python MQTT\"}'\n        client.publish(topic, payload)\n        print(\"\ud83d\ude80 Mensaje de prueba enviado.\")\n    else:\n        print(f\"\u274c Error de conexi\u00f3n. C\u00f3digo de retorno: {rc}\")\n\ndef on_publish(client, userdata, mid):\n    print(\"\u2705 Mensaje publicado exitosamente.\")\n\ndef on_disconnect(client, userdata, rc):\n    print(\"\ud83d\udd0c Desconectado del servidor.\")\n\n# Crear cliente MQTT\nclient = mqtt.Client(client_id=device_id, protocol=mqtt.MQTTv311)\nclient.username_pw_set(username=username, password=password)\n\n# Configurar TLS\nclient.tls_set(\n    ca_certs=ca_cert,\n    certfile=client_cert,\n    keyfile=client_key,\n    tls_version=ssl.PROTOCOL_TLSv1_2,\n    cert_reqs=ssl.CERT_REQUIRED\n)\n\nclient.on_connect = on_connect\nclient.on_publish = on_publish\nclient.on_disconnect = on_disconnect\n\nclient.connect(broker, port)\nclient.loop_forever()\n</code></pre>"},{"location":"iot/configuracion/azure/#autenticacion-con-sas-token","title":"\ud83d\udd11 Autenticaci\u00f3n con SAS Token","text":""},{"location":"iot/configuracion/azure/#codigo-de-ejemplo-en-python_1","title":"\ud83e\uddea C\u00f3digo de Ejemplo en Python","text":"<pre><code>import paho.mqtt.client as mqtt\nimport ssl\n\n# Configuraci\u00f3n\nbroker = \"elaltoiot.azure-devices.net\"\nport = 8883\ndevice_id = \"UC300\"\nsas_token = \"SharedAccessSignature sr=elaltoiot.azure-devices.net%2Fdevices%2FUC300&amp;sig=5jLjkvegnXWmLkPd%2F79OhmrrRqS0UMehS9LYifeJdzI%3D&amp;se=1747747216\"\nusername = f\"{broker}/{device_id}/?api-version=2018-06-30\"\nca_cert = \"DigiCertGlobalRootG2.crt.pem\"\n\ndef on_connect(client, userdata, flags, rc):\n    if rc == 0:\n        print(\"\u2705 Conectado exitosamente a Azure IoT Hub.\")\n        client.publish(f\"devices/{device_id}/messages/events/\", payload=\"Prueba desde Python\", qos=1)\n    else:\n        print(f\"\u274c Error al conectar. C\u00f3digo de retorno: {rc}\")\n\ndef on_publish(client, userdata, mid):\n    print(\"\ud83d\udce8 Mensaje publicado exitosamente.\")\n\nclient = mqtt.Client(client_id=device_id, protocol=mqtt.MQTTv311)\nclient.username_pw_set(username=username, password=sas_token)\nclient.tls_set(\n    ca_certs=ca_cert,\n    certfile=None,\n    keyfile=None,\n    cert_reqs=ssl.CERT_REQUIRED,\n    tls_version=ssl.PROTOCOL_TLSv1_2,\n    ciphers=None\n)\n\nclient.on_connect = on_connect\nclient.on_publish = on_publish\n\nclient.connect(broker, port=port)\nclient.loop_forever()\n</code></pre>"},{"location":"iot/configuracion/azure/#verificacion-de-conexion-con-azure-iot-explorer","title":"\ud83d\udd7d\ufe0f Verificaci\u00f3n de Conexi\u00f3n con Azure IoT Explorer","text":"<ol> <li>Abrir Azure IoT Explorer y conectarse al IoT Hub.</li> <li>Ir a Devices y seleccionar el dispositivo <code>UC-300</code>.</li> <li>Revisar el Device Twin:</li> <li><code>connectionState</code>: Connected o Disconnected</li> <li><code>lastActivityTime</code>: Fecha y hora de la \u00faltima actividad</li> <li>Enviar mensajes desde la pesta\u00f1a Telemetry para confirmar la comunicaci\u00f3n.</li> </ol>"},{"location":"iot/configuracion/azure/#pruebas-con-mqttx","title":"\ud83d\udee0\ufe0f Pruebas con MQTTX","text":"<ol> <li>Crear nueva conexi\u00f3n en MQTTX:</li> <li>Broker Address: <code>elaltoiot.azure-devices.net</code></li> <li>Port: <code>8883</code></li> <li>Client ID: <code>UC-300</code></li> <li>Username: <code>elaltoiot.azure-devices.net/UC-300/?api-version=2018-06-30</code></li> <li>Password: (SAS Token o vac\u00edo si es certificado)</li> <li>TLS Activado:</li> <li>CA File: <code>DigiCertGlobalRootG2.crt.pem</code></li> <li>Client Certificate: <code>UC-300-primary.crt</code></li> <li>Client Key: <code>UC-300-primary.key</code></li> <li>Conectar y observar el estado.</li> <li>Publicar en <code>devices/UC-300/messages/events/</code>.</li> <li>Suscribirse para verificar la recepci\u00f3n.</li> </ol>"},{"location":"iot/configuracion/azure/#diagrama-de-flujo-de-conexion","title":"\ud83e\uddf9 Diagrama de Flujo de Conexi\u00f3n","text":"<pre><code>graph LR\n    A[Inicio] --&gt; B{Tipo de Autenticaci\u00f3n}\n    B --&gt;|Certificado X.509| C[Configurar certificados]\n    B --&gt;|SAS Token| D[Generar SAS token]\n    C --&gt; E[Configurar cliente MQTT]\n    D --&gt; E\n    E --&gt; F[Conectar al IoT Hub]\n    F --&gt; G{Conexi\u00f3n exitosa?}\n    G --&gt;|S\u00ed| H[Enviar mensaje de prueba]\n    G --&gt;|No| I[Revisar configuraci\u00f3n]\n    H --&gt; J[Verificar en Azure IoT Explorer]\n    I --&gt; E</code></pre>"},{"location":"iot/configuracion/azure/#recursos-adicionales","title":"\ud83d\udcda Recursos Adicionales","text":"<ul> <li>Documentaci\u00f3n de Azure IoT Hub</li> <li>Gu\u00eda de Azure IoT Explorer</li> <li>MQTTX - Herramienta de Pruebas MQTT</li> </ul>"},{"location":"iot/configuracion/azure/#generacion-y-firma-de-certificados-con-openssl","title":"\ud83d\udee1\ufe0f Generaci\u00f3n y Firma de Certificados con OpenSSL","text":"<p>A continuaci\u00f3n se describen los pasos para crear una CA, generar un certificado de dispositivo, firmarlo y obtener el thumbprint (huella digital) en el formato requerido por Azure.</p>"},{"location":"iot/configuracion/azure/#1-generar-la-clave-privada-de-la-ca-y-su-certificado","title":"1. Generar la clave privada de la CA y su certificado","text":"<p><pre><code>openssl genrsa -out ca.key 2048\nopenssl req -x509 -new -nodes -key ca.key -sha256 -days 3650 -out ca.crt\n</code></pre> - ca.key: Clave privada de la CA - ca.crt: Certificado de la CA (v\u00e1lido por 10 a\u00f1os)</p>"},{"location":"iot/configuracion/azure/#2-generar-la-clave-privada-y-csr-solicitud-de-firma-del-dispositivo","title":"2. Generar la clave privada y CSR (solicitud de firma) del dispositivo","text":"<p><pre><code>openssl genrsa -out device.key 2048\nopenssl req -new -key device.key -out device.csr\n</code></pre> - device.key: Clave privada del dispositivo - device.csr: Solicitud de firma de certificado</p>"},{"location":"iot/configuracion/azure/#3-firmar-el-certificado-del-dispositivo-con-la-ca","title":"3. Firmar el certificado del dispositivo con la CA","text":"<p><pre><code>openssl x509 -req -in device.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out device.crt -days 365 -sha256\n</code></pre> - device.crt: Certificado del dispositivo firmado por la CA</p>"},{"location":"iot/configuracion/azure/#4-verificar-el-certificado-generado","title":"4. Verificar el certificado generado","text":"<pre><code>openssl x509 -in device.crt -text -noout\n</code></pre>"},{"location":"iot/configuracion/azure/#5-obtener-el-thumbprint-huella-digital-sha1-del-certificado","title":"5. Obtener el thumbprint (huella digital SHA1) del certificado","text":"<p><pre><code>openssl x509 -in device.crt -noout -fingerprint -sha1\n</code></pre> El resultado ser\u00e1 algo como: <pre><code>SHA1 Fingerprint=AA:BB:CC:DD:EE:FF:11:22:33:44:55:66:77:88:99:AA:BB:CC:DD:EE\n</code></pre></p>"},{"location":"iot/configuracion/azure/#6-quitar-los-dos-puntos-del-thumbprint-para-azure","title":"6. Quitar los dos puntos (:) del thumbprint para Azure","text":"<p>En Windows CMD: <pre><code>FOR /F \"tokens=2 delims==\" %A IN ('openssl x509 -in device.crt -noout -fingerprint -sha1') DO @SET thumb=%A\nSET thumb=%thumb::=%\nECHO %thumb%\n</code></pre></p> <p>En PowerShell: <pre><code>( openssl x509 -in device.crt -noout -fingerprint -sha1 ) -replace 'SHA1 Fingerprint=','' -replace ':',''\n</code></pre></p> <p>En Linux/Mac: <pre><code>openssl x509 -in device.crt -noout -fingerprint -sha1 | sed 's/://g' | sed 's/SHA1 Fingerprint=//'\n</code></pre></p>"},{"location":"iot/configuracion/azure/#7-usa-el-thumbprint-sin-los-dos-puntos-para-registrar-el-certificado-en-azure-iot-hub","title":"7. Usa el thumbprint sin los dos puntos para registrar el certificado en Azure IoT Hub","text":"<p>Importante: El thumbprint debe estar en may\u00fasculas y sin los dos puntos (<code>:</code>). Ejemplo: <code>AABBCCDDEEFF112233445566778899AABBCCDDEE</code></p>"},{"location":"iot/configuracion/azure/#archivos-generados","title":"\ud83d\udce6 Archivos generados","text":"<ul> <li><code>ca.key</code> y <code>ca.crt</code>: Clave y certificado de la CA</li> <li><code>device.key</code>: Clave privada del dispositivo</li> <li><code>device.csr</code>: Solicitud de firma del dispositivo</li> <li><code>device.crt</code>: Certificado del dispositivo firmado</li> </ul> <p>Guarda estos archivos en un lugar seguro.</p>"},{"location":"iot/configuracion/contadores/","title":"\ud83d\udc23 Programaci\u00f3n de Contadores de Huevos - Arduino Opta","text":""},{"location":"iot/configuracion/contadores/#objetivo-del-documento","title":"\ud83d\udccb Objetivo del Documento","text":"<p>Este documento tiene como objetivo formalizar y documentar el procedimiento correcto para compilar, cargar y mantener el firmware de los dispositivos Arduino Opta utilizados como contadores de huevos en los pabellones de la av\u00edcola.</p>"},{"location":"iot/configuracion/contadores/#propositos","title":"\ud83c\udfaf Prop\u00f3sitos","text":"<ul> <li>\u2705 Evitar dependencia de memoria individual</li> <li>\u2705 Reducir errores t\u00edpicos asociados a la arquitectura dual\u2011core (M7 / M4) del equipo</li> <li>\u2705 Establecer un procedimiento est\u00e1ndar y reproducible</li> </ul> <p>Nota: Los c\u00f3digos fuente se mantienen como archivos independientes y est\u00e1n disponibles para descarga en la secci\u00f3n de Archivos del Proyecto.</p>"},{"location":"iot/configuracion/contadores/#arquitectura-del-arduino-opta","title":"\ud83c\udfd7\ufe0f Arquitectura del Arduino Opta","text":"<p>El Arduino Opta est\u00e1 basado en el microcontrolador STM32H747, que posee dos n\u00facleos f\u00edsicos independientes que trabajan en paralelo:</p> <pre><code>graph TB\n    A[Arduino Opta&lt;br/&gt;STM32H747] --&gt; B[Cortex-M7&lt;br/&gt;N\u00facleo Principal]\n    A --&gt; C[Cortex-M4&lt;br/&gt;N\u00facleo Secundario]\n\n    B --&gt; D[Red Ethernet]\n    B --&gt; E[Sincronizaci\u00f3n NTP]\n    B --&gt; F[Firebase RTDB]\n    B --&gt; G[Actualizaci\u00f3n OTA]\n    B --&gt; H[Pantalla LCD]\n    B --&gt; I[L\u00f3gica de Negocio]\n\n    C --&gt; J[Lectura de Entradas]\n    C --&gt; K[Conteo de Pulsos]\n    C --&gt; L[Tareas en Tiempo Real]\n\n    style B fill:#4CAF50,stroke:#2E7D32,color:#fff\n    style C fill:#2196F3,stroke:#1565C0,color:#fff\n    style A fill:#FF9800,stroke:#E65100,color:#fff</code></pre>"},{"location":"iot/configuracion/contadores/#tabla-de-responsabilidades-por-nucleo","title":"\ud83d\udcca Tabla de Responsabilidades por N\u00facleo","text":"N\u00facleo Nombre Funci\u00f3n Principal Responsabilidades Core Principal Cortex\u2011M7 Control y Comunicaci\u00f3n Red Ethernet, NTP, Firebase, OTA, LCD, l\u00f3gica de negocio Core Secundario Cortex\u2011M4 Adquisici\u00f3n de Datos Lectura de entradas, conteo de pulsos, tareas en tiempo real"},{"location":"iot/configuracion/contadores/#importante-ambos-nucleos-son-necesarios","title":"\u26a0\ufe0f Importante: Ambos N\u00facleos Son Necesarios","text":"<pre><code>graph LR\n    A[Programaci\u00f3n] --&gt; B{Solo M7?}\n    B --&gt;|S\u00ed| C[\u274c Contadores en 0&lt;br/&gt;Sistema incompleto]\n    B --&gt;|No| D{Ambos n\u00facleos?}\n    D --&gt;|S\u00ed| E[\u2705 Sistema funcional&lt;br/&gt;Conteo correcto]\n\n    style C fill:#f44336,stroke:#c62828,color:#fff\n    style E fill:#4CAF50,stroke:#2E7D32,color:#fff</code></pre> <p>Si solo se programa el M7: - \u2705 El equipo puede conectarse a la red - \u2705 Puede enviar datos a Firebase - \u274c Los contadores permanecer\u00e1n en 0 porque el M4 no est\u00e1 ejecutando su l\u00f3gica</p> <p>Si solo se programa el M4: - \u2705 Los contadores funcionan - \u274c No hay comunicaci\u00f3n con Firebase - \u274c No hay sincronizaci\u00f3n de tiempo</p>"},{"location":"iot/configuracion/contadores/#estructura-del-codigo","title":"\ud83d\udcc1 Estructura del C\u00f3digo","text":"<p>El proyecto utiliza un \u00fanico archivo <code>.ino</code> que contiene el c\u00f3digo de ambos n\u00facleos, separado mediante directivas de precompilaci\u00f3n:</p> <pre><code>#ifdef CORE_CM7\n    // C\u00f3digo que se compila para el Cortex\u2011M7\n    // Red, Firebase, NTP, LCD, etc.\n#else\n    // C\u00f3digo que se compila para el Cortex\u2011M4\n    // Lectura de entradas, conteo, etc.\n#endif\n</code></pre>"},{"location":"iot/configuracion/contadores/#archivos-del-proyecto","title":"\ud83d\udce6 Archivos del Proyecto","text":"<p>Los siguientes archivos son necesarios para compilar el proyecto:</p> <p>Descargar Pabellon5.ino</p> <p>Descargar FlashIAPLimits.h</p>"},{"location":"iot/configuracion/contadores/#archivos-auxiliares","title":"\ud83d\udd27 Archivos Auxiliares","text":"<ul> <li><code>Pabellon5.ino</code>: Archivo principal con el c\u00f3digo de ambos n\u00facleos</li> <li><code>FlashIAPLimits.h</code>: Helper para el manejo de memoria Flash IAP</li> </ul> <p>Importante: Aunque exista un solo archivo <code>.ino</code>, el firmware debe cargarse dos veces, una por cada n\u00facleo.</p>"},{"location":"iot/configuracion/contadores/#preparacion-del-entorno","title":"\ud83d\udee0\ufe0f Preparaci\u00f3n del Entorno","text":""},{"location":"iot/configuracion/contadores/#software-requerido","title":"\ud83d\udcdf Software Requerido","text":""},{"location":"iot/configuracion/contadores/#1-arduino-ide","title":"1. Arduino IDE","text":"<ul> <li>Versi\u00f3n recomendada: Arduino IDE 2.x</li> <li>Descarga: Arduino IDE Official</li> </ul>"},{"location":"iot/configuracion/contadores/#2-core-de-placa","title":"2. Core de Placa","text":"<ul> <li>Nombre: Arduino Mbed OS \u2013 Arduino Opta</li> <li>Instalaci\u00f3n: </li> <li>Abrir Arduino IDE</li> <li>Ir a <code>Herramientas</code> \u2192 <code>Placa</code> \u2192 <code>Administrador de Placas</code></li> <li>Buscar \"Arduino Opta\"</li> <li>Instalar la versi\u00f3n estable</li> </ul>"},{"location":"iot/configuracion/contadores/#librerias-necesarias","title":"\ud83d\udcda Librer\u00edas Necesarias","text":"<p>Las siguientes librer\u00edas deben instalarse desde el Administrador de Librer\u00edas de Arduino IDE:</p> Librer\u00eda Versi\u00f3n Uso FirebaseClient Estable Comunicaci\u00f3n con Firebase RTDB ESP_SSLClient Compatible Cliente SSL para conexiones seguras ArduinoJson Estable Manejo de JSON Arduino_Portenta_OTA Estable Actualizaciones Over-The-Air LiquidCrystal_I2C Estable Control de pantalla LCD Adafruit_MCP23017 Estable Control de expansor I2C Adafruit_BusIO Estable Soporte I2C/SPI <p>\u26a0\ufe0f Advertencia: Se recomienda NO actualizar librer\u00edas sin validar primero en un equipo de prueba. Las versiones estables probadas garantizan compatibilidad.</p>"},{"location":"iot/configuracion/contadores/#instalacion-de-librerias","title":"\ud83d\udce5 Instalaci\u00f3n de Librer\u00edas","text":"<ol> <li>Abrir Arduino IDE</li> <li>Ir a <code>Herramientas</code> \u2192 <code>Administrar Librer\u00edas</code></li> <li>Buscar cada librer\u00eda por nombre</li> <li>Instalar la versi\u00f3n estable recomendada</li> <li>Verificar que no haya conflictos de versiones</li> </ol>"},{"location":"iot/configuracion/contadores/#configuracion-de-placa-y-opciones","title":"\u2699\ufe0f Configuraci\u00f3n de Placa y Opciones","text":""},{"location":"iot/configuracion/contadores/#configuracion-en-arduino-ide","title":"\ud83d\udd27 Configuraci\u00f3n en Arduino IDE","text":"<p>Antes de compilar, configurar las siguientes opciones:</p> <pre><code>graph TD\n    A[Arduino IDE] --&gt; B[Herramientas]\n    B --&gt; C[Placa: Arduino Opta]\n    B --&gt; D[Core: Arduino Mbed OS]\n    B --&gt; E[Puerto: COM X]\n    B --&gt; F[Flash split: 75/25]\n\n    style C fill:#4CAF50,stroke:#2E7D32,color:#fff\n    style D fill:#2196F3,stroke:#1565C0,color:#fff\n    style F fill:#FF9800,stroke:#E65100,color:#fff</code></pre>"},{"location":"iot/configuracion/contadores/#valores-recomendados","title":"\ud83d\udccb Valores Recomendados","text":"Opci\u00f3n Valor Descripci\u00f3n Placa Arduino Opta Modelo de hardware Core Arduino Mbed OS Sistema operativo embebido Puerto COM X (Windows) / /dev/ttyACM0 (Linux) Puerto serie del dispositivo Flash split 75/25 Distribuci\u00f3n de memoria (75% M7, 25% M4) <p>Importante: El valor de Flash split afecta la distribuci\u00f3n de memoria entre M7 y M4. Usar siempre el mismo valor en todos los pabellones para mantener consistencia.</p>"},{"location":"iot/configuracion/contadores/#procedimiento-de-carga-del-firmware","title":"\ud83d\udce4 Procedimiento de Carga del Firmware","text":""},{"location":"iot/configuracion/contadores/#orden-obligatorio","title":"\ud83c\udfaf Orden Obligatorio","text":"<pre><code>graph TD\n    A[Inicio] --&gt; B[Paso 1: Programar M4]\n    B --&gt; C{\u00bfCarga exitosa?}\n    C --&gt;|No| D[Revisar errores]\n    D --&gt; B\n    C --&gt;|S\u00ed| E[Paso 2: Programar M7]\n    E --&gt; F{\u00bfCarga exitosa?}\n    F --&gt;|No| G[Revisar errores]\n    G --&gt; E\n    F --&gt;|S\u00ed| H[\u2705 Sistema completo]\n\n    style B fill:#2196F3,stroke:#1565C0,color:#fff\n    style E fill:#4CAF50,stroke:#2E7D32,color:#fff\n    style H fill:#4CAF50,stroke:#2E7D32,color:#fff\n    style D fill:#f44336,stroke:#c62828,color:#fff\n    style G fill:#f44336,stroke:#c62828,color:#fff</code></pre> <p>\u26a0\ufe0f CR\u00cdTICO: Siempre se debe programar primero el M4 y luego el M7. Este orden es obligatorio.</p>"},{"location":"iot/configuracion/contadores/#paso-1-programar-el-nucleo-cortexm4","title":"\ud83d\udd35 Paso 1 \u2013 Programar el N\u00facleo Cortex\u2011M4","text":"<p>Este paso graba la l\u00f3gica de conteo y lectura de entradas.</p>"},{"location":"iot/configuracion/contadores/#pasos-detallados","title":"\ud83d\udcdd Pasos Detallados","text":"<ol> <li>Abrir el proyecto en Arduino IDE</li> <li> <p>Abrir el archivo <code>Pabellon5.ino</code></p> </li> <li> <p>Seleccionar el n\u00facleo M4</p> </li> <li> <p>Ir a: <code>Herramientas</code> \u2192 <code>Target core</code> \u2192 <code>Cortex\u2011M4</code></p> </li> <li> <p>Verificar configuraci\u00f3n</p> </li> <li>\u2705 Placa: Arduino Opta</li> <li>\u2705 Core: Arduino Mbed OS</li> <li> <p>\u2705 Puerto COM: Seleccionar el correcto</p> </li> <li> <p>Compilar y cargar</p> </li> <li>Presionar el bot\u00f3n Upload (flecha hacia la derecha)</li> <li> <p>O usar el atajo: <code>Ctrl + U</code> (Windows/Linux) o <code>Cmd + U</code> (Mac)</p> </li> <li> <p>Esperar finalizaci\u00f3n</p> </li> <li>Observar la barra de progreso en la parte inferior</li> <li>Verificar mensaje: <code>\"Done uploading\"</code> o <code>\"Carga completada\"</code></li> </ol>"},{"location":"iot/configuracion/contadores/#verificacion-del-paso-1","title":"\u2705 Verificaci\u00f3n del Paso 1","text":"<ul> <li>El monitor serial mostrar\u00e1 mensajes de inicializaci\u00f3n del M4</li> <li>El LED <code>LED_D3</code> comenzar\u00e1 a parpadear peri\u00f3dicamente (cada 10 segundos)</li> </ul>"},{"location":"iot/configuracion/contadores/#paso-2-programar-el-nucleo-cortexm7","title":"\ud83d\udfe2 Paso 2 \u2013 Programar el N\u00facleo Cortex\u2011M7","text":"<p>Este paso graba la l\u00f3gica de red, sincronizaci\u00f3n horaria, Firebase, OTA y visualizaci\u00f3n.</p>"},{"location":"iot/configuracion/contadores/#pasos-detallados_1","title":"\ud83d\udcdd Pasos Detallados","text":"<ol> <li>Sin cerrar el proyecto, cambiar el n\u00facleo objetivo</li> <li> <p>Ir a: <code>Herramientas</code> \u2192 <code>Target core</code> \u2192 <code>Cortex\u2011M7</code></p> </li> <li> <p>Verificar nuevamente el puerto COM</p> </li> <li> <p>Asegurarse de que sigue siendo el mismo puerto</p> </li> <li> <p>Compilar y cargar</p> </li> <li>Presionar el bot\u00f3n Upload</li> <li> <p>O usar el atajo: <code>Ctrl + U</code> (Windows/Linux) o <code>Cmd + U</code> (Mac)</p> </li> <li> <p>Esperar finalizaci\u00f3n</p> </li> <li>Observar la barra de progreso</li> <li>Verificar mensaje de \u00e9xito</li> </ol>"},{"location":"iot/configuracion/contadores/#verificacion-del-paso-2","title":"\u2705 Verificaci\u00f3n del Paso 2","text":"<ul> <li>El monitor serial mostrar\u00e1:</li> <li><code>\"Conectando Ethernet (DHCP)\"</code></li> <li><code>\"IP asignada: XXX.XXX.XXX.XXX\"</code></li> <li><code>\"syncNTP: hora inicial\"</code></li> <li><code>\"Initializing app...\"</code></li> <li><code>\"El equipo se ha Re-Iniciado\"</code></li> </ul>"},{"location":"iot/configuracion/contadores/#casos-especiales","title":"\ud83d\udd04 Casos Especiales","text":""},{"location":"iot/configuracion/contadores/#cambios-en-red-ip-o-firebase","title":"Cambios en Red, IP o Firebase","text":"<p>Importante: Cambios en configuraci\u00f3n de red, IP, Firebase o l\u00f3gica general NO eximen la necesidad de volver a cargar ambos n\u00facleos.</p> <p>Si solo cambiaste: - Credenciales de Firebase - Configuraci\u00f3n de red - L\u00f3gica de negocio en el M7</p> <p>A\u00fan as\u00ed debes: 1. \u2705 Cargar el M4 (aunque no haya cambios) 2. \u2705 Cargar el M7 (con los cambios)</p>"},{"location":"iot/configuracion/contadores/#verificacion-posterior-a-la-carga","title":"\u2705 Verificaci\u00f3n Posterior a la Carga","text":""},{"location":"iot/configuracion/contadores/#verificacion-del-m4","title":"\ud83d\udd35 Verificaci\u00f3n del M4","text":"<p>El firmware del M4 incluye una se\u00f1al visual de diagn\u00f3stico:</p> <pre><code>graph LR\n    A[LED_D3] --&gt; B[Parpadea cada 10 segundos]\n    B --&gt; C{\u00bfParpadea?}\n    C --&gt;|S\u00ed| D[\u2705 M4 funcionando]\n    C --&gt;|No| E[\u274c M4 no ejecutando c\u00f3digo]\n    E --&gt; F[Revisar carga del firmware]\n\n    style D fill:#4CAF50,stroke:#2E7D32,color:#fff\n    style E fill:#f44336,stroke:#c62828,color:#fff</code></pre> <p>Si el LED no parpadea: - \u274c El M4 no est\u00e1 ejecutando c\u00f3digo - \ud83d\udd0d Revisar que el <code>Target core</code> haya sido correctamente seleccionado - \ud83d\udd0d Verificar que la carga se complet\u00f3 sin errores - \ud83d\udd0d Intentar cargar nuevamente el M4</p>"},{"location":"iot/configuracion/contadores/#verificacion-del-sistema-completo","title":"\ud83d\udfe2 Verificaci\u00f3n del Sistema Completo","text":"<p>Despu\u00e9s de cargar ambos n\u00facleos, verificar los siguientes puntos:</p>"},{"location":"iot/configuracion/contadores/#checklist-de-verificacion","title":"\u2705 Checklist de Verificaci\u00f3n","text":"<ul> <li>[ ] Conexi\u00f3n Ethernet</li> <li>El equipo obtiene IP por DHCP</li> <li> <p>Mensaje en serial: <code>\"IP asignada: XXX.XXX.XXX.XXX\"</code></p> </li> <li> <p>[ ] Sincronizaci\u00f3n NTP</p> </li> <li>La hora se sincroniza correctamente</li> <li> <p>Mensaje en serial: <code>\"syncNTP: hora inicial\"</code></p> </li> <li> <p>[ ] Contadores Funcionales</p> </li> <li>Los contadores aumentan al pasar huevos por los sensores</li> <li> <p>Verificar en la pantalla LCD o en Firebase</p> </li> <li> <p>[ ] Comunicaci\u00f3n Firebase</p> </li> <li>Los datos se reflejan en Firebase RTDB</li> <li> <p>Verificar en la consola de Firebase</p> </li> <li> <p>[ ] Pantalla LCD</p> </li> <li>Muestra el nombre del pabell\u00f3n</li> <li>Muestra el nivel (LVL)</li> <li>Muestra el conteo de huevos (H:XXXXXX)</li> </ul>"},{"location":"iot/configuracion/contadores/#errores-comunes-y-diagnostico","title":"\ud83d\udc1b Errores Comunes y Diagn\u00f3stico","text":""},{"location":"iot/configuracion/contadores/#contadores-siempre-en-0","title":"\u274c Contadores Siempre en 0","text":"<p>S\u00edntomas: - Los contadores no aumentan - Los valores en Firebase son siempre 0 - La pantalla LCD muestra <code>H:000000</code></p> <p>Causas posibles: - M4 no programado o firmware incorrecto - Carga realizada solo en M7 - Sensores desconectados o da\u00f1ados</p> <p>Soluci\u00f3n: 1. Verificar que el M4 fue cargado correctamente 2. Verificar el parpadeo del LED_D3 3. Cargar nuevamente el M4 si es necesario 4. Revisar conexiones f\u00edsicas de los sensores</p>"},{"location":"iot/configuracion/contadores/#error-de-compilacion-br_ssl_","title":"\u274c Error de Compilaci\u00f3n: <code>br_ssl_*</code>","text":"<p>S\u00edntomas: <pre><code>Error: undefined reference to 'br_ssl_*'\n</code></pre></p> <p>Causas posibles: - Incompatibilidad de versi\u00f3n de <code>ESP_SSLClient</code> - Diferencia de versi\u00f3n del core Arduino Opta - Conflictos entre librer\u00edas</p> <p>Soluci\u00f3n: 1. Usar versiones validadas de las librer\u00edas 2. No actualizar librer\u00edas sin pruebas previas 3. Verificar compatibilidad entre:    - Versi\u00f3n de Arduino IDE    - Versi\u00f3n del core Arduino Opta    - Versi\u00f3n de ESP_SSLClient</p>"},{"location":"iot/configuracion/contadores/#error-de-puerto-com","title":"\u274c Error de Puerto COM","text":"<p>S\u00edntomas: <pre><code>Error: No se puede abrir el puerto COM X\nError: Port busy\n</code></pre></p> <p>Causas posibles: - Puerto bloqueado por el monitor serial - Cambio de puerto al reiniciar el Opta - Dispositivo desconectado</p> <p>Soluci\u00f3n: 1. Cerrar el monitor serial de Arduino IDE 2. Desconectar y reconectar el cable USB 3. Esperar a que Windows/Linux detecte el dispositivo 4. Seleccionar nuevamente el puerto COM correcto 5. Intentar cargar nuevamente</p>"},{"location":"iot/configuracion/contadores/#error-de-memoria-flash","title":"\u274c Error de Memoria Flash","text":"<p>S\u00edntomas: <pre><code>Error: Flash memory full\nError: Not enough space\n</code></pre></p> <p>Causas posibles: - Flash split incorrecto - Firmware demasiado grande</p> <p>Soluci\u00f3n: 1. Verificar configuraci\u00f3n de Flash split (75/25) 2. Optimizar el c\u00f3digo si es necesario 3. Verificar que no haya librer\u00edas innecesarias</p>"},{"location":"iot/configuracion/contadores/#diagrama-de-flujo-completo","title":"\ud83d\udcca Diagrama de Flujo Completo","text":"<pre><code>graph TD\n    A[Inicio del Proceso] --&gt; B[Preparar Entorno]\n    B --&gt; C[Instalar Arduino IDE]\n    C --&gt; D[Instalar Core Arduino Opta]\n    D --&gt; E[Instalar Librer\u00edas]\n    E --&gt; F[Configurar Placa]\n    F --&gt; G[Seleccionar Target: M4]\n    G --&gt; H[Compilar y Cargar M4]\n    H --&gt; I{\u00bfCarga exitosa?}\n    I --&gt;|No| J[Revisar Errores]\n    J --&gt; G\n    I --&gt;|S\u00ed| K[Verificar LED_D3]\n    K --&gt; L[Seleccionar Target: M7]\n    L --&gt; M[Compilar y Cargar M7]\n    M --&gt; N{\u00bfCarga exitosa?}\n    N --&gt;|No| O[Revisar Errores]\n    O --&gt; L\n    N --&gt;|S\u00ed| P[Verificar Sistema]\n    P --&gt; Q{\u00bfTodo OK?}\n    Q --&gt;|No| R[Diagnosticar Problemas]\n    R --&gt; S[Consultar Secci\u00f3n Errores]\n    S --&gt; T{\u00bfProblema resuelto?}\n    T --&gt;|No| U[Solicitar Soporte]\n    T --&gt;|S\u00ed| P\n    Q --&gt;|S\u00ed| V[\u2705 Sistema Operativo]\n\n    style V fill:#4CAF50,stroke:#2E7D32,color:#fff\n    style I fill:#FF9800,stroke:#E65100,color:#fff\n    style N fill:#FF9800,stroke:#E65100,color:#fff\n    style Q fill:#FF9800,stroke:#E65100,color:#fff</code></pre>"},{"location":"iot/configuracion/contadores/#recomendaciones-operativas","title":"\ud83d\udca1 Recomendaciones Operativas","text":""},{"location":"iot/configuracion/contadores/#buenas-practicas","title":"\ud83d\udccb Buenas Pr\u00e1cticas","text":"<ol> <li>Mantener este instructivo junto al repositorio del proyecto</li> <li>Facilita el acceso r\u00e1pido a la informaci\u00f3n</li> <li> <p>Permite actualizaciones centralizadas</p> </li> <li> <p>Documentar versiones de librer\u00edas</p> </li> <li>Crear un archivo <code>requirements.txt</code> o similar</li> <li> <p>Registrar versiones probadas y estables</p> </li> <li> <p>Probar siempre en un Opta de laboratorio</p> </li> <li>Antes de desplegar en pabell\u00f3n</li> <li> <p>Validar cambios en entorno controlado</p> </li> <li> <p>No asumir funcionamiento completo</p> </li> <li>No asumir que \"si conecta a internet, est\u00e1 funcionando\"</li> <li> <p>Verificar siempre los contadores f\u00edsicamente</p> </li> <li> <p>Mantener backups del firmware</p> </li> <li>Guardar versiones estables del c\u00f3digo</li> <li>Documentar cambios y versiones</li> </ol>"},{"location":"iot/configuracion/contadores/#seguridad-y-mantenimiento","title":"\ud83d\udd12 Seguridad y Mantenimiento","text":"<ul> <li>No compartir credenciales en el c\u00f3digo fuente</li> <li>Usar variables de entorno para informaci\u00f3n sensible</li> <li>Documentar cambios en el c\u00f3digo</li> <li>Realizar pruebas antes de desplegar en producci\u00f3n</li> </ul>"},{"location":"iot/configuracion/contadores/#recursos-adicionales","title":"\ud83d\udcda Recursos Adicionales","text":""},{"location":"iot/configuracion/contadores/#enlaces-utiles","title":"\ud83d\udd17 Enlaces \u00datiles","text":"<ul> <li>Documentaci\u00f3n Oficial Arduino Opta</li> <li>Arduino Mbed OS Documentation</li> <li>Firebase Realtime Database</li> <li>STM32H747 Reference Manual</li> </ul>"},{"location":"iot/configuracion/contadores/#documentacion-relacionada","title":"\ud83d\udcd6 Documentaci\u00f3n Relacionada","text":"<ul> <li>Configuraci\u00f3n Azure IoT</li> <li>Estructura del Proyecto</li> </ul>"},{"location":"iot/configuracion/contadores/#resumen-ejecutivo","title":"\ud83c\udfaf Resumen Ejecutivo","text":""},{"location":"iot/configuracion/contadores/#procedimiento-obligatorio","title":"\u2705 Procedimiento Obligatorio","text":"<p>Este procedimiento es obligatorio para cualquier intervenci\u00f3n en los contadores de huevos basados en Arduino Opta.</p>"},{"location":"iot/configuracion/contadores/#cumplimiento-de-pasos","title":"\ud83c\udfaf Cumplimiento de Pasos","text":"<p>El cumplimiento de estos pasos asegura:</p> <ul> <li>\u2705 Conteo confiable de huevos</li> <li>\u2705 Operaci\u00f3n estable del sistema</li> <li>\u2705 Continuidad operativa independiente de personas espec\u00edficas</li> <li>\u2705 Reducci\u00f3n de errores comunes</li> </ul>"},{"location":"iot/configuracion/contadores/#recordatorio-final","title":"\ud83d\udcdd Recordatorio Final","text":"<p>IMPORTANTE: Siempre programar primero el M4 y luego el M7. Este orden es cr\u00edtico para el funcionamiento correcto del sistema.</p>"},{"location":"logica_negocio/SAASS/flujo/","title":"API Packaging y Distribuci\u00f3n - Documentaci\u00f3n (Admin)","text":""},{"location":"logica_negocio/SAASS/flujo/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Sistema de gesti\u00f3n de packaging y distribuci\u00f3n que permite controlar el proceso desde el packaging hasta los puntos de venta. Integraci\u00f3n con SAP Business Layer para gesti\u00f3n de inventario y documentos.</p>"},{"location":"logica_negocio/SAASS/flujo/#ejemplos-de-documentos","title":"Ejemplos de Documentos","text":""},{"location":"logica_negocio/SAASS/flujo/#guia-de-transferencia-de-stock","title":"Gu\u00eda de transferencia de stock","text":"<p>Puedes descargar un ejemplo de gu\u00eda de transferencia de stock generada por el sistema:</p> <p> Descargar ejemplo de Gu\u00eda de transferencia de stock (PDF)</p> <p>Nota sobre el documento</p> <p>Este documento es un ejemplo de una gu\u00eda de despacho generada por el sistema. Contiene todos los campos relevantes como informaci\u00f3n del cliente, conductor, veh\u00edculo, producto, cantidades y valores.</p>"},{"location":"logica_negocio/SAASS/flujo/#video-demostracion","title":"Video Demostraci\u00f3n","text":"Notas Importantes <ul> <li>Sistema integrado con SAP Business Layer</li> <li>Control de documentos de transferencia</li> <li>Acceso v\u00eda huevosdehoy.tracmin.cl</li> </ul> Consideraciones de Seguridad <ul> <li>Validaci\u00f3n de permisos SAP</li> <li>Control de acceso por rol</li> <li>Validaci\u00f3n de documentos de transferencia</li> <li>Trazabilidad de movimientos</li> </ul> Mejores Pr\u00e1cticas <ul> <li>Verificar stock antes de transferencias</li> <li>Mantener registro de movimientos</li> <li>Monitorear niveles de inventario</li> <li>Documentar ajustes de stock</li> <li>Notificar eventos cr\u00edticos</li> </ul> Integraciones <ul> <li>SAP Business Layer:<ul> <li>Gesti\u00f3n de inventario</li> <li>Generaci\u00f3n de documentos</li> <li>Control de stock</li> </ul> </li> <li>Web App:<ul> <li>Interfaz de usuario (huevosdehoy.tracmin.cl)</li> <li>Operaciones de packaging</li> <li>Gesti\u00f3n de transferencias</li> </ul> </li> </ul>"},{"location":"logica_negocio/SAASS/flujo/#flujo-operacional-packaging-despacho-y-distribucion","title":"Flujo Operacional: Packaging, Despacho y Distribuci\u00f3n","text":"<p>Este documento describe el proceso paso a paso de la gesti\u00f3n desde la etrada hasta la distribuci\u00f3n de stock hacia las distintas bodegas, utilizando la integraci\u00f3n con SAP Business Layer y la aplicaci\u00f3n web huevosdehoy.tracmin.cl.</p>"},{"location":"logica_negocio/SAASS/flujo/#descripcion-de-pasos","title":"Descripci\u00f3n de Pasos","text":"1. Despacho desde Packaging <ul> <li>Se inicia el proceso de carga de huevos en el transporte</li> <li>El sistema genera autom\u00e1ticamente la Gu\u00eda de Despacho SAASS</li> <li>Se registra la Entrada de Mercanc\u00eda en SAP (BodegaBOD0003)</li> <li>El operador confirma la carga en huevosdehoy.tracmin.cl</li> </ul> 2. Recepci\u00f3n en Bodega Central <ul> <li>El transporte llega a la bodega central</li> <li>Se confirma la recepci\u00f3n en SAP</li> <li>El sistema actualiza el inventario autom\u00e1ticamente</li> <li>Se registra la ubicaci\u00f3n f\u00edsica del producto</li> </ul> 3. Distribuci\u00f3n a Puntos de Venta <ul> <li>Se planifica la distribuci\u00f3n a bodegas de venta</li> <li>El sistema genera Gu\u00edas de Transferencia</li> <li>Se asigna stock a cada punto de venta</li> <li>Se actualiza el inventario en tiempo real</li> </ul> 4. Transferencia de Stock <ul> <li>Se procesa la transferencia en SAP</li> <li>Se genera documentaci\u00f3n de movimiento</li> <li>Se actualiza inventario en origen y destino</li> <li>Se confirma la recepci\u00f3n en destino</li> </ul> 5. Recepci\u00f3n en Puntos de Venta <ul> <li>Se confirma la recepci\u00f3n en destino</li> <li>El sistema actualiza el inventario final</li> <li>Se genera documentaci\u00f3n de cierre</li> <li>Se registra la disponibilidad para venta</li> </ul>"},{"location":"logica_negocio/SAASS/flujo/#diagrama-de-flujo","title":"Diagrama de Flujo","text":"<pre><code>flowchart TD\n    A([\"Despacho de Huevos Packing\"]) --&gt; n2[\"Carga de huevos en transporte\"]\n    n2 --&gt; n3[\"Gu\u00eda de despacho SAASS (Entrega)\"] &amp; n5[\"Entrada de Mercancia Comer&lt;br&gt;(BodegaBOD0003)\"]\n    n5 --&gt; n4[\"Recepci\u00f3n en Bodega Comer\"]\n    n3 --&gt; n4\n    n4 --&gt; n6[\"Distribuci\u00f3n a bodegas de venta (Locales, Vendedores)\"]\n    n6 --&gt; n7[\"Gu\u00eda de despacho (Transferencia de stock)\"]\n    n7 --&gt; n8[\"Recepci\u00f3n autom\u00e1tica en bodegas de venta\"]\n    n3@{ shape: doc}\n    n5@{ shape: doc}\n    n7@{ shape: doc}</code></pre>"},{"location":"logica_negocio/SAASS/flujo/#integracion-tecnica","title":"Integraci\u00f3n T\u00e9cnica","text":"SAP Business Layer <ul> <li>Gesti\u00f3n de documentos: <code>{ Gu\u00edaDespacho, TransferenciaStock, EntradaMercanc\u00eda }</code></li> <li>Control de inventario: <code>{ Actualizaci\u00f3nStock, Validaci\u00f3nDisponibilidad }</code></li> <li>Procesos autom\u00e1ticos: <code>{ Generaci\u00f3nDocumentos, Actualizaci\u00f3nInventario }</code></li> </ul> Requisitos de Infraestructura <ul> <li>Conexi\u00f3n estable con SAP Business Layer</li> <li>Acceso a huevosdehoy.tracmin.cl</li> </ul>"},{"location":"logica_negocio/combustible/entrada_mercancia/","title":"API Combustible - Documentaci\u00f3n (Admin)","text":""},{"location":"logica_negocio/combustible/entrada_mercancia/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Sistema de gesti\u00f3n de combustible que permite registrar y consultar el consumo de combustible de la flota. Acceso exclusivo para administradores.</p> Notas Importantes <ul> <li>Sistema CRUD para gesti\u00f3n de combustible</li> <li>Acceso restringido a administradores</li> <li>Modelos principales:     modelos<pre><code>class reqSession(BaseModel):\n    Folio: str\n\nclass reqSessionPostStock(BaseModel):\n    Folio: str\n    Planta: str\n    Patente: str\n    FotoDocumento: str  # Base64\n    WarehouseCodeQuantity: List[WarehouseCodeQuantityItem]\n    UnitPrice: float\n\nclass WarehouseCodeQuantityItem(BaseModel):\n    WarehouseCode: str\n    Quantity: float\n</code></pre></li> </ul> Consideraciones de Seguridad <ul> <li>Validaci\u00f3n de key de autorizaci\u00f3n</li> <li>Acceso restringido a administradores</li> <li>Validaci\u00f3n de documentos</li> <li>Protecci\u00f3n de datos sensibles</li> <li>Control de acceso a bodegas</li> </ul> Mejores Pr\u00e1cticas <ul> <li>Validar documentos antes de procesar</li> <li>Mantener registro de transacciones</li> <li>Monitorear niveles de stock</li> <li>Documentar cambios de inventario</li> <li>Notificar eventos importantes</li> </ul> Integraciones <ul> <li>FEBOS:<ul> <li>Consulta de documentos tributarios</li> <li>Validaci\u00f3n de gu\u00edas</li> </ul> </li> <li>SAP:<ul> <li>Control de inventario</li> <li>Registro de movimientos</li> </ul> </li> <li>Azure:<ul> <li>Almacenamiento de documentos</li> <li>Gesti\u00f3n de archivos</li> </ul> </li> <li>Email:<ul> <li>Notificaciones autom\u00e1ticas</li> <li>Alertas de stock</li> </ul> </li> </ul>"},{"location":"logica_negocio/combustible/entrada_mercancia/#endpoints-combustible","title":"Endpoints Combustible","text":"EndpointsSequence DiagramEjemplos de RespuestaC\u00f3digos de EstadoValidaciones Consultar Gu\u00eda de Combustible POST /api/logipath/get_fuel_guide<pre><code>@router.post(f\"{APP_PATH}/get_fuel_guide\")\nasync def fuel(res: Request, req: reqSession):\n    \"\"\"\n    Obtiene informaci\u00f3n detallada de una gu\u00eda de combustible.\n\n    Args:\n        res (Request): Request con key de autorizaci\u00f3n\n        req (reqSession): Folio de la gu\u00eda\n\n    Returns:\n        dict: {\n            \"documento\": dict,\n            \"tipo_dte\": str,\n            \"folio\": int,\n            \"fecha_emision\": str,\n            \"razon_social_emisor\": str,\n            \"monto_total\": float,\n            \"cantidad\": float,\n            \"PrcItem\": float,\n            \"DirDest\": str,\n            \"CmnaDest\": str,\n            \"CiudadDest\": str\n        }\n\n    Raises:\n        HTTPException: \n            - 401: Si la key es inv\u00e1lida\n            - 500: Error en la consulta\n    \"\"\"\n</code></pre> Consultar Stock de Combustible POST /api/logipath/get_stock_fuel<pre><code>@router.post(f\"{APP_PATH}/get_stock_fuel\")\nasync def fuel(res: Request, req: reqSession):\n    \"\"\"\n    Obtiene el stock actual de combustible por bodega.\n\n    Args:\n        res (Request): Request con key de autorizaci\u00f3n\n        req (reqSession): Datos de consulta\n\n    Returns:\n        dict: {\n            \"bodegas\": [\n                {\n                    \"WarehouseCode\": str,\n                    \"cantidad\": float,\n                    \"WarehouseName\": str,\n                    \"MaximalStock\": float,\n                    \"MinimalStock\": float\n                }\n            ]\n        }\n    \"\"\"\n</code></pre> Registrar Consumo de Combustible POST /api/logipath/post_fuel_stock<pre><code>@router.post(f\"{APP_PATH}/post_fuel_stock\")\nasync def fuel(res: Request, req: reqSessionPostStock):\n    \"\"\"\n    Registra el consumo de combustible y actualiza stock.\n\n    Args:\n        res (Request): Request con key de autorizaci\u00f3n\n        req (reqSessionPostStock): Datos del consumo\n\n    Returns:\n        dict: {\n            \"message\": str,\n            \"IdAzure\": str,\n            \"LinkAzure\": str\n        }\n    \"\"\"\n</code></pre> <pre><code>sequenceDiagram\n    participant Admin\n    participant API\n    participant FEBOS\n    participant SAP\n    participant Azure\n    participant Email\n\n    alt Consulta Gu\u00eda\n        Admin-&gt;&gt;API: POST /get_fuel_guide\n        API-&gt;&gt;API: Validar Key\n        API-&gt;&gt;FEBOS: Consultar Gu\u00eda\n        FEBOS--&gt;&gt;API: XML Gu\u00eda\n        API-&gt;&gt;API: Procesar XML\n        API--&gt;&gt;Admin: Datos Gu\u00eda\n\n    else Consulta Stock\n        Admin-&gt;&gt;API: POST /get_stock_fuel\n        API-&gt;&gt;API: Validar Key\n        API-&gt;&gt;SAP: Login\n        SAP--&gt;&gt;API: Token\n        API-&gt;&gt;SAP: Consultar Stock\n        SAP--&gt;&gt;API: Datos Stock\n        API--&gt;&gt;Admin: Stock por Bodega\n\n    else Registrar Consumo\n        Admin-&gt;&gt;API: POST /post_fuel_stock\n        API-&gt;&gt;API: Validar Key\n        API-&gt;&gt;SAP: Actualizar Stock\n\n        par Almacenar Documento\n            API-&gt;&gt;Azure: Subir Foto\n            Azure--&gt;&gt;API: URL Documento\n        and Notificar\n            API-&gt;&gt;Email: Enviar Notificaci\u00f3n\n        end\n\n        API--&gt;&gt;Admin: Confirmaci\u00f3n\n    end</code></pre> Consulta Gu\u00eda <pre><code>{\n    \"documento\": {\n        \"xmlLink\": \"https://api.febos.cl/...\"\n    },\n    \"tipo_dte\": \"33\",\n    \"folio\": \"123456\",\n    \"fecha_emision\": \"2024-03-20\",\n    \"razon_social_emisor\": \"Empresa Combustibles\",\n    \"monto_total\": 150000.00,\n    \"cantidad\": 100.00,\n    \"PrcItem\": 1500.00\n}\n</code></pre> Consulta Stock <pre><code>{\n    \"bodegas\": [\n        {\n            \"WarehouseCode\": \"BOD1017\",\n            \"cantidad\": 5000.00,\n            \"WarehouseName\": \"Estanque Equipos M\u00f3viles\",\n            \"MaximalStock\": 10000.00,\n            \"MinimalStock\": 1000.00\n        }\n    ]\n}\n</code></pre> C\u00f3digo Descripci\u00f3n 200 Operaci\u00f3n exitosa 401 No autorizado 404 Documento no encontrado 500 Error interno Campo Regla Folio Formato v\u00e1lido Cantidad &gt; 0 FotoDocumento Base64 v\u00e1lido WarehouseCode Existente en SAP"},{"location":"logica_negocio/combustible/guias/","title":"Gu\u00edas Combustible - Documentaci\u00f3n","text":""},{"location":"logica_negocio/combustible/guias/#flujo-proceso-consumos-de-combustible","title":"Flujo Proceso Consumos de Combustible","text":"<p>Proceso que automatiza la generaci\u00f3n de gu\u00edas de despacho para consumos de combustible, integrando datos desde Neotac con SAP y Febos.</p> Visi\u00f3n de Negocio <p>El proceso automatiza la generaci\u00f3n de documentos tributarios para consumos de combustible siguiendo estos pasos clave:</p> 1. Identificaci\u00f3n de Consumos <p>Busca en la base de datos Neotac los consumos de combustible que no tienen gu\u00eda asociada.</p> 2. Validaci\u00f3n de Datos <p>Verifica que el RUT del conductor y la patente del veh\u00edculo sean v\u00e1lidos y est\u00e9n registrados.</p> 3. Determinaci\u00f3n de Precios <ul> <li>Consulta precios actuales de combustible en API externa (bencinaenlinea.cl)</li> <li>Obtiene impuestos espec\u00edficos desde el SII mediante web scraping</li> <li>Calcula precio final seg\u00fan el tipo de acuerdo comercial:<ul> <li>TipoAcuerdo 0: Precio copec menos impuesto espec\u00edfico, sin IVA, m\u00e1s margen</li> <li>TipoAcuerdo 1: Precio de costo m\u00e1s margen</li> </ul> </li> </ul> 4. Generaci\u00f3n de Documentos <ul> <li>Crea gu\u00eda de despacho en SAP con los datos del consumo</li> <li>Genera XML para documento tributario electr\u00f3nico</li> <li>Env\u00eda a Febos para foliado</li> </ul> 5. Actualizaci\u00f3n de Estado <ul> <li>Actualiza la gu\u00eda en SAP con el folio de Febos</li> <li>Registra el estado del proceso en NeotacGuiasStatus</li> <li>Obtiene link al documento para consulta posterior</li> </ul> Integraciones Clave <ul> <li>SAP: Creaci\u00f3n y actualizaci\u00f3n de gu\u00edas de despacho</li> <li>Febos: Timbrado electr\u00f3nico y foliado de documentos tributarios</li> <li>SII: Obtenci\u00f3n de impuestos espec\u00edficos a combustibles</li> <li>API de Precios: Consulta de precios actuales de combustible</li> </ul> Bases de Datos Tabla Descripci\u00f3n Datos Relevantes ConsumosNeotac Registra las transacciones de combustible desde Neotac Voucher, fecha, volumen, patente, RUT conductor, producto NeotacGuiasStatus Almacena el estado de procesamiento de cada gu\u00eda Voucher, DocEntry, Folio, FebosId, Status, errores VehiculosNeoTac Contiene informaci\u00f3n de los veh\u00edculos autorizados Patente, Empresa, datos t\u00e9cnicos ClientesCombustible Almacena informaci\u00f3n de clientes y sus acuerdos comerciales Empresa, TipoAcuerdo, Margen"},{"location":"logica_negocio/combustible/guias/#ejemplos-de-documentos","title":"Ejemplos de Documentos","text":""},{"location":"logica_negocio/combustible/guias/#guia-de-despacho-de-combustible","title":"Gu\u00eda de Despacho de Combustible","text":"<p>Puedes descargar un ejemplo de gu\u00eda de despacho de combustible generada por el sistema:</p> <p> Descargar ejemplo de Gu\u00eda de Despacho (PDF)</p> <p>Nota sobre el documento</p> <p>Este documento es un ejemplo de una gu\u00eda de despacho generada por el sistema. Contiene todos los campos relevantes como informaci\u00f3n del cliente, conductor, veh\u00edculo, producto, cantidades y valores.</p>"},{"location":"logica_negocio/combustible/guias/#diagramas-de-flujo","title":"Diagramas de Flujo","text":"FlujoDiagrama de SecuenciaEjemplos de RespuestaC\u00f3digos de Estado <pre><code>flowchart TD\nA[\"Inicio\"] --&gt; B[\"Obtener consumos sin procesar\"]\nB --&gt; C{\"\u00bfHay consumos?\"}\nC -- No --&gt; D[\"Retornar: No hay consumos nuevos\"]\nC -- S\u00ed --&gt; E[\"Procesar cada consumo\"]\nE --&gt; F[\"Validar datos del consumo\"]\nF --&gt; G{\"\u00bfDatos v\u00e1lidos?\"}\nG -- No --&gt; H[\"Registrar error y continuar\"]\nH --&gt; V[\"Continuar con siguiente consumo\"]\nG -- S\u00ed --&gt; I[\"Login en SAP\"]\nI --&gt; J[\"Obtener precio combustible\"]\nJ --&gt; K[\"Obtener datos impuestos SII\"]\nK --&gt; L[\"Crear gu\u00eda en SAP\"]\nL --&gt; M[\"Registrar gu\u00eda en base de datos\"]\nM --&gt; N[\"Obtener detalles adicionales\"]\nN --&gt; O[\"Generar XML para Febos\"]\nO --&gt; P[\"Enviar documento a Febos\"]\nP --&gt; Q{\"\u00bf\u00c9xito en Febos?\"}\nQ -- No --&gt; R[\"Cancelar gu\u00eda en SAP y registrar error\"]\nR --&gt; V\nQ -- S\u00ed --&gt; S[\"Actualizar gu\u00eda en SAP con folio\"]\nS --&gt; T[\"Obtener link de documento\"]\nT --&gt; U[\"Actualizar estado final\"]\nU --&gt; V\nV --&gt; W[\"Retornar resumen de procesamiento\"]</code></pre> <pre><code>sequenceDiagram\nparticipant API\nparticipant DB\nparticipant SAP\nparticipant SII\nparticipant PrecioAPI\nparticipant Febos\n\nNote over API: Inicio del proceso\n\nAPI-&gt;&gt;DB: Obtener consumos sin procesar\nDB--&gt;&gt;API: Lista de consumos\n\nalt No hay consumos\n    API--&gt;&gt;API: Retornar \"No hay consumos nuevos\"\nelse Hay consumos\n    loop Para cada consumo\n        API-&gt;&gt;API: Validar datos del consumo (RUT, patente)\n\n        alt Datos inv\u00e1lidos\n            API-&gt;&gt;DB: Registrar error\n            Note over API: Continuar con siguiente consumo\n        else Datos v\u00e1lidos\n            API-&gt;&gt;SAP: Login en SAP\n            SAP--&gt;&gt;API: Sesi\u00f3n autenticada\n\n            API-&gt;&gt;PrecioAPI: Obtener precio combustible\n            PrecioAPI--&gt;&gt;API: Precio actual\n\n            API-&gt;&gt;SII: Obtener datos impuestos SII\n            SII--&gt;&gt;API: Componentes IEF, IEV, IER\n\n            API-&gt;&gt;SAP: Crear gu\u00eda en SAP\n            SAP--&gt;&gt;API: DocEntry\n\n            API-&gt;&gt;DB: Registrar gu\u00eda en base de datos\n\n            API-&gt;&gt;SAP: Obtener detalles adicionales\n            SAP--&gt;&gt;API: Datos cliente y direcci\u00f3n\n\n            API-&gt;&gt;API: Generar XML para Febos\n\n            API-&gt;&gt;Febos: Enviar documento a Febos\n\n            alt Error en Febos\n                Febos--&gt;&gt;API: Error\n                API-&gt;&gt;SAP: Cancelar gu\u00eda en SAP\n                API-&gt;&gt;DB: Registrar error\n                Note over API: Continuar con siguiente consumo\n            else \u00c9xito en Febos\n                Febos--&gt;&gt;API: Folio y FebosId\n\n                API-&gt;&gt;SAP: Actualizar gu\u00eda en SAP con folio\n\n                API-&gt;&gt;Febos: Obtener link de documento\n                Febos--&gt;&gt;API: URL documento\n\n                API-&gt;&gt;DB: Actualizar estado final\n                Note over API: Continuar con siguiente consumo\n            end\n        end\n    end\n    API--&gt;&gt;API: Retornar resumen de procesamiento\nend</code></pre> Gu\u00eda generada correctamente <pre><code>{\n  \"message\": \"Se procesaron 3 consumos correctamente y fallaron 1 consumos\",\n  \"exitosos\": [\n    {\n      \"voucher\": \"12345\",\n      \"folio\": \"987654\",\n      \"link\": \"https://febos.cl/documento/987654\",\n      \"docEntry\": 12345,\n      \"monto_bruto\": 50000,\n      \"monto_neto\": 42016.81,\n      \"monto_iev\": 1.25,\n      \"monto_ief\": 3.75\n    }\n  ],\n  \"fallidos\": [\n    {\n      \"voucher\": \"67890\",\n      \"error\": \"RUT inv\u00e1lido: 12345678-9\",\n      \"patente\": \"ABCD12\"\n    }\n  ]\n}\n</code></pre> Error en la creaci\u00f3n de la gu\u00eda <pre><code>{\n    \"message\": \"Error al procesar los consumos\",\n    \"error\": str(e)\n}\n</code></pre> C\u00f3digo Descripci\u00f3n 200 Operaci\u00f3n exitosa 401 No autorizado 404 Documento no encontrado 500 Error interno"},{"location":"logica_negocio/combustible/ingreso_documento_combustible/","title":"API Combustible - Documentaci\u00f3n (Admin)","text":""},{"location":"logica_negocio/combustible/ingreso_documento_combustible/#diagrama-de-flujo","title":"Diagrama de Flujo","text":"<pre><code>flowchart TD\n    A[Admin inicia b\u00fasqueda] --&gt; B{\u00bfGu\u00eda o Factura?}\n    B -- Gu\u00eda --&gt; C[POST /search_guia_copec]\n    B -- Factura --&gt; D[POST /search_factura_mail]\n    C --&gt; E[Validar Key]\n    D --&gt; E\n    E --&gt; F[Buscar en Email]\n    F --&gt; G[Procesar datos]\n    G --&gt; H[Mostrar datos a Admin]\n    H --&gt; I[Admin confirma]\n    I --&gt; J{\u00bfGu\u00eda o Factura?}\n    J -- Gu\u00eda --&gt; K[Subir Gu\u00eda a Azure]\n    J -- Factura --&gt; L[Guardar Factura]\n    L --&gt; M[Subir Factura a Azure]\n    M --&gt; N[Subir Factura a SAP]\n    N --&gt; O[Confirmaci\u00f3n SAP]</code></pre>"},{"location":"logica_negocio/combustible/ingreso_documento_combustible/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Sistema de gesti\u00f3n de documentos relacionados a combustible que permite ingresar aquellas gu\u00edas o facturas no fueron ingresadas al sistema. Acceso exclusivo para administradores.</p> Notas Importantes <ul> <li>Sistema CRUD para gesti\u00f3n de documentos</li> <li>Acceso restringido a administradores</li> <li>Modelos principales:     modelos<pre><code>class reqSessionSearchDoc(BaseModel):\n    numero_doc: str\n    confirmar: bool = False\n</code></pre></li> </ul> Consideraciones de Seguridad <ul> <li>Validaci\u00f3n de key de autorizaci\u00f3n</li> <li>Acceso restringido a administradores</li> <li>Validaci\u00f3n de documentos</li> <li>Protecci\u00f3n de datos sensibles</li> <li>Control de acceso a bodegas</li> </ul> Mejores Pr\u00e1cticas <ul> <li>Validar documentos antes de procesar</li> <li>Mantener registro de transacciones</li> </ul> Integraciones <ul> <li>Azure:<ul> <li>Almacenamiento de documentos</li> <li>Gesti\u00f3n de archivos</li> </ul> </li> <li>Email:<ul> <li>Obtenci\u00f3n de documentos</li> </ul> </li> <li>SAP<ul> <li>Subir documentos encontrados</li> </ul> </li> </ul>"},{"location":"logica_negocio/combustible/ingreso_documento_combustible/#endpoints-combustible","title":"Endpoints Combustible","text":"EndpointsSequence DiagramEjemplos de RespuestaC\u00f3digos de EstadoValidaciones Buscar Gu\u00eda de Combustible POST /api/logipath/search_guia_copec<pre><code>    @router.post(f\"{APP_PATH}/search_guia_copec\")\n    async def search_guia_copec(sec: Request, req: reqSessionSearchDoc):\n    \"\"\"\n    Busca una gu\u00eda de despacho de COPEC por folio\n\n    Args:\n        res (Request): Request con key de autorizaci\u00f3n\n        req (reqSessionSearchDoc): Folio documento y estado de confirmaci\u00f3n\n\n        return {\n            \"message\": str,\n            \"email\": str,\n            \"copec_link\": str,\n            \"numero_guia\": int,\n            \"folio\": int,\n            \"patente\": str,\n            \"litros\": int,\n            \"planta\": str,\n            \"destino\": str,\n            \"hora_entrada\": date,\n            \"pdf_link\": str,\n            \"xml_link\": str,\n            \"database_created\": bool,\n            \"sap_updated\": str,\n            \"sap_docentry\": str,\n            \"email_info\": {\n                \"subject\": str,\n                \"received_date\": date,\n                \"from\": str\n            }\n        }\n\n    Raises:\n        HTTPException: \n            - 401: Si la key es inv\u00e1lida\n            - 500: Error en la consulta\n    \"\"\"\n</code></pre> Buscar factura de combustible POST /api/logipath/search_factura_mail<pre><code>    @router.post(f\"{APP_PATH}/search_factura_mail\")\n    async def search_factura_mail(sec: Request, req: reqSessionSearchDoc):\n    \"\"\"\n    Busca una factura de COPEC por folio\n\n    Args:\n        res (Request): Request con key de autorizaci\u00f3n\n        req (reqSession): Folio de la factura\n\n    return {\n        \"message\": str,\n        \"email\": str,\n        \"copec_link\": str,\n        \"numero_guia\": int,\n        \"folio\": int,\n        \"patente\": str,\n        \"litros\": int,\n        \"planta\": str,\n        \"destino\": str,\n        \"hora_entrada\": date,\n        \"pdf_link\": str,\n        \"xml_link\": str,\n        \"database_created\": bool,\n        \"sap_updated\": str,\n        \"sap_docentry\": str,\n        \"email_info\": {\n            \"subject\": str,\n            \"received_date\": date,\n            \"from\": str\n        }\n    }\n\n    Raises:\n        HTTPException: \n            - 401: Si la key es inv\u00e1lida\n            - 500: Error en la consulta\n    \"\"\"\n</code></pre> <pre><code>sequenceDiagram\n    participant Admin\n    participant API\n    participant Email\n    participant Azure\n    participant SAP\n\n    alt Buscar Gu\u00eda\n        Admin-&gt;&gt;API: POST /search_guia_copec\n        API-&gt;&gt;API: Validar Key\n        API-&gt;&gt;Email: Buscar Gu\u00eda\n        Email--&gt;&gt;API: Gu\u00eda y datos\n        API-&gt;&gt;API: Procesar datos\n        API--&gt;&gt;Admin: Datos Gu\u00eda\n        Admin-&gt;&gt;API: Confirmar gu\u00eda\n        API-&gt;&gt;API:Subir Gu\u00eda\n        API-&gt;&gt;Azure: Subir documento\n\n    else Buscar Factura\n        Admin-&gt;&gt;API: POST /search_factura_mail\n        API-&gt;&gt;API: Validar Key\n        API-&gt;&gt;Email: Buscar Factura\n        Email--&gt;&gt;API: Factura y datos\n        API-&gt;&gt;API: Procesar datos\n        API--&gt;&gt;Admin: Datos Factura\n        Admin-&gt;&gt;API: Confirmar Factura\n        API-&gt;&gt;API:Guardar Factura\n        API-&gt;&gt;Azure: Subir documento\n        API-&gt;&gt;SAP:Subir Factura\n        SAP--&gt;&gt;API: Confirmaci\u00f3n Factura\n\n    end</code></pre> Buscar Gu\u00eda o Factura <pre><code>{\n    \"message\":\"preview\",    \n    \"data\":\n        {\n            \"copec_link\":\"http://copec2510.acepta.com/v01/C0849616120FDD85B5DDF62445F0DA37D7391439?k=4fe0c3d4b0963c0dfee2e137087661c7\",\n            \"folio\":\"18496166\",\n            \"litros\":\"15000.000\",\n            \"comuna\":\"EMPEDRADO\",\n            \"patente\":\"KBVX73\",\n            \"pdf_url\":\"https://copec2505.acepta.com/ca4webv3/PdfViewMedia?url=http%3A%2F%2Fcopec2510.acepta.com%2Fv01%2FC0849616120FDD85B5DDF62445F0DA37D7391439%3Fk%3D4fe0c3d4b0963c0dfee2e137087661c7\",\n            \"xml_url\":\"https://copec2505.acepta.com/ca4webv3/XmlView?url=http%3A%2F%2Fcopec2510.acepta.com%2Fv01%2FC0849616120FDD85B5DDF62445F0DA37D7391439%3Fk%3D4fe0c3d4b0963c0dfee2e137087661c7\"\n        }\n}\n</code></pre> C\u00f3digo Descripci\u00f3n 200 Operaci\u00f3n exitosa 401 No autorizado 404 Documento no encontrado 500 Error interno Campo Regla Folio Formato v\u00e1lido Documento No ingresado"},{"location":"logica_negocio/romanaremota/flujo/","title":"API Romana Remota - Documentaci\u00f3n (Admin)","text":""},{"location":"logica_negocio/romanaremota/flujo/#descripcion-general","title":"Descripci\u00f3n General","text":"<p>Sistema de gesti\u00f3n de pesaje y despacho que permite registrar y controlar el proceso de taraje, carga y despacho de camiones. Acceso exclusivo para administradores y operadores de romana.</p>"},{"location":"logica_negocio/romanaremota/flujo/#video-demostracion","title":"Video Demostraci\u00f3n","text":"Notas Importantes <ul> <li>Sistema CRUD para gesti\u00f3n de pesaje y despacho</li> <li>Acceso restringido a administradores y operadores</li> </ul> Consideraciones de Seguridad <ul> <li>Validaci\u00f3n de key de autorizaci\u00f3n</li> <li>Acceso restringido a administradores y operadores</li> <li>Validaci\u00f3n de documentos</li> <li>Control de acceso a romana</li> </ul> Mejores Pr\u00e1cticas <ul> <li>Validar pesajes antes de procesar</li> <li>Mantener registro de transacciones</li> <li>Monitorear estado de sem\u00e1foros</li> <li>Documentar cambios de estado</li> <li>Notificar eventos importantes</li> </ul> Integraciones <ul> <li>WebSocket:<ul> <li>Comunicaci\u00f3n en tiempo real</li> <li>Notificaciones de estado</li> </ul> </li> <li>RDP:<ul> <li>Conexi\u00f3n a romana</li> <li>Control de pesaje</li> <li>Generaci\u00f3n de gu\u00edas</li> </ul> </li> <li>Impresora:<ul> <li>Impresi\u00f3n de documentos</li> </ul> </li> <li>Email:<ul> <li>Notificaciones autom\u00e1ticas</li> <li>Alertas de estado</li> </ul> </li> </ul>"},{"location":"logica_negocio/romanaremota/flujo/#flujo-operacional-pesaje-carga-y-despacho-de-camiones","title":"Flujo Operacional: Pesaje, Carga y Despacho de Camiones","text":"<p>Este documento describe el proceso paso a paso de la sub-feature que gestiona el pesaje de camiones (tara y carga), la comunicaci\u00f3n en tiempo real v\u00eda WebSocket entre las aplicaciones de Tracmin (Conductor y Cargador Frontal) y la generaci\u00f3n de la gu\u00eda de despacho.</p>"},{"location":"logica_negocio/romanaremota/flujo/#descripcion-de-pasos","title":"Descripci\u00f3n de Pasos","text":"1. Llegada y Tara <ul> <li>El cami\u00f3n llega a la Romana</li> <li>El sem\u00e1foro de taraje se pone en VERDE</li> <li>La Romana establece conexi\u00f3n RDP con el escritorio remoto donde el operador de Tracmin Admin realiza el pesaje sin carga</li> <li>El operador registra el valor de tara en la aplicaci\u00f3n Tracmin Admin</li> </ul> 2. Notificaci\u00f3n de Nueva Tara <ul> <li>Al registrar la tara, Tracmin Admin emite un mensaje WebSocket (<code>NuevaTara</code>) con el valor y el ID de cami\u00f3n</li> <li>Las aplicaciones Tracmin Conductor y Tracmin Cargador Frontal, suscritas al canal de WebSocket, reciben el evento y actualizan su interfaz para mostrar la nueva tara</li> </ul> 3. Proceso de Carga <ul> <li>El cami\u00f3n se dirige a la planta de carga e inicia conexi\u00f3n bidireccional</li> <li>El flujo conecta directamente con la confirmaci\u00f3n de inicio de carga por parte del cargador frontal y conductor</li> <li>El conductor o cargador pueden pulsar \"Iniciar Carga\" en Tracmin, emitiendo un evento WebSocket</li> <li>Una vez completada la carga, el cargador frontal o conductor emite un evento WebSocket para finalizar la carga</li> <li>El conductor y cargador reciben la se\u00f1al de fin de carga, cerrando el ciclo de carga</li> </ul> 4. Pesaje con Carga <ul> <li>El cami\u00f3n regresa a la Romana para el pesaje con carga</li> <li>El sem\u00e1foro de pesaje cambia a VERDE</li> <li>El operador pesa el cami\u00f3n y registra el peso bruto en Tracmin Admin</li> </ul> 5. Generaci\u00f3n de Gu\u00eda de Despacho <ul> <li>Tras el registro del peso con carga, Tracmin Admin calcula el peso neto (peso bruto \u2013 tara) y genera la Gu\u00eda de Despacho</li> <li>Tracmin Admin emite un evento WebSocket (<code>dispatch_ready</code>)</li> <li>Tracmin Conductor recibe la notificaci\u00f3n y muestra la opci\u00f3n para imprimir la gu\u00eda</li> <li>El sem\u00e1foro de salida se pone en VERDE, indicando que el cami\u00f3n puede retirar la gu\u00eda y dirigirse al cliente</li> </ul>"},{"location":"logica_negocio/romanaremota/flujo/#diagrama-de-flujo","title":"Diagrama de Flujo","text":"<pre><code>flowchart TD\n subgraph subGraph0[\"Tracmin Log\u00edstica (Conductor)\"]\n        K1[\"Iniciar Carga (load_start)\"]\n        N1[\"Confirmar Fin de Carga\"]\n  end\n subgraph subGraph1[\"Tracmin Extracci\u00f3n (Cargador Frontal)\"]\n        K2[\"Confirmar Inicio de Carga\"]\n        M2[\"Notificar Fin de Carga (load_complete)\"]\n  end\n subgraph subGraph2[\"Carga en Planta\"]\n    direction LR\n        subGraph0\n        subGraph1\n        L2[\"Cargador Frontal recibe load_start\"]\n        L1[\"Conductor recibe confirmaci\u00f3n de inicio\"]\n        L1b[\"Conductor recibe load_complete\"]\n        L2b[\"Cargador Frontal recibe confirmaci\u00f3n fin\"]\n  end\n    A[\"Cami\u00f3n llega a la Romana (tara)\"] --&gt; B[\"Sem\u00e1foro taraje cambia a VERDE\"]\n    B --&gt; C[\"Ingreso a escritorio remoto\"]\n    C --&gt; D[\"Romanero remoto pesa cami\u00f3n vac\u00edo e ingresa tara en Tracmin Admin\"]\n    D --&gt; F[\"Tracmin Admin emite evento WebSocket: new_tara\"]\n    F --&gt; G[\"Tracmin Conductor recibe su tara en la pantalla\"] &amp; H[\"Tracmin Cargador Frontal recibe Nueva tara e informaci\u00f3n (Patente, destino, etc.)\"]\n    G --&gt; J[\"Cami\u00f3n va a planta para carga\"]\n    J --&gt; K1\n    H --&gt; K2\n    K1 --&gt; N1\n    K2 --&gt; M2\n    K1 -- evento --&gt; L2\n    K2 -- evento --&gt; L1\n    M2 -- evento --&gt; L1b\n    N1 -- evento --&gt; L2b\n    L2b --&gt; O[\"Cami\u00f3n regresa a Romana (peso con carga)\"]\n    L1b --&gt; O\n    O --&gt; P[\"Sem\u00e1foro de pesaje cambia a VERDE\"]\n    P --&gt; Q[\"Romanero remoto pesa cami\u00f3n cargado y crea Gu\u00eda de Despacho en Tracmin Admin\"]\n    Q --&gt; T[\"Tracmin Admin emite evento WebSocket: dispatch_ready\"]\n    T --&gt; U[\"Tracmin Conductor recibe dispatch_ready (Gu\u00eda de Despacho Digital)\"]\n    U --&gt; V[\"Sem\u00e1foro de salida cambia a VERDE\"]\n    V --&gt; W[\"Conductor retira gu\u00eda impresa y va a despachar\"]\n\n    K1@{ shape: rounded}\n    N1@{ shape: rounded}\n    K2@{ shape: rounded}\n    M2@{ shape: rounded}\n    subGraph0@{ shape: rounded}\n    subGraph1@{ shape: rounded}\n    L2@{ shape: rounded}\n    L1@{ shape: rounded}\n    L1b@{ shape: rounded}\n    L2b@{ shape: rounded}\n    A@{ shape: rounded}\n    B@{ shape: rounded}\n    C@{ shape: rounded}\n    D@{ shape: rounded}\n    F@{ shape: rounded}\n    G@{ shape: rounded}\n    H@{ shape: rounded}\n    J@{ shape: rounded}\n    O@{ shape: rounded}\n    P@{ shape: rounded}\n    Q@{ shape: rounded}\n    T@{ shape: rounded}\n    U@{ shape: rounded}\n    V@{ shape: rounded}\n    W@{ shape: rounded}\n    subGraph2@{ shape: rounded}\n    classDef Pine stroke-width:1px, stroke-dasharray:none, stroke:#254336, fill:#27654A, color:#FFFFFF\n    classDef Rose stroke-width:1px, stroke-dasharray:none, stroke:#FF5978, fill:#FFDFE5, color:#8E2236\n    classDef Sky stroke-width:1px, stroke-dasharray:none, stroke:#374D7C, fill:#E2EBFF, color:#374D7C\n    style K1 fill:#C8E6C9,stroke:#C8E6C9\n    style N1 fill:#C8E6C9,stroke:#C8E6C9\n    style K2 fill:#FFCDD2,stroke:#FFCDD2\n    style M2 stroke:#FFCDD2,fill:#FFCDD2\n    style subGraph0 fill:#00C853\n    style subGraph1 fill:#FFCDD2\n    style L2 fill:#C8E6C9,stroke:#C8E6C9\n    style L1 fill:#FFCDD2,stroke:#FFCDD2\n    style L1b fill:#FFCDD2,stroke:#FFCDD2\n    style L2b fill:#C8E6C9,stroke:#C8E6C9,stroke-width:2px,stroke-dasharray: 0\n    style D fill:#C8E6C9,color:none,stroke:#C8E6C9\n    style F fill:#C8E6C9,stroke:#C8E6C9\n    style G fill:#C8E6C9,stroke:#C8E6C9\n    style H fill:#FFCDD2,stroke:#FFCDD2\n    style J fill:#C8E6C9,stroke:none,color:none\n    style Q fill:#C8E6C9,stroke:#C8E6C9\n    style T fill:#C8E6C9,stroke:#C8E6C9\n    style U stroke:#C8E6C9,fill:#C8E6C9</code></pre>"},{"location":"logica_negocio/romanaremota/flujo/#integracion-tecnica","title":"Integraci\u00f3n T\u00e9cnica","text":"WebSocket Channels <ul> <li><code>post_trip</code>: Emite <code>{ InicioCarga, FinCarga }</code></li> <li><code>post_trip_tracmin</code>: Emite <code>{ PantallaFinCarga, PantallaGuias }</code></li> <li><code>sap_guides</code>: Emite <code>{ PantallaGuias }</code></li> </ul> Roles y Permisos <ul> <li>Romanero remoto Admin: Puede pesar cami\u00f3n y registrar datos en Tracmin Admin</li> <li>Conductor: Visualiza eventos y controla inicio/fin de carga</li> <li>Cargador Frontal: Supervisa y confirma procesos de carga</li> </ul> Requisitos de Infraestructura <ul> <li>Servidor de WebSocket con alta disponibilidad</li> <li>Escritorio remoto con cliente RDP habilitado conectado a la Romana</li> <li>Impresora de gu\u00edas en el punto de salida</li> </ul>"},{"location":"logica_negocio/romanaremota/flujo/#manejo-de-fallas-y-reconexion-websocket","title":"Manejo de Fallas y Reconexi\u00f3n WebSocket","text":"<p>En caso de que se pierda la conexi\u00f3n WebSocket en alguna de las aplicaciones (Tracmin Conductor o Cargador Frontal), se implementan los siguientes mecanismos de resiliencia:</p> 1. Reconexi\u00f3n Autom\u00e1tica <ul> <li>Cada cliente WebSocket intenta reconectarse de forma autom\u00e1tica usando un backoff exponencial</li> <li>Durante la reconexi\u00f3n, se muestra en la interfaz un mensaje de estado como \"Reconectando con servidor\u2026\"</li> </ul> 2. Re-sincronizaci\u00f3n de Estado <ul> <li>Una vez restablecida la conexi\u00f3n, la aplicaci\u00f3n emite autom\u00e1ticamente un evento <code>resync_state</code> con su <code>IdViaje</code></li> <li>Tracmin Admin responde con el estado actual del cami\u00f3n, incluyendo:     <pre><code>{\n\"Id\": \"123\",\n\"Tara\": 18500,\n\"HoraInicioCarga\": \"\",\n\"HoraFinCarga\": \"\"\n}\n</code></pre></li> <li>La aplicaci\u00f3n cliente actualiza su interfaz para reflejar correctamente el estado del flujo</li> </ul> 3. Caso Fallo Websocket <ul> <li>Los operadores pueden continuar el flujo de forma manual desde Tracmin Admin si es necesario</li> </ul> 4. Registro de Errores <ul> <li>Todas las fallas de conexi\u00f3n se registran con timestamp y detalle del error en un log central accesible para monitoreo y an\u00e1lisis de incidencias</li> </ul> <p>Este mecanismo asegura que ninguna aplicaci\u00f3n se quede en un estado inconsistente ante fallas de red temporales, y permite continuar el flujo operativo una vez restaurada la conectividad. </p>"}]}